{"file_contents":{"client/src/components/admin-dashboard.tsx":{"content":"import { useState, useEffect, Fragment } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { format } from \"date-fns\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n  TableFooter,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  TrendingUp,\n  GraduationCap,\n  Users,\n  AlertTriangle,\n  DollarSign,\n  ClipboardList,\n  File,\n  Plus,\n  Check,\n  X,\n  Edit,\n  PlusCircle,\n  Save,\n  Download,\n  HandHeart,\n  PieChart,\n  Calendar,\n  FileText,\n  Archive,\n  RotateCcw,\n  UserX,\n  ArrowUpDown,\n  ArrowUp,\n  ArrowDown,\n  Filter,\n  ChevronDown,\n  ChevronRight,\n  Eye,\n  UserPlus,\n  Phone,\n  Mail,\n  History,\n  Trash2,\n  MessageSquare,\n  Reply,\n  Link2,\n  Link2Off,\n} from \"lucide-react\";\nimport type { User, StudentWithTutor, TimesheetEntryWithRelations, WeeklyTimesheetWithRelations, ArchivedStudentSummary, ArchivedTutorSummary, WaitlistEntry, InsertWaitlistEntry, ParentMessageWithRelations, StudentTopic, ParentMessageReplyWithRelations, RateConfiguration, TutorRate, ParentRate, RateLink, Invoice, TutorInvoice, InvoiceWithRelations, AdhocInvoice } from \"@shared/schema\";\nimport { insertWaitlistSchema } from \"@shared/schema\";\nimport { BookOpen } from \"lucide-react\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\n\nconst studentSchema = z.object({\n  name: z.string().min(1, \"Name is required\"),\n  parentName: z.string().optional(),\n  parentSurname: z.string().optional(),\n  parentEmail: z.string().email(\"Valid email required\").optional().or(z.literal(\"\")),\n  parentPhone: z.string().optional(),\n  subject: z.string().min(1, \"Subject is required\"),\n  examType: z.string().optional(),\n  tutorId: z.string().min(1, \"Please select a tutor\"),\n  classType: z.enum([\"individual\", \"group\"]),\n  sessionsBooked: z.coerce.number().min(0, \"Sessions booked must be 0 or more\"),\n  sessionsRemaining: z.coerce.number().min(0, \"Sessions remaining must be 0 or more\"),\n  parentRate: z.coerce.number().min(0, \"Parent rate must be positive\"),\n  tutorRate: z.coerce.number().min(0, \"Tutor rate must be positive\"),\n  startYear: z.coerce.number().optional(),\n  examMonth: z.coerce.number().min(1).max(12).optional(),\n  examYear: z.coerce.number().optional(),\n  examBoard: z.string().optional(),\n  targetSchools: z.string().optional(),\n  primarySchool: z.string().optional(),\n});\n\nconst monthNames = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\n\nconst tutorSchema = z.object({\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  email: z.string().email(\"Valid email is required\"),\n  startYear: z.coerce.number().optional(),\n});\n\n\nconst rateConfigSchema = z.object({\n  name: z.string().min(1, \"Name is required\"),\n  description: z.string().optional(),\n  classType: z.enum([\"individual\", \"group\"]),\n  subject: z.string().optional(),\n  rateType: z.enum([\"tutor\", \"parent\", \"combined\"]).optional(),\n  tutorRate: z.coerce.number().min(0, \"Rate must be positive\"),\n  parentRate: z.coerce.number().min(0, \"Rate must be positive\"),\n  linkedRateId: z.string().optional().nullable(),\n  isDefault: z.boolean().optional(),\n  isActive: z.boolean().optional(),\n});\n\ntype StudentFormData = z.infer<typeof studentSchema>;\ntype TutorFormData = z.infer<typeof tutorSchema>;\ntype WaitlistFormData = z.infer<typeof insertWaitlistSchema>;\ntype RateConfigFormData = z.infer<typeof rateConfigSchema>;\n\ninterface AdminDashboardProps {\n  user: User;\n}\n\ninterface StatusHistoryItem {\n  id: string;\n  weeklyTimesheetId: string;\n  fromStatus: string | null;\n  toStatus: string;\n  changedBy: string;\n  notes: string | null;\n  createdAt: string;\n  changedByName?: string;\n}\n\nfunction StatusHistorySection({ \n  timesheetId, \n  isExpanded, \n  onToggle \n}: { \n  timesheetId: string; \n  isExpanded: boolean; \n  onToggle: () => void; \n}) {\n  const { data: history = [], isLoading } = useQuery<StatusHistoryItem[]>({\n    queryKey: [\"/api/weekly-timesheets\", timesheetId, \"history\"],\n    queryFn: async () => {\n      const res = await fetch(`/api/weekly-timesheets/${timesheetId}/history`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch status history\");\n      return res.json();\n    },\n    enabled: isExpanded,\n    retry: false,\n  });\n\n  return (\n    <div className=\"mb-4\">\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground\"\n        onClick={onToggle}\n        data-testid={`button-toggle-history-${timesheetId}`}\n      >\n        {isExpanded ? <ChevronDown className=\"w-4 h-4\" /> : <ChevronRight className=\"w-4 h-4\" />}\n        <History className=\"w-4 h-4\" />\n        Status History\n      </Button>\n      \n      {isExpanded && (\n        <div className=\"mt-2 ml-6 p-3 bg-muted/50 rounded-lg border border-border/50\">\n          {isLoading ? (\n            <p className=\"text-sm text-muted-foreground\">Loading history...</p>\n          ) : history.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground\">No status history yet</p>\n          ) : (\n            <div className=\"space-y-3\">\n              {history.map((item) => (\n                <div key={item.id} className=\"text-sm\">\n                  <div className=\"flex items-start gap-2\">\n                    <div className={`w-2 h-2 rounded-full mt-1.5 flex-shrink-0 ${\n                      item.toStatus === \"rejected\" ? \"bg-destructive\" : \n                      item.toStatus === \"approved\" ? \"bg-green-500\" : \"bg-primary\"\n                    }`} />\n                    <div className=\"flex-1\">\n                      <span className=\"font-medium\">\n                        {item.fromStatus ? `${item.fromStatus} â†’ ` : \"\"}{item.toStatus}\n                      </span>\n                      <div className=\"text-xs text-muted-foreground\">\n                        by {item.changedByName || \"Unknown\"} on {format(new Date(item.createdAt), \"MMM dd, yyyy h:mm a\")}\n                      </div>\n                    </div>\n                  </div>\n                  {item.notes && (\n                    <div className={`ml-4 mt-1 p-2 rounded text-sm ${\n                      item.toStatus === \"rejected\" \n                        ? \"bg-destructive/10 border border-destructive/20 text-destructive\" \n                        : \"bg-muted/50 border border-border/50\"\n                    }`}>\n                      <span className=\"font-medium\">\n                        {item.toStatus === \"rejected\" ? \"Reason: \" : \"Notes: \"}\n                      </span>\n                      {item.notes}\n                    </div>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default function AdminDashboard({ user }: AdminDashboardProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [isAddStudentOpen, setIsAddStudentOpen] = useState(false);\n  const [isAddTutorOpen, setIsAddTutorOpen] = useState(false);\n  const [editingStudent, setEditingStudent] = useState<StudentWithTutor | null>(null);\n  const [isEditStudentOpen, setIsEditStudentOpen] = useState(false);\n  const [editStudentData, setEditStudentData] = useState({\n    name: \"\",\n    parentName: \"\",\n    parentSurname: \"\",\n    parentEmail: \"\",\n    parentPhone: \"\",\n    subject: \"\",\n    examType: \"\",\n    tutorId: \"\",\n    classType: \"individual\" as \"individual\" | \"group\",\n    sessionsBooked: 0,\n    sessionsRemaining: 0,\n    parentRate: 0,\n    tutorRate: 0,\n    parentContactInfo: \"\",\n    startYear: undefined as number | undefined,\n    endYear: undefined as number | undefined,\n    examMonth: undefined as number | undefined,\n    examYear: undefined as number | undefined,\n    examBoard: \"\",\n    targetSchools: \"\",\n    primarySchool: \"\",\n  });\n  const [editingStaff, setEditingStaff] = useState<User | null>(null);\n  const [isEditStaffOpen, setIsEditStaffOpen] = useState(false);\n  const [editStaffData, setEditStaffData] = useState({\n    firstName: \"\",\n    lastName: \"\",\n    email: \"\",\n    startYear: undefined as number | undefined,\n    endYear: undefined as number | undefined,\n  });\n  const [sessionView, setSessionView] = useState<\"week\" | \"all\">(\"week\");\n  const [sessionTutorFilter, setSessionTutorFilter] = useState<string>(\"all\");\n  const [sessionSortOrder, setSessionSortOrder] = useState<\"desc\" | \"asc\">(\"desc\");\n  const [expandedStudents, setExpandedStudents] = useState<Set<string>>(new Set());\n  const [expandedArchivedStudents, setExpandedArchivedStudents] = useState<Set<string>>(new Set());\n  const [viewingTutorEarnings, setViewingTutorEarnings] = useState<User | null>(null);\n  const [isTutorEarningsOpen, setIsTutorEarningsOpen] = useState(false);\n  const [isAddWaitlistOpen, setIsAddWaitlistOpen] = useState(false);\n  const [editingWaitlist, setEditingWaitlist] = useState<WaitlistEntry | null>(null);\n  const [isEditWaitlistOpen, setIsEditWaitlistOpen] = useState(false);\n  const [editWaitlistData, setEditWaitlistData] = useState({\n    studentName: \"\",\n    parentName: \"\",\n    parentEmail: \"\",\n    parentPhone: \"\",\n    subject: \"\",\n    notes: \"\",\n    depositPaid: false,\n    depositAmount: \"\" as string,\n    status: \"new\" as \"new\" | \"contacted\" | \"scheduled\" | \"converted\" | \"declined\",\n  });\n\n  // Topics management state\n  const [selectedStudentForTopics, setSelectedStudentForTopics] = useState<StudentWithTutor | null>(null);\n  const [isTopicsDialogOpen, setIsTopicsDialogOpen] = useState(false);\n  const [bulkTopicsText, setBulkTopicsText] = useState(\"\");\n  const [editingTopicId, setEditingTopicId] = useState<string | null>(null);\n  const [editingTopicTitle, setEditingTopicTitle] = useState(\"\");\n  const [expandedMessageId, setExpandedMessageId] = useState<string | null>(null);\n  const [replyContent, setReplyContent] = useState(\"\");\n  const [messageRecipientFilter, setMessageRecipientFilter] = useState<\"all\" | \"admin\" | \"tutor\">(\"all\");\n  const [legacyStatusFilter, setLegacyStatusFilter] = useState<\"all\" | \"pending\" | \"approved\" | \"rejected\">(\"all\");\n  const [legacyTutorFilter, setLegacyTutorFilter] = useState<string>(\"all\");\n  const [expandedLegacyTutor, setExpandedLegacyTutor] = useState<string | null>(null);\n  const [expandedLegacyWeek, setExpandedLegacyWeek] = useState<string | null>(null);\n\n  // Rate configuration management state (NEW INDEPENDENT SYSTEM)\n  const [isAddTutorRateOpen, setIsAddTutorRateOpen] = useState(false);\n  const [isAddParentRateOpen, setIsAddParentRateOpen] = useState(false);\n  const [editingTutorRate, setEditingTutorRate] = useState<TutorRate | null>(null);\n  const [editingParentRate, setEditingParentRate] = useState<ParentRate | null>(null);\n  const [isEditTutorRateOpen, setIsEditTutorRateOpen] = useState(false);\n  const [isEditParentRateOpen, setIsEditParentRateOpen] = useState(false);\n  const [isLinkRateOpen, setIsLinkRateOpen] = useState(false);\n  const [linkingTutorRateId, setLinkingTutorRateId] = useState<string>(\"\");\n  const [linkingParentRateId, setLinkingParentRateId] = useState<string>(\"\");\n  const [tutorRateFormData, setTutorRateFormData] = useState({\n    name: \"\",\n    description: \"\",\n    classType: \"individual\" as \"individual\" | \"group\",\n    subject: \"\",\n    rate: 0,\n    isDefault: false,\n    isActive: true,\n  });\n  const [parentRateFormData, setParentRateFormData] = useState({\n    name: \"\",\n    description: \"\",\n    classType: \"individual\" as \"individual\" | \"group\",\n    subject: \"\",\n    rate: 0,\n    isDefault: false,\n    isActive: true,\n  });\n  \n  // Parent invoice editing state\n  const [editingParentInvoice, setEditingParentInvoice] = useState<Invoice | null>(null);\n  const [isEditParentInvoiceOpen, setIsEditParentInvoiceOpen] = useState(false);\n  const [parentInvoiceFormData, setParentInvoiceFormData] = useState({\n    amount: \"\",\n    sessionsIncluded: 0,\n    selectedRateId: \"\",\n    status: \"draft\" as \"draft\" | \"sent\" | \"approved\" | \"paid\" | \"partial\" | \"overdue\" | \"cancelled\",\n    notes: \"\",\n  });\n\n  // Adhoc invoice state\n  const [isCreateAdhocInvoiceOpen, setIsCreateAdhocInvoiceOpen] = useState(false);\n  const [isEditAdhocInvoiceOpen, setIsEditAdhocInvoiceOpen] = useState(false);\n  const [editingAdhocInvoice, setEditingAdhocInvoice] = useState<AdhocInvoice | null>(null);\n  const [adhocInvoiceFormData, setAdhocInvoiceFormData] = useState({\n    parentFirstName: \"\",\n    parentSurname: \"\",\n    amount: \"\",\n    reason: \"\",\n    dueDate: \"\",\n    status: \"draft\" as \"draft\" | \"sent\" | \"approved\" | \"paid\" | \"partial\" | \"overdue\" | \"cancelled\",\n    notes: \"\",\n  });\n\n  // Parent invoice view state (outstanding vs paid)\n  const [parentInvoiceView, setParentInvoiceView] = useState<\"outstanding\" | \"paid\">(\"outstanding\");\n  const [paidInvoiceFilters, setPaidInvoiceFilters] = useState({\n    studentName: \"\",\n    parentName: \"\",\n    tutorName: \"\",\n    month: \"\",\n    year: \"\",\n    minAmount: \"\",\n    maxAmount: \"\",\n  });\n\n  // Legacy state (keeping for backward compatibility)\n  const [editingRate, setEditingRate] = useState<RateConfiguration | null>(null);\n  const [isEditRateOpen, setIsEditRateOpen] = useState(false);\n  const [rateFormData, setRateFormData] = useState<RateConfigFormData>({\n    name: \"\",\n    description: \"\",\n    classType: \"individual\",\n    subject: \"\",\n    tutorRate: 0,\n    parentRate: 0,\n    isDefault: false,\n    isActive: true,\n  });\n\n  // Toggle student expansion\n  const toggleStudentExpand = (studentId: string) => {\n    setExpandedStudents(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(studentId)) {\n        newSet.delete(studentId);\n      } else {\n        newSet.add(studentId);\n      }\n      return newSet;\n    });\n  };\n\n  // Toggle archived student expansion\n  const toggleArchivedStudentExpand = (studentId: string) => {\n    setExpandedArchivedStudents(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(studentId)) {\n        newSet.delete(studentId);\n      } else {\n        newSet.add(studentId);\n      }\n      return newSet;\n    });\n  };\n\n  // Date helpers for session filtering\n  const getWeekStart = () => {\n    const now = new Date();\n    const dayOfWeek = now.getDay();\n    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);\n    return new Date(now.setDate(diff));\n  };\n  const weekStart = getWeekStart();\n  const weekEnd = new Date(weekStart);\n  weekEnd.setDate(weekEnd.getDate() + 6);\n  weekEnd.setHours(23, 59, 59, 999);\n\n  // Fetch admin stats\n  const { data: stats } = useQuery<{\n    totalRevenue: number;\n    activeStudents: number;\n    activeTutors: number;\n    lowBalanceAlerts: number;\n    weeklyOutgoings: number;\n    totalExpenditure: number;\n    monthlyIncome: number;\n  }>({\n    queryKey: [\"/api/analytics/admin-stats\"],\n    retry: false,\n  });\n\n  // Fetch active students\n  const {\n    data: students = [],\n    isLoading: studentsLoading,\n    error: studentsError,\n  } = useQuery<StudentWithTutor[]>({\n    queryKey: [\"/api/students\"],\n    retry: false,\n  });\n\n  // Fetch all students including inactive (ex-students)\n  const { data: allStudents = [] } = useQuery<StudentWithTutor[]>({\n    queryKey: [\"/api/students/all\"],\n    retry: false,\n  });\n\n  // Fetch active tutors\n  const { data: tutors = [] } = useQuery<User[]>({\n    queryKey: [\"/api/tutors\"],\n    retry: false,\n  });\n\n  // Fetch all tutors including inactive (ex-tutors)\n  const { data: allTutors = [] } = useQuery<User[]>({\n    queryKey: [\"/api/tutors/all\"],\n    retry: false,\n  });\n\n  // Fetch pending timesheets\n  const { data: pendingTimesheets = [] } = useQuery<TimesheetEntryWithRelations[]>({\n    queryKey: [\"/api/timesheets\", \"pending\"],\n    retry: false,\n  });\n\n  // Fetch all sessions for admin view\n  const { data: allSessions = [] } = useQuery<TimesheetEntryWithRelations[]>({\n    queryKey: [\"/api/timesheets/all\"],\n    retry: false,\n  });\n\n  // Fetch submitted weekly timesheets for admin review\n  const { data: submittedWeeklyTimesheets = [] } = useQuery<WeeklyTimesheetWithRelations[]>({\n    queryKey: [\"/api/weekly-timesheets/submitted\"],\n    retry: false,\n  });\n\n\n  // State for weekly timesheet review\n  const [reviewNotes, setReviewNotes] = useState<Record<string, string>>({});\n  const [rejectDialogOpen, setRejectDialogOpen] = useState(false);\n  const [expandedStatusHistoryId, setExpandedStatusHistoryId] = useState<string | null>(null);\n  const [rejectingTimesheetId, setRejectingTimesheetId] = useState<string | null>(null);\n  const [rejectionReason, setRejectionReason] = useState(\"\");\n  const [editEntryDialogOpen, setEditEntryDialogOpen] = useState(false);\n  const [editingEntry, setEditingEntry] = useState<{\n    id: string;\n    duration: string;\n    tutorEarnings: string;\n    parentBilling: string;\n    studentName: string;\n  } | null>(null);\n\n  // State for archive view\n  const [archiveView, setArchiveView] = useState<\"students\" | \"tutors\">(\"students\");\n  const [selectedArchivedStudent, setSelectedArchivedStudent] = useState<ArchivedStudentSummary | null>(null);\n  const [selectedArchivedTutor, setSelectedArchivedTutor] = useState<ArchivedTutorSummary | null>(null);\n\n  // Fetch student invoice summaries (outstanding invoices and unpaid sessions)\n  const { data: invoiceSummaries = [] } = useQuery<{ studentId: string; outstandingInvoices: number; unpaidSessions: number }[]>({\n    queryKey: [\"/api/students/invoice-summaries\"],\n    retry: false,\n    staleTime: 30000,\n  });\n\n  // Create a lookup map for invoice summaries\n  const invoiceSummaryMap = new Map(invoiceSummaries.map(s => [s.studentId, s]));\n\n  // Fetch archived students with financial summaries\n  const { data: archivedStudents = [], isLoading: archivedStudentsLoading } = useQuery<ArchivedStudentSummary[]>({\n    queryKey: [\"/api/archive/students\"],\n    retry: false,\n  });\n\n  // Fetch archived tutors with financial summaries\n  const { data: archivedTutors = [], isLoading: archivedTutorsLoading } = useQuery<ArchivedTutorSummary[]>({\n    queryKey: [\"/api/archive/tutors\"],\n    retry: false,\n  });\n\n  // Fetch waitlist entries\n  const { data: waitlistEntries = [], isLoading: waitlistLoading } = useQuery<WaitlistEntry[]>({\n    queryKey: [\"/api/waitlist\"],\n    retry: false,\n  });\n\n  // Fetch parent messages for admin\n  const { data: parentMessages = [], isLoading: parentMessagesLoading } = useQuery<ParentMessageWithRelations[]>({\n    queryKey: [\"/api/messages/admin\"],\n    retry: false,\n  });\n\n  // Fetch rate configurations (legacy - deprecated)\n  const { data: rateConfigurations = [], isLoading: ratesLoading } = useQuery<RateConfiguration[]>({\n    queryKey: [\"/api/rate-configurations\"],\n    retry: false,\n  });\n\n  // Fetch tutor rates (NEW INDEPENDENT SYSTEM)\n  const { data: tutorRatesData = [], isLoading: tutorRatesLoading } = useQuery<TutorRate[]>({\n    queryKey: [\"/api/tutor-rates\"],\n    retry: false,\n  });\n\n  // Fetch parent rates (NEW INDEPENDENT SYSTEM)\n  const { data: parentRatesData = [], isLoading: parentRatesLoading } = useQuery<ParentRate[]>({\n    queryKey: [\"/api/parent-rates\"],\n    retry: false,\n  });\n\n  // Fetch rate links (for profit margin analysis)\n  const { data: rateLinksData = [], isLoading: rateLinksLoading } = useQuery<(RateLink & { tutorRate: TutorRate; parentRate: ParentRate })[]>({\n    queryKey: [\"/api/rate-links\"],\n    retry: false,\n  });\n\n  // Fetch tutor invoices (invoices sent from tutors to admin this week)\n  const { data: tutorInvoicesThisWeek = [], isLoading: tutorInvoicesLoading } = useQuery<(TutorInvoice & { tutor: User })[]>({\n    queryKey: [\"/api/tutor-invoices/this-week\"],\n    retry: false,\n  });\n\n  // Fetch all tutor invoices\n  const { data: allTutorInvoices = [] } = useQuery<(TutorInvoice & { tutor: User })[]>({\n    queryKey: [\"/api/tutor-invoices\"],\n    retry: false,\n  });\n\n  // Fetch parent invoices (for parents) - includes student info\n  const { data: parentInvoices = [], isLoading: parentInvoicesLoading } = useQuery<InvoiceWithRelations[]>({\n    queryKey: [\"/api/invoices\"],\n    retry: false,\n  });\n\n  // Fetch adhoc invoices (manual invoices not tied to students)\n  const { data: adhocInvoices = [], isLoading: adhocInvoicesLoading } = useQuery<AdhocInvoice[]>({\n    queryKey: [\"/api/adhoc-invoices\"],\n    retry: false,\n  });\n\n  // Fetch single message with replies when expanded\n  const { data: expandedMessage } = useQuery<ParentMessageWithRelations & { replies: ParentMessageReplyWithRelations[] }>({\n    queryKey: [\"/api/messages\", expandedMessageId],\n    enabled: !!expandedMessageId,\n    retry: false,\n  });\n\n  // Create reply mutation\n  const createReplyMutation = useMutation({\n    mutationFn: async ({ messageId, replyContent }: { messageId: string; replyContent: string }) => {\n      const response = await apiRequest(\"POST\", `/api/messages/${messageId}/replies`, { replyContent });\n      return response.json();\n    },\n    onSuccess: () => {\n      setReplyContent(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages\", expandedMessageId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages/admin\"] });\n      toast({\n        title: \"Reply Sent\",\n        description: \"Your reply has been sent successfully.\",\n      });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to send reply.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Fetch topics for selected student\n  const { data: studentTopics = [], isLoading: topicsLoading } = useQuery<StudentTopic[]>({\n    queryKey: [\"/api/students\", selectedStudentForTopics?.id, \"topics\"],\n    queryFn: async () => {\n      if (!selectedStudentForTopics) return [];\n      const res = await fetch(`/api/students/${selectedStudentForTopics.id}/topics`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch topics\");\n      return res.json();\n    },\n    enabled: !!selectedStudentForTopics && isTopicsDialogOpen,\n    retry: false,\n  });\n\n  // Import topics mutation\n  const importTopicsMutation = useMutation({\n    mutationFn: async ({ studentId, topics }: { studentId: string; topics: { title: string; orderIndex: number }[] }) => {\n      const response = await apiRequest(\"POST\", `/api/students/${studentId}/topics/import`, { topics });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Topics imported successfully!\",\n      });\n      setBulkTopicsText(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/students\", selectedStudentForTopics?.id, \"topics\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to import topics.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update topic mutation\n  const updateTopicMutation = useMutation({\n    mutationFn: async ({ topicId, title }: { topicId: string; title: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/topics/${topicId}`, { title });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Topic updated!\",\n      });\n      setEditingTopicId(null);\n      setEditingTopicTitle(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/students\", selectedStudentForTopics?.id, \"topics\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update topic.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mark parent message as read mutation\n  const markMessageReadMutation = useMutation({\n    mutationFn: async (messageId: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/messages/${messageId}/read`);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages/admin\"] });\n      toast({\n        title: \"Success\",\n        description: \"Message marked as read.\",\n      });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to mark message as read.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Fetch selected tutor's earnings view (what the tutor sees)\n  const { data: tutorEarningsData, isLoading: tutorEarningsLoading } = useQuery<{\n    earnings: number;\n    entries: TimesheetEntryWithRelations[];\n  }>({\n    queryKey: [`/api/analytics/tutor-earnings/${viewingTutorEarnings?.id}?startDate=${weekStart.toISOString()}&endDate=${weekEnd.toISOString()}`],\n    enabled: !!viewingTutorEarnings && isTutorEarningsOpen,\n    retry: false,\n  });\n\n  // Student form\n  const studentForm = useForm<StudentFormData>({\n    resolver: zodResolver(studentSchema),\n    defaultValues: {\n      name: \"\",\n      parentName: \"\",\n      parentSurname: \"\",\n      parentEmail: \"\",\n      parentPhone: \"\",\n      subject: \"\",\n      examType: \"\",\n      tutorId: \"\",\n      classType: \"individual\",\n      sessionsBooked: 1,\n      sessionsRemaining: 1,\n      parentRate: 0,\n      tutorRate: 0,\n      startYear: undefined,\n      examMonth: undefined,\n      examYear: undefined,\n      examBoard: \"\",\n      targetSchools: \"\",\n      primarySchool: \"\",\n    },\n  });\n\n  // Tutor form\n  const tutorForm = useForm<TutorFormData>({\n    resolver: zodResolver(tutorSchema),\n    defaultValues: {\n      firstName: \"\",\n      lastName: \"\",\n      email: \"\",\n      startYear: undefined,\n    },\n  });\n\n  // Waitlist form\n  const waitlistForm = useForm<WaitlistFormData>({\n    resolver: zodResolver(insertWaitlistSchema),\n    defaultValues: {\n      studentName: \"\",\n      parentName: \"\",\n      parentEmail: \"\",\n      parentPhone: \"\",\n      subject: \"\",\n      notes: \"\",\n      depositPaid: false,\n      depositAmount: undefined,\n    },\n  });\n\n  // Create student mutation\n  const createStudentMutation = useMutation({\n    mutationFn: async (data: StudentFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/students\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Student created successfully!\",\n      });\n      studentForm.reset();\n      setIsAddStudentOpen(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/students\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/admin-stats\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to create student. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Create tutor mutation\n  const createTutorMutation = useMutation({\n    mutationFn: async (data: TutorFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/tutors\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Staff member created successfully!\",\n      });\n      tutorForm.reset();\n      setIsAddTutorOpen(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutors\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to create staff member. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update tutor role mutation\n  const updateTutorRoleMutation = useMutation({\n    mutationFn: async ({ tutorId, role }: { tutorId: string; role: \"admin\" | \"tutor\" }) => {\n      const response = await apiRequest(\"PATCH\", `/api/tutors/${tutorId}`, { role });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Staff role updated successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutors\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update role. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update student mutation\n  const updateStudentMutation = useMutation({\n    mutationFn: async ({ studentId, updates }: { studentId: string; updates: Record<string, any> }) => {\n      const response = await apiRequest(\"PATCH\", `/api/students/${studentId}`, updates);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Student updated successfully!\",\n      });\n      setIsEditStudentOpen(false);\n      setEditingStudent(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/students\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/admin-stats\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update student. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update staff mutation\n  const updateStaffMutation = useMutation({\n    mutationFn: async ({ staffId, updates }: { staffId: string; updates: { firstName?: string; lastName?: string; email?: string } }) => {\n      const response = await apiRequest(\"PATCH\", `/api/tutors/${staffId}`, updates);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Staff member updated successfully!\",\n      });\n      setIsEditStaffOpen(false);\n      setEditingStaff(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutors\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update staff member. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Open edit dialog for a student\n  const openEditDialog = (student: StudentWithTutor) => {\n    setEditingStudent(student);\n    setEditStudentData({\n      name: student.name,\n      parentName: student.parentName || \"\",\n      parentSurname: (student as any).parentSurname || \"\",\n      parentEmail: (student as any).parentEmail || \"\",\n      parentPhone: student.parentPhone || \"\",\n      subject: student.subject,\n      examType: (student as any).examType || \"\",\n      tutorId: student.tutorId,\n      classType: student.classType as \"individual\" | \"group\",\n      sessionsBooked: student.sessionsBooked,\n      sessionsRemaining: student.sessionsRemaining,\n      parentRate: parseFloat(student.parentRate.toString()),\n      tutorRate: parseFloat(student.tutorRate.toString()),\n      parentContactInfo: student.parentContactInfo || \"\",\n      startYear: student.startYear ?? undefined,\n      endYear: student.endYear ?? undefined,\n      examMonth: student.examMonth ?? undefined,\n      examYear: student.examYear ?? undefined,\n      examBoard: (student as any).examBoard || \"\",\n      targetSchools: (student as any).targetSchools || \"\",\n      primarySchool: (student as any).primarySchool || \"\",\n    });\n    setIsEditStudentOpen(true);\n  };\n\n  // Handle save student updates\n  const handleSaveStudent = () => {\n    if (!editingStudent) return;\n    \n    updateStudentMutation.mutate({\n      studentId: editingStudent.id,\n      updates: {\n        name: editStudentData.name,\n        parentName: editStudentData.parentName,\n        parentSurname: editStudentData.parentSurname,\n        parentEmail: editStudentData.parentEmail,\n        parentPhone: editStudentData.parentPhone,\n        subject: editStudentData.subject,\n        examType: editStudentData.examType || null,\n        tutorId: editStudentData.tutorId,\n        classType: editStudentData.classType,\n        sessionsBooked: editStudentData.sessionsBooked,\n        sessionsRemaining: editStudentData.sessionsRemaining,\n        parentRate: String(editStudentData.parentRate),\n        tutorRate: String(editStudentData.tutorRate),\n        parentContactInfo: editStudentData.parentContactInfo,\n        startYear: editStudentData.startYear || null,\n        endYear: editStudentData.endYear || null,\n        examMonth: editStudentData.examMonth || null,\n        examYear: editStudentData.examYear || null,\n        examBoard: editStudentData.examBoard || null,\n        targetSchools: editStudentData.targetSchools || null,\n        primarySchool: editStudentData.primarySchool || null,\n      },\n    });\n  };\n\n  // Open edit dialog for staff\n  const openEditStaffDialog = (staff: User) => {\n    setEditingStaff(staff);\n    setEditStaffData({\n      firstName: staff.firstName || \"\",\n      lastName: staff.lastName || \"\",\n      email: staff.email || \"\",\n      startYear: staff.startYear ?? undefined,\n      endYear: staff.endYear ?? undefined,\n    });\n    setIsEditStaffOpen(true);\n  };\n\n  // Handle save staff updates\n  const handleSaveStaff = () => {\n    if (!editingStaff) return;\n    updateStaffMutation.mutate({\n      staffId: editingStaff.id,\n      updates: editStaffData,\n    });\n  };\n\n  // Open topics dialog for a student\n  const openTopicsDialog = (student: StudentWithTutor) => {\n    setSelectedStudentForTopics(student);\n    setBulkTopicsText(\"\");\n    setEditingTopicId(null);\n    setEditingTopicTitle(\"\");\n    setIsTopicsDialogOpen(true);\n  };\n\n  // Handle bulk import of topics\n  const handleBulkImport = () => {\n    if (!selectedStudentForTopics || !bulkTopicsText.trim()) return;\n    const lines = bulkTopicsText.split(\"\\n\").filter(line => line.trim());\n    const topics = lines.map((title, index) => ({\n      title: title.trim(),\n      orderIndex: index,\n    }));\n    importTopicsMutation.mutate({ studentId: selectedStudentForTopics.id, topics });\n  };\n\n  // Archive student mutation\n  const archiveStudentMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/students/${id}/archive`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Student archived and moved to Ex-Students.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/students\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/students/all\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/admin-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/archive/students\"] });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to archive student.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Restore student mutation\n  const restoreStudentMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/students/${id}/restore`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Student restored successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/students\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/students/all\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/admin-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/archive/students\"] });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to restore student.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Permanently delete archived student mutation\n  const deleteStudentMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/students/${id}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Student permanently deleted from the system.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/students\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/students/all\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/admin-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/archive/students\"] });\n      setSelectedArchivedStudent(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete student.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Archive tutor mutation\n  const archiveTutorMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/tutors/${id}/archive`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Staff member archived and moved to Ex-Tutors.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutors/all\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/admin-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/archive/tutors\"] });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to archive staff member.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Restore tutor mutation\n  const restoreTutorMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/tutors/${id}/restore`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Staff member restored successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutors/all\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/admin-stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/archive/tutors\"] });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to restore staff member.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Create waitlist mutation\n  const createWaitlistMutation = useMutation({\n    mutationFn: async (data: WaitlistFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/waitlist\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Waitlist entry created successfully!\",\n      });\n      waitlistForm.reset();\n      setIsAddWaitlistOpen(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/waitlist\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to create waitlist entry. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update waitlist mutation\n  const updateWaitlistMutation = useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<WaitlistFormData> }) => {\n      const response = await apiRequest(\"PATCH\", `/api/waitlist/${id}`, updates);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Waitlist entry updated successfully!\",\n      });\n      setIsEditWaitlistOpen(false);\n      setEditingWaitlist(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/waitlist\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update waitlist entry. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete waitlist mutation\n  const deleteWaitlistMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/waitlist/${id}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Waitlist entry deleted successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/waitlist\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete waitlist entry. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Rate configuration mutations\n  const createRateMutation = useMutation({\n    mutationFn: async (data: RateConfigFormData) => {\n      const payload = {\n        ...data,\n        tutorRate: data.tutorRate.toString(),\n        parentRate: data.parentRate.toString(),\n      };\n      const response = await apiRequest(\"POST\", \"/api/rate-configurations\", payload);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Rate configuration created successfully!\",\n      });\n      setIsAddRateOpen(false);\n      setRateFormData({\n        name: \"\",\n        description: \"\",\n        classType: \"individual\",\n        subject: \"\",\n        tutorRate: 0,\n        parentRate: 0,\n        isDefault: false,\n        isActive: true,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-configurations\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to create rate configuration. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateRateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: RateConfigFormData }) => {\n      const payload = {\n        ...data,\n        tutorRate: data.tutorRate.toString(),\n        parentRate: data.parentRate.toString(),\n      };\n      const response = await apiRequest(\"PATCH\", `/api/rate-configurations/${id}`, payload);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Rate configuration updated successfully!\",\n      });\n      setIsEditRateOpen(false);\n      setEditingRate(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-configurations\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update rate configuration. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteRateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      // First, find if this rate is linked to another\n      const rate = rateConfigurations.find(r => r.id === id);\n      if (rate?.linkedRateId) {\n        // Clear the linkedRateId on the partner rate (don't delete it)\n        await apiRequest(\"PATCH\", `/api/rate-configurations/${rate.linkedRateId}`, { linkedRateId: null });\n      }\n      // Then delete the rate\n      await apiRequest(\"DELETE\", `/api/rate-configurations/${id}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Rate configuration deleted successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-configurations\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete rate configuration. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const linkRateMutation = useMutation({\n    mutationFn: async ({ tutorRateId, parentRateId }: { tutorRateId: string; parentRateId: string }) => {\n      // Update both rates to link to each other\n      await apiRequest(\"PATCH\", `/api/rate-configurations/${tutorRateId}`, { linkedRateId: parentRateId });\n      await apiRequest(\"PATCH\", `/api/rate-configurations/${parentRateId}`, { linkedRateId: tutorRateId });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Rates linked successfully!\",\n      });\n      setIsLinkRateOpen(false);\n      setLinkingTutorRate(null);\n      setSelectedParentRateId(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-configurations\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to link rates. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unlinkRateMutation = useMutation({\n    mutationFn: async (rateId: string) => {\n      const rate = rateConfigurations.find(r => r.id === rateId);\n      if (rate?.linkedRateId) {\n        // Unlink both rates\n        await apiRequest(\"PATCH\", `/api/rate-configurations/${rateId}`, { linkedRateId: null });\n        await apiRequest(\"PATCH\", `/api/rate-configurations/${rate.linkedRateId}`, { linkedRateId: null });\n      }\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Rates unlinked successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-configurations\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to unlink rates. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // ============ NEW INDEPENDENT RATE SYSTEM MUTATIONS ============\n  \n  // Create tutor rate mutation\n  const createTutorRateMutation = useMutation({\n    mutationFn: async (data: typeof tutorRateFormData) => {\n      const payload = {\n        ...data,\n        rate: data.rate.toString(),\n      };\n      const response = await apiRequest(\"POST\", \"/api/tutor-rates\", payload);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Tutor rate created successfully!\",\n      });\n      setIsAddTutorRateOpen(false);\n      setTutorRateFormData({\n        name: \"\",\n        description: \"\",\n        classType: \"individual\",\n        subject: \"\",\n        rate: 0,\n        isDefault: false,\n        isActive: true,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutor-rates\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({ title: \"Unauthorized\", description: \"You are logged out. Logging in again...\", variant: \"destructive\" });\n        setTimeout(() => { window.location.href = \"/api/login\"; }, 500);\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to create tutor rate. Please try again.\", variant: \"destructive\" });\n    },\n  });\n\n  // Update tutor rate mutation\n  const updateTutorRateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof tutorRateFormData }) => {\n      const payload = {\n        ...data,\n        rate: data.rate.toString(),\n      };\n      const response = await apiRequest(\"PATCH\", `/api/tutor-rates/${id}`, payload);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Tutor rate updated successfully!\" });\n      setIsEditTutorRateOpen(false);\n      setEditingTutorRate(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutor-rates\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({ title: \"Unauthorized\", description: \"You are logged out. Logging in again...\", variant: \"destructive\" });\n        setTimeout(() => { window.location.href = \"/api/login\"; }, 500);\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to update tutor rate. Please try again.\", variant: \"destructive\" });\n    },\n  });\n\n  // Delete tutor rate mutation\n  const deleteTutorRateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/tutor-rates/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Tutor rate deleted successfully!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tutor-rates\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-links\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({ title: \"Unauthorized\", description: \"You are logged out. Logging in again...\", variant: \"destructive\" });\n        setTimeout(() => { window.location.href = \"/api/login\"; }, 500);\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to delete tutor rate. Please try again.\", variant: \"destructive\" });\n    },\n  });\n\n  // Create parent rate mutation\n  const createParentRateMutation = useMutation({\n    mutationFn: async (data: typeof parentRateFormData) => {\n      const payload = {\n        ...data,\n        rate: data.rate.toString(),\n      };\n      const response = await apiRequest(\"POST\", \"/api/parent-rates\", payload);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Parent rate created successfully!\",\n      });\n      setIsAddParentRateOpen(false);\n      setParentRateFormData({\n        name: \"\",\n        description: \"\",\n        classType: \"individual\",\n        subject: \"\",\n        rate: 0,\n        isDefault: false,\n        isActive: true,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/parent-rates\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({ title: \"Unauthorized\", description: \"You are logged out. Logging in again...\", variant: \"destructive\" });\n        setTimeout(() => { window.location.href = \"/api/login\"; }, 500);\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to create parent rate. Please try again.\", variant: \"destructive\" });\n    },\n  });\n\n  // Update parent rate mutation\n  const updateParentRateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof parentRateFormData }) => {\n      const payload = {\n        ...data,\n        rate: data.rate.toString(),\n      };\n      const response = await apiRequest(\"PATCH\", `/api/parent-rates/${id}`, payload);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Parent rate updated successfully!\" });\n      setIsEditParentRateOpen(false);\n      setEditingParentRate(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/parent-rates\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({ title: \"Unauthorized\", description: \"You are logged out. Logging in again...\", variant: \"destructive\" });\n        setTimeout(() => { window.location.href = \"/api/login\"; }, 500);\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to update parent rate. Please try again.\", variant: \"destructive\" });\n    },\n  });\n\n  // Delete parent rate mutation\n  const deleteParentRateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/parent-rates/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Parent rate deleted successfully!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/parent-rates\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-links\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({ title: \"Unauthorized\", description: \"You are logged out. Logging in again...\", variant: \"destructive\" });\n        setTimeout(() => { window.location.href = \"/api/login\"; }, 500);\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to delete parent rate. Please try again.\", variant: \"destructive\" });\n    },\n  });\n\n  // Create rate link mutation\n  const createRateLinkMutation = useMutation({\n    mutationFn: async ({ tutorRateId, parentRateId }: { tutorRateId: string; parentRateId: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/rate-links\", { tutorRateId, parentRateId });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Rates linked successfully!\" });\n      setIsLinkRateOpen(false);\n      setLinkingTutorRateId(\"\");\n      setLinkingParentRateId(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-links\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({ title: \"Unauthorized\", description: \"You are logged out. Logging in again...\", variant: \"destructive\" });\n        setTimeout(() => { window.location.href = \"/api/login\"; }, 500);\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to link rates. Please try again.\", variant: \"destructive\" });\n    },\n  });\n\n  // Delete rate link mutation\n  const deleteRateLinkMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/rate-links/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Rate link removed successfully!\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/rate-links\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({ title: \"Unauthorized\", description: \"You are logged out. Logging in again...\", variant: \"destructive\" });\n        setTimeout(() => { window.location.href = \"/api/login\"; }, 500);\n        return;\n      }\n      toast({ title: \"Error\", description: \"Failed to remove rate link. Please try again.\", variant: \"destructive\" });\n    },\n  });\n\n  // Open edit waitlist dialog\n  const openEditWaitlistDialog = (entry: WaitlistEntry) => {\n    setEditingWaitlist(entry);\n    setEditWaitlistData({\n      studentName: entry.studentName,\n      parentName: entry.parentName || \"\",\n      parentEmail: entry.parentEmail || \"\",\n      parentPhone: entry.parentPhone || \"\",\n      subject: entry.subject || \"\",\n      notes: entry.notes || \"\",\n      depositPaid: entry.depositPaid || false,\n      depositAmount: entry.depositAmount ? String(entry.depositAmount) : \"\",\n      status: entry.status as \"new\" | \"contacted\" | \"scheduled\" | \"converted\" | \"declined\",\n    });\n    setIsEditWaitlistOpen(true);\n  };\n\n  // Handle save waitlist updates\n  const handleSaveWaitlist = () => {\n    if (!editingWaitlist) return;\n    const updates = {\n      ...editWaitlistData,\n      depositAmount: editWaitlistData.depositAmount === \"\" ? null : editWaitlistData.depositAmount,\n    };\n    updateWaitlistMutation.mutate({\n      id: editingWaitlist.id,\n      updates,\n    });\n  };\n\n  // Get waitlist status badge variant\n  const getWaitlistStatusBadge = (status: string) => {\n    switch (status) {\n      case \"new\":\n        return <Badge className=\"bg-blue-500 hover:bg-blue-600\">{status}</Badge>;\n      case \"contacted\":\n        return <Badge className=\"bg-yellow-500 hover:bg-yellow-600 text-black\">{status}</Badge>;\n      case \"scheduled\":\n        return <Badge className=\"bg-purple-500 hover:bg-purple-600\">{status}</Badge>;\n      case \"converted\":\n        return <Badge className=\"bg-green-500 hover:bg-green-600\">{status}</Badge>;\n      case \"declined\":\n        return <Badge className=\"bg-red-500 hover:bg-red-600\">{status}</Badge>;\n      default:\n        return <Badge>{status}</Badge>;\n    }\n  };\n\n  // Derived data for ex-students and ex-tutors\n  const exStudents = allStudents.filter((s: StudentWithTutor) => !s.isActive);\n  const exTutors = allTutors.filter((t: User) => !t.isActive);\n\n  // Approve timesheet mutation\n  const approveTimesheetMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/timesheets/${id}/status`, {\n        status: \"approved\",\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Timesheet approved successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to approve timesheet. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Reject timesheet mutation\n  const rejectTimesheetMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/timesheets/${id}/status`, {\n        status: \"rejected\",\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Timesheet rejected successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to reject timesheet. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Approve weekly timesheet mutation\n  const approveWeeklyTimesheetMutation = useMutation({\n    mutationFn: async ({ id, notes }: { id: string; notes?: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/weekly-timesheets/${id}/review`, {\n        status: \"approved\",\n        notes,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Weekly timesheet approved!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/submitted\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to approve weekly timesheet. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Reject weekly timesheet mutation\n  const rejectWeeklyTimesheetMutation = useMutation({\n    mutationFn: async ({ id, notes }: { id: string; notes?: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/weekly-timesheets/${id}/review`, {\n        status: \"rejected\",\n        notes,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Weekly timesheet rejected!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/submitted\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to reject weekly timesheet. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateTimesheetEntryMutation = useMutation({\n    mutationFn: async ({ id, tutorEarnings, parentBilling, duration }: { id: string; tutorEarnings: number; parentBilling: number; duration: number }) => {\n      const response = await apiRequest(\"PATCH\", `/api/timesheet-entries/${id}`, {\n        tutorEarnings,\n        parentBilling,\n        duration,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Session entry updated!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/submitted\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets\"] });\n      setEditEntryDialogOpen(false);\n      setEditingEntry(null);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update session entry. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Parent invoice mutations\n  const updateParentInvoiceMutation = useMutation({\n    mutationFn: async ({ id, amount, sessionsIncluded, status, notes }: { id: string; amount: string; sessionsIncluded: number; status: string; notes: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/invoices/${id}`, {\n        amount,\n        sessionsIncluded,\n        status,\n        notes,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Parent invoice updated!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/invoices\"] });\n      setIsEditParentInvoiceOpen(false);\n      setEditingParentInvoice(null);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update invoice. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Create adhoc invoice mutation\n  const createAdhocInvoiceMutation = useMutation({\n    mutationFn: async (data: { parentFirstName: string; parentSurname: string; amount: string; reason: string; dueDate?: string; status: string; notes?: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/adhoc-invoices\", {\n        parentFirstName: data.parentFirstName,\n        parentSurname: data.parentSurname,\n        amount: data.amount,\n        reason: data.reason,\n        dueDate: data.dueDate ? new Date(data.dueDate) : undefined,\n        status: data.status,\n        notes: data.notes,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Adhoc invoice created!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/adhoc-invoices\"] });\n      setIsCreateAdhocInvoiceOpen(false);\n      setAdhocInvoiceFormData({\n        parentFirstName: \"\",\n        parentSurname: \"\",\n        amount: \"\",\n        reason: \"\",\n        dueDate: \"\",\n        status: \"draft\",\n        notes: \"\",\n      });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to create adhoc invoice. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update adhoc invoice mutation\n  const updateAdhocInvoiceMutation = useMutation({\n    mutationFn: async (data: { id: string; parentFirstName?: string; parentSurname?: string; amount?: string; reason?: string; dueDate?: string | null; status?: string; paidAt?: string | null; notes?: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/adhoc-invoices/${data.id}`, {\n        parentFirstName: data.parentFirstName,\n        parentSurname: data.parentSurname,\n        amount: data.amount,\n        reason: data.reason,\n        dueDate: data.dueDate,\n        status: data.status,\n        paidAt: data.paidAt,\n        notes: data.notes,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Invoice updated!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/adhoc-invoices\"] });\n      setIsEditAdhocInvoiceOpen(false);\n      setEditingAdhocInvoice(null);\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update invoice. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Handle unauthorized error\n  useEffect(() => {\n    if (studentsError && isUnauthorizedError(studentsError)) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [studentsError, toast]);\n\n  const onSubmitStudent = (data: StudentFormData) => {\n    createStudentMutation.mutate(data);\n  };\n\n  const onSubmitTutor = (data: TutorFormData) => {\n    createTutorMutation.mutate(data);\n  };\n\n  // Calculate low balance students (including those needing invoices)\n  const lowBalanceStudents = students.filter((student) => \n    student.sessionsRemaining <= 5\n  );\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Admin Stats Overview */}\n      <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-3 sm:gap-4\">\n        <Card data-testid=\"card-total-revenue\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Total Revenue</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-total-revenue\">\n                  ${stats?.totalRevenue?.toFixed(2) || \"0.00\"}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-chart-2/10 rounded-full flex items-center justify-center\">\n                <TrendingUp className=\"h-6 w-6 text-chart-2\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-active-students-admin\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Active Students</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-active-students-admin\">\n                  {stats?.activeStudents || 0}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center\">\n                <GraduationCap className=\"h-6 w-6 text-primary\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-active-tutors\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Active Tutors</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-active-tutors\">\n                  {stats?.activeTutors || 0}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-chart-1/10 rounded-full flex items-center justify-center\">\n                <Users className=\"h-6 w-6 text-chart-1\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-low-balance-alerts\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Low Balance Alerts</p>\n                <p className=\"text-2xl font-bold text-destructive\" data-testid=\"text-low-balance-alerts\">\n                  {stats?.lowBalanceAlerts || 0}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-destructive/10 rounded-full flex items-center justify-center\">\n                <AlertTriangle className=\"h-6 w-6 text-destructive\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-weekly-outgoings\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Weekly Outgoings</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-weekly-outgoings\">\n                  Â£{(stats?.weeklyOutgoings || 0).toFixed(2)}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-orange-500/10 rounded-full flex items-center justify-center\">\n                <HandHeart className=\"h-6 w-6 text-orange-500\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-total-expenditure\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Total Expenditure</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-total-expenditure\">\n                  Â£{(stats?.totalExpenditure || 0).toFixed(2)}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center\">\n                <DollarSign className=\"h-6 w-6 text-red-500\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-monthly-income\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Monthly Income</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-monthly-income\">\n                  Â£{(stats?.monthlyIncome || 0).toFixed(2)}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-emerald-500/10 rounded-full flex items-center justify-center\">\n                <PieChart className=\"h-6 w-6 text-emerald-500\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Admin Tabs */}\n      <Card>\n        <Tabs defaultValue=\"students\" className=\"w-full\">\n          <div className=\"border-b border-border\">\n            <TabsList className=\"grid w-full grid-cols-4 sm:grid-cols-10\">\n              <TabsTrigger value=\"students\" data-testid=\"tab-students\" className=\"text-xs sm:text-sm\">\n                <GraduationCap className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Students</span>\n                <span className=\"sm:hidden\">Students</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"waitlist\" data-testid=\"tab-waitlist\" className=\"text-xs sm:text-sm\">\n                <UserPlus className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Waitlist</span>\n                <span className=\"sm:hidden\">Waitlist</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"tutors\" data-testid=\"tab-tutors\" className=\"text-xs sm:text-sm\">\n                <Users className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Staff</span>\n                <span className=\"sm:hidden\">Staff</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"sessions\" data-testid=\"tab-sessions\" className=\"text-xs sm:text-sm\">\n                <Calendar className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Sessions</span>\n                <span className=\"sm:hidden\">Sessions</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"rates\" data-testid=\"tab-rates\" className=\"text-xs sm:text-sm\">\n                <DollarSign className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Rates</span>\n                <span className=\"sm:hidden\">Rates</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"weekly-timesheets\" data-testid=\"tab-weekly-timesheets\" className=\"text-xs sm:text-sm\">\n                <FileText className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Weekly</span>\n                <span className=\"sm:hidden\">Weekly</span>\n                {submittedWeeklyTimesheets.length > 0 && (\n                  <Badge variant=\"destructive\" className=\"ml-1 text-xs px-1\">\n                    {submittedWeeklyTimesheets.length}\n                  </Badge>\n                )}\n              </TabsTrigger>\n              <TabsTrigger value=\"timesheets\" data-testid=\"tab-timesheets\" className=\"text-xs sm:text-sm\">\n                <ClipboardList className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Legacy</span>\n                <span className=\"sm:hidden\">Legacy</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"invoices\" data-testid=\"tab-invoices\" className=\"text-xs sm:text-sm\">\n                <File className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Invoices</span>\n                <span className=\"sm:hidden\">Invoices</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"archive\" data-testid=\"tab-archive\" className=\"text-xs sm:text-sm\">\n                <Archive className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Archive</span>\n                <span className=\"sm:hidden\">Archive</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"feedback\" data-testid=\"tab-feedback\" className=\"text-xs sm:text-sm\">\n                <MessageSquare className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Feedback</span>\n                <span className=\"sm:hidden\">Feedback</span>\n                {parentMessages.filter(m => !m.isRead).length > 0 && (\n                  <Badge variant=\"destructive\" className=\"ml-1 text-xs px-1\">\n                    {parentMessages.filter(m => !m.isRead).length}\n                  </Badge>\n                )}\n              </TabsTrigger>\n            </TabsList>\n          </div>\n\n          {/* Students & Sessions Tab */}\n          <TabsContent value=\"students\" className=\"p-4 sm:p-6\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6\">\n              <h3 className=\"text-lg font-semibold\">Students & Session Management</h3>\n              <Dialog open={isAddStudentOpen} onOpenChange={setIsAddStudentOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-add-student\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Student\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n                  <DialogHeader>\n                    <DialogTitle>Add New Student</DialogTitle>\n                  </DialogHeader>\n                  <Form {...studentForm}>\n                    <form onSubmit={studentForm.handleSubmit(onSubmitStudent)} className=\"space-y-4\">\n                      <FormField\n                        control={studentForm.control}\n                        name=\"name\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Student Name</FormLabel>\n                            <FormControl>\n                              <Input {...field} data-testid=\"input-student-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"parentName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Parent First Name</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Optional\" data-testid=\"input-parent-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"parentSurname\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Parent Surname</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Optional\" data-testid=\"input-parent-surname\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"parentEmail\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Parent Email</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"email\" placeholder=\"Optional\" data-testid=\"input-parent-email\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"parentPhone\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Parent Phone</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Optional\" data-testid=\"input-parent-phone\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"subject\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Subject</FormLabel>\n                            <FormControl>\n                              <Input {...field} data-testid=\"input-subject\" placeholder=\"e.g., Maths, English, Science\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"examType\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Exam Type</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-exam-type\">\n                                  <SelectValue placeholder=\"Select exam type...\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"11+\">11+</SelectItem>\n                                <SelectItem value=\"13+\">13+</SelectItem>\n                                <SelectItem value=\"GCSE\">GCSE</SelectItem>\n                                <SelectItem value=\"A-Level\">A-Level</SelectItem>\n                                <SelectItem value=\"SATs\">SATs</SelectItem>\n                                <SelectItem value=\"Other\">Other</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"tutorId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Tutor</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-tutor\">\n                                  <SelectValue placeholder=\"Select a tutor...\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                {tutors.map((tutor) => (\n                                  <SelectItem key={tutor.id} value={tutor.id}>\n                                    {tutor.firstName && tutor.lastName\n                                      ? `${tutor.firstName} ${tutor.lastName}`\n                                      : tutor.email}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"classType\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Class Type</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-class-type\">\n                                  <SelectValue placeholder=\"Select class type...\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"individual\">Individual (1-on-1)</SelectItem>\n                                <SelectItem value=\"group\">Group Class</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"sessionsBooked\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Sessions Booked</FormLabel>\n                            <Select onValueChange={(v) => field.onChange(parseInt(v))} value={field.value?.toString()}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-sessions-booked\">\n                                  <SelectValue placeholder=\"Select sessions...\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"1\">1 Session</SelectItem>\n                                <SelectItem value=\"4\">4 Sessions</SelectItem>\n                                <SelectItem value=\"6\">6 Sessions</SelectItem>\n                                <SelectItem value=\"12\">12 Sessions</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"sessionsRemaining\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Sessions Remaining</FormLabel>\n                            <FormControl>\n                              <Input type=\"number\" min=\"0\" {...field} data-testid=\"input-sessions\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"parentRate\"\n                        render={({ field }) => {\n                          const activeRates = parentRatesData.filter(r => r.isActive);\n                          const matchingRate = activeRates.find(r => parseFloat(r.rate.toString()) === field.value);\n                          return (\n                            <FormItem>\n                              <FormLabel>Parent Rate (Â£/hour)</FormLabel>\n                              <Select \n                                onValueChange={(v) => {\n                                  const rate = activeRates.find(r => r.id === v);\n                                  if (rate) field.onChange(parseFloat(rate.rate.toString()));\n                                }} \n                                value={matchingRate?.id || \"\"}\n                              >\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-parent-rate\">\n                                    <SelectValue placeholder=\"Select parent rate...\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  {activeRates.map((rate) => (\n                                    <SelectItem key={rate.id} value={rate.id}>\n                                      {rate.name} - Â£{parseFloat(rate.rate.toString()).toFixed(2)}/hr ({rate.classType})\n                                    </SelectItem>\n                                  ))}\n                                  {activeRates.length === 0 && (\n                                    <SelectItem value=\"none\" disabled>No parent rates configured</SelectItem>\n                                  )}\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          );\n                        }}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"tutorRate\"\n                        render={({ field }) => {\n                          const activeRates = tutorRatesData.filter(r => r.isActive);\n                          const matchingRate = activeRates.find(r => parseFloat(r.rate.toString()) === field.value);\n                          return (\n                            <FormItem>\n                              <FormLabel>Tutor Rate (Â£/hour)</FormLabel>\n                              <Select \n                                onValueChange={(v) => {\n                                  const rate = activeRates.find(r => r.id === v);\n                                  if (rate) field.onChange(parseFloat(rate.rate.toString()));\n                                }} \n                                value={matchingRate?.id || \"\"}\n                              >\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-tutor-rate\">\n                                    <SelectValue placeholder=\"Select tutor rate...\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  {activeRates.map((rate) => (\n                                    <SelectItem key={rate.id} value={rate.id}>\n                                      {rate.name} - Â£{parseFloat(rate.rate.toString()).toFixed(2)}/hr ({rate.classType})\n                                    </SelectItem>\n                                  ))}\n                                  {activeRates.length === 0 && (\n                                    <SelectItem value=\"none\" disabled>No tutor rates configured</SelectItem>\n                                  )}\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          );\n                        }}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"startYear\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Year Started</FormLabel>\n                            <FormControl>\n                              <Input type=\"number\" min=\"2000\" max=\"2100\" placeholder=\"e.g. 2024\" {...field} value={field.value ?? \"\"} data-testid=\"input-start-year\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <FormField\n                          control={studentForm.control}\n                          name=\"examMonth\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Exam Month</FormLabel>\n                              <Select onValueChange={(v) => field.onChange(parseInt(v))} value={field.value?.toString() ?? \"\"}>\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-exam-month\">\n                                    <SelectValue placeholder=\"Select month...\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  {monthNames.map((month, index) => (\n                                    <SelectItem key={index + 1} value={(index + 1).toString()}>\n                                      {month}\n                                    </SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <FormField\n                          control={studentForm.control}\n                          name=\"examYear\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Exam Year</FormLabel>\n                              <FormControl>\n                                <Input type=\"number\" min=\"2000\" max=\"2100\" placeholder=\"e.g. 2025\" {...field} value={field.value ?? \"\"} data-testid=\"input-exam-year\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </div>\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"examBoard\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Exam Board</FormLabel>\n                            <FormControl>\n                              <Input placeholder=\"e.g. AQA, Edexcel, OCR\" {...field} value={field.value ?? \"\"} data-testid=\"input-exam-board\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"targetSchools\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Target Schools</FormLabel>\n                            <FormControl>\n                              <Input placeholder=\"e.g. Eton, Westminster, St Paul's\" {...field} value={field.value ?? \"\"} data-testid=\"input-target-schools\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={studentForm.control}\n                        name=\"primarySchool\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Primary School</FormLabel>\n                            <FormControl>\n                              <Input placeholder=\"Current primary school\" {...field} value={field.value ?? \"\"} data-testid=\"input-primary-school\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <Button\n                        type=\"submit\"\n                        className=\"w-full\"\n                        disabled={createStudentMutation.isPending}\n                        data-testid=\"button-save-student\"\n                      >\n                        {createStudentMutation.isPending ? (\n                          <div className=\"flex items-center\">\n                            <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2\"></div>\n                            Creating...\n                          </div>\n                        ) : (\n                          <>\n                            <Save className=\"w-4 h-4 mr-2\" />\n                            Create Student\n                          </>\n                        )}\n                      </Button>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <div className=\"overflow-x-auto mobile-scroll\">\n              <Table className=\"min-w-[800px]\">\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-10\"></TableHead>\n                    <TableHead>Student Name</TableHead>\n                    <TableHead>Parent First Name</TableHead>\n                    <TableHead>Parent Surname</TableHead>\n                    <TableHead>Tutor</TableHead>\n                    <TableHead className=\"text-center\">Sessions Remaining</TableHead>\n                    <TableHead className=\"text-center\">Outstanding Invoices</TableHead>\n                    <TableHead className=\"text-center\">Unpaid Sessions</TableHead>\n                    <TableHead className=\"text-right\">Parent Rate</TableHead>\n                    <TableHead className=\"text-center\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {studentsLoading ? (\n                    [...Array(5)].map((_, i) => (\n                      <TableRow key={i}>\n                        <TableCell><Skeleton className=\"h-4 w-4\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-24\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                      </TableRow>\n                    ))\n                  ) : students.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={10} className=\"text-center py-8 text-muted-foreground\">\n                        No students found. Add your first student to get started.\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    students.map((student) => {\n                      const isExpanded = expandedStudents.has(student.id);\n                      const parentFirstName = student.parentName || \"-\";\n                      const parentSurname = (student as any).parentSurname || \"-\";\n                      \n                      return (\n                        <Fragment key={student.id}>\n                          <TableRow \n                            data-testid={`row-student-${student.id}`}\n                            className=\"cursor-pointer hover:bg-muted/50\"\n                            onClick={() => toggleStudentExpand(student.id)}\n                          >\n                            <TableCell className=\"w-10\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-6 w-6 p-0\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  toggleStudentExpand(student.id);\n                                }}\n                                data-testid={`button-expand-student-${student.id}`}\n                              >\n                                {isExpanded ? (\n                                  <ChevronDown className=\"h-4 w-4\" />\n                                ) : (\n                                  <ChevronRight className=\"h-4 w-4\" />\n                                )}\n                              </Button>\n                            </TableCell>\n                            <TableCell className=\"font-medium\">{student.name}</TableCell>\n                            <TableCell>{parentFirstName}</TableCell>\n                            <TableCell>{parentSurname}</TableCell>\n                            <TableCell>\n                              {student.tutor.firstName && student.tutor.lastName\n                                ? `${student.tutor.firstName} ${student.tutor.lastName}`\n                                : student.tutor.email}\n                            </TableCell>\n                            <TableCell className=\"text-center\">\n                              <Badge\n                                variant={student.sessionsRemaining <= 0 ? \"destructive\" : (student.sessionsRemaining <= 5 ? \"secondary\" : \"default\")}\n                                className=\"font-medium\"\n                              >\n                                {student.sessionsRemaining <= 0 ? (\n                                  \"Send Invoice\"\n                                ) : (\n                                  <>\n                                    {student.sessionsRemaining}\n                                    {student.sessionsRemaining <= 5 && (\n                                      <AlertTriangle className=\"w-3 h-3 ml-1\" />\n                                    )}\n                                  </>\n                                )}\n                              </Badge>\n                            </TableCell>\n                            <TableCell className=\"text-center\">\n                              {(() => {\n                                const summary = invoiceSummaryMap.get(student.id);\n                                const count = summary?.outstandingInvoices || 0;\n                                return count > 0 ? (\n                                  <Badge variant=\"destructive\" className=\"font-medium\" data-testid={`badge-outstanding-invoices-${student.id}`}>\n                                    {count} <AlertTriangle className=\"w-3 h-3 ml-1\" />\n                                  </Badge>\n                                ) : (\n                                  <Badge variant=\"outline\" className=\"font-medium text-green-600\" data-testid={`badge-no-outstanding-invoices-${student.id}`}>\n                                    0\n                                  </Badge>\n                                );\n                              })()}\n                            </TableCell>\n                            <TableCell className=\"text-center\">\n                              {(() => {\n                                const summary = invoiceSummaryMap.get(student.id);\n                                const count = summary?.unpaidSessions || 0;\n                                return count > 0 ? (\n                                  <Badge variant=\"secondary\" className=\"font-medium\" data-testid={`badge-unpaid-sessions-${student.id}`}>\n                                    {count}\n                                  </Badge>\n                                ) : (\n                                  <span className=\"text-muted-foreground\" data-testid={`text-no-unpaid-sessions-${student.id}`}>0</span>\n                                );\n                              })()}\n                            </TableCell>\n                            <TableCell className=\"text-right\">\n                              ${parseFloat(student.parentRate.toString()).toFixed(2)}/hr\n                            </TableCell>\n                            <TableCell className=\"text-center\">\n                              <div className=\"flex justify-center space-x-1\" onClick={(e) => e.stopPropagation()}>\n                                <Button \n                                  variant=\"ghost\" \n                                  size=\"sm\" \n                                  onClick={() => openEditDialog(student)}\n                                  data-testid={`button-edit-student-${student.id}`}\n                                >\n                                  <Edit className=\"w-4 h-4\" />\n                                </Button>\n                                <Button \n                                  variant=\"ghost\" \n                                  size=\"sm\"\n                                  onClick={() => archiveStudentMutation.mutate(student.id)}\n                                  disabled={archiveStudentMutation.isPending}\n                                  data-testid={`button-archive-student-${student.id}`}\n                                  title=\"Archive student\"\n                                >\n                                  <Archive className=\"w-4 h-4 text-muted-foreground\" />\n                                </Button>\n                              </div>\n                            </TableCell>\n                          </TableRow>\n                          {isExpanded && (\n                            <TableRow key={`${student.id}-details`} className=\"bg-muted/30\">\n                              <TableCell colSpan={10} className=\"py-4\">\n                                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Subject:</span>\n                                    <p className=\"mt-1\">{student.subject}</p>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Exam Type:</span>\n                                    <p className=\"mt-1\">{(student as any).examType || \"-\"}</p>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Class Type:</span>\n                                    <p className=\"mt-1 capitalize\">{student.classType}</p>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Parent Email:</span>\n                                    <p className=\"mt-1\">{student.parentEmail || \"-\"}</p>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Parent Phone:</span>\n                                    <p className=\"mt-1\">{student.parentPhone || \"-\"}</p>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Sessions Booked:</span>\n                                    <p className=\"mt-1\">{student.sessionsBooked}</p>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Tutor Rate:</span>\n                                    <p className=\"mt-1\">${parseFloat(student.tutorRate.toString()).toFixed(2)}/hr</p>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Year Started:</span>\n                                    <p className=\"mt-1\">{student.startYear || \"-\"}</p>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-muted-foreground\">Exam Date:</span>\n                                    <p className=\"mt-1\">\n                                      {student.examMonth && student.examYear\n                                        ? `${monthNames[student.examMonth - 1]} ${student.examYear}`\n                                        : \"-\"}\n                                    </p>\n                                  </div>\n                                </div>\n                                <div className=\"mt-4 flex gap-2\">\n                                  <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      openTopicsDialog(student);\n                                    }}\n                                    data-testid={`button-manage-topics-${student.id}`}\n                                  >\n                                    <BookOpen className=\"w-4 h-4 mr-2\" />\n                                    Manage Topics\n                                  </Button>\n                                </div>\n                              </TableCell>\n                            </TableRow>\n                          )}\n                        </Fragment>\n                      );\n                    })\n                  )}\n                </TableBody>\n              </Table>\n            </div>\n\n            {/* Topics Management Dialog */}\n            <Dialog open={isTopicsDialogOpen} onOpenChange={setIsTopicsDialogOpen}>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center gap-2\">\n                    <BookOpen className=\"w-5 h-5\" />\n                    Topics for {selectedStudentForTopics?.name}\n                  </DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-6\">\n                  {/* Bulk Import Section */}\n                  <div className=\"space-y-3\">\n                    <h4 className=\"font-medium text-sm\">Import Topics</h4>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Enter one topic per line. This will replace all existing topics.\n                    </p>\n                    <Textarea\n                      placeholder=\"Topic 1&#10;Topic 2&#10;Topic 3...\"\n                      value={bulkTopicsText}\n                      onChange={(e) => setBulkTopicsText(e.target.value)}\n                      className=\"min-h-[100px]\"\n                      data-testid=\"textarea-bulk-topics\"\n                    />\n                    <Button\n                      onClick={handleBulkImport}\n                      disabled={!bulkTopicsText.trim() || importTopicsMutation.isPending}\n                      data-testid=\"button-import-topics\"\n                    >\n                      {importTopicsMutation.isPending ? \"Importing...\" : \"Import Topics\"}\n                    </Button>\n                  </div>\n\n                  {/* Existing Topics List */}\n                  <div className=\"space-y-3\">\n                    <h4 className=\"font-medium text-sm\">\n                      Existing Topics ({studentTopics.length})\n                    </h4>\n                    {topicsLoading ? (\n                      <div className=\"space-y-2\">\n                        <Skeleton className=\"h-10 w-full\" />\n                        <Skeleton className=\"h-10 w-full\" />\n                        <Skeleton className=\"h-10 w-full\" />\n                      </div>\n                    ) : studentTopics.length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground\">No topics added yet.</p>\n                    ) : (\n                      <div className=\"space-y-2\">\n                        {studentTopics.map((topic, index) => (\n                          <div\n                            key={topic.id}\n                            className=\"flex items-center gap-3 p-3 bg-muted/30 rounded-lg\"\n                            data-testid={`topic-item-${topic.id}`}\n                          >\n                            <span className=\"text-muted-foreground text-sm w-6\">\n                              {index + 1}.\n                            </span>\n                            {editingTopicId === topic.id ? (\n                              <>\n                                <Input\n                                  value={editingTopicTitle}\n                                  onChange={(e) => setEditingTopicTitle(e.target.value)}\n                                  className=\"flex-1\"\n                                  data-testid={`input-edit-topic-${topic.id}`}\n                                />\n                                <Button\n                                  size=\"sm\"\n                                  onClick={() => updateTopicMutation.mutate({ topicId: topic.id, title: editingTopicTitle })}\n                                  disabled={updateTopicMutation.isPending}\n                                  data-testid={`button-save-topic-${topic.id}`}\n                                >\n                                  <Save className=\"w-4 h-4\" />\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  onClick={() => {\n                                    setEditingTopicId(null);\n                                    setEditingTopicTitle(\"\");\n                                  }}\n                                  data-testid={`button-cancel-topic-${topic.id}`}\n                                >\n                                  <X className=\"w-4 h-4\" />\n                                </Button>\n                              </>\n                            ) : (\n                              <>\n                                <span className=\"flex-1\">{topic.title}</span>\n                                {topic.isCovered && (\n                                  <Badge variant=\"default\" className=\"flex items-center gap-1\">\n                                    <Check className=\"w-3 h-3\" />\n                                    Covered\n                                  </Badge>\n                                )}\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  onClick={() => {\n                                    setEditingTopicId(topic.id);\n                                    setEditingTopicTitle(topic.title);\n                                  }}\n                                  data-testid={`button-edit-topic-${topic.id}`}\n                                >\n                                  <Edit className=\"w-4 h-4\" />\n                                </Button>\n                              </>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </DialogContent>\n            </Dialog>\n\n            {/* Edit Student Dialog */}\n            <Dialog open={isEditStudentOpen} onOpenChange={setIsEditStudentOpen}>\n              <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Edit Student</DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Student Name</label>\n                      <Input\n                        value={editStudentData.name}\n                        onChange={(e) => setEditStudentData({...editStudentData, name: e.target.value})}\n                        data-testid=\"input-edit-student-name\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Subject</label>\n                      <Input\n                        value={editStudentData.subject}\n                        onChange={(e) => setEditStudentData({...editStudentData, subject: e.target.value})}\n                        data-testid=\"input-edit-subject\"\n                        placeholder=\"e.g., Maths, English, Science\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Exam Type</label>\n                      <Select \n                        value={editStudentData.examType || \"\"} \n                        onValueChange={(value) => setEditStudentData({...editStudentData, examType: value})}\n                      >\n                        <SelectTrigger data-testid=\"select-edit-exam-type\">\n                          <SelectValue placeholder=\"Select exam type...\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"11+\">11+</SelectItem>\n                          <SelectItem value=\"13+\">13+</SelectItem>\n                          <SelectItem value=\"GCSE\">GCSE</SelectItem>\n                          <SelectItem value=\"A-Level\">A-Level</SelectItem>\n                          <SelectItem value=\"SATs\">SATs</SelectItem>\n                          <SelectItem value=\"Other\">Other</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Parent First Name</label>\n                      <Input\n                        value={editStudentData.parentName}\n                        onChange={(e) => setEditStudentData({...editStudentData, parentName: e.target.value})}\n                        data-testid=\"input-edit-parent-name\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Parent Surname</label>\n                      <Input\n                        value={editStudentData.parentSurname}\n                        onChange={(e) => setEditStudentData({...editStudentData, parentSurname: e.target.value})}\n                        data-testid=\"input-edit-parent-surname\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Parent Email</label>\n                      <Input\n                        type=\"email\"\n                        value={editStudentData.parentEmail}\n                        onChange={(e) => setEditStudentData({...editStudentData, parentEmail: e.target.value})}\n                        data-testid=\"input-edit-parent-email\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Parent Phone</label>\n                      <Input\n                        value={editStudentData.parentPhone}\n                        onChange={(e) => setEditStudentData({...editStudentData, parentPhone: e.target.value})}\n                        data-testid=\"input-edit-parent-phone\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Tutor</label>\n                      <Select \n                        value={editStudentData.tutorId} \n                        onValueChange={(value) => setEditStudentData({...editStudentData, tutorId: value})}\n                      >\n                        <SelectTrigger data-testid=\"select-edit-tutor\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {tutors.map((tutor) => (\n                            <SelectItem key={tutor.id} value={tutor.id}>\n                              {tutor.firstName && tutor.lastName\n                                ? `${tutor.firstName} ${tutor.lastName}`\n                                : tutor.email}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Class Type</label>\n                      <Select \n                        value={editStudentData.classType} \n                        onValueChange={(value: \"individual\" | \"group\") => setEditStudentData({...editStudentData, classType: value})}\n                      >\n                        <SelectTrigger data-testid=\"select-edit-class-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"individual\">Individual</SelectItem>\n                          <SelectItem value=\"group\">Group</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Sessions Booked</label>\n                      <Select \n                        value={editStudentData.sessionsBooked.toString()} \n                        onValueChange={(value) => setEditStudentData({...editStudentData, sessionsBooked: parseInt(value)})}\n                      >\n                        <SelectTrigger data-testid=\"select-edit-sessions-booked\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"1\">1 Session</SelectItem>\n                          <SelectItem value=\"4\">4 Sessions</SelectItem>\n                          <SelectItem value=\"6\">6 Sessions</SelectItem>\n                          <SelectItem value=\"12\">12 Sessions</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Sessions Remaining</label>\n                      <Input\n                        type=\"number\"\n                        min=\"0\"\n                        value={editStudentData.sessionsRemaining}\n                        onChange={(e) => setEditStudentData({...editStudentData, sessionsRemaining: parseInt(e.target.value) || 0})}\n                        data-testid=\"input-edit-sessions-remaining\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Parent Rate (Â£/hr)</label>\n                      {(() => {\n                        const activeRates = parentRatesData.filter(r => r.isActive);\n                        const matchingRate = activeRates.find(r => parseFloat(r.rate.toString()) === editStudentData.parentRate);\n                        const hasCustomRate = editStudentData.parentRate > 0 && !matchingRate;\n                        return (\n                          <Select \n                            value={matchingRate?.id || (hasCustomRate ? \"custom\" : \"\")} \n                            onValueChange={(value) => {\n                              if (value === \"custom\") return;\n                              const rate = activeRates.find(r => r.id === value);\n                              if (rate) setEditStudentData({...editStudentData, parentRate: parseFloat(rate.rate.toString())});\n                            }}\n                          >\n                            <SelectTrigger data-testid=\"select-edit-parent-rate\">\n                              <SelectValue placeholder=\"Select parent rate...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {activeRates.map((rate) => (\n                                <SelectItem key={rate.id} value={rate.id}>\n                                  {rate.name} - Â£{parseFloat(rate.rate.toString()).toFixed(2)}/hr\n                                </SelectItem>\n                              ))}\n                              {hasCustomRate && (\n                                <SelectItem value=\"custom\">\n                                  Current: Â£{editStudentData.parentRate.toFixed(2)}/hr\n                                </SelectItem>\n                              )}\n                            </SelectContent>\n                          </Select>\n                        );\n                      })()}\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Tutor Rate (Â£/hr)</label>\n                      {(() => {\n                        const activeRates = tutorRatesData.filter(r => r.isActive);\n                        const matchingRate = activeRates.find(r => parseFloat(r.rate.toString()) === editStudentData.tutorRate);\n                        const hasCustomRate = editStudentData.tutorRate > 0 && !matchingRate;\n                        return (\n                          <Select \n                            value={matchingRate?.id || (hasCustomRate ? \"custom\" : \"\")} \n                            onValueChange={(value) => {\n                              if (value === \"custom\") return;\n                              const rate = activeRates.find(r => r.id === value);\n                              if (rate) setEditStudentData({...editStudentData, tutorRate: parseFloat(rate.rate.toString())});\n                            }}\n                          >\n                            <SelectTrigger data-testid=\"select-edit-tutor-rate\">\n                              <SelectValue placeholder=\"Select tutor rate...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {activeRates.map((rate) => (\n                                <SelectItem key={rate.id} value={rate.id}>\n                                  {rate.name} - Â£{parseFloat(rate.rate.toString()).toFixed(2)}/hr\n                                </SelectItem>\n                              ))}\n                              {hasCustomRate && (\n                                <SelectItem value=\"custom\">\n                                  Current: Â£{editStudentData.tutorRate.toFixed(2)}/hr\n                                </SelectItem>\n                              )}\n                            </SelectContent>\n                          </Select>\n                        );\n                      })()}\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Year Started</label>\n                      <Input\n                        type=\"number\"\n                        min=\"2000\"\n                        max=\"2100\"\n                        placeholder=\"e.g. 2024\"\n                        value={editStudentData.startYear ?? \"\"}\n                        onChange={(e) => setEditStudentData({...editStudentData, startYear: e.target.value ? parseInt(e.target.value) : undefined})}\n                        data-testid=\"input-edit-start-year\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Year Finished</label>\n                      <Input\n                        type=\"number\"\n                        min=\"2000\"\n                        max=\"2100\"\n                        placeholder=\"e.g. 2025\"\n                        value={editStudentData.endYear ?? \"\"}\n                        onChange={(e) => setEditStudentData({...editStudentData, endYear: e.target.value ? parseInt(e.target.value) : undefined})}\n                        data-testid=\"input-edit-end-year\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Exam Month</label>\n                      <Select \n                        value={editStudentData.examMonth?.toString() ?? \"\"} \n                        onValueChange={(value) => setEditStudentData({...editStudentData, examMonth: value ? parseInt(value) : undefined})}\n                      >\n                        <SelectTrigger data-testid=\"select-edit-exam-month\">\n                          <SelectValue placeholder=\"Select month...\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {monthNames.map((month, index) => (\n                            <SelectItem key={index + 1} value={(index + 1).toString()}>\n                              {month}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Exam Year</label>\n                      <Input\n                        type=\"number\"\n                        min=\"2000\"\n                        max=\"2100\"\n                        placeholder=\"e.g. 2025\"\n                        value={editStudentData.examYear ?? \"\"}\n                        onChange={(e) => setEditStudentData({...editStudentData, examYear: e.target.value ? parseInt(e.target.value) : undefined})}\n                        data-testid=\"input-edit-exam-year\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Exam Board</label>\n                      <Input\n                        placeholder=\"e.g. AQA, Edexcel, OCR\"\n                        value={editStudentData.examBoard}\n                        onChange={(e) => setEditStudentData({...editStudentData, examBoard: e.target.value})}\n                        data-testid=\"input-edit-exam-board\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Target Schools</label>\n                      <Input\n                        placeholder=\"e.g. Eton, Westminster\"\n                        value={editStudentData.targetSchools}\n                        onChange={(e) => setEditStudentData({...editStudentData, targetSchools: e.target.value})}\n                        data-testid=\"input-edit-target-schools\"\n                      />\n                    </div>\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Primary School</label>\n                    <Input\n                      placeholder=\"Current primary school\"\n                      value={editStudentData.primarySchool}\n                      onChange={(e) => setEditStudentData({...editStudentData, primarySchool: e.target.value})}\n                      data-testid=\"input-edit-primary-school\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Notes</label>\n                    <textarea\n                      className=\"w-full min-h-[80px] p-3 border rounded-md text-sm\"\n                      placeholder=\"Add notes about this student...\"\n                      value={editStudentData.parentContactInfo}\n                      onChange={(e) => setEditStudentData({...editStudentData, parentContactInfo: e.target.value})}\n                      data-testid=\"input-edit-notes\"\n                    />\n                  </div>\n                  <Button\n                    onClick={handleSaveStudent}\n                    className=\"w-full\"\n                    disabled={updateStudentMutation.isPending}\n                    data-testid=\"button-save-student-edit\"\n                  >\n                    {updateStudentMutation.isPending ? (\n                      <div className=\"flex items-center\">\n                        <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2\"></div>\n                        Saving...\n                      </div>\n                    ) : (\n                      <>\n                        <Save className=\"w-4 h-4 mr-2\" />\n                        Save Changes\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n\n          </TabsContent>\n\n          {/* Waitlist Tab */}\n          <TabsContent value=\"waitlist\" className=\"p-4 sm:p-6\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6\">\n              <h3 className=\"text-lg font-semibold\">Waitlist Management</h3>\n              <Dialog open={isAddWaitlistOpen} onOpenChange={setIsAddWaitlistOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-add-waitlist\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Waitlist Entry\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n                  <DialogHeader>\n                    <DialogTitle>Add New Waitlist Entry</DialogTitle>\n                  </DialogHeader>\n                  <Form {...waitlistForm}>\n                    <form onSubmit={waitlistForm.handleSubmit((data) => createWaitlistMutation.mutate(data))} className=\"space-y-4\">\n                      <FormField\n                        control={waitlistForm.control}\n                        name=\"studentName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Student Name *</FormLabel>\n                            <FormControl>\n                              <Input {...field} data-testid=\"input-waitlist-student-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={waitlistForm.control}\n                        name=\"parentName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Parent Name</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Optional\" data-testid=\"input-waitlist-parent-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={waitlistForm.control}\n                        name=\"parentEmail\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Parent Email</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"email\" placeholder=\"Optional\" data-testid=\"input-waitlist-parent-email\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={waitlistForm.control}\n                        name=\"parentPhone\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Parent Phone</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Optional\" data-testid=\"input-waitlist-parent-phone\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={waitlistForm.control}\n                        name=\"subject\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Subject</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Optional\" data-testid=\"input-waitlist-subject\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={waitlistForm.control}\n                        name=\"notes\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Notes</FormLabel>\n                            <FormControl>\n                              <Textarea {...field} placeholder=\"Optional notes about this prospect\" data-testid=\"input-waitlist-notes\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <FormField\n                          control={waitlistForm.control}\n                          name=\"depositPaid\"\n                          render={({ field }) => (\n                            <FormItem className=\"flex flex-row items-center space-x-3 space-y-0\">\n                              <FormControl>\n                                <Checkbox\n                                  checked={field.value}\n                                  onCheckedChange={field.onChange}\n                                  data-testid=\"checkbox-waitlist-deposit-paid\"\n                                />\n                              </FormControl>\n                              <FormLabel className=\"font-normal\">Deposit Paid</FormLabel>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n\n                        <FormField\n                          control={waitlistForm.control}\n                          name=\"depositAmount\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Deposit Amount</FormLabel>\n                              <FormControl>\n                                <Input \n                                  {...field} \n                                  type=\"number\" \n                                  step=\"0.01\" \n                                  placeholder=\"0.00\"\n                                  value={field.value ?? \"\"}\n                                  onChange={(e) => field.onChange(e.target.value ? e.target.value : undefined)}\n                                  data-testid=\"input-waitlist-deposit-amount\" \n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </div>\n\n                      <FormField\n                        control={waitlistForm.control}\n                        name=\"status\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Status</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-waitlist-status\">\n                                  <SelectValue placeholder=\"Select status...\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"new\">New</SelectItem>\n                                <SelectItem value=\"contacted\">Contacted</SelectItem>\n                                <SelectItem value=\"scheduled\">Scheduled</SelectItem>\n                                <SelectItem value=\"converted\">Converted</SelectItem>\n                                <SelectItem value=\"declined\">Declined</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <Button\n                        type=\"submit\"\n                        className=\"w-full\"\n                        disabled={createWaitlistMutation.isPending}\n                        data-testid=\"button-save-waitlist\"\n                      >\n                        {createWaitlistMutation.isPending ? (\n                          <div className=\"flex items-center\">\n                            <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2\"></div>\n                            Creating...\n                          </div>\n                        ) : (\n                          <>\n                            <Save className=\"w-4 h-4 mr-2\" />\n                            Create Entry\n                          </>\n                        )}\n                      </Button>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <div className=\"overflow-x-auto mobile-scroll\">\n              <Table className=\"min-w-[900px]\">\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Student Name</TableHead>\n                    <TableHead>Parent Name</TableHead>\n                    <TableHead>Contact Info</TableHead>\n                    <TableHead>Subject</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Notes</TableHead>\n                    <TableHead className=\"text-center\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {waitlistLoading ? (\n                    [...Array(5)].map((_, i) => (\n                      <TableRow key={i}>\n                        <TableCell><Skeleton className=\"h-4 w-24\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-32\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-24\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                      </TableRow>\n                    ))\n                  ) : waitlistEntries.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={7} className=\"text-center py-8 text-muted-foreground\">\n                        No waitlist entries found. Add your first prospective student to get started.\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    waitlistEntries.map((entry) => (\n                      <TableRow key={entry.id} data-testid={`row-waitlist-${entry.id}`}>\n                        <TableCell className=\"font-medium\">{entry.studentName}</TableCell>\n                        <TableCell>{entry.parentName || \"-\"}</TableCell>\n                        <TableCell>\n                          <div className=\"flex flex-col gap-1\">\n                            {entry.parentEmail && (\n                              <span className=\"flex items-center gap-1 text-sm\">\n                                <Mail className=\"w-3 h-3\" />\n                                {entry.parentEmail}\n                              </span>\n                            )}\n                            {entry.parentPhone && (\n                              <span className=\"flex items-center gap-1 text-sm\">\n                                <Phone className=\"w-3 h-3\" />\n                                {entry.parentPhone}\n                              </span>\n                            )}\n                            {!entry.parentEmail && !entry.parentPhone && \"-\"}\n                          </div>\n                        </TableCell>\n                        <TableCell>{entry.subject || \"-\"}</TableCell>\n                        <TableCell>{getWaitlistStatusBadge(entry.status)}</TableCell>\n                        <TableCell className=\"max-w-[200px] truncate\" title={entry.notes || \"\"}>\n                          {entry.notes || \"-\"}\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <div className=\"flex justify-center space-x-1\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => openEditWaitlistDialog(entry)}\n                              data-testid={`button-edit-waitlist-${entry.id}`}\n                            >\n                              <Edit className=\"w-4 h-4\" />\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => {\n                                if (confirm(\"Are you sure you want to delete this waitlist entry?\")) {\n                                  deleteWaitlistMutation.mutate(entry.id);\n                                }\n                              }}\n                              disabled={deleteWaitlistMutation.isPending}\n                              data-testid={`button-delete-waitlist-${entry.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4 text-destructive\" />\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))\n                  )}\n                </TableBody>\n              </Table>\n            </div>\n\n            {/* Edit Waitlist Dialog */}\n            <Dialog open={isEditWaitlistOpen} onOpenChange={setIsEditWaitlistOpen}>\n              <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Edit Waitlist Entry</DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div>\n                    <label className=\"text-sm font-medium\">Student Name *</label>\n                    <Input\n                      value={editWaitlistData.studentName}\n                      onChange={(e) => setEditWaitlistData({...editWaitlistData, studentName: e.target.value})}\n                      data-testid=\"input-edit-waitlist-student-name\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Parent Name</label>\n                    <Input\n                      value={editWaitlistData.parentName}\n                      onChange={(e) => setEditWaitlistData({...editWaitlistData, parentName: e.target.value})}\n                      data-testid=\"input-edit-waitlist-parent-name\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Parent Email</label>\n                    <Input\n                      type=\"email\"\n                      value={editWaitlistData.parentEmail}\n                      onChange={(e) => setEditWaitlistData({...editWaitlistData, parentEmail: e.target.value})}\n                      data-testid=\"input-edit-waitlist-parent-email\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Parent Phone</label>\n                    <Input\n                      value={editWaitlistData.parentPhone}\n                      onChange={(e) => setEditWaitlistData({...editWaitlistData, parentPhone: e.target.value})}\n                      data-testid=\"input-edit-waitlist-parent-phone\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Subject</label>\n                    <Input\n                      value={editWaitlistData.subject}\n                      onChange={(e) => setEditWaitlistData({...editWaitlistData, subject: e.target.value})}\n                      data-testid=\"input-edit-waitlist-subject\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Notes</label>\n                    <Textarea\n                      value={editWaitlistData.notes}\n                      onChange={(e) => setEditWaitlistData({...editWaitlistData, notes: e.target.value})}\n                      data-testid=\"input-edit-waitlist-notes\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        checked={editWaitlistData.depositPaid}\n                        onCheckedChange={(checked) => setEditWaitlistData({...editWaitlistData, depositPaid: checked as boolean})}\n                        data-testid=\"checkbox-edit-waitlist-deposit-paid\"\n                      />\n                      <label className=\"text-sm font-medium\">Deposit Paid</label>\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Deposit Amount</label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        placeholder=\"0.00\"\n                        value={editWaitlistData.depositAmount}\n                        onChange={(e) => setEditWaitlistData({...editWaitlistData, depositAmount: e.target.value})}\n                        data-testid=\"input-edit-waitlist-deposit-amount\"\n                      />\n                    </div>\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Status</label>\n                    <Select\n                      value={editWaitlistData.status}\n                      onValueChange={(value: \"new\" | \"contacted\" | \"scheduled\" | \"converted\" | \"declined\") => \n                        setEditWaitlistData({...editWaitlistData, status: value})\n                      }\n                    >\n                      <SelectTrigger data-testid=\"select-edit-waitlist-status\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"new\">New</SelectItem>\n                        <SelectItem value=\"contacted\">Contacted</SelectItem>\n                        <SelectItem value=\"scheduled\">Scheduled</SelectItem>\n                        <SelectItem value=\"converted\">Converted</SelectItem>\n                        <SelectItem value=\"declined\">Declined</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <Button\n                    onClick={handleSaveWaitlist}\n                    className=\"w-full\"\n                    disabled={updateWaitlistMutation.isPending}\n                    data-testid=\"button-update-waitlist\"\n                  >\n                    {updateWaitlistMutation.isPending ? (\n                      <div className=\"flex items-center\">\n                        <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2\"></div>\n                        Saving...\n                      </div>\n                    ) : (\n                      <>\n                        <Save className=\"w-4 h-4 mr-2\" />\n                        Save Changes\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </TabsContent>\n\n          {/* Staff Management Tab */}\n          <TabsContent value=\"tutors\" className=\"p-4 sm:p-6\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6\">\n              <h3 className=\"text-lg font-semibold\">Staff Management</h3>\n              <Dialog open={isAddTutorOpen} onOpenChange={setIsAddTutorOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-add-tutor\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Staff Member\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>Add New Staff Member</DialogTitle>\n                  </DialogHeader>\n                  <Form {...tutorForm}>\n                    <form onSubmit={tutorForm.handleSubmit(onSubmitTutor)} className=\"space-y-4\">\n                      <FormField\n                        control={tutorForm.control}\n                        name=\"firstName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>First Name</FormLabel>\n                            <FormControl>\n                              <Input {...field} data-testid=\"input-tutor-first-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={tutorForm.control}\n                        name=\"lastName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Last Name</FormLabel>\n                            <FormControl>\n                              <Input {...field} data-testid=\"input-tutor-last-name\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={tutorForm.control}\n                        name=\"email\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Email Address</FormLabel>\n                            <FormControl>\n                              <Input type=\"email\" {...field} data-testid=\"input-tutor-email\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={tutorForm.control}\n                        name=\"startYear\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Year Started</FormLabel>\n                            <FormControl>\n                              <Input type=\"number\" min=\"2000\" max=\"2100\" placeholder=\"e.g. 2024\" {...field} value={field.value ?? \"\"} data-testid=\"input-tutor-start-year\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <Button\n                        type=\"submit\"\n                        className=\"w-full h-12\"\n                        disabled={createTutorMutation.isPending}\n                        data-testid=\"button-save-tutor\"\n                      >\n                        {createTutorMutation.isPending ? (\n                          <div className=\"flex items-center\">\n                            <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2\"></div>\n                            Creating...\n                          </div>\n                        ) : (\n                          <>\n                            <Save className=\"w-4 h-4 mr-2\" />\n                            Create Staff Member\n                          </>\n                        )}\n                      </Button>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n            </div>\n\n            <div className=\"overflow-x-auto mobile-scroll\">\n              <Table className=\"min-w-[700px]\">\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Name</TableHead>\n                    <TableHead>Email</TableHead>\n                    <TableHead className=\"text-center\">Role</TableHead>\n                    <TableHead className=\"text-center\">Students</TableHead>\n                    <TableHead className=\"text-center\">Active Sessions</TableHead>\n                    <TableHead className=\"text-center\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {tutors.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={6} className=\"text-center py-8 text-muted-foreground\">\n                        No staff members found. Add your first tutor to get started.\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    tutors.map((tutor) => (\n                      <TableRow key={tutor.id} data-testid={`row-tutor-${tutor.id}`}>\n                        <TableCell className=\"font-medium\">\n                          {tutor.firstName && tutor.lastName\n                            ? `${tutor.firstName} ${tutor.lastName}`\n                            : tutor.email}\n                        </TableCell>\n                        <TableCell>{tutor.email}</TableCell>\n                        <TableCell className=\"text-center\">\n                          <Select\n                            value={tutor.role}\n                            onValueChange={(value: \"admin\" | \"tutor\") => {\n                              if (tutor.id === user.id) {\n                                toast({\n                                  title: \"Cannot change own role\",\n                                  description: \"You cannot change your own role.\",\n                                  variant: \"destructive\",\n                                });\n                                return;\n                              }\n                              updateTutorRoleMutation.mutate({ tutorId: tutor.id, role: value });\n                            }}\n                            disabled={tutor.id === user.id || updateTutorRoleMutation.isPending}\n                          >\n                            <SelectTrigger \n                              className=\"w-[100px]\" \n                              data-testid={`select-role-${tutor.id}`}\n                            >\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"admin\">Admin</SelectItem>\n                              <SelectItem value=\"tutor\">Tutor</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <Badge variant=\"outline\">\n                            {students.filter(s => s.tutorId === tutor.id).length}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <Badge variant=\"default\">\n                            {students.filter(s => s.tutorId === tutor.id && s.sessionsRemaining > 0).length}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <div className=\"flex justify-center space-x-1\">\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\" \n                              onClick={() => {\n                                setViewingTutorEarnings(tutor);\n                                setIsTutorEarningsOpen(true);\n                              }}\n                              data-testid={`button-view-earnings-${tutor.id}`}\n                              title=\"View tutor's earnings\"\n                            >\n                              <Eye className=\"w-4 h-4 text-primary\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\" \n                              onClick={() => openEditStaffDialog(tutor)}\n                              data-testid={`button-edit-staff-${tutor.id}`}\n                            >\n                              <Edit className=\"w-4 h-4\" />\n                            </Button>\n                            {tutor.id !== user.id && (\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\"\n                                onClick={() => archiveTutorMutation.mutate(tutor.id)}\n                                disabled={archiveTutorMutation.isPending}\n                                data-testid={`button-archive-staff-${tutor.id}`}\n                                title=\"Archive staff member\"\n                              >\n                                <Archive className=\"w-4 h-4 text-muted-foreground\" />\n                              </Button>\n                            )}\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))\n                  )}\n                </TableBody>\n              </Table>\n            </div>\n\n            {/* View Tutor Earnings Dialog */}\n            <Dialog open={isTutorEarningsOpen} onOpenChange={setIsTutorEarningsOpen}>\n              <DialogContent className=\"max-w-2xl\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center gap-2\">\n                    <Eye className=\"w-5 h-5 text-primary\" />\n                    Tutor's Earnings View: {viewingTutorEarnings?.firstName} {viewingTutorEarnings?.lastName}\n                  </DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div className=\"p-4 bg-muted/30 rounded-lg\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Viewing what this tutor sees for the current week ({format(weekStart, \"MMM dd\")} - {format(weekEnd, \"MMM dd, yyyy\")})\n                    </p>\n                  </div>\n                  \n                  <Card>\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"text-muted-foreground text-sm\">This Week's Earnings (What Tutor Sees)</p>\n                          <p className=\"text-2xl font-bold text-foreground\">\n                            ${tutorEarningsLoading ? \"...\" : (tutorEarningsData?.earnings || 0).toFixed(2)}\n                          </p>\n                        </div>\n                        <div className=\"w-12 h-12 bg-chart-2/10 rounded-full flex items-center justify-center\">\n                          <DollarSign className=\"h-6 w-6 text-chart-2\" />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  {tutorEarningsLoading ? (\n                    <div className=\"space-y-2\">\n                      <Skeleton className=\"h-10 w-full\" />\n                      <Skeleton className=\"h-10 w-full\" />\n                    </div>\n                  ) : tutorEarningsData?.entries && tutorEarningsData.entries.length > 0 ? (\n                    <div className=\"border rounded-lg overflow-hidden\">\n                      <Table>\n                        <TableHeader>\n                          <TableRow className=\"bg-muted/50\">\n                            <TableHead>Date</TableHead>\n                            <TableHead>Student</TableHead>\n                            <TableHead>Subject</TableHead>\n                            <TableHead className=\"text-right\">Duration</TableHead>\n                            <TableHead className=\"text-right\">Tutor Rate</TableHead>\n                            <TableHead className=\"text-right\">Earnings</TableHead>\n                            <TableHead>Status</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {tutorEarningsData.entries\n                            .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                            .map((entry) => (\n                              <TableRow key={entry.id}>\n                                <TableCell className=\"font-medium\">\n                                  {format(new Date(entry.date), \"EEE, MMM dd\")}\n                                </TableCell>\n                                <TableCell>{entry.student?.name || \"Unknown\"}</TableCell>\n                                <TableCell>{entry.student?.subject || \"-\"}</TableCell>\n                                <TableCell className=\"text-right\">{entry.duration}h</TableCell>\n                                <TableCell className=\"text-right\">\n                                  ${entry.student?.tutorRate ? Number(entry.student.tutorRate).toFixed(2) : \"-\"}\n                                </TableCell>\n                                <TableCell className=\"text-right font-medium\">\n                                  ${Number(entry.tutorEarnings).toFixed(2)}\n                                </TableCell>\n                                <TableCell>\n                                  <Badge\n                                    variant={\n                                      entry.status === \"approved\"\n                                        ? \"default\"\n                                        : entry.status === \"rejected\"\n                                        ? \"destructive\"\n                                        : \"secondary\"\n                                    }\n                                  >\n                                    {entry.status}\n                                  </Badge>\n                                </TableCell>\n                              </TableRow>\n                            ))}\n                        </TableBody>\n                        <TableFooter>\n                          <TableRow>\n                            <TableCell colSpan={3} className=\"font-medium\">Total (Approved Only)</TableCell>\n                            <TableCell className=\"text-right font-medium\">\n                              {tutorEarningsData.entries\n                                .filter(e => e.status === \"approved\")\n                                .reduce((sum, e) => sum + Number(e.duration), 0)}h\n                            </TableCell>\n                            <TableCell></TableCell>\n                            <TableCell className=\"text-right font-medium\">\n                              ${tutorEarningsData.entries\n                                .filter(e => e.status === \"approved\")\n                                .reduce((sum, e) => sum + Number(e.tutorEarnings), 0).toFixed(2)}\n                            </TableCell>\n                            <TableCell></TableCell>\n                          </TableRow>\n                        </TableFooter>\n                      </Table>\n                    </div>\n                  ) : (\n                    <p className=\"text-center text-muted-foreground py-4\">\n                      No sessions recorded for this week.\n                    </p>\n                  )}\n\n                  <div className=\"text-xs text-muted-foreground space-y-1\">\n                    <p><strong>Note:</strong> Earnings shown are calculated from the tutor rate at the time each session was logged.</p>\n                    <p>Only approved sessions count towards the tutor's earnings total.</p>\n                  </div>\n                </div>\n              </DialogContent>\n            </Dialog>\n\n            {/* Edit Staff Dialog */}\n            <Dialog open={isEditStaffOpen} onOpenChange={setIsEditStaffOpen}>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Edit Staff Member</DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div>\n                    <label className=\"text-sm font-medium\">First Name</label>\n                    <Input\n                      value={editStaffData.firstName}\n                      onChange={(e) => setEditStaffData({...editStaffData, firstName: e.target.value})}\n                      data-testid=\"input-edit-staff-first-name\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Last Name</label>\n                    <Input\n                      value={editStaffData.lastName}\n                      onChange={(e) => setEditStaffData({...editStaffData, lastName: e.target.value})}\n                      data-testid=\"input-edit-staff-last-name\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Email</label>\n                    <Input\n                      type=\"email\"\n                      value={editStaffData.email}\n                      onChange={(e) => setEditStaffData({...editStaffData, email: e.target.value})}\n                      data-testid=\"input-edit-staff-email\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium\">Year Started</label>\n                      <Input\n                        type=\"number\"\n                        min=\"2000\"\n                        max=\"2100\"\n                        placeholder=\"e.g. 2024\"\n                        value={editStaffData.startYear ?? \"\"}\n                        onChange={(e) => setEditStaffData({...editStaffData, startYear: e.target.value ? parseInt(e.target.value) : undefined})}\n                        data-testid=\"input-edit-staff-start-year\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium\">Year Finished</label>\n                      <Input\n                        type=\"number\"\n                        min=\"2000\"\n                        max=\"2100\"\n                        placeholder=\"e.g. 2025\"\n                        value={editStaffData.endYear ?? \"\"}\n                        onChange={(e) => setEditStaffData({...editStaffData, endYear: e.target.value ? parseInt(e.target.value) : undefined})}\n                        data-testid=\"input-edit-staff-end-year\"\n                      />\n                    </div>\n                  </div>\n                  <Button\n                    onClick={handleSaveStaff}\n                    className=\"w-full\"\n                    disabled={updateStaffMutation.isPending}\n                    data-testid=\"button-save-staff-edit\"\n                  >\n                    {updateStaffMutation.isPending ? (\n                      <div className=\"flex items-center\">\n                        <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2\"></div>\n                        Saving...\n                      </div>\n                    ) : (\n                      <>\n                        <Save className=\"w-4 h-4 mr-2\" />\n                        Save Changes\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n\n          </TabsContent>\n\n          {/* Sessions Tab */}\n          <TabsContent value=\"sessions\" className=\"p-4 sm:p-6\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6\">\n              <h3 className=\"text-lg font-semibold\">Teaching Sessions</h3>\n              <div className=\"flex flex-wrap gap-2\">\n                {/* Time Period Filter */}\n                <Select value={sessionView} onValueChange={(v: \"week\" | \"all\") => setSessionView(v)}>\n                  <SelectTrigger className=\"w-[130px]\" data-testid=\"select-session-view\">\n                    <Calendar className=\"w-4 h-4 mr-2\" />\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"week\">This Week</SelectItem>\n                    <SelectItem value=\"all\">All Sessions</SelectItem>\n                  </SelectContent>\n                </Select>\n\n                {/* Tutor Filter */}\n                <Select value={sessionTutorFilter} onValueChange={setSessionTutorFilter}>\n                  <SelectTrigger className=\"w-[160px]\" data-testid=\"select-session-tutor-filter\">\n                    <Filter className=\"w-4 h-4 mr-2\" />\n                    <SelectValue placeholder=\"All Tutors\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Tutors</SelectItem>\n                    {tutors.map((tutor) => (\n                      <SelectItem key={tutor.id} value={tutor.id}>\n                        {tutor.firstName && tutor.lastName\n                          ? `${tutor.firstName} ${tutor.lastName}`\n                          : tutor.email || tutor.id}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                {/* Sort Order Toggle */}\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setSessionSortOrder(sessionSortOrder === \"desc\" ? \"asc\" : \"desc\")}\n                  data-testid=\"button-session-sort\"\n                  className=\"flex items-center gap-1\"\n                >\n                  {sessionSortOrder === \"desc\" ? (\n                    <>\n                      <ArrowDown className=\"w-4 h-4\" />\n                      <span className=\"hidden sm:inline\">Newest First</span>\n                    </>\n                  ) : (\n                    <>\n                      <ArrowUp className=\"w-4 h-4\" />\n                      <span className=\"hidden sm:inline\">Oldest First</span>\n                    </>\n                  )}\n                </Button>\n              </div>\n            </div>\n\n            {(() => {\n              // Filter by time period\n              let filteredSessions = sessionView === \"week\"\n                ? allSessions.filter((s: TimesheetEntryWithRelations) => {\n                    const sessionDate = new Date(s.date);\n                    return sessionDate >= weekStart && sessionDate <= weekEnd;\n                  })\n                : allSessions;\n\n              // Filter by tutor\n              if (sessionTutorFilter !== \"all\") {\n                filteredSessions = filteredSessions.filter(\n                  (s: TimesheetEntryWithRelations) => s.tutorId === sessionTutorFilter\n                );\n              }\n\n              // Sort by date\n              const sortedSessions = [...filteredSessions].sort((a, b) => {\n                const dateA = new Date(a.date).getTime();\n                const dateB = new Date(b.date).getTime();\n                return sessionSortOrder === \"desc\" ? dateB - dateA : dateA - dateB;\n              });\n\n              if (sortedSessions.length === 0) {\n                return (\n                  <Card>\n                    <CardContent className=\"text-center py-8\">\n                      <Calendar className=\"w-8 h-8 mx-auto mb-2 opacity-50 text-muted-foreground\" />\n                      <p className=\"text-muted-foreground\">\n                        {sessionView === \"week\" ? \"No sessions this week\" : \"No sessions recorded yet\"}\n                      </p>\n                    </CardContent>\n                  </Card>\n                );\n              }\n\n              return (\n                <div className=\"overflow-x-auto mobile-scroll\">\n                  <Table className=\"min-w-[800px]\">\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Tutor</TableHead>\n                        <TableHead>Student</TableHead>\n                        <TableHead>Subject</TableHead>\n                        <TableHead className=\"text-center\">Duration</TableHead>\n                        <TableHead className=\"text-center\">Status</TableHead>\n                        <TableHead>Notes</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {sortedSessions.map((session: TimesheetEntryWithRelations) => (\n                        <TableRow key={session.id} data-testid={`row-session-${session.id}`}>\n                          <TableCell className=\"font-medium\">\n                            {format(new Date(session.date), \"MMM dd, yyyy\")}\n                          </TableCell>\n                          <TableCell>\n                            {session.tutor.firstName && session.tutor.lastName\n                              ? `${session.tutor.firstName} ${session.tutor.lastName}`\n                              : session.tutor.email}\n                          </TableCell>\n                          <TableCell>{session.student.name}</TableCell>\n                          <TableCell>{session.student.subject}</TableCell>\n                          <TableCell className=\"text-center\">\n                            {parseFloat(session.duration)} hr{parseFloat(session.duration) !== 1 ? 's' : ''}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            <Badge \n                              variant={\n                                session.status === \"approved\" ? \"default\" : \n                                session.status === \"rejected\" ? \"destructive\" : \n                                \"secondary\"\n                              }\n                            >\n                              {session.status.charAt(0).toUpperCase() + session.status.slice(1)}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"max-w-[200px]\">\n                            {session.notes ? (\n                              <div className=\"flex items-start\">\n                                <FileText className=\"w-4 h-4 mr-1 mt-0.5 text-muted-foreground flex-shrink-0\" />\n                                <span className=\"text-sm text-muted-foreground truncate\" title={session.notes}>\n                                  {session.notes}\n                                </span>\n                              </div>\n                            ) : (\n                              <span className=\"text-muted-foreground text-sm\">â€”</span>\n                            )}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                    <TableFooter>\n                      <TableRow>\n                        <TableCell colSpan={4} className=\"font-medium\">\n                          Total: {sortedSessions.length} session{sortedSessions.length !== 1 ? 's' : ''}\n                        </TableCell>\n                        <TableCell className=\"text-center font-medium\">\n                          {sortedSessions.reduce((sum, s) => sum + parseFloat(s.duration), 0).toFixed(1)} hrs\n                        </TableCell>\n                        <TableCell colSpan={2}></TableCell>\n                      </TableRow>\n                    </TableFooter>\n                  </Table>\n                </div>\n              );\n            })()}\n          </TabsContent>\n\n          {/* Rate Management Tab */}\n          <TabsContent value=\"rates\" className=\"p-4 sm:p-6\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6\">\n              <div>\n                <h3 className=\"text-lg font-semibold\">Rate Management</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Tutor and parent rates are completely independent. Create, update, or delete one without affecting the other.\n                </p>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\"\n                  className=\"border-green-500 text-green-600 hover:bg-green-50\"\n                  onClick={() => {\n                    setTutorRateFormData({\n                      name: \"\",\n                      description: \"\",\n                      classType: \"individual\",\n                      subject: \"\",\n                      rate: 0,\n                      isDefault: false,\n                      isActive: true,\n                    });\n                    setIsAddTutorRateOpen(true);\n                  }}\n                  data-testid=\"button-add-tutor-rate\"\n                >\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Add Tutor Rate\n                </Button>\n                <Button \n                  variant=\"outline\"\n                  className=\"border-blue-500 text-blue-600 hover:bg-blue-50\"\n                  onClick={() => {\n                    setParentRateFormData({\n                      name: \"\",\n                      description: \"\",\n                      classType: \"individual\",\n                      subject: \"\",\n                      rate: 0,\n                      isDefault: false,\n                      isActive: true,\n                    });\n                    setIsAddParentRateOpen(true);\n                  }}\n                  data-testid=\"button-add-parent-rate\"\n                >\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Add Parent Rate\n                </Button>\n              </div>\n            </div>\n\n            {/* Add Tutor Rate Dialog (NEW INDEPENDENT SYSTEM) */}\n            <Dialog open={isAddTutorRateOpen} onOpenChange={setIsAddTutorRateOpen}>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center text-green-600\">\n                    <HandHeart className=\"w-5 h-5 mr-2\" />\n                    Add Tutor Payment Rate\n                  </DialogTitle>\n                  <DialogDescription>\n                    Create a new independent rate for tutor payments.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Name *</label>\n                    <Input\n                      placeholder=\"e.g., Standard Individual Rate\"\n                      value={tutorRateFormData.name}\n                      onChange={(e) => setTutorRateFormData({ ...tutorRateFormData, name: e.target.value })}\n                      data-testid=\"input-tutor-rate-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Description</label>\n                    <Input\n                      placeholder=\"Optional description\"\n                      value={tutorRateFormData.description || \"\"}\n                      onChange={(e) => setTutorRateFormData({ ...tutorRateFormData, description: e.target.value })}\n                      data-testid=\"input-tutor-rate-description\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Class Type *</label>\n                      <Select\n                        value={tutorRateFormData.classType}\n                        onValueChange={(value: \"individual\" | \"group\") => setTutorRateFormData({ ...tutorRateFormData, classType: value })}\n                      >\n                        <SelectTrigger data-testid=\"select-tutor-rate-class-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"individual\">Individual</SelectItem>\n                          <SelectItem value=\"group\">Group</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Subject</label>\n                      <Input\n                        placeholder=\"e.g., Maths\"\n                        value={tutorRateFormData.subject || \"\"}\n                        onChange={(e) => setTutorRateFormData({ ...tutorRateFormData, subject: e.target.value })}\n                        data-testid=\"input-tutor-rate-subject\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-green-600\">Tutor Rate (Â£/hr) *</label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.01\"\n                      min=\"0\"\n                      value={tutorRateFormData.rate}\n                      onChange={(e) => setTutorRateFormData({ ...tutorRateFormData, rate: parseFloat(e.target.value) || 0 })}\n                      className=\"border-green-200 focus:border-green-500\"\n                      data-testid=\"input-tutor-rate-amount\"\n                    />\n                  </div>\n                  <div className=\"flex items-center space-x-4\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id=\"tutorIsDefault\"\n                        checked={tutorRateFormData.isDefault}\n                        onCheckedChange={(checked) => setTutorRateFormData({ ...tutorRateFormData, isDefault: !!checked })}\n                        data-testid=\"checkbox-tutor-rate-default\"\n                      />\n                      <label htmlFor=\"tutorIsDefault\" className=\"text-sm\">Default rate</label>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id=\"tutorIsActive\"\n                        checked={tutorRateFormData.isActive}\n                        onCheckedChange={(checked) => setTutorRateFormData({ ...tutorRateFormData, isActive: !!checked })}\n                        data-testid=\"checkbox-tutor-rate-active\"\n                      />\n                      <label htmlFor=\"tutorIsActive\" className=\"text-sm\">Active</label>\n                    </div>\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setIsAddTutorRateOpen(false)}\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    className=\"bg-green-600 hover:bg-green-700\"\n                    onClick={() => createTutorRateMutation.mutate(tutorRateFormData)}\n                    disabled={createTutorRateMutation.isPending || !tutorRateFormData.name || tutorRateFormData.rate <= 0}\n                    data-testid=\"button-save-tutor-rate\"\n                  >\n                    {createTutorRateMutation.isPending ? \"Creating...\" : \"Create Tutor Rate\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n\n            {/* Add Parent Rate Dialog (NEW INDEPENDENT SYSTEM) */}\n            <Dialog open={isAddParentRateOpen} onOpenChange={setIsAddParentRateOpen}>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center text-blue-600\">\n                    <Users className=\"w-5 h-5 mr-2\" />\n                    Add Parent Billing Rate\n                  </DialogTitle>\n                  <DialogDescription>\n                    Create a new independent rate for parent billing.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Name *</label>\n                    <Input\n                      placeholder=\"e.g., Standard Individual Rate\"\n                      value={parentRateFormData.name}\n                      onChange={(e) => setParentRateFormData({ ...parentRateFormData, name: e.target.value })}\n                      data-testid=\"input-parent-rate-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Description</label>\n                    <Input\n                      placeholder=\"Optional description\"\n                      value={parentRateFormData.description || \"\"}\n                      onChange={(e) => setParentRateFormData({ ...parentRateFormData, description: e.target.value })}\n                      data-testid=\"input-parent-rate-description\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Class Type *</label>\n                      <Select\n                        value={parentRateFormData.classType}\n                        onValueChange={(value: \"individual\" | \"group\") => setParentRateFormData({ ...parentRateFormData, classType: value })}\n                      >\n                        <SelectTrigger data-testid=\"select-parent-rate-class-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"individual\">Individual</SelectItem>\n                          <SelectItem value=\"group\">Group</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Subject</label>\n                      <Input\n                        placeholder=\"e.g., Maths\"\n                        value={parentRateFormData.subject || \"\"}\n                        onChange={(e) => setParentRateFormData({ ...parentRateFormData, subject: e.target.value })}\n                        data-testid=\"input-parent-rate-subject\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-blue-600\">Parent Rate (Â£/hr) *</label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.01\"\n                      min=\"0\"\n                      value={parentRateFormData.rate}\n                      onChange={(e) => setParentRateFormData({ ...parentRateFormData, rate: parseFloat(e.target.value) || 0 })}\n                      className=\"border-blue-200 focus:border-blue-500\"\n                      data-testid=\"input-parent-rate-amount\"\n                    />\n                  </div>\n                  <div className=\"flex items-center space-x-4\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id=\"parentIsDefault\"\n                        checked={parentRateFormData.isDefault}\n                        onCheckedChange={(checked) => setParentRateFormData({ ...parentRateFormData, isDefault: !!checked })}\n                        data-testid=\"checkbox-parent-rate-default\"\n                      />\n                      <label htmlFor=\"parentIsDefault\" className=\"text-sm\">Default rate</label>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id=\"parentIsActive\"\n                        checked={parentRateFormData.isActive}\n                        onCheckedChange={(checked) => setParentRateFormData({ ...parentRateFormData, isActive: !!checked })}\n                        data-testid=\"checkbox-parent-rate-active\"\n                      />\n                      <label htmlFor=\"parentIsActive\" className=\"text-sm\">Active</label>\n                    </div>\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setIsAddParentRateOpen(false)}\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    className=\"bg-blue-600 hover:bg-blue-700\"\n                    onClick={() => createParentRateMutation.mutate(parentRateFormData)}\n                    disabled={createParentRateMutation.isPending || !parentRateFormData.name || parentRateFormData.rate <= 0}\n                    data-testid=\"button-save-parent-rate\"\n                  >\n                    {createParentRateMutation.isPending ? \"Creating...\" : \"Create Parent Rate\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n\n            {tutorRatesLoading || parentRatesLoading ? (\n              <div className=\"space-y-4\">\n                <Skeleton className=\"h-48 w-full\" />\n                <Skeleton className=\"h-48 w-full\" />\n              </div>\n            ) : tutorRatesData.length === 0 && parentRatesData.length === 0 ? (\n              <Card>\n                <CardContent className=\"text-center py-12\">\n                  <DollarSign className=\"w-12 h-12 mx-auto mb-4 opacity-30 text-muted-foreground\" />\n                  <h3 className=\"text-lg font-medium mb-2\">No Rate Configurations</h3>\n                  <p className=\"text-muted-foreground mb-4\">\n                    Create rate templates to standardize tutor payments and parent billing.\n                    Rates are completely independent - creating one does not affect the other.\n                  </p>\n                  <div className=\"flex justify-center gap-3 flex-wrap\">\n                    <Button \n                      variant=\"outline\"\n                      className=\"border-green-500 text-green-600 hover:bg-green-50\"\n                      onClick={() => {\n                        setTutorRateFormData({\n                          name: \"\",\n                          description: \"\",\n                          classType: \"individual\",\n                          subject: \"\",\n                          rate: 0,\n                          isDefault: false,\n                          isActive: true,\n                        });\n                        setIsAddTutorRateOpen(true);\n                      }}\n                      data-testid=\"button-add-first-tutor-rate\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-2\" />\n                      Add Tutor Rate\n                    </Button>\n                    <Button \n                      variant=\"outline\"\n                      className=\"border-blue-500 text-blue-600 hover:bg-blue-50\"\n                      onClick={() => {\n                        setParentRateFormData({\n                          name: \"\",\n                          description: \"\",\n                          classType: \"individual\",\n                          subject: \"\",\n                          rate: 0,\n                          isDefault: false,\n                          isActive: true,\n                        });\n                        setIsAddParentRateOpen(true);\n                      }}\n                      data-testid=\"button-add-first-parent-rate\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-2\" />\n                      Add Parent Rate\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                {/* Tutor Rates Section (NEW INDEPENDENT SYSTEM) */}\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"flex items-center text-green-600\">\n                      <HandHeart className=\"w-5 h-5 mr-2\" />\n                      Tutor Payment Rates\n                    </CardTitle>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Independent rates paid to tutors for each session type\n                    </p>\n                  </CardHeader>\n                  <CardContent className=\"p-0\">\n                    {tutorRatesData.length === 0 ? (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <p>No tutor rates configured yet.</p>\n                        <Button \n                          variant=\"link\" \n                          className=\"text-green-600\"\n                          onClick={() => {\n                            setTutorRateFormData({\n                              name: \"\",\n                              description: \"\",\n                              classType: \"individual\",\n                              subject: \"\",\n                              rate: 0,\n                              isDefault: false,\n                              isActive: true,\n                            });\n                            setIsAddTutorRateOpen(true);\n                          }}\n                        >\n                          Add your first tutor rate\n                        </Button>\n                      </div>\n                    ) : (\n                      <div className=\"overflow-x-auto\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>Name</TableHead>\n                              <TableHead>Type</TableHead>\n                              <TableHead className=\"text-right\">Rate (Â£/hr)</TableHead>\n                              <TableHead className=\"text-right\">Actions</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {tutorRatesData.map((rate) => {\n                              const rateAmount = parseFloat(rate.rate?.toString() || \"0\");\n                              return (\n                                <TableRow key={rate.id} data-testid={`row-tutor-rate-${rate.id}`}>\n                                  <TableCell className=\"font-medium\">\n                                    <div className=\"flex items-center gap-2\">\n                                      {rate.name}\n                                      {rate.isDefault && (\n                                        <Badge variant=\"secondary\" className=\"text-xs\">Default</Badge>\n                                      )}\n                                      {!rate.isActive && (\n                                        <Badge variant=\"outline\" className=\"text-xs\">Inactive</Badge>\n                                      )}\n                                    </div>\n                                    {rate.subject && (\n                                      <span className=\"text-xs text-muted-foreground\">{rate.subject}</span>\n                                    )}\n                                  </TableCell>\n                                  <TableCell>\n                                    <Badge variant={rate.classType === \"individual\" ? \"default\" : \"outline\"} className=\"text-xs\">\n                                      {rate.classType}\n                                    </Badge>\n                                  </TableCell>\n                                  <TableCell className=\"text-right font-mono text-green-600 font-semibold\">\n                                    Â£{rateAmount.toFixed(2)}\n                                  </TableCell>\n                                  <TableCell className=\"text-right\">\n                                    <div className=\"flex justify-end gap-1\">\n                                      <Button\n                                        variant=\"ghost\"\n                                        size=\"sm\"\n                                        onClick={() => {\n                                          setEditingTutorRate(rate);\n                                          setTutorRateFormData({\n                                            name: rate.name,\n                                            description: rate.description || \"\",\n                                            classType: rate.classType as \"individual\" | \"group\",\n                                            subject: rate.subject || \"\",\n                                            rate: rateAmount,\n                                            isDefault: rate.isDefault,\n                                            isActive: rate.isActive,\n                                          });\n                                          setIsEditTutorRateOpen(true);\n                                        }}\n                                        data-testid={`button-edit-tutor-rate-${rate.id}`}\n                                      >\n                                        <Edit className=\"w-4 h-4\" />\n                                      </Button>\n                                      <Button\n                                        variant=\"ghost\"\n                                        size=\"sm\"\n                                        className=\"text-destructive hover:text-destructive\"\n                                        onClick={() => {\n                                          if (confirm(\"Are you sure you want to delete this tutor rate? This will NOT affect any parent rates.\")) {\n                                            deleteTutorRateMutation.mutate(rate.id);\n                                          }\n                                        }}\n                                        data-testid={`button-delete-tutor-rate-${rate.id}`}\n                                      >\n                                        <Trash2 className=\"w-4 h-4\" />\n                                      </Button>\n                                    </div>\n                                  </TableCell>\n                                </TableRow>\n                              );\n                            })}\n                          </TableBody>\n                        </Table>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                {/* Parent Rates Section (NEW INDEPENDENT SYSTEM) */}\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"flex items-center text-blue-600\">\n                      <Users className=\"w-5 h-5 mr-2\" />\n                      Parent Billing Rates\n                    </CardTitle>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Independent rates charged to parents for each session type\n                    </p>\n                  </CardHeader>\n                  <CardContent className=\"p-0\">\n                    {parentRatesData.length === 0 ? (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <p>No parent rates configured yet.</p>\n                        <Button \n                          variant=\"link\" \n                          className=\"text-blue-600\"\n                          onClick={() => {\n                            setParentRateFormData({\n                              name: \"\",\n                              description: \"\",\n                              classType: \"individual\",\n                              subject: \"\",\n                              rate: 0,\n                              isDefault: false,\n                              isActive: true,\n                            });\n                            setIsAddParentRateOpen(true);\n                          }}\n                        >\n                          Add your first parent rate\n                        </Button>\n                      </div>\n                    ) : (\n                      <div className=\"overflow-x-auto\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>Name</TableHead>\n                              <TableHead>Type</TableHead>\n                              <TableHead className=\"text-right\">Rate (Â£/hr)</TableHead>\n                              <TableHead className=\"text-right\">Actions</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {parentRatesData.map((rate) => {\n                              const rateAmount = parseFloat(rate.rate?.toString() || \"0\");\n                              return (\n                                <TableRow key={rate.id} data-testid={`row-parent-rate-${rate.id}`}>\n                                  <TableCell className=\"font-medium\">\n                                    <div className=\"flex items-center gap-2\">\n                                      {rate.name}\n                                      {rate.isDefault && (\n                                        <Badge variant=\"secondary\" className=\"text-xs\">Default</Badge>\n                                      )}\n                                      {!rate.isActive && (\n                                        <Badge variant=\"outline\" className=\"text-xs\">Inactive</Badge>\n                                      )}\n                                    </div>\n                                    {rate.subject && (\n                                      <span className=\"text-xs text-muted-foreground\">{rate.subject}</span>\n                                    )}\n                                  </TableCell>\n                                  <TableCell>\n                                    <Badge variant={rate.classType === \"individual\" ? \"default\" : \"outline\"} className=\"text-xs\">\n                                      {rate.classType}\n                                    </Badge>\n                                  </TableCell>\n                                  <TableCell className=\"text-right font-mono text-blue-600 font-semibold\">\n                                    Â£{rateAmount.toFixed(2)}\n                                  </TableCell>\n                                  <TableCell className=\"text-right\">\n                                    <div className=\"flex justify-end gap-1\">\n                                      <Button\n                                        variant=\"ghost\"\n                                        size=\"sm\"\n                                        onClick={() => {\n                                          setEditingParentRate(rate);\n                                          setParentRateFormData({\n                                            name: rate.name,\n                                            description: rate.description || \"\",\n                                            classType: rate.classType as \"individual\" | \"group\",\n                                            subject: rate.subject || \"\",\n                                            rate: rateAmount,\n                                            isDefault: rate.isDefault,\n                                            isActive: rate.isActive,\n                                          });\n                                          setIsEditParentRateOpen(true);\n                                        }}\n                                        data-testid={`button-edit-parent-rate-${rate.id}`}\n                                      >\n                                        <Edit className=\"w-4 h-4\" />\n                                      </Button>\n                                      <Button\n                                        variant=\"ghost\"\n                                        size=\"sm\"\n                                        className=\"text-destructive hover:text-destructive\"\n                                        onClick={() => {\n                                          if (confirm(\"Are you sure you want to delete this parent rate? This will NOT affect any tutor rates.\")) {\n                                            deleteParentRateMutation.mutate(rate.id);\n                                          }\n                                        }}\n                                        data-testid={`button-delete-parent-rate-${rate.id}`}\n                                      >\n                                        <Trash2 className=\"w-4 h-4\" />\n                                      </Button>\n                                    </div>\n                                  </TableCell>\n                                </TableRow>\n                              );\n                            })}\n                          </TableBody>\n                        </Table>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            )}\n\n            {/* Profit Margin Analysis - Shows linked rate pairs (NEW INDEPENDENT SYSTEM) */}\n            {(tutorRatesData.length > 0 || parentRatesData.length > 0) && (\n              <Card className=\"mt-6\">\n                <CardHeader className=\"flex flex-row items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"flex items-center\">\n                      <PieChart className=\"w-5 h-5 text-chart-2 mr-2\" />\n                      Profit Margin Analysis\n                    </CardTitle>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Optionally link tutor rates to parent rates to calculate profit margins\n                    </p>\n                  </div>\n                  <Button\n                    variant=\"outline\"\n                    className=\"border-purple-500 text-purple-600 hover:bg-purple-50\"\n                    onClick={() => {\n                      setLinkingTutorRateId(\"\");\n                      setLinkingParentRateId(\"\");\n                      setIsLinkRateOpen(true);\n                    }}\n                    data-testid=\"button-create-link\"\n                  >\n                    <Link2 className=\"w-4 h-4 mr-2\" />\n                    Link Rates\n                  </Button>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Tutor Rate</TableHead>\n                          <TableHead>Parent Rate</TableHead>\n                          <TableHead className=\"text-right text-green-600\">Tutor Â£/hr</TableHead>\n                          <TableHead className=\"text-right text-blue-600\">Parent Â£/hr</TableHead>\n                          <TableHead className=\"text-right\">Profit</TableHead>\n                          <TableHead className=\"text-right\">Margin</TableHead>\n                          <TableHead className=\"text-right\">Actions</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {rateLinksData.length === 0 ? (\n                          <TableRow>\n                            <TableCell colSpan={7} className=\"text-center py-8 text-muted-foreground\">\n                              No rate links created yet. Link tutor rates with parent rates to analyze profit margins.\n                            </TableCell>\n                          </TableRow>\n                        ) : (\n                          rateLinksData.map((link) => {\n                            const tutorRate = tutorRatesData.find(r => r.id === link.tutorRateId);\n                            const parentRate = parentRatesData.find(r => r.id === link.parentRateId);\n                            \n                            if (!tutorRate || !parentRate) return null;\n                            \n                            const tutorAmount = parseFloat(tutorRate.rate?.toString() || \"0\");\n                            const parentAmount = parseFloat(parentRate.rate?.toString() || \"0\");\n                            const profit = parentAmount - tutorAmount;\n                            const profitMargin = parentAmount > 0 ? ((profit / parentAmount) * 100).toFixed(1) : \"0\";\n                            \n                            return (\n                              <TableRow key={link.id} className=\"bg-emerald-50/50\" data-testid={`row-linked-${link.id}`}>\n                                <TableCell className=\"font-medium\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"text-green-600\">{tutorRate.name}</span>\n                                    <Badge variant=\"secondary\" className=\"text-xs bg-green-100 text-green-700\">Tutor</Badge>\n                                  </div>\n                                  {tutorRate.subject && (\n                                    <span className=\"text-xs text-muted-foreground\">{tutorRate.subject}</span>\n                                  )}\n                                </TableCell>\n                                <TableCell className=\"font-medium\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"text-blue-600\">{parentRate.name}</span>\n                                    <Badge variant=\"secondary\" className=\"text-xs bg-blue-100 text-blue-700\">Parent</Badge>\n                                  </div>\n                                  {parentRate.subject && (\n                                    <span className=\"text-xs text-muted-foreground\">{parentRate.subject}</span>\n                                  )}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono text-green-600 font-semibold\">\n                                  Â£{tutorAmount.toFixed(2)}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono text-blue-600 font-semibold\">\n                                  Â£{parentAmount.toFixed(2)}\n                                </TableCell>\n                                <TableCell className=\"text-right\">\n                                  <span className={`font-mono font-semibold ${profit >= 0 ? \"text-emerald-600\" : \"text-red-600\"}`}>\n                                    Â£{profit.toFixed(2)}\n                                  </span>\n                                </TableCell>\n                                <TableCell className=\"text-right\">\n                                  <Badge variant={profit >= 0 ? \"default\" : \"destructive\"} className=\"font-mono\">\n                                    {profitMargin}%\n                                  </Badge>\n                                </TableCell>\n                                <TableCell className=\"text-right\">\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    className=\"text-orange-600 hover:text-orange-700\"\n                                    onClick={() => {\n                                      if (confirm(\"Remove this rate link? This will NOT delete either rate.\")) {\n                                        deleteRateLinkMutation.mutate(link.id);\n                                      }\n                                    }}\n                                    data-testid={`button-unlink-${link.id}`}\n                                  >\n                                    <Link2Off className=\"w-4 h-4\" />\n                                  </Button>\n                                </TableCell>\n                              </TableRow>\n                            );\n                          })\n                        )}\n                      </TableBody>\n                    </Table>\n                  </div>\n                  \n                  {/* Summary stats */}\n                  {rateLinksData.length > 0 && (\n                    <div className=\"grid grid-cols-1 sm:grid-cols-4 gap-4 mt-4 pt-4 border-t\">\n                      {(() => {\n                        const linkedPairs: { tutorAmount: number; parentAmount: number }[] = [];\n                        \n                        rateLinksData.forEach((link) => {\n                          const tutorRate = tutorRatesData.find(r => r.id === link.tutorRateId);\n                          const parentRate = parentRatesData.find(r => r.id === link.parentRateId);\n                          if (tutorRate && parentRate) {\n                            linkedPairs.push({\n                              tutorAmount: parseFloat(tutorRate.rate?.toString() || \"0\"),\n                              parentAmount: parseFloat(parentRate.rate?.toString() || \"0\"),\n                            });\n                          }\n                        });\n                        \n                        const count = linkedPairs.length;\n                        const avgTutorRate = count > 0 ? linkedPairs.reduce((sum, p) => sum + p.tutorAmount, 0) / count : 0;\n                        const avgParentRate = count > 0 ? linkedPairs.reduce((sum, p) => sum + p.parentAmount, 0) / count : 0;\n                        const avgProfit = avgParentRate - avgTutorRate;\n                        const avgMargin = avgParentRate > 0 ? ((avgProfit / avgParentRate) * 100).toFixed(1) : \"0\";\n                        \n                        return (\n                          <>\n                            <div className=\"p-3 rounded-lg bg-muted/50 text-center\">\n                              <p className=\"text-xs text-muted-foreground\">Linked Pairs</p>\n                              <p className=\"text-xl font-bold\">{count}</p>\n                            </div>\n                            <div className=\"p-3 rounded-lg bg-green-500/10 text-center\">\n                              <p className=\"text-xs text-muted-foreground\">Avg Tutor Rate</p>\n                              <p className=\"text-xl font-bold text-green-600\">Â£{avgTutorRate.toFixed(2)}</p>\n                            </div>\n                            <div className=\"p-3 rounded-lg bg-blue-500/10 text-center\">\n                              <p className=\"text-xs text-muted-foreground\">Avg Parent Rate</p>\n                              <p className=\"text-xl font-bold text-blue-600\">Â£{avgParentRate.toFixed(2)}</p>\n                            </div>\n                            <div className=\"p-3 rounded-lg bg-emerald-500/10 text-center\">\n                              <p className=\"text-xs text-muted-foreground\">Avg Profit Margin</p>\n                              <p className=\"text-xl font-bold text-emerald-600\">{avgMargin}%</p>\n                            </div>\n                          </>\n                        );\n                      })()}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            )}\n\n            {/* Link Rate Dialog (NEW INDEPENDENT SYSTEM) */}\n            <Dialog open={isLinkRateOpen} onOpenChange={setIsLinkRateOpen}>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center text-purple-600\">\n                    <Link2 className=\"w-5 h-5 mr-2\" />\n                    Link Rates for Profit Analysis\n                  </DialogTitle>\n                  <DialogDescription>\n                    Link a tutor rate with a parent rate to calculate profit margins. Both rates remain completely independent.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-green-600\">Select Tutor Rate</label>\n                    <Select\n                      value={linkingTutorRateId}\n                      onValueChange={setLinkingTutorRateId}\n                    >\n                      <SelectTrigger data-testid=\"select-tutor-rate-link\">\n                        <SelectValue placeholder=\"Choose a tutor rate...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {tutorRatesData.map((rate) => (\n                          <SelectItem key={rate.id} value={rate.id}>\n                            {rate.name} - Â£{parseFloat(rate.rate?.toString() || \"0\").toFixed(2)}/hr\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  \n                  <div className=\"flex items-center justify-center\">\n                    <ArrowDown className=\"w-6 h-6 text-purple-400\" />\n                  </div>\n                  \n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-blue-600\">Select Parent Rate</label>\n                    <Select\n                      value={linkingParentRateId}\n                      onValueChange={setLinkingParentRateId}\n                    >\n                      <SelectTrigger data-testid=\"select-parent-rate-link\">\n                        <SelectValue placeholder=\"Choose a parent rate...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {parentRatesData.map((rate) => (\n                          <SelectItem key={rate.id} value={rate.id}>\n                            {rate.name} - Â£{parseFloat(rate.rate?.toString() || \"0\").toFixed(2)}/hr\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  \n                  {linkingTutorRateId && linkingParentRateId && (() => {\n                    const tutorRate = tutorRatesData.find(r => r.id === linkingTutorRateId);\n                    const parentRate = parentRatesData.find(r => r.id === linkingParentRateId);\n                    if (!tutorRate || !parentRate) return null;\n                    const tutorAmount = parseFloat(tutorRate.rate?.toString() || \"0\");\n                    const parentAmount = parseFloat(parentRate.rate?.toString() || \"0\");\n                    const profit = parentAmount - tutorAmount;\n                    const margin = parentAmount > 0 ? ((profit / parentAmount) * 100).toFixed(1) : \"0\";\n                    \n                    return (\n                      <div className=\"p-3 rounded-lg bg-emerald-50 border border-emerald-200\">\n                        <p className=\"text-sm font-medium text-emerald-700\">Profit Preview</p>\n                        <p className={`text-lg font-bold ${profit >= 0 ? \"text-emerald-600\" : \"text-red-600\"}`}>\n                          Â£{profit.toFixed(2)}/hr ({margin}% margin)\n                        </p>\n                      </div>\n                    );\n                  })()}\n                </div>\n                <DialogFooter>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setIsLinkRateOpen(false);\n                      setLinkingTutorRateId(\"\");\n                      setLinkingParentRateId(\"\");\n                    }}\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    className=\"bg-purple-600 hover:bg-purple-700\"\n                    onClick={() => {\n                      if (linkingTutorRateId && linkingParentRateId) {\n                        createRateLinkMutation.mutate({\n                          tutorRateId: linkingTutorRateId,\n                          parentRateId: linkingParentRateId,\n                        });\n                      }\n                    }}\n                    disabled={createRateLinkMutation.isPending || !linkingTutorRateId || !linkingParentRateId}\n                    data-testid=\"button-confirm-link\"\n                  >\n                    {createRateLinkMutation.isPending ? \"Linking...\" : \"Link Rates\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n\n            {/* Edit Tutor Rate Dialog (NEW INDEPENDENT SYSTEM) */}\n            <Dialog open={isEditTutorRateOpen} onOpenChange={setIsEditTutorRateOpen}>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center text-green-600\">\n                    <HandHeart className=\"w-5 h-5 mr-2\" />\n                    Edit Tutor Rate\n                  </DialogTitle>\n                  <DialogDescription>\n                    Update this tutor payment rate. Changes will NOT affect any parent rates.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Name *</label>\n                    <Input\n                      placeholder=\"e.g., Standard Individual Rate\"\n                      value={tutorRateFormData.name}\n                      onChange={(e) => setTutorRateFormData({ ...tutorRateFormData, name: e.target.value })}\n                      data-testid=\"input-edit-tutor-rate-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Description</label>\n                    <Input\n                      placeholder=\"Optional description\"\n                      value={tutorRateFormData.description || \"\"}\n                      onChange={(e) => setTutorRateFormData({ ...tutorRateFormData, description: e.target.value })}\n                      data-testid=\"input-edit-tutor-rate-description\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Class Type *</label>\n                      <Select\n                        value={tutorRateFormData.classType}\n                        onValueChange={(value: \"individual\" | \"group\") => setTutorRateFormData({ ...tutorRateFormData, classType: value })}\n                      >\n                        <SelectTrigger data-testid=\"select-edit-tutor-rate-class-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"individual\">Individual</SelectItem>\n                          <SelectItem value=\"group\">Group</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Subject</label>\n                      <Input\n                        placeholder=\"e.g., Maths\"\n                        value={tutorRateFormData.subject || \"\"}\n                        onChange={(e) => setTutorRateFormData({ ...tutorRateFormData, subject: e.target.value })}\n                        data-testid=\"input-edit-tutor-rate-subject\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-green-600\">Tutor Rate (Â£/hr) *</label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.01\"\n                      min=\"0\"\n                      value={tutorRateFormData.rate}\n                      onChange={(e) => setTutorRateFormData({ ...tutorRateFormData, rate: parseFloat(e.target.value) || 0 })}\n                      className=\"border-green-200 focus:border-green-500\"\n                      data-testid=\"input-edit-tutor-rate-amount\"\n                    />\n                  </div>\n                  <div className=\"flex items-center space-x-4\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id=\"editTutorIsDefault\"\n                        checked={tutorRateFormData.isDefault}\n                        onCheckedChange={(checked) => setTutorRateFormData({ ...tutorRateFormData, isDefault: !!checked })}\n                        data-testid=\"checkbox-edit-tutor-rate-default\"\n                      />\n                      <label htmlFor=\"editTutorIsDefault\" className=\"text-sm\">Default rate</label>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id=\"editTutorIsActive\"\n                        checked={tutorRateFormData.isActive}\n                        onCheckedChange={(checked) => setTutorRateFormData({ ...tutorRateFormData, isActive: !!checked })}\n                        data-testid=\"checkbox-edit-tutor-rate-active\"\n                      />\n                      <label htmlFor=\"editTutorIsActive\" className=\"text-sm\">Active</label>\n                    </div>\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setIsEditTutorRateOpen(false);\n                      setEditingTutorRate(null);\n                    }}\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    className=\"bg-green-600 hover:bg-green-700\"\n                    onClick={() => {\n                      if (editingTutorRate) {\n                        updateTutorRateMutation.mutate({ id: editingTutorRate.id, data: tutorRateFormData });\n                      }\n                    }}\n                    disabled={updateTutorRateMutation.isPending || !tutorRateFormData.name || tutorRateFormData.rate <= 0}\n                    data-testid=\"button-save-edit-tutor-rate\"\n                  >\n                    {updateTutorRateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n\n            {/* Edit Parent Rate Dialog (NEW INDEPENDENT SYSTEM) */}\n            <Dialog open={isEditParentRateOpen} onOpenChange={setIsEditParentRateOpen}>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center text-blue-600\">\n                    <Users className=\"w-5 h-5 mr-2\" />\n                    Edit Parent Rate\n                  </DialogTitle>\n                  <DialogDescription>\n                    Update this parent billing rate. Changes will NOT affect any tutor rates.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Name *</label>\n                    <Input\n                      placeholder=\"e.g., Standard Individual Rate\"\n                      value={parentRateFormData.name}\n                      onChange={(e) => setParentRateFormData({ ...parentRateFormData, name: e.target.value })}\n                      data-testid=\"input-edit-parent-rate-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Description</label>\n                    <Input\n                      placeholder=\"Optional description\"\n                      value={parentRateFormData.description || \"\"}\n                      onChange={(e) => setParentRateFormData({ ...parentRateFormData, description: e.target.value })}\n                      data-testid=\"input-edit-parent-rate-description\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Class Type *</label>\n                      <Select\n                        value={parentRateFormData.classType}\n                        onValueChange={(value: \"individual\" | \"group\") => setParentRateFormData({ ...parentRateFormData, classType: value })}\n                      >\n                        <SelectTrigger data-testid=\"select-edit-parent-rate-class-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"individual\">Individual</SelectItem>\n                          <SelectItem value=\"group\">Group</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Subject</label>\n                      <Input\n                        placeholder=\"e.g., Maths\"\n                        value={parentRateFormData.subject || \"\"}\n                        onChange={(e) => setParentRateFormData({ ...parentRateFormData, subject: e.target.value })}\n                        data-testid=\"input-edit-parent-rate-subject\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-blue-600\">Parent Rate (Â£/hr) *</label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.01\"\n                      min=\"0\"\n                      value={parentRateFormData.rate}\n                      onChange={(e) => setParentRateFormData({ ...parentRateFormData, rate: parseFloat(e.target.value) || 0 })}\n                      className=\"border-blue-200 focus:border-blue-500\"\n                      data-testid=\"input-edit-parent-rate-amount\"\n                    />\n                  </div>\n                  <div className=\"flex items-center space-x-4\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id=\"editParentIsDefault\"\n                        checked={parentRateFormData.isDefault}\n                        onCheckedChange={(checked) => setParentRateFormData({ ...parentRateFormData, isDefault: !!checked })}\n                        data-testid=\"checkbox-edit-parent-rate-default\"\n                      />\n                      <label htmlFor=\"editParentIsDefault\" className=\"text-sm\">Default rate</label>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id=\"editParentIsActive\"\n                        checked={parentRateFormData.isActive}\n                        onCheckedChange={(checked) => setParentRateFormData({ ...parentRateFormData, isActive: !!checked })}\n                        data-testid=\"checkbox-edit-parent-rate-active\"\n                      />\n                      <label htmlFor=\"editParentIsActive\" className=\"text-sm\">Active</label>\n                    </div>\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setIsEditParentRateOpen(false);\n                      setEditingParentRate(null);\n                    }}\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    className=\"bg-blue-600 hover:bg-blue-700\"\n                    onClick={() => {\n                      if (editingParentRate) {\n                        updateParentRateMutation.mutate({ id: editingParentRate.id, data: parentRateFormData });\n                      }\n                    }}\n                    disabled={updateParentRateMutation.isPending || !parentRateFormData.name || parentRateFormData.rate <= 0}\n                    data-testid=\"button-save-edit-parent-rate\"\n                  >\n                    {updateParentRateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n\n          </TabsContent>\n\n          {/* Weekly Timesheets Tab */}\n          <TabsContent value=\"weekly-timesheets\" className=\"p-6\">\n            <div className=\"flex justify-between items-center mb-6\">\n              <h3 className=\"text-lg font-semibold\">Weekly Timesheet Approvals</h3>\n            </div>\n\n            <div className=\"space-y-4\">\n              {submittedWeeklyTimesheets.length === 0 ? (\n                <Card>\n                  <CardContent className=\"text-center py-8\">\n                    <FileText className=\"w-8 h-8 mx-auto mb-2 opacity-50 text-muted-foreground\" />\n                    <p className=\"text-muted-foreground\">No weekly timesheets pending review</p>\n                  </CardContent>\n                </Card>\n              ) : (\n                submittedWeeklyTimesheets.map((timesheet: WeeklyTimesheetWithRelations) => {\n                  const totalHours = timesheet.entries.reduce((sum, e) => sum + parseFloat(e.duration.toString()), 0);\n                  const totalTutorPay = timesheet.entries.reduce((sum, e) => sum + parseFloat(e.tutorEarnings.toString()), 0);\n                  const totalParentBill = timesheet.entries.reduce((sum, e) => sum + parseFloat(e.parentBilling.toString()), 0);\n\n                  return (\n                    <Card key={timesheet.id} data-testid={`card-weekly-timesheet-${timesheet.id}`}>\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex flex-col sm:flex-row justify-between items-start gap-4 mb-4\">\n                          <div>\n                            <h4 className=\"font-semibold text-lg\">\n                              {timesheet.tutor.firstName && timesheet.tutor.lastName\n                                ? `${timesheet.tutor.firstName} ${timesheet.tutor.lastName}`\n                                : timesheet.tutor.email}\n                            </h4>\n                            <p className=\"text-sm text-muted-foreground\">\n                              Week of {format(new Date(timesheet.weekStart), \"MMM dd\")} - {format(new Date(timesheet.weekEnd), \"MMM dd, yyyy\")}\n                            </p>\n                            <p className=\"text-sm text-muted-foreground\">\n                              Submitted: {timesheet.submittedAt ? format(new Date(timesheet.submittedAt), \"MMM dd, yyyy 'at' h:mm a\") : \"N/A\"}\n                            </p>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <Badge variant=\"secondary\" className=\"text-sm\">\n                              {timesheet.entries.length} session(s)\n                            </Badge>\n                            <Badge variant=\"outline\" className=\"text-sm\">\n                              {totalHours.toFixed(1)} hours\n                            </Badge>\n                          </div>\n                        </div>\n\n                        <div className=\"overflow-x-auto mb-4\">\n                          <Table>\n                            <TableHeader>\n                              <TableRow>\n                                <TableHead>Date</TableHead>\n                                <TableHead>Student</TableHead>\n                                <TableHead>Subject</TableHead>\n                                <TableHead className=\"text-right\">Duration</TableHead>\n                                <TableHead className=\"text-right\">Tutor Pay</TableHead>\n                                <TableHead className=\"text-right\">Parent Bill</TableHead>\n                                <TableHead>Notes</TableHead>\n                                <TableHead className=\"text-center\">Actions</TableHead>\n                              </TableRow>\n                            </TableHeader>\n                            <TableBody>\n                              {timesheet.entries.map((entry) => (\n                                <TableRow key={entry.id}>\n                                  <TableCell>{format(new Date(entry.date), \"MMM dd\")}</TableCell>\n                                  <TableCell>{entry.student.name}</TableCell>\n                                  <TableCell>{entry.student.subject}</TableCell>\n                                  <TableCell className=\"text-right\">{entry.duration}h</TableCell>\n                                  <TableCell className=\"text-right\">${parseFloat(entry.tutorEarnings.toString()).toFixed(2)}</TableCell>\n                                  <TableCell className=\"text-right\">${parseFloat(entry.parentBilling.toString()).toFixed(2)}</TableCell>\n                                  <TableCell className=\"max-w-[200px]\">\n                                    {entry.notes ? (\n                                      <div className=\"flex items-start\">\n                                        <FileText className=\"w-4 h-4 mr-1 mt-0.5 text-muted-foreground flex-shrink-0\" />\n                                        <span className=\"text-sm text-muted-foreground truncate\" title={entry.notes}>\n                                          {entry.notes}\n                                        </span>\n                                      </div>\n                                    ) : (\n                                      <span className=\"text-muted-foreground text-sm\">â€”</span>\n                                    )}\n                                  </TableCell>\n                                  <TableCell className=\"text-center\">\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"sm\"\n                                      onClick={() => {\n                                        setEditingEntry({\n                                          id: entry.id,\n                                          duration: entry.duration.toString(),\n                                          tutorEarnings: parseFloat(entry.tutorEarnings.toString()).toFixed(2),\n                                          parentBilling: parseFloat(entry.parentBilling.toString()).toFixed(2),\n                                          studentName: entry.student.name,\n                                        });\n                                        setEditEntryDialogOpen(true);\n                                      }}\n                                      data-testid={`button-edit-entry-${entry.id}`}\n                                    >\n                                      <Edit className=\"w-4 h-4\" />\n                                    </Button>\n                                  </TableCell>\n                                </TableRow>\n                              ))}\n                            </TableBody>\n                            <TableFooter>\n                              <TableRow>\n                                <TableCell colSpan={3} className=\"font-semibold\">Total</TableCell>\n                                <TableCell className=\"text-right font-semibold\">{totalHours.toFixed(1)}h</TableCell>\n                                <TableCell className=\"text-right font-semibold\">${totalTutorPay.toFixed(2)}</TableCell>\n                                <TableCell className=\"text-right font-semibold\">${totalParentBill.toFixed(2)}</TableCell>\n                                <TableCell colSpan={2}></TableCell>\n                              </TableRow>\n                            </TableFooter>\n                          </Table>\n                        </div>\n\n                        {/* Status History Section */}\n                        <StatusHistorySection \n                          timesheetId={timesheet.id}\n                          isExpanded={expandedStatusHistoryId === timesheet.id}\n                          onToggle={() => setExpandedStatusHistoryId(\n                            expandedStatusHistoryId === timesheet.id ? null : timesheet.id\n                          )}\n                        />\n\n                        {/* Notes input for review */}\n                        <div className=\"mb-4\">\n                          <label className=\"text-sm font-medium text-muted-foreground mb-2 block\">\n                            Review Notes (Optional)\n                          </label>\n                          <Textarea\n                            placeholder=\"Add notes for the tutor...\"\n                            value={reviewNotes[timesheet.id] || \"\"}\n                            onChange={(e) =>\n                              setReviewNotes((prev) => ({ ...prev, [timesheet.id]: e.target.value }))\n                            }\n                            className=\"h-20\"\n                            data-testid={`textarea-review-notes-${timesheet.id}`}\n                          />\n                        </div>\n\n                        <div className=\"flex justify-end gap-2\">\n                          <Button\n                            variant=\"outline\"\n                            onClick={() => {\n                              setRejectingTimesheetId(timesheet.id);\n                              setRejectionReason(\"\");\n                              setRejectDialogOpen(true);\n                            }}\n                            disabled={rejectWeeklyTimesheetMutation.isPending}\n                            data-testid={`button-reject-weekly-${timesheet.id}`}\n                          >\n                            <X className=\"w-4 h-4 mr-1\" />\n                            Reject\n                          </Button>\n                          <Button\n                            onClick={() =>\n                              approveWeeklyTimesheetMutation.mutate({\n                                id: timesheet.id,\n                                notes: reviewNotes[timesheet.id],\n                              })\n                            }\n                            disabled={approveWeeklyTimesheetMutation.isPending}\n                            data-testid={`button-approve-weekly-${timesheet.id}`}\n                          >\n                            <Check className=\"w-4 h-4 mr-1\" />\n                            Approve\n                          </Button>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  );\n                })\n              )}\n            </div>\n\n            {/* Rejection Dialog */}\n            <Dialog open={rejectDialogOpen} onOpenChange={setRejectDialogOpen}>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Reject Timesheet</DialogTitle>\n                  <DialogDescription>\n                    Please provide a reason for rejecting this timesheet. The tutor will see this message and can amend their timesheet accordingly.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4 py-4\">\n                  <div>\n                    <label className=\"text-sm font-medium mb-2 block\">Rejection Reason *</label>\n                    <Textarea\n                      placeholder=\"Explain why this timesheet is being rejected...\"\n                      value={rejectionReason}\n                      onChange={(e) => setRejectionReason(e.target.value)}\n                      className=\"min-h-[100px]\"\n                      data-testid=\"textarea-rejection-reason\"\n                    />\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button variant=\"outline\" onClick={() => setRejectDialogOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button\n                    variant=\"destructive\"\n                    onClick={() => {\n                      if (rejectingTimesheetId && rejectionReason.trim()) {\n                        rejectWeeklyTimesheetMutation.mutate({\n                          id: rejectingTimesheetId,\n                          notes: rejectionReason,\n                        });\n                        setRejectDialogOpen(false);\n                        setRejectingTimesheetId(null);\n                        setRejectionReason(\"\");\n                      }\n                    }}\n                    disabled={!rejectionReason.trim() || rejectWeeklyTimesheetMutation.isPending}\n                    data-testid=\"button-confirm-reject\"\n                  >\n                    {rejectWeeklyTimesheetMutation.isPending ? \"Rejecting...\" : \"Reject Timesheet\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n\n            {/* Edit Entry Dialog */}\n            <Dialog open={editEntryDialogOpen} onOpenChange={setEditEntryDialogOpen}>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Edit Session Entry</DialogTitle>\n                  <DialogDescription>\n                    Update the session details for {editingEntry?.studentName}\n                  </DialogDescription>\n                </DialogHeader>\n                {editingEntry && (\n                  <div className=\"space-y-4 py-4\">\n                    <div>\n                      <label className=\"text-sm font-medium mb-2 block\">Duration (hours)</label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.25\"\n                        min=\"0\"\n                        value={editingEntry.duration}\n                        onChange={(e) => setEditingEntry({ ...editingEntry, duration: e.target.value })}\n                        data-testid=\"input-edit-duration\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium mb-2 block\">Tutor Pay ($)</label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        min=\"0\"\n                        value={editingEntry.tutorEarnings}\n                        onChange={(e) => setEditingEntry({ ...editingEntry, tutorEarnings: e.target.value })}\n                        data-testid=\"input-edit-tutor-earnings\"\n                      />\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium mb-2 block\">Parent Bill ($)</label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        min=\"0\"\n                        value={editingEntry.parentBilling}\n                        onChange={(e) => setEditingEntry({ ...editingEntry, parentBilling: e.target.value })}\n                        data-testid=\"input-edit-parent-billing\"\n                      />\n                    </div>\n                  </div>\n                )}\n                <DialogFooter>\n                  <Button variant=\"outline\" onClick={() => setEditEntryDialogOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button\n                    onClick={() => {\n                      if (editingEntry) {\n                        updateTimesheetEntryMutation.mutate({\n                          id: editingEntry.id,\n                          duration: parseFloat(editingEntry.duration),\n                          tutorEarnings: parseFloat(editingEntry.tutorEarnings),\n                          parentBilling: parseFloat(editingEntry.parentBilling),\n                        });\n                      }\n                    }}\n                    disabled={updateTimesheetEntryMutation.isPending}\n                    data-testid=\"button-save-entry\"\n                  >\n                    {updateTimesheetEntryMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n          </TabsContent>\n\n          {/* Timesheet Review Tab (Legacy) */}\n          <TabsContent value=\"timesheets\" className=\"p-6\">\n            <div className=\"flex justify-between items-center mb-6\">\n              <h3 className=\"text-lg font-semibold\">Timesheet History (Legacy)</h3>\n              <div className=\"flex space-x-2\">\n                <Select \n                  value={legacyTutorFilter} \n                  onValueChange={setLegacyTutorFilter}\n                >\n                  <SelectTrigger className=\"w-[180px]\" data-testid=\"select-legacy-tutor\">\n                    <SelectValue placeholder=\"Filter by tutor\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Tutors</SelectItem>\n                    {tutors.filter(t => t.role === \"tutor\").map((tutor) => (\n                      <SelectItem key={tutor.id} value={tutor.id}>\n                        {tutor.firstName && tutor.lastName\n                          ? `${tutor.firstName} ${tutor.lastName}`\n                          : tutor.email}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <Select \n                  value={legacyStatusFilter} \n                  onValueChange={(val) => setLegacyStatusFilter(val as \"all\" | \"pending\" | \"approved\" | \"rejected\")}\n                >\n                  <SelectTrigger className=\"w-[150px]\" data-testid=\"select-legacy-status\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Statuses</SelectItem>\n                    <SelectItem value=\"pending\">Pending</SelectItem>\n                    <SelectItem value=\"approved\">Approved</SelectItem>\n                    <SelectItem value=\"rejected\">Rejected</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"space-y-4\">\n              {(() => {\n                let filteredTimesheets = allSessions;\n                \n                if (legacyTutorFilter !== \"all\") {\n                  filteredTimesheets = filteredTimesheets.filter(t => t.tutorId === legacyTutorFilter);\n                }\n                \n                if (legacyStatusFilter !== \"all\") {\n                  filteredTimesheets = filteredTimesheets.filter(t => t.status === legacyStatusFilter);\n                }\n                \n                if (filteredTimesheets.length === 0) {\n                  return (\n                    <Card>\n                      <CardContent className=\"text-center py-8\">\n                        <ClipboardList className=\"w-8 h-8 mx-auto mb-2 opacity-50 text-muted-foreground\" />\n                        <p className=\"text-muted-foreground\">No timesheets found matching filters</p>\n                      </CardContent>\n                    </Card>\n                  );\n                }\n\n                // Group by tutor, then by week\n                const groupedByTutor = filteredTimesheets.reduce((acc, entry) => {\n                  const tutorId = entry.tutorId;\n                  if (!acc[tutorId]) {\n                    acc[tutorId] = {\n                      tutor: entry.tutor,\n                      weeks: {} as Record<string, {\n                        weekKey: string;\n                        weekStart: Date;\n                        weekEnd: Date;\n                        entries: TimesheetEntryWithRelations[];\n                        totalHours: number;\n                        totalEarnings: number;\n                        totalBilling: number;\n                        status: string;\n                      }>,\n                      totalHours: 0,\n                      totalEarnings: 0,\n                      totalBilling: 0,\n                    };\n                  }\n                  \n                  // Calculate week start (Monday) for this entry\n                  const entryDate = new Date(entry.date);\n                  const dayOfWeek = entryDate.getDay();\n                  const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n                  const weekStart = new Date(entryDate);\n                  weekStart.setDate(entryDate.getDate() + mondayOffset);\n                  weekStart.setHours(0, 0, 0, 0);\n                  const weekEnd = new Date(weekStart);\n                  weekEnd.setDate(weekStart.getDate() + 6);\n                  const weekKey = `${tutorId}-${format(weekStart, \"yyyy-MM-dd\")}`;\n                  \n                  if (!acc[tutorId].weeks[weekKey]) {\n                    acc[tutorId].weeks[weekKey] = {\n                      weekKey,\n                      weekStart,\n                      weekEnd,\n                      entries: [],\n                      totalHours: 0,\n                      totalEarnings: 0,\n                      totalBilling: 0,\n                      status: entry.status,\n                    };\n                  }\n                  \n                  acc[tutorId].weeks[weekKey].entries.push(entry);\n                  acc[tutorId].weeks[weekKey].totalHours += Number(entry.duration);\n                  acc[tutorId].weeks[weekKey].totalEarnings += parseFloat(entry.tutorEarnings.toString());\n                  acc[tutorId].weeks[weekKey].totalBilling += parseFloat(entry.parentBilling.toString());\n                  \n                  acc[tutorId].totalHours += Number(entry.duration);\n                  acc[tutorId].totalEarnings += parseFloat(entry.tutorEarnings.toString());\n                  acc[tutorId].totalBilling += parseFloat(entry.parentBilling.toString());\n                  \n                  return acc;\n                }, {} as Record<string, { \n                  tutor: any; \n                  weeks: Record<string, {\n                    weekKey: string;\n                    weekStart: Date;\n                    weekEnd: Date;\n                    entries: TimesheetEntryWithRelations[];\n                    totalHours: number;\n                    totalEarnings: number;\n                    totalBilling: number;\n                    status: string;\n                  }>;\n                  totalHours: number; \n                  totalEarnings: number; \n                  totalBilling: number;\n                }>);\n                \n                return Object.entries(groupedByTutor).map(([tutorId, group]) => (\n                  <Card key={tutorId} data-testid={`card-tutor-summary-${tutorId}`}>\n                    <CardContent className=\"p-4\">\n                      <div \n                        className=\"flex justify-between items-center cursor-pointer\"\n                        onClick={() => setExpandedLegacyTutor(expandedLegacyTutor === tutorId ? null : tutorId)}\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          {expandedLegacyTutor === tutorId ? (\n                            <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n                          ) : (\n                            <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n                          )}\n                          <div>\n                            <h4 className=\"font-semibold\">\n                              {group.tutor.firstName && group.tutor.lastName\n                                ? `${group.tutor.firstName} ${group.tutor.lastName}`\n                                : group.tutor.email}\n                            </h4>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {Object.keys(group.weeks).length} week{Object.keys(group.weeks).length !== 1 ? \"s\" : \"\"}\n                            </p>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-6 text-sm\">\n                          <div className=\"text-right\">\n                            <p className=\"text-muted-foreground\">Total Hours</p>\n                            <p className=\"font-semibold\">{group.totalHours.toFixed(1)}h</p>\n                          </div>\n                          <div className=\"text-right\">\n                            <p className=\"text-muted-foreground\">Tutor Earnings</p>\n                            <p className=\"font-semibold text-green-600\">Â£{group.totalEarnings.toFixed(2)}</p>\n                          </div>\n                          <div className=\"text-right\">\n                            <p className=\"text-muted-foreground\">Parent Billing</p>\n                            <p className=\"font-semibold text-blue-600\">Â£{group.totalBilling.toFixed(2)}</p>\n                          </div>\n                        </div>\n                      </div>\n\n                      {expandedLegacyTutor === tutorId && (\n                        <div className=\"mt-4 pt-4 border-t space-y-3\">\n                          {Object.values(group.weeks)\n                            .sort((a, b) => new Date(b.weekStart).getTime() - new Date(a.weekStart).getTime())\n                            .map((week) => (\n                              <div key={week.weekKey} className=\"border rounded-lg\">\n                                <div \n                                  className=\"flex justify-between items-center p-3 cursor-pointer hover:bg-muted/50\"\n                                  onClick={() => setExpandedLegacyWeek(expandedLegacyWeek === week.weekKey ? null : week.weekKey)}\n                                >\n                                  <div className=\"flex items-center gap-2\">\n                                    {expandedLegacyWeek === week.weekKey ? (\n                                      <ChevronDown className=\"w-4 h-4 text-muted-foreground\" />\n                                    ) : (\n                                      <ChevronRight className=\"w-4 h-4 text-muted-foreground\" />\n                                    )}\n                                    <div>\n                                      <p className=\"font-medium\">\n                                        Week of {format(week.weekStart, \"MMM dd\")} - {format(week.weekEnd, \"MMM dd, yyyy\")}\n                                      </p>\n                                      <p className=\"text-sm text-muted-foreground\">\n                                        {week.entries.length} session{week.entries.length !== 1 ? \"s\" : \"\"}\n                                      </p>\n                                    </div>\n                                  </div>\n                                  <div className=\"flex items-center gap-4 text-sm\">\n                                    <span className=\"text-muted-foreground\">{week.totalHours.toFixed(1)}h</span>\n                                    <span className=\"text-green-600 font-medium\" title=\"Tutor Pay\">Â£{week.totalEarnings.toFixed(2)}</span>\n                                    <span className=\"text-blue-600 font-medium\" title=\"Parent Billing\">Â£{week.totalBilling.toFixed(2)}</span>\n                                    <Badge\n                                      variant={\n                                        week.entries.every(e => e.status === \"approved\") ? \"default\" :\n                                        week.entries.some(e => e.status === \"rejected\") ? \"destructive\" :\n                                        \"secondary\"\n                                      }\n                                      className=\"text-xs\"\n                                    >\n                                      {week.entries.every(e => e.status === \"approved\") ? \"Approved\" :\n                                       week.entries.some(e => e.status === \"rejected\") ? \"Rejected\" :\n                                       week.entries.some(e => e.status === \"pending\") ? \"Pending\" : \"Draft\"}\n                                    </Badge>\n                                  </div>\n                                </div>\n                                \n                                {expandedLegacyWeek === week.weekKey && (\n                                  <div className=\"border-t p-3 space-y-4\">\n                                    <Table>\n                                      <TableHeader>\n                                        <TableRow>\n                                          <TableHead>Date</TableHead>\n                                          <TableHead>Student</TableHead>\n                                          <TableHead>Subject</TableHead>\n                                          <TableHead className=\"text-right\">Duration</TableHead>\n                                          <TableHead className=\"text-right\">Tutor Pay</TableHead>\n                                          <TableHead className=\"text-right\">Parent Bill</TableHead>\n                                          <TableHead>Notes</TableHead>\n                                        </TableRow>\n                                      </TableHeader>\n                                      <TableBody>\n                                        {week.entries\n                                          .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                                          .map((entry) => (\n                                            <TableRow key={entry.id}>\n                                              <TableCell>{format(new Date(entry.date), \"EEE, MMM dd\")}</TableCell>\n                                              <TableCell>{entry.student.name}</TableCell>\n                                              <TableCell>{entry.student.subject}</TableCell>\n                                              <TableCell className=\"text-right\">{entry.duration}h</TableCell>\n                                              <TableCell className=\"text-right\">\n                                                Â£{parseFloat(entry.tutorEarnings.toString()).toFixed(2)}\n                                              </TableCell>\n                                              <TableCell className=\"text-right\">\n                                                Â£{parseFloat(entry.parentBilling.toString()).toFixed(2)}\n                                              </TableCell>\n                                              <TableCell className=\"max-w-[200px]\">\n                                                {entry.notes ? (\n                                                  <div className=\"flex items-start\">\n                                                    <FileText className=\"w-4 h-4 mr-1 mt-0.5 text-muted-foreground flex-shrink-0\" />\n                                                    <span className=\"text-sm text-muted-foreground truncate\" title={entry.notes}>\n                                                      {entry.notes}\n                                                    </span>\n                                                  </div>\n                                                ) : (\n                                                  <span className=\"text-muted-foreground text-sm\">â€”</span>\n                                                )}\n                                              </TableCell>\n                                            </TableRow>\n                                          ))}\n                                      </TableBody>\n                                      <TableFooter>\n                                        <TableRow>\n                                          <TableCell colSpan={3} className=\"font-medium\">Week Total</TableCell>\n                                          <TableCell className=\"text-right font-medium\">{week.totalHours.toFixed(1)}h</TableCell>\n                                          <TableCell className=\"text-right font-bold text-green-600\">Â£{week.totalEarnings.toFixed(2)}</TableCell>\n                                          <TableCell className=\"text-right font-bold text-blue-600\">Â£{week.totalBilling.toFixed(2)}</TableCell>\n                                          <TableCell></TableCell>\n                                        </TableRow>\n                                      </TableFooter>\n                                    </Table>\n                                    \n                                    {/* Status History for this week */}\n                                    {week.entries[0]?.weeklyTimesheetId && (\n                                      <StatusHistorySection \n                                        timesheetId={week.entries[0].weeklyTimesheetId}\n                                        isExpanded={true}\n                                        onToggle={() => {}}\n                                      />\n                                    )}\n                                  </div>\n                                )}\n                              </div>\n                            ))}\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                ));\n              })()}\n            </div>\n          </TabsContent>\n\n          {/* Invoices & Payments Tab */}\n          <TabsContent value=\"invoices\" className=\"p-6\">\n            <div className=\"flex justify-between items-center mb-6\">\n              <h3 className=\"text-lg font-semibold\">Invoices & Payment Management</h3>\n              <div className=\"flex space-x-2\">\n                <Button onClick={() => setIsCreateAdhocInvoiceOpen(true)} data-testid=\"button-create-adhoc-invoice\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Create Adhoc Invoice\n                </Button>\n                <Button variant=\"outline\" data-testid=\"button-export-quickbooks\">\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Export to QuickBooks\n                </Button>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              {/* Tutor Invoices - This Week */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center\">\n                    <HandHeart className=\"w-5 h-5 text-primary mr-2\" />\n                    Tutor Invoices - This Week\n                  </CardTitle>\n                  <CardDescription>\n                    Invoices submitted by tutors for payment this week\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {tutorInvoicesLoading ? (\n                    <div className=\"space-y-3\">\n                      {[...Array(3)].map((_, i) => (\n                        <Skeleton key={i} className=\"h-16 w-full\" />\n                      ))}\n                    </div>\n                  ) : tutorInvoicesThisWeek.length === 0 ? (\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <HandHeart className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                      <p>No tutor invoices submitted this week</p>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {tutorInvoicesThisWeek.map((invoice) => (\n                        <div \n                          key={invoice.id} \n                          className=\"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50\"\n                          data-testid={`tutor-invoice-${invoice.id}`}\n                        >\n                          <div className=\"flex items-center space-x-3\">\n                            <div className=\"w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center\">\n                              <GraduationCap className=\"w-5 h-5 text-primary\" />\n                            </div>\n                            <div>\n                              <p className=\"font-medium\" data-testid={`text-tutor-invoice-name-${invoice.id}`}>\n                                {invoice.tutor?.firstName} {invoice.tutor?.lastName}\n                              </p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {invoice.submittedAt ? new Date(invoice.submittedAt).toLocaleDateString() : \"N/A\"} â€¢ {invoice.invoiceNumber}\n                              </p>\n                            </div>\n                          </div>\n                          <div className=\"text-right\">\n                            <p className=\"font-bold text-lg text-green-600\" data-testid={`text-tutor-invoice-amount-${invoice.id}`}>\n                              Â£{parseFloat(invoice.amount).toFixed(2)}\n                            </p>\n                            <Badge \n                              variant={invoice.status === \"paid\" ? \"default\" : invoice.status === \"approved\" ? \"secondary\" : \"outline\"}\n                              className={invoice.status === \"paid\" ? \"bg-green-100 text-green-800\" : \"\"}\n                            >\n                              {invoice.status}\n                            </Badge>\n                          </div>\n                        </div>\n                      ))}\n                      {tutorInvoicesThisWeek.length > 0 && (\n                        <div className=\"pt-3 border-t\">\n                          <div className=\"flex justify-between items-center\">\n                            <span className=\"font-medium\">Total This Week:</span>\n                            <span className=\"font-bold text-lg text-green-600\">\n                              Â£{tutorInvoicesThisWeek.reduce((sum, inv) => sum + parseFloat(inv.amount), 0).toFixed(2)}\n                            </span>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              {/* Parent Invoices with Outstanding/Paid Toggle */}\n              <Card>\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center\">\n                        <File className=\"w-5 h-5 text-chart-1 mr-2\" />\n                        Parent Invoices\n                      </CardTitle>\n                      <CardDescription>\n                        Invoices sent to parents for tutoring sessions\n                      </CardDescription>\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Button\n                        variant={parentInvoiceView === \"outstanding\" ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => setParentInvoiceView(\"outstanding\")}\n                        data-testid=\"button-view-outstanding\"\n                      >\n                        Outstanding ({parentInvoices.filter(inv => inv.status !== \"paid\" && inv.status !== \"cancelled\").length})\n                      </Button>\n                      <Button\n                        variant={parentInvoiceView === \"paid\" ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => setParentInvoiceView(\"paid\")}\n                        data-testid=\"button-view-paid\"\n                      >\n                        Paid/Settled ({parentInvoices.filter(inv => inv.status === \"paid\").length})\n                      </Button>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {parentInvoicesLoading ? (\n                    <div className=\"space-y-3\">\n                      {[...Array(3)].map((_, i) => (\n                        <Skeleton key={i} className=\"h-16 w-full\" />\n                      ))}\n                    </div>\n                  ) : parentInvoiceView === \"outstanding\" ? (\n                    // Outstanding Invoices View\n                    (() => {\n                      const outstandingInvoices = parentInvoices.filter(inv => inv.status !== \"paid\" && inv.status !== \"cancelled\");\n                      return outstandingInvoices.length === 0 ? (\n                        <div className=\"text-center py-8 text-muted-foreground\">\n                          <Check className=\"w-8 h-8 mx-auto mb-2 text-green-500\" />\n                          <p>No outstanding invoices</p>\n                          <p className=\"text-sm mt-1\">All invoices have been paid!</p>\n                        </div>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {outstandingInvoices.map((invoice) => (\n                            <div \n                              key={invoice.id} \n                              className=\"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50\"\n                              data-testid={`parent-invoice-${invoice.id}`}\n                            >\n                              <div>\n                                <p className=\"font-bold text-base\" data-testid={`text-parent-invoice-student-${invoice.id}`}>\n                                  {invoice.student?.name || \"Unknown Student\"}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\" data-testid={`text-parent-invoice-number-${invoice.id}`}>\n                                  {invoice.invoiceNumber}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  Sent: {invoice.sentAt ? new Date(invoice.sentAt).toLocaleDateString() : (invoice.createdAt ? new Date(invoice.createdAt).toLocaleDateString() : \"N/A\")} â€¢ {invoice.sessionsIncluded} sessions â€¢ Due {invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString() : \"N/A\"}\n                                </p>\n                              </div>\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"text-right\">\n                                  <p className=\"font-bold text-lg text-blue-600\" data-testid={`text-parent-invoice-amount-${invoice.id}`}>\n                                    Â£{parseFloat(invoice.amount).toFixed(2)}\n                                  </p>\n                                  <Badge \n                                    variant={invoice.status === \"overdue\" ? \"destructive\" : invoice.status === \"sent\" ? \"secondary\" : \"outline\"}\n                                    className={invoice.status === \"overdue\" ? \"bg-red-100 text-red-800\" : \"\"}\n                                  >\n                                    {invoice.status}\n                                  </Badge>\n                                </div>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => {\n                                    setEditingParentInvoice(invoice);\n                                    setParentInvoiceFormData({\n                                      amount: invoice.amount,\n                                      sessionsIncluded: invoice.sessionsIncluded || 0,\n                                      selectedRateId: \"\",\n                                      status: invoice.status as any,\n                                      notes: invoice.notes || \"\",\n                                    });\n                                    setIsEditParentInvoiceOpen(true);\n                                  }}\n                                  data-testid={`button-edit-parent-invoice-${invoice.id}`}\n                                >\n                                  <Edit className=\"w-4 h-4\" />\n                                </Button>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      );\n                    })()\n                  ) : (\n                    // Paid/Settled Invoices View with Filters\n                    (() => {\n                      const paidInvoices = parentInvoices.filter(inv => inv.status === \"paid\");\n                      \n                      // Apply filters\n                      const filteredPaidInvoices = paidInvoices.filter(inv => {\n                        // Student name filter\n                        if (paidInvoiceFilters.studentName && \n                            !inv.student?.name?.toLowerCase().includes(paidInvoiceFilters.studentName.toLowerCase())) {\n                          return false;\n                        }\n                        // Parent name filter (from student's parent info)\n                        if (paidInvoiceFilters.parentName) {\n                          const parentName = `${inv.student?.parentName || \"\"} ${(inv.student as any)?.parentSurname || \"\"}`.toLowerCase();\n                          if (!parentName.includes(paidInvoiceFilters.parentName.toLowerCase())) {\n                            return false;\n                          }\n                        }\n                        // Tutor name filter\n                        if (paidInvoiceFilters.tutorName) {\n                          const tutorName = `${(inv.student as any)?.tutor?.firstName || \"\"} ${(inv.student as any)?.tutor?.lastName || \"\"}`.toLowerCase();\n                          if (!tutorName.includes(paidInvoiceFilters.tutorName.toLowerCase())) {\n                            return false;\n                          }\n                        }\n                        // Month filter\n                        if (paidInvoiceFilters.month) {\n                          const invoiceDate = inv.paidAt ? new Date(inv.paidAt) : (inv.createdAt ? new Date(inv.createdAt) : null);\n                          if (!invoiceDate || (invoiceDate.getMonth() + 1).toString() !== paidInvoiceFilters.month) {\n                            return false;\n                          }\n                        }\n                        // Year filter\n                        if (paidInvoiceFilters.year) {\n                          const invoiceDate = inv.paidAt ? new Date(inv.paidAt) : (inv.createdAt ? new Date(inv.createdAt) : null);\n                          if (!invoiceDate || invoiceDate.getFullYear().toString() !== paidInvoiceFilters.year) {\n                            return false;\n                          }\n                        }\n                        // Amount filters\n                        const amount = parseFloat(inv.amount);\n                        if (paidInvoiceFilters.minAmount && amount < parseFloat(paidInvoiceFilters.minAmount)) {\n                          return false;\n                        }\n                        if (paidInvoiceFilters.maxAmount && amount > parseFloat(paidInvoiceFilters.maxAmount)) {\n                          return false;\n                        }\n                        return true;\n                      });\n                      \n                      return (\n                        <div className=\"space-y-4\">\n                          {/* Filters */}\n                          <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2 p-3 bg-muted/30 rounded-lg\">\n                            <Input\n                              placeholder=\"Student name\"\n                              value={paidInvoiceFilters.studentName}\n                              onChange={(e) => setPaidInvoiceFilters(prev => ({ ...prev, studentName: e.target.value }))}\n                              className=\"h-8 text-sm\"\n                              data-testid=\"filter-student-name\"\n                            />\n                            <Input\n                              placeholder=\"Parent name\"\n                              value={paidInvoiceFilters.parentName}\n                              onChange={(e) => setPaidInvoiceFilters(prev => ({ ...prev, parentName: e.target.value }))}\n                              className=\"h-8 text-sm\"\n                              data-testid=\"filter-parent-name\"\n                            />\n                            <Input\n                              placeholder=\"Tutor name\"\n                              value={paidInvoiceFilters.tutorName}\n                              onChange={(e) => setPaidInvoiceFilters(prev => ({ ...prev, tutorName: e.target.value }))}\n                              className=\"h-8 text-sm\"\n                              data-testid=\"filter-tutor-name\"\n                            />\n                            <Select\n                              value={paidInvoiceFilters.month || \"all\"}\n                              onValueChange={(value) => setPaidInvoiceFilters(prev => ({ ...prev, month: value === \"all\" ? \"\" : value }))}\n                            >\n                              <SelectTrigger className=\"h-8 text-sm\" data-testid=\"filter-month\">\n                                <SelectValue placeholder=\"Month\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"all\">All Months</SelectItem>\n                                {monthNames.map((month, index) => (\n                                  <SelectItem key={index + 1} value={(index + 1).toString()}>{month}</SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <Input\n                              placeholder=\"Year\"\n                              type=\"number\"\n                              value={paidInvoiceFilters.year}\n                              onChange={(e) => setPaidInvoiceFilters(prev => ({ ...prev, year: e.target.value }))}\n                              className=\"h-8 text-sm\"\n                              data-testid=\"filter-year\"\n                            />\n                            <Input\n                              placeholder=\"Min Â£\"\n                              type=\"number\"\n                              value={paidInvoiceFilters.minAmount}\n                              onChange={(e) => setPaidInvoiceFilters(prev => ({ ...prev, minAmount: e.target.value }))}\n                              className=\"h-8 text-sm\"\n                              data-testid=\"filter-min-amount\"\n                            />\n                            <Input\n                              placeholder=\"Max Â£\"\n                              type=\"number\"\n                              value={paidInvoiceFilters.maxAmount}\n                              onChange={(e) => setPaidInvoiceFilters(prev => ({ ...prev, maxAmount: e.target.value }))}\n                              className=\"h-8 text-sm\"\n                              data-testid=\"filter-max-amount\"\n                            />\n                          </div>\n                          \n                          {/* Clear Filters Button */}\n                          {(paidInvoiceFilters.studentName || paidInvoiceFilters.parentName || paidInvoiceFilters.tutorName || \n                            paidInvoiceFilters.month || paidInvoiceFilters.year || paidInvoiceFilters.minAmount || paidInvoiceFilters.maxAmount) && (\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => setPaidInvoiceFilters({\n                                studentName: \"\",\n                                parentName: \"\",\n                                tutorName: \"\",\n                                month: \"\",\n                                year: \"\",\n                                minAmount: \"\",\n                                maxAmount: \"\",\n                              })}\n                              className=\"text-muted-foreground\"\n                              data-testid=\"button-clear-filters\"\n                            >\n                              <X className=\"w-3 h-3 mr-1\" /> Clear Filters\n                            </Button>\n                          )}\n                          \n                          {/* Results */}\n                          <p className=\"text-sm text-muted-foreground\">\n                            Showing {filteredPaidInvoices.length} of {paidInvoices.length} paid invoices\n                          </p>\n                          \n                          {filteredPaidInvoices.length === 0 ? (\n                            <div className=\"text-center py-8 text-muted-foreground\">\n                              <File className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                              <p>No paid invoices found</p>\n                              {paidInvoices.length > 0 && (\n                                <p className=\"text-sm mt-1\">Try adjusting your filters</p>\n                              )}\n                            </div>\n                          ) : (\n                            <div className=\"overflow-x-auto\">\n                              <Table>\n                                <TableHeader>\n                                  <TableRow>\n                                    <TableHead>Invoice #</TableHead>\n                                    <TableHead>Student</TableHead>\n                                    <TableHead>Parent</TableHead>\n                                    <TableHead>Paid Date</TableHead>\n                                    <TableHead>Sessions</TableHead>\n                                    <TableHead className=\"text-right\">Amount</TableHead>\n                                    <TableHead>Actions</TableHead>\n                                  </TableRow>\n                                </TableHeader>\n                                <TableBody>\n                                  {filteredPaidInvoices.map((invoice) => (\n                                    <TableRow key={invoice.id} data-testid={`paid-invoice-${invoice.id}`}>\n                                      <TableCell className=\"font-medium\">{invoice.invoiceNumber}</TableCell>\n                                      <TableCell>{invoice.student?.name || \"Unknown\"}</TableCell>\n                                      <TableCell>\n                                        {invoice.student?.parentName || \"\"} {(invoice.student as any)?.parentSurname || \"\"}\n                                      </TableCell>\n                                      <TableCell>\n                                        {invoice.paidAt ? new Date(invoice.paidAt).toLocaleDateString() : (invoice.createdAt ? new Date(invoice.createdAt).toLocaleDateString() : \"N/A\")}\n                                      </TableCell>\n                                      <TableCell>{invoice.sessionsIncluded}</TableCell>\n                                      <TableCell className=\"text-right font-bold text-green-600\">\n                                        Â£{parseFloat(invoice.amount).toFixed(2)}\n                                      </TableCell>\n                                      <TableCell>\n                                        <Button\n                                          variant=\"ghost\"\n                                          size=\"sm\"\n                                          onClick={() => {\n                                            setEditingParentInvoice(invoice);\n                                            setParentInvoiceFormData({\n                                              amount: invoice.amount,\n                                              sessionsIncluded: invoice.sessionsIncluded || 0,\n                                              selectedRateId: \"\",\n                                              status: invoice.status as any,\n                                              notes: invoice.notes || \"\",\n                                            });\n                                            setIsEditParentInvoiceOpen(true);\n                                          }}\n                                          data-testid={`button-view-paid-invoice-${invoice.id}`}\n                                        >\n                                          <Eye className=\"w-4 h-4\" />\n                                        </Button>\n                                      </TableCell>\n                                    </TableRow>\n                                  ))}\n                                </TableBody>\n                                <TableFooter>\n                                  <TableRow>\n                                    <TableCell colSpan={5} className=\"font-bold\">Total</TableCell>\n                                    <TableCell className=\"text-right font-bold text-green-600\">\n                                      Â£{filteredPaidInvoices.reduce((sum, inv) => sum + parseFloat(inv.amount), 0).toFixed(2)}\n                                    </TableCell>\n                                    <TableCell></TableCell>\n                                  </TableRow>\n                                </TableFooter>\n                              </Table>\n                            </div>\n                          )}\n                        </div>\n                      );\n                    })()\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Adhoc Invoices Section */}\n            <Card className=\"mt-6\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <FileText className=\"w-5 h-5 text-orange-500 mr-2\" />\n                  Adhoc Invoices\n                </CardTitle>\n                <CardDescription>\n                  Manual invoices not tied to students - for one-off payments\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                {adhocInvoicesLoading ? (\n                  <div className=\"space-y-3\">\n                    {[...Array(3)].map((_, i) => (\n                      <Skeleton key={i} className=\"h-16 w-full\" />\n                    ))}\n                  </div>\n                ) : adhocInvoices.length === 0 ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <FileText className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                    <p>No adhoc invoices yet</p>\n                    <p className=\"text-sm mt-1\">Click \"Create Adhoc Invoice\" to create a manual invoice</p>\n                  </div>\n                ) : (\n                  <div className=\"overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Invoice #</TableHead>\n                          <TableHead>Parent Name</TableHead>\n                          <TableHead>Reason</TableHead>\n                          <TableHead>Amount</TableHead>\n                          <TableHead>Due Date</TableHead>\n                          <TableHead>Status</TableHead>\n                          <TableHead>Actions</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {adhocInvoices.map((invoice) => (\n                          <TableRow key={invoice.id} data-testid={`adhoc-invoice-${invoice.id}`}>\n                            <TableCell className=\"font-medium\">{invoice.invoiceNumber}</TableCell>\n                            <TableCell>{invoice.parentFirstName} {invoice.parentSurname}</TableCell>\n                            <TableCell className=\"max-w-[200px] truncate\">{invoice.reason}</TableCell>\n                            <TableCell className=\"font-bold text-blue-600\">Â£{parseFloat(invoice.amount).toFixed(2)}</TableCell>\n                            <TableCell>{invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString() : \"N/A\"}</TableCell>\n                            <TableCell>\n                              <Badge \n                                variant={invoice.status === \"paid\" ? \"default\" : invoice.status === \"sent\" ? \"secondary\" : invoice.status === \"approved\" ? \"secondary\" : \"outline\"}\n                                className={invoice.status === \"paid\" ? \"bg-green-100 text-green-800\" : invoice.status === \"approved\" ? \"bg-blue-100 text-blue-800\" : invoice.status === \"overdue\" ? \"bg-red-100 text-red-800\" : \"\"}\n                              >\n                                {invoice.status}\n                              </Badge>\n                            </TableCell>\n                            <TableCell>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => {\n                                  setEditingAdhocInvoice(invoice);\n                                  setAdhocInvoiceFormData({\n                                    parentFirstName: invoice.parentFirstName,\n                                    parentSurname: invoice.parentSurname,\n                                    amount: invoice.amount,\n                                    reason: invoice.reason,\n                                    dueDate: invoice.dueDate ? new Date(invoice.dueDate).toISOString().split('T')[0] : \"\",\n                                    status: invoice.status as \"draft\" | \"sent\" | \"paid\" | \"partial\" | \"overdue\" | \"cancelled\",\n                                    notes: invoice.notes || \"\",\n                                  });\n                                  setIsEditAdhocInvoiceOpen(true);\n                                }}\n                                data-testid={`button-edit-adhoc-${invoice.id}`}\n                              >\n                                <Edit className=\"w-4 h-4\" />\n                              </Button>\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* All Tutor Invoices Table */}\n            <Card className=\"mt-6\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <FileText className=\"w-5 h-5 text-primary mr-2\" />\n                  All Tutor Invoices\n                </CardTitle>\n                <CardDescription>\n                  Complete history of tutor payment requests\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                {allTutorInvoices.length === 0 ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <FileText className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                    <p>No tutor invoices have been submitted yet</p>\n                  </div>\n                ) : (\n                  <div className=\"overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Invoice #</TableHead>\n                          <TableHead>Tutor</TableHead>\n                          <TableHead>Submitted</TableHead>\n                          <TableHead className=\"text-right\">Amount</TableHead>\n                          <TableHead className=\"text-center\">Status</TableHead>\n                          <TableHead>Notes</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {allTutorInvoices.map((invoice) => (\n                          <TableRow key={invoice.id} data-testid={`row-tutor-invoice-${invoice.id}`}>\n                            <TableCell className=\"font-mono text-sm\">\n                              {invoice.invoiceNumber}\n                            </TableCell>\n                            <TableCell>\n                              {invoice.tutor?.firstName} {invoice.tutor?.lastName}\n                            </TableCell>\n                            <TableCell>\n                              {invoice.submittedAt ? new Date(invoice.submittedAt).toLocaleDateString() : \"N/A\"}\n                            </TableCell>\n                            <TableCell className=\"text-right font-bold text-green-600\">\n                              Â£{parseFloat(invoice.amount).toFixed(2)}\n                            </TableCell>\n                            <TableCell className=\"text-center\">\n                              <Badge \n                                variant={invoice.status === \"paid\" ? \"default\" : invoice.status === \"approved\" ? \"secondary\" : \"outline\"}\n                                className={invoice.status === \"paid\" ? \"bg-green-100 text-green-800\" : \"\"}\n                              >\n                                {invoice.status}\n                              </Badge>\n                            </TableCell>\n                            <TableCell className=\"max-w-[200px] truncate\">\n                              {invoice.notes || \"-\"}\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* Archive Tab */}\n          <TabsContent value=\"archive\" className=\"p-4 sm:p-6\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6\">\n              <h3 className=\"text-lg font-semibold\">Archive - Ex-Students & Ex-Tutors</h3>\n              <div className=\"flex gap-2\">\n                <Button\n                  variant={archiveView === \"students\" ? \"default\" : \"outline\"}\n                  onClick={() => setArchiveView(\"students\")}\n                  data-testid=\"button-archive-students\"\n                >\n                  <GraduationCap className=\"w-4 h-4 mr-2\" />\n                  Ex-Students\n                </Button>\n                <Button\n                  variant={archiveView === \"tutors\" ? \"default\" : \"outline\"}\n                  onClick={() => setArchiveView(\"tutors\")}\n                  data-testid=\"button-archive-tutors\"\n                >\n                  <UserX className=\"w-4 h-4 mr-2\" />\n                  Ex-Tutors\n                </Button>\n              </div>\n            </div>\n\n            {archiveView === \"students\" && (\n              <div className=\"overflow-x-auto mobile-scroll\">\n                <Table className=\"min-w-[800px]\">\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead className=\"w-10\"></TableHead>\n                      <TableHead>Student Name</TableHead>\n                      <TableHead>Parent First Name</TableHead>\n                      <TableHead>Parent Surname</TableHead>\n                      <TableHead>Tutor</TableHead>\n                      <TableHead className=\"text-center\">Total Sessions</TableHead>\n                      <TableHead className=\"text-right\">Parent Rate</TableHead>\n                      <TableHead className=\"text-center\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {archivedStudentsLoading ? (\n                      [...Array(3)].map((_, i) => (\n                        <TableRow key={i}>\n                          <TableCell><Skeleton className=\"h-4 w-4\" /></TableCell>\n                          <TableCell><Skeleton className=\"h-4 w-24\" /></TableCell>\n                          <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                          <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                          <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                          <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                          <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                          <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                        </TableRow>\n                      ))\n                    ) : archivedStudents.length === 0 ? (\n                      <TableRow>\n                        <TableCell colSpan={8} className=\"text-center py-12\">\n                          <Archive className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50\" />\n                          <p className=\"text-muted-foreground\">No archived students found</p>\n                          <p className=\"text-sm text-muted-foreground mt-1\">\n                            Students will appear here when they are archived\n                          </p>\n                        </TableCell>\n                      </TableRow>\n                    ) : (\n                      archivedStudents.map((student) => {\n                        const isExpanded = expandedArchivedStudents.has(student.id);\n                        const parentFirstName = student.parentName || \"-\";\n                        const parentSurname = (student as any).parentSurname || \"-\";\n                        \n                        return (\n                          <>\n                            <TableRow \n                              key={student.id} \n                              data-testid={`row-archived-student-${student.id}`}\n                              className=\"cursor-pointer hover:bg-muted/50\"\n                              onClick={() => toggleArchivedStudentExpand(student.id)}\n                            >\n                              <TableCell className=\"w-10\">\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"h-6 w-6 p-0\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    toggleArchivedStudentExpand(student.id);\n                                  }}\n                                  data-testid={`button-expand-archived-student-${student.id}`}\n                                >\n                                  {isExpanded ? (\n                                    <ChevronDown className=\"h-4 w-4\" />\n                                  ) : (\n                                    <ChevronRight className=\"h-4 w-4\" />\n                                  )}\n                                </Button>\n                              </TableCell>\n                              <TableCell className=\"font-medium\" data-testid={`text-archived-student-name-${student.id}`}>\n                                {student.name}\n                              </TableCell>\n                              <TableCell>{parentFirstName}</TableCell>\n                              <TableCell>{parentSurname}</TableCell>\n                              <TableCell>\n                                {student.tutor?.firstName && student.tutor?.lastName\n                                  ? `${student.tutor.firstName} ${student.tutor.lastName}`\n                                  : \"-\"}\n                              </TableCell>\n                              <TableCell className=\"text-center\">\n                                <Badge variant=\"secondary\" className=\"font-medium\">\n                                  {student.sessionCount}\n                                </Badge>\n                              </TableCell>\n                              <TableCell className=\"text-right\">\n                                ${parseFloat((student.parentRate || 0).toString()).toFixed(2)}/hr\n                              </TableCell>\n                              <TableCell className=\"text-center\">\n                                <div className=\"flex justify-center space-x-1\" onClick={(e) => e.stopPropagation()}>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => setSelectedArchivedStudent(student)}\n                                    data-testid={`button-view-archived-student-${student.id}`}\n                                    title=\"View details\"\n                                  >\n                                    <FileText className=\"w-4 h-4\" />\n                                  </Button>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => restoreStudentMutation.mutate(student.id)}\n                                    disabled={restoreStudentMutation.isPending}\n                                    data-testid={`button-restore-student-${student.id}`}\n                                    title=\"Restore student\"\n                                  >\n                                    <RotateCcw className=\"w-4 h-4\" />\n                                  </Button>\n                                  <AlertDialog>\n                                    <AlertDialogTrigger asChild>\n                                      <Button\n                                        variant=\"ghost\"\n                                        size=\"sm\"\n                                        className=\"text-red-600 hover:text-red-700 hover:bg-red-100\"\n                                        data-testid={`button-delete-student-${student.id}`}\n                                        title=\"Permanently delete\"\n                                      >\n                                        <Trash2 className=\"w-4 h-4\" />\n                                      </Button>\n                                    </AlertDialogTrigger>\n                                    <AlertDialogContent>\n                                      <AlertDialogHeader>\n                                        <AlertDialogTitle>Permanently Delete Student?</AlertDialogTitle>\n                                        <AlertDialogDescription>\n                                          This action cannot be undone. This will permanently delete {student.name} and all associated records including session history.\n                                        </AlertDialogDescription>\n                                      </AlertDialogHeader>\n                                      <AlertDialogFooter>\n                                        <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                        <AlertDialogAction\n                                          className=\"bg-red-600 hover:bg-red-700\"\n                                          onClick={() => deleteStudentMutation.mutate(student.id)}\n                                        >\n                                          {deleteStudentMutation.isPending ? \"Deleting...\" : \"Delete Permanently\"}\n                                        </AlertDialogAction>\n                                      </AlertDialogFooter>\n                                    </AlertDialogContent>\n                                  </AlertDialog>\n                                </div>\n                              </TableCell>\n                            </TableRow>\n                            {isExpanded && (\n                              <TableRow key={`${student.id}-details`} className=\"bg-muted/30\">\n                                <TableCell colSpan={8} className=\"py-4\">\n                                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Subject:</span>\n                                      <p className=\"mt-1\">{student.subject}</p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Exam Type:</span>\n                                      <p className=\"mt-1\">{(student as any).examType || \"-\"}</p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Class Type:</span>\n                                      <p className=\"mt-1 capitalize\">{student.classType}</p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Parent Name:</span>\n                                      <p className=\"mt-1\">{student.parentName || \"-\"}</p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Parent Email:</span>\n                                      <p className=\"mt-1\">{student.parentEmail || \"-\"}</p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Parent Phone:</span>\n                                      <p className=\"mt-1\">{student.parentPhone || \"-\"}</p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Tutor Rate:</span>\n                                      <p className=\"mt-1\">${parseFloat((student.tutorRate || 0).toString()).toFixed(2)}/hr</p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Period:</span>\n                                      <p className=\"mt-1\">\n                                        {student.startYear || student.endYear\n                                          ? `${student.startYear || \"?\"} - ${student.endYear || \"?\"}`\n                                          : \"-\"}\n                                      </p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Exam Date:</span>\n                                      <p className=\"mt-1\">\n                                        {student.examMonth && student.examYear\n                                          ? `${monthNames[student.examMonth - 1]} ${student.examYear}`\n                                          : \"-\"}\n                                      </p>\n                                    </div>\n                                    <div>\n                                      <span className=\"font-medium text-muted-foreground\">Sessions Booked:</span>\n                                      <p className=\"mt-1\">{student.sessionsBooked || 0}</p>\n                                    </div>\n                                  </div>\n                                  <div className=\"grid grid-cols-3 gap-4 mt-4\">\n                                    <div className=\"p-3 bg-muted/50 rounded-lg text-center\">\n                                      <p className=\"text-xs text-muted-foreground mb-1\">Total Billed</p>\n                                      <p className=\"font-semibold text-primary\" data-testid={`text-archived-student-billed-${student.id}`}>\n                                        ${(student.totalBilled || 0).toFixed(2)}\n                                      </p>\n                                    </div>\n                                    <div className=\"p-3 bg-green-50 dark:bg-green-950 rounded-lg text-center\">\n                                      <p className=\"text-xs text-muted-foreground mb-1\">Received</p>\n                                      <p className=\"font-semibold text-green-600\" data-testid={`text-archived-student-received-${student.id}`}>\n                                        ${(student.totalReceived || 0).toFixed(2)}\n                                      </p>\n                                    </div>\n                                    <div className=\"p-3 bg-red-50 dark:bg-red-950 rounded-lg text-center\">\n                                      <p className=\"text-xs text-muted-foreground mb-1\">Outstanding</p>\n                                      <p className=\"font-semibold text-red-600\" data-testid={`text-archived-student-outstanding-${student.id}`}>\n                                        ${(student.totalOutstanding || 0).toFixed(2)}\n                                      </p>\n                                    </div>\n                                  </div>\n                                </TableCell>\n                              </TableRow>\n                            )}\n                          </>\n                        );\n                      })\n                    )}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n\n            {archiveView === \"tutors\" && (\n              <div className=\"space-y-4\">\n                {archivedTutorsLoading ? (\n                  <div className=\"space-y-3\">\n                    <Skeleton className=\"h-24 w-full\" />\n                    <Skeleton className=\"h-24 w-full\" />\n                    <Skeleton className=\"h-24 w-full\" />\n                  </div>\n                ) : archivedTutors.length === 0 ? (\n                  <Card>\n                    <CardContent className=\"text-center py-12\">\n                      <UserX className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50\" />\n                      <p className=\"text-muted-foreground\">No archived tutors found</p>\n                      <p className=\"text-sm text-muted-foreground mt-1\">\n                        Tutors will appear here when they are archived\n                      </p>\n                    </CardContent>\n                  </Card>\n                ) : (\n                  <div className=\"grid gap-4\">\n                    {archivedTutors.map((tutor) => (\n                      <Card key={tutor.id} data-testid={`card-archived-tutor-${tutor.id}`}>\n                        <CardContent className=\"p-4\">\n                          <div className=\"flex flex-col lg:flex-row lg:items-center justify-between gap-4\">\n                            <div className=\"flex-1\">\n                              <div className=\"flex items-center gap-3 mb-2\">\n                                <h4 className=\"font-semibold text-lg\" data-testid={`text-archived-tutor-name-${tutor.id}`}>\n                                  {tutor.firstName} {tutor.lastName}\n                                </h4>\n                                <Badge variant={tutor.role === \"admin\" ? \"default\" : \"secondary\"}>\n                                  {tutor.role === \"admin\" ? \"Admin\" : \"Tutor\"}\n                                </Badge>\n                              </div>\n                              <div className=\"text-sm text-muted-foreground space-y-1\">\n                                {tutor.email && <p><strong>Email:</strong> {tutor.email}</p>}\n                                <p><strong>Total Sessions:</strong> {tutor.sessionCount}</p>\n                                <p><strong>Students Taught:</strong> {tutor.studentCount}</p>\n                                {(tutor.startYear || tutor.endYear) && (\n                                  <p>\n                                    <strong>Period:</strong> {tutor.startYear || \"?\"} - {tutor.endYear || \"?\"}\n                                  </p>\n                                )}\n                              </div>\n                            </div>\n\n                            <div className=\"grid grid-cols-3 gap-4 text-center\">\n                              <div className=\"p-3 bg-muted/50 rounded-lg\">\n                                <p className=\"text-xs text-muted-foreground mb-1\">Total Earnings</p>\n                                <p className=\"font-semibold text-primary\" data-testid={`text-archived-tutor-earnings-${tutor.id}`}>\n                                  ${(tutor.totalEarnings || 0).toFixed(2)}\n                                </p>\n                              </div>\n                              <div className=\"p-3 bg-green-50 dark:bg-green-950 rounded-lg\">\n                                <p className=\"text-xs text-muted-foreground mb-1\">Paid Out</p>\n                                <p className=\"font-semibold text-green-600\" data-testid={`text-archived-tutor-paid-${tutor.id}`}>\n                                  ${(tutor.totalPaid || 0).toFixed(2)}\n                                </p>\n                              </div>\n                              <div className=\"p-3 bg-orange-50 dark:bg-orange-950 rounded-lg\">\n                                <p className=\"text-xs text-muted-foreground mb-1\">Outstanding</p>\n                                <p className=\"font-semibold text-orange-600\" data-testid={`text-archived-tutor-outstanding-${tutor.id}`}>\n                                  ${(tutor.totalOutstanding || 0).toFixed(2)}\n                                </p>\n                              </div>\n                            </div>\n\n                            <div className=\"flex gap-2\">\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => setSelectedArchivedTutor(tutor)}\n                                data-testid={`button-view-archived-tutor-${tutor.id}`}\n                              >\n                                <FileText className=\"w-4 h-4 mr-1\" />\n                                Details\n                              </Button>\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => restoreTutorMutation.mutate(tutor.id)}\n                                disabled={restoreTutorMutation.isPending}\n                                data-testid={`button-restore-tutor-${tutor.id}`}\n                              >\n                                <RotateCcw className=\"w-4 h-4 mr-1\" />\n                                Restore\n                              </Button>\n                            </div>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Archived Student Detail Dialog */}\n            <Dialog open={selectedArchivedStudent !== null} onOpenChange={(open) => !open && setSelectedArchivedStudent(null)}>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center gap-2\">\n                    <GraduationCap className=\"w-5 h-5\" />\n                    {selectedArchivedStudent?.name} - Archive Details\n                  </DialogTitle>\n                </DialogHeader>\n                {selectedArchivedStudent && (\n                  <div className=\"space-y-6\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Subject</p>\n                        <p className=\"font-medium\">{selectedArchivedStudent.subject}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Class Type</p>\n                        <p className=\"font-medium capitalize\">{selectedArchivedStudent.classType}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Parent</p>\n                        <p className=\"font-medium\">{selectedArchivedStudent.parentName || \"N/A\"}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Phone</p>\n                        <p className=\"font-medium\">{selectedArchivedStudent.parentPhone || \"N/A\"}</p>\n                      </div>\n                    </div>\n\n                    <Card>\n                      <CardHeader className=\"py-3\">\n                        <CardTitle className=\"text-sm\">Financial Summary</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"grid grid-cols-4 gap-4 text-center\">\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Sessions</p>\n                            <p className=\"font-bold text-lg\">{selectedArchivedStudent.sessionCount}</p>\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Total Billed</p>\n                            <p className=\"font-bold text-lg text-primary\">${(selectedArchivedStudent.totalBilled || 0).toFixed(2)}</p>\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Received</p>\n                            <p className=\"font-bold text-lg text-green-600\">${(selectedArchivedStudent.totalReceived || 0).toFixed(2)}</p>\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Outstanding</p>\n                            <p className=\"font-bold text-lg text-red-600\">${(selectedArchivedStudent.totalOutstanding || 0).toFixed(2)}</p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <div className=\"flex justify-end\">\n                      <Button\n                        onClick={() => {\n                          restoreStudentMutation.mutate(selectedArchivedStudent.id);\n                          setSelectedArchivedStudent(null);\n                        }}\n                        disabled={restoreStudentMutation.isPending}\n                      >\n                        <RotateCcw className=\"w-4 h-4 mr-2\" />\n                        Restore Student\n                      </Button>\n                    </div>\n                  </div>\n                )}\n              </DialogContent>\n            </Dialog>\n\n            {/* Archived Tutor Detail Dialog */}\n            <Dialog open={selectedArchivedTutor !== null} onOpenChange={(open) => !open && setSelectedArchivedTutor(null)}>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center gap-2\">\n                    <Users className=\"w-5 h-5\" />\n                    {selectedArchivedTutor?.firstName} {selectedArchivedTutor?.lastName} - Archive Details\n                  </DialogTitle>\n                </DialogHeader>\n                {selectedArchivedTutor && (\n                  <div className=\"space-y-6\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Email</p>\n                        <p className=\"font-medium\">{selectedArchivedTutor.email || \"N/A\"}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Role</p>\n                        <Badge variant={selectedArchivedTutor.role === \"admin\" ? \"default\" : \"secondary\"}>\n                          {selectedArchivedTutor.role === \"admin\" ? \"Admin\" : \"Tutor\"}\n                        </Badge>\n                      </div>\n                    </div>\n\n                    <Card>\n                      <CardHeader className=\"py-3\">\n                        <CardTitle className=\"text-sm\">Financial Summary</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"grid grid-cols-4 gap-4 text-center\">\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Sessions</p>\n                            <p className=\"font-bold text-lg\">{selectedArchivedTutor.sessionCount}</p>\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Total Earnings</p>\n                            <p className=\"font-bold text-lg text-primary\">${(selectedArchivedTutor.totalEarnings || 0).toFixed(2)}</p>\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Paid Out</p>\n                            <p className=\"font-bold text-lg text-green-600\">${(selectedArchivedTutor.totalPaid || 0).toFixed(2)}</p>\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Outstanding</p>\n                            <p className=\"font-bold text-lg text-orange-600\">${(selectedArchivedTutor.totalOutstanding || 0).toFixed(2)}</p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <div>\n                      <p className=\"text-sm text-muted-foreground mb-2\">Students Taught: {selectedArchivedTutor.studentCount}</p>\n                    </div>\n\n                    <div className=\"flex justify-end\">\n                      <Button\n                        onClick={() => {\n                          restoreTutorMutation.mutate(selectedArchivedTutor.id);\n                          setSelectedArchivedTutor(null);\n                        }}\n                        disabled={restoreTutorMutation.isPending}\n                      >\n                        <RotateCcw className=\"w-4 h-4 mr-2\" />\n                        Restore Tutor\n                      </Button>\n                    </div>\n                  </div>\n                )}\n              </DialogContent>\n            </Dialog>\n          </TabsContent>\n\n          {/* Parent Feedback Tab */}\n          <TabsContent value=\"feedback\" className=\"p-4 sm:p-6\">\n            <div className=\"flex justify-between items-start mb-6\">\n              <div>\n                <h3 className=\"text-lg font-semibold\">Parent Feedback & Messages</h3>\n                <p className=\"text-sm text-muted-foreground\">View messages sent by parents</p>\n              </div>\n              <Select \n                value={messageRecipientFilter} \n                onValueChange={(val) => setMessageRecipientFilter(val as \"all\" | \"admin\" | \"tutor\")}\n              >\n                <SelectTrigger className=\"w-[180px]\" data-testid=\"select-message-filter\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Messages</SelectItem>\n                  <SelectItem value=\"admin\">Admin Only</SelectItem>\n                  <SelectItem value=\"tutor\">Tutor Messages</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {parentMessagesLoading ? (\n              <div className=\"space-y-4\">\n                {[1, 2, 3].map((i) => (\n                  <Skeleton key={i} className=\"h-32 w-full\" />\n                ))}\n              </div>\n            ) : parentMessages.length === 0 ? (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <MessageSquare className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                <p>No messages from parents yet</p>\n              </div>\n            ) : (() => {\n              const filteredMessages = parentMessages.filter(\n                message => messageRecipientFilter === \"all\" || message.recipientType === messageRecipientFilter\n              );\n              \n              if (filteredMessages.length === 0) {\n                return (\n                  <div className=\"text-center py-12 text-muted-foreground\">\n                    <MessageSquare className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                    <p>No {messageRecipientFilter === \"admin\" ? \"admin-only\" : \"tutor\"} messages found</p>\n                  </div>\n                );\n              }\n              \n              return (\n              <div className=\"space-y-4\">\n                {filteredMessages.map((message) => (\n                  <Card \n                    key={message.id} \n                    className={`${!message.isRead ? 'border-primary/50 bg-primary/5' : ''}`}\n                    data-testid={`card-message-${message.id}`}\n                  >\n                    <CardHeader className=\"pb-2\">\n                      <div className=\"flex flex-col sm:flex-row justify-between items-start gap-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <CardTitle className=\"text-base\">{message.subject || 'No Subject'}</CardTitle>\n                          {!message.isRead && (\n                            <Badge variant=\"secondary\" className=\"text-xs\">New</Badge>\n                          )}\n                          <Badge \n                            variant={message.recipientType === 'admin' ? 'default' : 'outline'}\n                            className=\"text-xs\"\n                          >\n                            {message.recipientType === 'admin' ? 'Admin Only' : 'Tutor & Admin'}\n                          </Badge>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {!message.isRead && (\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => markMessageReadMutation.mutate(message.id)}\n                              disabled={markMessageReadMutation.isPending}\n                              data-testid={`button-mark-read-${message.id}`}\n                            >\n                              <Check className=\"w-4 h-4 mr-1\" />\n                              Mark Read\n                            </Button>\n                          )}\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm text-muted-foreground mb-3\">\n                        <div className=\"flex items-center gap-1\">\n                          <GraduationCap className=\"w-4 h-4\" />\n                          <span>Student: <span className=\"text-foreground font-medium\">{message.student?.name || 'Unknown'}</span></span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Mail className=\"w-4 h-4\" />\n                          <span>From: <span className=\"text-foreground\">{message.senderName || message.senderEmail}</span></span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Calendar className=\"w-4 h-4\" />\n                          <span>{format(new Date(message.createdAt!), 'PPp')}</span>\n                        </div>\n                      </div>\n                      <div className=\"bg-muted/50 rounded-lg p-4 mt-2\">\n                        <p className=\"whitespace-pre-wrap text-sm\">{message.message}</p>\n                      </div>\n                      {message.isRead && message.readAt && (\n                        <p className=\"text-xs text-muted-foreground mt-2\">\n                          Read {message.readByTutor ? `by ${message.readByTutor.firstName} ${message.readByTutor.lastName}` : ''} on {format(new Date(message.readAt), 'PPp')}\n                        </p>\n                      )}\n                      \n                      <div className=\"mt-4\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => setExpandedMessageId(expandedMessageId === message.id ? null : message.id)}\n                          data-testid={`button-toggle-reply-${message.id}`}\n                        >\n                          {expandedMessageId === message.id ? (\n                            <>\n                              <ChevronDown className=\"w-4 h-4 mr-1\" />\n                              Hide Replies\n                            </>\n                          ) : (\n                            <>\n                              <Reply className=\"w-4 h-4 mr-1\" />\n                              Reply / View Replies\n                            </>\n                          )}\n                        </Button>\n                      </div>\n                      \n                      {expandedMessageId === message.id && (\n                        <div className=\"mt-4 border-t pt-4\">\n                          {expandedMessage?.replies && expandedMessage.replies.length > 0 && (\n                            <div className=\"space-y-3 mb-4\">\n                              <p className=\"text-sm font-medium text-muted-foreground\">Conversation</p>\n                              {expandedMessage.replies.map((reply) => (\n                                <div \n                                  key={reply.id} \n                                  className=\"ml-4 p-3 bg-primary/5 rounded-lg border-l-2 border-primary\"\n                                  data-testid={`reply-${reply.id}`}\n                                >\n                                  <div className=\"flex items-center gap-2 mb-1\">\n                                    <Badge variant=\"outline\" className=\"text-xs capitalize\">\n                                      {reply.repliedByRole}\n                                    </Badge>\n                                    <span className=\"text-xs text-muted-foreground\">\n                                      {reply.createdAt ? format(new Date(reply.createdAt), 'PPp') : \"\"}\n                                    </span>\n                                  </div>\n                                  <p className=\"text-sm whitespace-pre-wrap\">{reply.replyContent}</p>\n                                </div>\n                              ))}\n                            </div>\n                          )}\n                          \n                          <div className=\"space-y-2\">\n                            <p className=\"text-sm font-medium text-muted-foreground\">Write a reply</p>\n                            <Textarea\n                              placeholder=\"Type your reply here...\"\n                              value={replyContent}\n                              onChange={(e) => setReplyContent(e.target.value)}\n                              className=\"min-h-[80px]\"\n                              data-testid={`reply-textarea-${message.id}`}\n                            />\n                            <div className=\"flex justify-end\">\n                              <Button\n                                size=\"sm\"\n                                onClick={() => {\n                                  if (replyContent.trim()) {\n                                    createReplyMutation.mutate({\n                                      messageId: message.id,\n                                      replyContent: replyContent.trim(),\n                                    });\n                                  }\n                                }}\n                                disabled={!replyContent.trim() || createReplyMutation.isPending}\n                                data-testid={`button-send-reply-${message.id}`}\n                              >\n                                <Reply className=\"w-4 h-4 mr-2\" />\n                                {createReplyMutation.isPending ? \"Sending...\" : \"Send Reply\"}\n                              </Button>\n                            </div>\n                          </div>\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n              );\n            })()}\n          </TabsContent>\n        </Tabs>\n      </Card>\n\n      {/* Edit Parent Invoice Dialog */}\n      <Dialog open={isEditParentInvoiceOpen} onOpenChange={setIsEditParentInvoiceOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Parent Invoice</DialogTitle>\n            <DialogDescription>\n              Update the invoice details for {editingParentInvoice?.invoiceNumber}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Select Rate (from Rates tab)</label>\n              <Select\n                value={parentInvoiceFormData.selectedRateId}\n                onValueChange={(value) => {\n                  const selectedRate = parentRatesData.find(r => r.id === value);\n                  if (selectedRate) {\n                    const rateAmount = parseFloat(selectedRate.ratePerHour);\n                    const totalAmount = rateAmount * parentInvoiceFormData.sessionsIncluded;\n                    setParentInvoiceFormData(prev => ({\n                      ...prev,\n                      selectedRateId: value,\n                      amount: totalAmount.toFixed(2),\n                    }));\n                  }\n                }}\n              >\n                <SelectTrigger data-testid=\"select-invoice-rate\">\n                  <SelectValue placeholder=\"Select a rate to apply\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {parentRatesData.map((rate) => (\n                    <SelectItem key={rate.id} value={rate.id}>\n                      {rate.name} - Â£{rate.ratePerHour}/hr ({rate.classType})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground\">Selecting a rate will auto-calculate the amount</p>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Sessions Included</label>\n              <Input\n                type=\"number\"\n                value={parentInvoiceFormData.sessionsIncluded}\n                onChange={(e) => {\n                  const sessions = parseInt(e.target.value) || 0;\n                  const selectedRate = parentRatesData.find(r => r.id === parentInvoiceFormData.selectedRateId);\n                  const rateAmount = selectedRate ? parseFloat(selectedRate.ratePerHour) : 0;\n                  const totalAmount = rateAmount * sessions;\n                  setParentInvoiceFormData(prev => ({\n                    ...prev,\n                    sessionsIncluded: sessions,\n                    amount: selectedRate ? totalAmount.toFixed(2) : prev.amount,\n                  }));\n                }}\n                data-testid=\"input-invoice-sessions\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Amount (Â£)</label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={parentInvoiceFormData.amount}\n                onChange={(e) => setParentInvoiceFormData(prev => ({ ...prev, amount: e.target.value }))}\n                data-testid=\"input-invoice-amount\"\n              />\n              <p className=\"text-xs text-muted-foreground\">Auto-calculated from rate Ã— sessions, or edit manually</p>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Status</label>\n              <Select\n                value={parentInvoiceFormData.status}\n                onValueChange={(value) => setParentInvoiceFormData(prev => ({ ...prev, status: value as any }))}\n              >\n                <SelectTrigger data-testid=\"select-invoice-status\">\n                  <SelectValue placeholder=\"Select status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"draft\">Draft</SelectItem>\n                  <SelectItem value=\"sent\">Sent</SelectItem>\n                  <SelectItem value=\"approved\">Approved</SelectItem>\n                  <SelectItem value=\"paid\">Paid</SelectItem>\n                  <SelectItem value=\"partial\">Partial</SelectItem>\n                  <SelectItem value=\"overdue\">Overdue</SelectItem>\n                  <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Notes</label>\n              <Textarea\n                value={parentInvoiceFormData.notes}\n                onChange={(e) => setParentInvoiceFormData(prev => ({ ...prev, notes: e.target.value }))}\n                placeholder=\"Add any notes about this invoice...\"\n                data-testid=\"input-invoice-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setIsEditParentInvoiceOpen(false);\n                setEditingParentInvoice(null);\n              }}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                if (editingParentInvoice) {\n                  updateParentInvoiceMutation.mutate({\n                    id: editingParentInvoice.id,\n                    ...parentInvoiceFormData,\n                  });\n                }\n              }}\n              disabled={updateParentInvoiceMutation.isPending}\n              data-testid=\"button-save-invoice\"\n            >\n              {updateParentInvoiceMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Create Adhoc Invoice Dialog */}\n      <Dialog open={isCreateAdhocInvoiceOpen} onOpenChange={setIsCreateAdhocInvoiceOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Create Adhoc Invoice</DialogTitle>\n            <DialogDescription>\n              Create a manual invoice for one-off payments not tied to a student\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <label className=\"text-sm font-medium\">Parent First Name *</label>\n                <Input\n                  value={adhocInvoiceFormData.parentFirstName}\n                  onChange={(e) => setAdhocInvoiceFormData(prev => ({ ...prev, parentFirstName: e.target.value }))}\n                  placeholder=\"First name\"\n                  data-testid=\"input-adhoc-firstname\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <label className=\"text-sm font-medium\">Parent Surname *</label>\n                <Input\n                  value={adhocInvoiceFormData.parentSurname}\n                  onChange={(e) => setAdhocInvoiceFormData(prev => ({ ...prev, parentSurname: e.target.value }))}\n                  placeholder=\"Surname\"\n                  data-testid=\"input-adhoc-surname\"\n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Select Rate (optional)</label>\n              <Select\n                value=\"\"\n                onValueChange={(rateId) => {\n                  const selectedRate = parentRatesData.find(r => r.id === rateId);\n                  if (selectedRate) {\n                    setAdhocInvoiceFormData(prev => ({ \n                      ...prev, \n                      amount: selectedRate.rate.toString(),\n                      reason: prev.reason || `${selectedRate.name} - ${selectedRate.classType || 'Session'}`\n                    }));\n                  }\n                }}\n              >\n                <SelectTrigger data-testid=\"select-adhoc-rate\">\n                  <SelectValue placeholder=\"Select a rate to auto-fill amount\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {parentRatesData.map((rate) => (\n                    <SelectItem key={rate.id} value={rate.id}>\n                      {rate.name} - Â£{rate.rate}/hr ({rate.classType || 'N/A'})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Amount (Â£) *</label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={adhocInvoiceFormData.amount}\n                onChange={(e) => setAdhocInvoiceFormData(prev => ({ ...prev, amount: e.target.value }))}\n                placeholder=\"0.00\"\n                data-testid=\"input-adhoc-amount\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Reason for Invoice *</label>\n              <Textarea\n                value={adhocInvoiceFormData.reason}\n                onChange={(e) => setAdhocInvoiceFormData(prev => ({ ...prev, reason: e.target.value }))}\n                placeholder=\"Enter the reason for this invoice...\"\n                data-testid=\"input-adhoc-reason\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Due Date</label>\n              <Input\n                type=\"date\"\n                value={adhocInvoiceFormData.dueDate}\n                onChange={(e) => setAdhocInvoiceFormData(prev => ({ ...prev, dueDate: e.target.value }))}\n                data-testid=\"input-adhoc-duedate\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Status</label>\n              <Select\n                value={adhocInvoiceFormData.status}\n                onValueChange={(value) => setAdhocInvoiceFormData(prev => ({ ...prev, status: value as any }))}\n              >\n                <SelectTrigger data-testid=\"select-adhoc-status\">\n                  <SelectValue placeholder=\"Select status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"draft\">Draft</SelectItem>\n                  <SelectItem value=\"sent\">Sent</SelectItem>\n                  <SelectItem value=\"approved\">Approved</SelectItem>\n                  <SelectItem value=\"paid\">Paid</SelectItem>\n                  <SelectItem value=\"partial\">Partial</SelectItem>\n                  <SelectItem value=\"overdue\">Overdue</SelectItem>\n                  <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Notes (optional)</label>\n              <Textarea\n                value={adhocInvoiceFormData.notes}\n                onChange={(e) => setAdhocInvoiceFormData(prev => ({ ...prev, notes: e.target.value }))}\n                placeholder=\"Any additional notes...\"\n                data-testid=\"input-adhoc-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setIsCreateAdhocInvoiceOpen(false);\n                setAdhocInvoiceFormData({\n                  parentFirstName: \"\",\n                  parentSurname: \"\",\n                  amount: \"\",\n                  reason: \"\",\n                  dueDate: \"\",\n                  status: \"draft\",\n                  notes: \"\",\n                });\n              }}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                if (adhocInvoiceFormData.parentFirstName && adhocInvoiceFormData.parentSurname && adhocInvoiceFormData.amount && adhocInvoiceFormData.reason) {\n                  createAdhocInvoiceMutation.mutate(adhocInvoiceFormData);\n                }\n              }}\n              disabled={createAdhocInvoiceMutation.isPending || !adhocInvoiceFormData.parentFirstName || !adhocInvoiceFormData.parentSurname || !adhocInvoiceFormData.amount || !adhocInvoiceFormData.reason}\n              data-testid=\"button-create-adhoc-submit\"\n            >\n              {createAdhocInvoiceMutation.isPending ? \"Creating...\" : \"Create Invoice\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Adhoc Invoice Dialog */}\n      <Dialog open={isEditAdhocInvoiceOpen} onOpenChange={setIsEditAdhocInvoiceOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Edit Adhoc Invoice</DialogTitle>\n            <DialogDescription>\n              Update details for invoice {editingAdhocInvoice?.invoiceNumber}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <label className=\"text-sm font-medium\">Parent First Name *</label>\n                <Input\n                  value={adhocInvoiceFormData.parentFirstName}\n                  onChange={(e) => setAdhocInvoiceFormData(prev => ({ ...prev, parentFirstName: e.target.value }))}\n                  placeholder=\"First name\"\n                  data-testid=\"input-edit-adhoc-firstname\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <label className=\"text-sm font-medium\">Parent Surname *</label>\n                <Input\n                  value","path":null,"size_bytes":360000,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"server/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nif (!process.env.REPLIT_DOMAINS) {\n  throw new Error(\"Environment variable REPLIT_DOMAINS not provided\");\n}\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  // Allow all email addresses - no domain restrictions\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    try {\n      const user = {};\n      updateUserSession(user, tokens);\n      await upsertUser(tokens.claims());\n      verified(null, user);\n    } catch (error) {\n      console.error(\"Authentication failed:\", error);\n      verified(error, false);\n    }\n  };\n\n  for (const domain of process.env\n    .REPLIT_DOMAINS!.split(\",\")) {\n    const strategy = new Strategy(\n      {\n        name: `replitauth:${domain}`,\n        config,\n        scope: \"openid email profile offline_access\",\n        callbackURL: `https://${domain}/api/callback`,\n      },\n      verify,\n    );\n    passport.use(strategy);\n  }\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":4407,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });","path":null,"size_bytes":482,"size_tokens":null},"client/src/components/tutor-dashboard.tsx":{"content":"import { useState, useEffect, Fragment } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { format, startOfWeek, endOfWeek } from \"date-fns\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport {\n  Card,\n  CardContent,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n  TableFooter,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Clock,\n  DollarSign,\n  Users,\n  PlusCircle,\n  History,\n  BarChart3,\n  Save,\n  AlertTriangle,\n  Send,\n  CheckCircle,\n  XCircle,\n  FileText,\n  ChevronDown,\n  ChevronRight,\n  BookOpen,\n  Check,\n  CheckCheck,\n  MessageSquare,\n  Mail,\n  Reply,\n  Edit,\n  Trash2,\n  Calendar,\n} from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport type { User, StudentWithTutor, TimesheetEntryWithRelations, WeeklyTimesheetWithRelations, StudentTopic, ParentMessageWithRelations, ParentMessageReplyWithRelations } from \"@shared/schema\";\n\nconst timesheetSchema = z.object({\n  studentId: z.string().min(1, \"Please select a student\"),\n  date: z.string().min(1, \"Please select a date\").refine((date) => {\n    const selectedDate = new Date(date);\n    const today = new Date();\n    today.setHours(23, 59, 59, 999);\n    return selectedDate <= today;\n  }, \"Cannot log sessions for future dates\"),\n  duration: z.coerce.number().min(0.25, \"Duration must be at least 15 minutes\").max(8, \"Duration cannot exceed 8 hours\"),\n  notes: z.string().optional(),\n});\n\ntype TimesheetFormData = z.infer<typeof timesheetSchema>;\n\ninterface TutorDashboardProps {\n  user: User;\n}\n\nexport default function TutorDashboard({ user }: TutorDashboardProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [selectedWeek, setSelectedWeek] = useState(new Date());\n  const [isCurrentWeekExpanded, setIsCurrentWeekExpanded] = useState(false);\n  const [selectedStudentForTopics, setSelectedStudentForTopics] = useState<StudentWithTutor | null>(null);\n  const [isTopicsDialogOpen, setIsTopicsDialogOpen] = useState(false);\n  const [expandedMessageId, setExpandedMessageId] = useState<string | null>(null);\n  const [replyContent, setReplyContent] = useState(\"\");\n  const [expandedSessionId, setExpandedSessionId] = useState<string | null>(null);\n  const [expandedHistoryTimesheetId, setExpandedHistoryTimesheetId] = useState<string | null>(null);\n  const [statusHistoryExpanded, setStatusHistoryExpanded] = useState(true);\n  const [editingEntry, setEditingEntry] = useState<TimesheetEntryWithRelations | null>(null);\n  const [isEditEntryDialogOpen, setIsEditEntryDialogOpen] = useState(false);\n  const [editEntryForm, setEditEntryForm] = useState({ date: \"\", duration: 1, notes: \"\" });\n  const [selectedEarningsYear, setSelectedEarningsYear] = useState(new Date().getFullYear());\n  \n  // Section collapse states\n  const [sectionsCollapsed, setSectionsCollapsed] = useState({\n    currentTimesheet: false,\n    pastTimesheets: false,\n    logSession: false,\n    recentSessions: false,\n    weeklySummary: false,\n    myStudents: false,\n    messages: false,\n    annualEarnings: false,\n  });\n  \n  const toggleSection = (section: keyof typeof sectionsCollapsed) => {\n    setSectionsCollapsed(prev => ({ ...prev, [section]: !prev[section] }));\n  };\n\n  const weekStart = startOfWeek(selectedWeek, { weekStartsOn: 1 });\n  const weekEnd = endOfWeek(selectedWeek, { weekStartsOn: 1 });\n\n  // Fetch students for this tutor (only students assigned to them)\n  const {\n    data: students = [],\n    isLoading: studentsLoading,\n    error: studentsError,\n  } = useQuery<StudentWithTutor[]>({\n    queryKey: [\"/api/students/my\"],\n    retry: false,\n  });\n\n  // Fetch timesheet entries for current week\n  const {\n    data: timesheetEntries = [],\n    isLoading: timesheetsLoading,\n  } = useQuery<TimesheetEntryWithRelations[]>({\n    queryKey: [\"/api/timesheets\", weekStart.toISOString(), weekEnd.toISOString()],\n    retry: false,\n  });\n\n  // Fetch all timesheet entries (for recent sessions including older ones)\n  const {\n    data: allTimesheetEntries = [],\n    isLoading: allTimesheetsLoading,\n  } = useQuery<TimesheetEntryWithRelations[]>({\n    queryKey: [\"/api/timesheets/my-sessions\"],\n    retry: false,\n  });\n\n  // Fetch weekly earnings\n  const { data: earnings } = useQuery<{ earnings: number }>({\n    queryKey: [\"/api/analytics/tutor-earnings\", { startDate: weekStart.toISOString(), endDate: weekEnd.toISOString() }],\n    queryFn: async () => {\n      const res = await fetch(`/api/analytics/tutor-earnings?startDate=${weekStart.toISOString()}&endDate=${weekEnd.toISOString()}`, {\n        credentials: \"include\",\n      });\n      if (!res.ok) throw new Error(\"Failed to fetch earnings\");\n      return res.json();\n    },\n    retry: false,\n  });\n\n  // Fetch annual earnings\n  const { data: annualEarnings, isLoading: annualEarningsLoading } = useQuery<{ totalEarnings: number; approvedSessions: number; year: number }>({\n    queryKey: [\"/api/tutor/earnings\", selectedEarningsYear],\n    queryFn: async () => {\n      const res = await fetch(`/api/tutor/earnings?year=${selectedEarningsYear}`, {\n        credentials: \"include\",\n      });\n      if (!res.ok) throw new Error(\"Failed to fetch annual earnings\");\n      return res.json();\n    },\n    retry: false,\n  });\n\n  // Fetch current week's timesheet\n  const {\n    data: currentWeeklyTimesheet,\n    isLoading: weeklyTimesheetLoading,\n  } = useQuery<WeeklyTimesheetWithRelations>({\n    queryKey: [\"/api/weekly-timesheets/current\"],\n    retry: false,\n  });\n\n  // Fetch all weekly timesheets for this tutor\n  const {\n    data: myWeeklyTimesheets = [],\n    isLoading: myTimesheetsLoading,\n  } = useQuery<WeeklyTimesheetWithRelations[]>({\n    queryKey: [\"/api/weekly-timesheets/my\"],\n    retry: false,\n  });\n\n  // Fetch topics for selected student\n  const { data: studentTopics = [], isLoading: topicsLoading } = useQuery<StudentTopic[]>({\n    queryKey: [\"/api/students\", selectedStudentForTopics?.id, \"topics\"],\n    queryFn: async () => {\n      if (!selectedStudentForTopics) return [];\n      const res = await fetch(`/api/students/${selectedStudentForTopics.id}/topics`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch topics\");\n      return res.json();\n    },\n    enabled: !!selectedStudentForTopics && isTopicsDialogOpen,\n    retry: false,\n  });\n\n  // Fetch all weeks the tutor has taught\n  const { data: tutorWeeks = [] } = useQuery<{ weekStart: string; weekEnd: string }[]>({\n    queryKey: [\"/api/analytics/tutor-weeks\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/analytics/tutor-weeks\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch tutor weeks\");\n      return res.json();\n    },\n    retry: false,\n  });\n\n  // Fetch parent messages for this tutor\n  const { data: parentMessages = [], isLoading: messagesLoading } = useQuery<ParentMessageWithRelations[]>({\n    queryKey: [\"/api/messages/tutor\"],\n    retry: false,\n  });\n\n  // Fetch single message with replies when expanded\n  const { data: expandedMessage } = useQuery<ParentMessageWithRelations & { replies: ParentMessageReplyWithRelations[] }>({\n    queryKey: [\"/api/messages\", expandedMessageId],\n    enabled: !!expandedMessageId,\n    retry: false,\n  });\n\n  // Fetch status history for expanded timesheet\n  interface StatusHistoryItem {\n    id: string;\n    weeklyTimesheetId: string;\n    fromStatus: string | null;\n    toStatus: string;\n    changedBy: string;\n    notes: string | null;\n    createdAt: string;\n    changedByName?: string;\n  }\n  const { data: statusHistory = [] } = useQuery<StatusHistoryItem[]>({\n    queryKey: [\"/api/weekly-timesheets\", expandedHistoryTimesheetId, \"history\"],\n    queryFn: async () => {\n      if (!expandedHistoryTimesheetId) return [];\n      const res = await fetch(`/api/weekly-timesheets/${expandedHistoryTimesheetId}/history`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch status history\");\n      return res.json();\n    },\n    enabled: !!expandedHistoryTimesheetId,\n    retry: false,\n  });\n\n  // Create reply mutation\n  const createReplyMutation = useMutation({\n    mutationFn: async ({ messageId, replyContent }: { messageId: string; replyContent: string }) => {\n      const response = await apiRequest(\"POST\", `/api/messages/${messageId}/replies`, { replyContent });\n      return response.json();\n    },\n    onSuccess: () => {\n      setReplyContent(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages\", expandedMessageId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages/tutor\"] });\n      toast({\n        title: \"Reply Sent\",\n        description: \"Your reply has been sent successfully.\",\n      });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to send reply.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mark message as read mutation\n  const markAsReadMutation = useMutation({\n    mutationFn: async (messageId: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/messages/${messageId}/read`);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages/tutor\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/messages\", expandedMessageId] });\n      toast({\n        title: \"Message Marked as Read\",\n        description: \"The message has been marked as read.\",\n      });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to mark message as read.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mark topic as covered mutation\n  const markTopicCoveredMutation = useMutation({\n    mutationFn: async ({ topicId, isCovered, coveredAt }: { topicId: string; isCovered: boolean; coveredAt?: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/topics/${topicId}/covered`, { isCovered, coveredAt });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/students\", selectedStudentForTopics?.id, \"topics\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to update topic status.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Open topics dialog for a student\n  const openTopicsDialog = (student: StudentWithTutor) => {\n    setSelectedStudentForTopics(student);\n    setIsTopicsDialogOpen(true);\n  };\n\n  // Form setup\n  const form = useForm<TimesheetFormData>({\n    resolver: zodResolver(timesheetSchema),\n    defaultValues: {\n      studentId: \"\",\n      date: format(new Date(), \"yyyy-MM-dd\"),\n      duration: 1,\n      notes: \"\",\n    },\n  });\n\n  // Create timesheet entry mutation\n  const createTimesheetMutation = useMutation({\n    mutationFn: async (data: TimesheetFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/timesheets\", {\n        studentId: data.studentId,\n        date: new Date(data.date).toISOString(),\n        duration: data.duration,\n        notes: data.notes,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Teaching session logged successfully!\",\n      });\n      form.reset({\n        studentId: \"\",\n        date: format(new Date(), \"yyyy-MM-dd\"),\n        duration: 1,\n        notes: \"\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/tutor-earnings\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/students/my\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/current\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/my\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets/my-sessions\"] });\n    },\n    onError: (error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to log teaching session. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Submit weekly timesheet mutation\n  const submitTimesheetMutation = useMutation({\n    mutationFn: async (timesheetId: string) => {\n      const response = await apiRequest(\"POST\", `/api/weekly-timesheets/${timesheetId}/submit`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Weekly timesheet submitted for approval!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/current\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/my\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets/my-sessions\"] });\n    },\n    onError: (error: any) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error?.message || \"Failed to submit timesheet. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation for editing timesheet entry (for tutors)\n  const updateEntryMutation = useMutation({\n    mutationFn: async (data: { id: string; date?: string; duration?: number; notes?: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/timesheet-entries/${data.id}/tutor`, {\n        date: data.date,\n        duration: data.duration,\n        notes: data.notes,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Session entry updated successfully!\",\n      });\n      setIsEditEntryDialogOpen(false);\n      setEditingEntry(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/current\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/my\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets/my-sessions\"] });\n    },\n    onError: (error: any) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error?.message || \"Failed to update entry. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation for deleting timesheet entry (for tutors)\n  const deleteEntryMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/timesheet-entries/${id}`);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Session entry deleted successfully!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/current\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/weekly-timesheets/my\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/timesheets/my-sessions\"] });\n    },\n    onError: (error: any) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error?.message || \"Failed to delete entry. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Handle unauthorized error for students\n  useEffect(() => {\n    if (studentsError && isUnauthorizedError(studentsError)) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n    }\n  }, [studentsError, toast]);\n\n  const onSubmit = (data: TimesheetFormData) => {\n    createTimesheetMutation.mutate(data);\n  };\n\n  // Calculate stats\n  const weeklyEarnings = earnings?.earnings || 0;\n  const weeklyLessons = timesheetEntries.length;\n  const activeStudents = students.filter((student) => student.sessionsRemaining > 0).length;\n  \n  // Calculate total earnings from all sessions shown in weekly summary (including pending)\n  const totalWeeklySessionEarnings = timesheetEntries.reduce((sum, entry) => \n    sum + parseFloat(entry.tutorEarnings.toString()), 0\n  );\n\n  // Recent sessions (last 5)\n  // Use all sessions for recent display, sorted by date descending, limit to 10\n  const recentSessions = [...allTimesheetEntries]\n    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())\n    .slice(0, 10);\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Stats Overview */}\n      <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6\">\n        <Card data-testid=\"card-weekly-earnings\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">This Week's Earnings</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-weekly-earnings\">\n                  ${weeklyEarnings.toFixed(2)}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-chart-2/10 rounded-full flex items-center justify-center\">\n                <DollarSign className=\"h-6 w-6 text-chart-2\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-weekly-lessons\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Sessions This Week</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-weekly-lessons\">\n                  {weeklyLessons}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center\">\n                <Clock className=\"h-6 w-6 text-primary\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-active-students\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-muted-foreground text-sm\">Active Students</p>\n                <p className=\"text-2xl font-bold text-foreground\" data-testid=\"text-active-students\">\n                  {activeStudents}\n                </p>\n              </div>\n              <div className=\"w-12 h-12 bg-chart-1/10 rounded-full flex items-center justify-center\">\n                <Users className=\"h-6 w-6 text-chart-1\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Current Week Timesheet Status */}\n      <Card data-testid=\"card-weekly-timesheet-status\">\n        <CardHeader \n          className=\"pb-4 cursor-pointer hover:bg-muted/50 transition-colors\"\n          onClick={() => toggleSection('currentTimesheet')}\n        >\n          <CardTitle className=\"flex items-center justify-between text-lg\">\n            <div className=\"flex items-center\">\n              <FileText className=\"w-5 h-5 text-primary mr-2\" />\n              Current Week Timesheet\n            </div>\n            {sectionsCollapsed.currentTimesheet ? (\n              <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n            ) : (\n              <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n            )}\n          </CardTitle>\n        </CardHeader>\n        {!sectionsCollapsed.currentTimesheet && <CardContent>\n          {weeklyTimesheetLoading ? (\n            <div className=\"flex items-center justify-between p-4 bg-muted/30 rounded-lg\">\n              <Skeleton className=\"h-6 w-48\" />\n              <Skeleton className=\"h-10 w-32\" />\n            </div>\n          ) : currentWeeklyTimesheet ? (\n            <div className=\"space-y-4\">\n              <div\n                className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 bg-muted/30 rounded-lg cursor-pointer hover:bg-muted/50 transition-colors\"\n                onClick={() => currentWeeklyTimesheet.entries.length > 0 && setIsCurrentWeekExpanded(!isCurrentWeekExpanded)}\n                data-testid=\"toggle-current-week-expand\"\n              >\n                <div className=\"flex items-center gap-2\">\n                  {currentWeeklyTimesheet.entries.length > 0 && (\n                    isCurrentWeekExpanded ? (\n                      <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n                    ) : (\n                      <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n                    )\n                  )}\n                  <div>\n                    <p className=\"font-medium text-foreground\">\n                      Week of {format(new Date(currentWeeklyTimesheet.weekStart), \"MMM dd\")} - {format(new Date(currentWeeklyTimesheet.weekEnd), \"MMM dd, yyyy\")}\n                    </p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {currentWeeklyTimesheet.entries.length} session(s) logged\n                      {currentWeeklyTimesheet.entries.length > 0 && (\n                        <span className=\"ml-2 font-medium text-chart-2\">\n                          â€¢ ${currentWeeklyTimesheet.entries.reduce((sum, e) => sum + Number(e.tutorEarnings), 0).toFixed(2)} earnings\n                        </span>\n                      )}\n                      {currentWeeklyTimesheet.entries.length > 0 && !isCurrentWeekExpanded && (\n                        <span className=\"ml-2 text-xs\">(click to view details)</span>\n                      )}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-3\" onClick={(e) => e.stopPropagation()}>\n                  <Badge\n                    variant={\n                      currentWeeklyTimesheet.status === \"approved\"\n                        ? \"default\"\n                        : currentWeeklyTimesheet.status === \"rejected\"\n                        ? \"destructive\"\n                        : currentWeeklyTimesheet.status === \"submitted\"\n                        ? \"secondary\"\n                        : \"outline\"\n                    }\n                    className=\"flex items-center gap-1\"\n                    data-testid=\"badge-timesheet-status\"\n                  >\n                    {currentWeeklyTimesheet.status === \"approved\" && <CheckCircle className=\"w-3 h-3\" />}\n                    {currentWeeklyTimesheet.status === \"rejected\" && <XCircle className=\"w-3 h-3\" />}\n                    {currentWeeklyTimesheet.status === \"submitted\" && <Clock className=\"w-3 h-3\" />}\n                    {currentWeeklyTimesheet.status === \"draft\" ? \"Draft\" : currentWeeklyTimesheet.status}\n                  </Badge>\n                  {(currentWeeklyTimesheet.status === \"draft\" || currentWeeklyTimesheet.status === \"rejected\") && currentWeeklyTimesheet.entries.length > 0 && (\n                    <Button\n                      onClick={() => submitTimesheetMutation.mutate(currentWeeklyTimesheet.id)}\n                      disabled={submitTimesheetMutation.isPending}\n                      data-testid=\"button-submit-timesheet\"\n                    >\n                      {submitTimesheetMutation.isPending ? (\n                        <div className=\"flex items-center\">\n                          <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2\"></div>\n                          Submitting...\n                        </div>\n                      ) : (\n                        <>\n                          <Send className=\"w-4 h-4 mr-2\" />\n                          {currentWeeklyTimesheet.status === \"rejected\" ? \"Resubmit\" : \"Submit for Approval\"}\n                        </>\n                      )}\n                    </Button>\n                  )}\n                </div>\n              </div>\n\n              {/* Expanded Sessions List */}\n              {isCurrentWeekExpanded && currentWeeklyTimesheet.entries.length > 0 && (\n                <div className=\"border rounded-lg overflow-hidden\" data-testid=\"current-week-sessions-list\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow className=\"bg-muted/50\">\n                        <TableHead>Date</TableHead>\n                        <TableHead>Student</TableHead>\n                        <TableHead>Subject</TableHead>\n                        <TableHead className=\"text-right\">Duration</TableHead>\n                        <TableHead className=\"text-right\">Earnings</TableHead>\n                        <TableHead>Notes</TableHead>\n                        {(currentWeeklyTimesheet.status === \"draft\" || currentWeeklyTimesheet.status === \"rejected\") && (\n                          <TableHead className=\"text-right\">Actions</TableHead>\n                        )}\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {currentWeeklyTimesheet.entries\n                        .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                        .map((entry) => (\n                          <TableRow key={entry.id} data-testid={`session-row-${entry.id}`}>\n                            <TableCell className=\"font-medium\">\n                              {format(new Date(entry.date), \"EEE, MMM dd\")}\n                            </TableCell>\n                            <TableCell>{entry.student?.name || \"Unknown\"}</TableCell>\n                            <TableCell>{entry.student?.subject || \"-\"}</TableCell>\n                            <TableCell className=\"text-right\">{entry.duration}h</TableCell>\n                            <TableCell className=\"text-right font-medium text-chart-2\">\n                              ${Number(entry.tutorEarnings).toFixed(2)}\n                            </TableCell>\n                            <TableCell className=\"text-muted-foreground text-sm max-w-[200px] truncate\">\n                              {entry.notes || \"-\"}\n                            </TableCell>\n                            {(currentWeeklyTimesheet.status === \"draft\" || currentWeeklyTimesheet.status === \"rejected\") && (\n                              <TableCell className=\"text-right\">\n                                <div className=\"flex justify-end gap-1\">\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => {\n                                      setEditingEntry(entry);\n                                      setEditEntryForm({\n                                        date: format(new Date(entry.date), \"yyyy-MM-dd\"),\n                                        duration: Number(entry.duration),\n                                        notes: entry.notes || \"\",\n                                      });\n                                      setIsEditEntryDialogOpen(true);\n                                    }}\n                                    data-testid={`button-edit-current-entry-${entry.id}`}\n                                  >\n                                    <Edit className=\"w-4 h-4\" />\n                                  </Button>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    className=\"text-destructive hover:text-destructive\"\n                                    onClick={() => {\n                                      if (confirm(\"Are you sure you want to delete this session entry?\")) {\n                                        deleteEntryMutation.mutate(entry.id);\n                                      }\n                                    }}\n                                    disabled={deleteEntryMutation.isPending}\n                                    data-testid={`button-delete-current-entry-${entry.id}`}\n                                  >\n                                    <Trash2 className=\"w-4 h-4\" />\n                                  </Button>\n                                </div>\n                              </TableCell>\n                            )}\n                          </TableRow>\n                        ))}\n                    </TableBody>\n                    <TableFooter>\n                      <TableRow>\n                        <TableCell colSpan={3} className=\"font-medium\">Total</TableCell>\n                        <TableCell className=\"text-right font-medium\">\n                          {currentWeeklyTimesheet.entries.reduce((sum, e) => sum + Number(e.duration), 0)}h\n                        </TableCell>\n                        <TableCell className=\"text-right font-bold text-chart-2\">\n                          ${currentWeeklyTimesheet.entries.reduce((sum, e) => sum + Number(e.tutorEarnings), 0).toFixed(2)}\n                        </TableCell>\n                        <TableCell></TableCell>\n                        {(currentWeeklyTimesheet.status === \"draft\" || currentWeeklyTimesheet.status === \"rejected\") && (\n                          <TableCell></TableCell>\n                        )}\n                      </TableRow>\n                    </TableFooter>\n                  </Table>\n                </div>\n              )}\n\n              {currentWeeklyTimesheet.reviewNotes && (\n                <div className=\"p-3 bg-destructive/10 rounded-lg border border-destructive/20\">\n                  <p className=\"text-sm\">\n                    <span className=\"font-medium text-destructive\">Admin Notes:</span>{\" \"}\n                    {currentWeeklyTimesheet.reviewNotes}\n                  </p>\n                </div>\n              )}\n              {currentWeeklyTimesheet.status === \"draft\" && currentWeeklyTimesheet.entries.length === 0 && (\n                <p className=\"text-sm text-muted-foreground\">\n                  Log your teaching sessions below to include them in this week's timesheet.\n                </p>\n              )}\n            </div>\n          ) : (\n            <p className=\"text-muted-foreground\">No timesheet data available</p>\n          )}\n        </CardContent>}\n      </Card>\n\n      {/* Timesheet History */}\n      <Card data-testid=\"card-timesheet-history\">\n        <CardHeader \n          className=\"pb-4 cursor-pointer hover:bg-muted/50 transition-colors\"\n          onClick={() => toggleSection('pastTimesheets')}\n        >\n          <CardTitle className=\"flex items-center justify-between text-lg\">\n            <div className=\"flex items-center\">\n              <History className=\"w-5 h-5 text-primary mr-2\" />\n              Timesheet History\n            </div>\n            {sectionsCollapsed.pastTimesheets ? (\n              <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n            ) : (\n              <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n            )}\n          </CardTitle>\n        </CardHeader>\n        {!sectionsCollapsed.pastTimesheets && <CardContent>\n          {myTimesheetsLoading ? (\n            <div className=\"space-y-3\">\n              {[...Array(3)].map((_, i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : myWeeklyTimesheets.length === 0 ? (\n            <p className=\"text-muted-foreground text-center py-4\">No timesheet history available</p>\n          ) : (\n            <div className=\"space-y-3\">\n              {myWeeklyTimesheets\n                .filter(ts => {\n                  const currentWeekStart = startOfWeek(new Date(), { weekStartsOn: 1 });\n                  const isPastWeek = new Date(ts.weekStart).getTime() < currentWeekStart.getTime();\n                  const isSubmitted = ts.status === \"submitted\" || ts.status === \"approved\" || ts.status === \"rejected\";\n                  // Show past weeks OR any submitted/approved/rejected timesheets (including current week)\n                  return isPastWeek || isSubmitted;\n                })\n                .sort((a, b) => new Date(b.weekStart).getTime() - new Date(a.weekStart).getTime())\n                .map((timesheet) => (\n                  <div\n                    key={timesheet.id}\n                    className=\"bg-muted/30 rounded-lg border border-border/50 overflow-hidden\"\n                    data-testid={`timesheet-history-${timesheet.id}`}\n                  >\n                    <div\n                      className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 cursor-pointer hover:bg-muted/50 transition-colors\"\n                      onClick={() => setExpandedHistoryTimesheetId(expandedHistoryTimesheetId === timesheet.id ? null : timesheet.id)}\n                    >\n                      <div className=\"flex items-center gap-2 flex-1\">\n                        {expandedHistoryTimesheetId === timesheet.id ? (\n                          <ChevronDown className=\"w-5 h-5 text-muted-foreground flex-shrink-0\" />\n                        ) : (\n                          <ChevronRight className=\"w-5 h-5 text-muted-foreground flex-shrink-0\" />\n                        )}\n                        <div>\n                          <p className=\"font-medium\">\n                            {format(new Date(timesheet.weekStart), \"MMM dd\")} - {format(new Date(timesheet.weekEnd), \"MMM dd, yyyy\")}\n                          </p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {timesheet.entries.length} session(s) â€¢ ${timesheet.entries.reduce((sum, e) => sum + Number(e.tutorEarnings), 0).toFixed(2)} earnings\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-3\" onClick={(e) => e.stopPropagation()}>\n                        <Badge\n                          variant={\n                            timesheet.status === \"approved\"\n                              ? \"default\"\n                              : timesheet.status === \"rejected\"\n                              ? \"destructive\"\n                              : timesheet.status === \"submitted\"\n                              ? \"secondary\"\n                              : \"outline\"\n                          }\n                          className=\"flex items-center gap-1\"\n                          data-testid={`badge-status-${timesheet.id}`}\n                        >\n                          {timesheet.status === \"approved\" && <CheckCircle className=\"w-3 h-3\" />}\n                          {timesheet.status === \"rejected\" && <XCircle className=\"w-3 h-3\" />}\n                          {timesheet.status === \"submitted\" && <Clock className=\"w-3 h-3\" />}\n                          {timesheet.status === \"approved\" ? \"Approved\" : \n                           timesheet.status === \"submitted\" ? \"Pending\" : \n                           timesheet.status === \"rejected\" ? \"Rejected\" : \"Draft\"}\n                        </Badge>\n                        {(timesheet.status === \"draft\" || timesheet.status === \"rejected\") && timesheet.entries.length > 0 && (\n                          <Button\n                            size=\"sm\"\n                            onClick={() => submitTimesheetMutation.mutate(timesheet.id)}\n                            disabled={submitTimesheetMutation.isPending}\n                            data-testid={`button-submit-${timesheet.id}`}\n                          >\n                            <Send className=\"w-4 h-4 mr-1\" />\n                            {timesheet.status === \"rejected\" ? \"Resubmit\" : \"Submit\"}\n                          </Button>\n                        )}\n                      </div>\n                    </div>\n                    \n                    {expandedHistoryTimesheetId === timesheet.id && (\n                      <div className=\"border-t border-border/50 p-4 space-y-4\">\n                        {timesheet.reviewNotes && (\n                          <div className=\"p-3 bg-destructive/10 rounded-lg border border-destructive/20\">\n                            <p className=\"text-sm\">\n                              <span className=\"font-medium text-destructive\">Admin Feedback:</span>{\" \"}\n                              {timesheet.reviewNotes}\n                            </p>\n                          </div>\n                        )}\n\n                        {/* Status History Timeline */}\n                        {statusHistory.length > 0 && (\n                          <div className=\"p-3 bg-muted/50 rounded-lg border border-border/50\">\n                            <button \n                              className=\"w-full text-sm font-medium flex items-center gap-2 hover:text-primary transition-colors\"\n                              onClick={() => setStatusHistoryExpanded(!statusHistoryExpanded)}\n                              data-testid=\"button-toggle-status-history\"\n                            >\n                              {statusHistoryExpanded ? (\n                                <ChevronDown className=\"w-4 h-4\" />\n                              ) : (\n                                <ChevronRight className=\"w-4 h-4\" />\n                              )}\n                              <History className=\"w-4 h-4\" />\n                              Status History ({statusHistory.length})\n                            </button>\n                            {statusHistoryExpanded && (\n                              <div className=\"space-y-3 mt-3\">\n                                {statusHistory.map((item) => (\n                                  <div key={item.id} className=\"text-sm\">\n                                    <div className=\"flex items-start gap-2\">\n                                      <div className={`w-2 h-2 rounded-full mt-1.5 flex-shrink-0 ${\n                                        item.toStatus === \"rejected\" ? \"bg-destructive\" : \n                                        item.toStatus === \"approved\" ? \"bg-green-500\" : \"bg-primary\"\n                                      }`} />\n                                      <div className=\"flex-1\">\n                                        <span className=\"font-medium\">\n                                          {item.fromStatus ? `${item.fromStatus} â†’ ` : \"\"}{item.toStatus}\n                                        </span>\n                                        <div className=\"text-xs text-muted-foreground\">\n                                          by {item.changedByName || \"Unknown\"} on {format(new Date(item.createdAt), \"MMM dd, yyyy h:mm a\")}\n                                        </div>\n                                      </div>\n                                    </div>\n                                    {item.notes && (\n                                      <div className={`ml-4 mt-1 p-2 rounded text-sm ${\n                                        item.toStatus === \"rejected\" \n                                          ? \"bg-destructive/10 border border-destructive/20 text-destructive\" \n                                          : \"bg-muted/50 border border-border/50\"\n                                      }`}>\n                                        <span className=\"font-medium\">\n                                          {item.toStatus === \"rejected\" ? \"Reason: \" : \"Notes: \"}\n                                        </span>\n                                        {item.notes}\n                                      </div>\n                                    )}\n                                  </div>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                        )}\n                        \n                        {timesheet.entries.length === 0 ? (\n                          <p className=\"text-muted-foreground text-center py-4\">No sessions in this timesheet</p>\n                        ) : (\n                          <div className=\"overflow-x-auto\">\n                            <Table>\n                              <TableHeader>\n                                <TableRow>\n                                  <TableHead>Date</TableHead>\n                                  <TableHead>Student</TableHead>\n                                  <TableHead>Subject</TableHead>\n                                  <TableHead className=\"text-right\">Duration</TableHead>\n                                  <TableHead className=\"text-right\">Earnings</TableHead>\n                                  <TableHead>Notes</TableHead>\n                                  {(timesheet.status === \"draft\" || timesheet.status === \"rejected\") && (\n                                    <TableHead className=\"text-right\">Actions</TableHead>\n                                  )}\n                                </TableRow>\n                              </TableHeader>\n                              <TableBody>\n                                {timesheet.entries\n                                  .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n                                  .map((entry) => (\n                                    <TableRow key={entry.id}>\n                                      <TableCell className=\"font-medium\">\n                                        {format(new Date(entry.date), \"EEE, MMM dd\")}\n                                      </TableCell>\n                                      <TableCell>{entry.student?.name || \"Unknown\"}</TableCell>\n                                      <TableCell>{entry.student?.subject || \"-\"}</TableCell>\n                                      <TableCell className=\"text-right\">{entry.duration}h</TableCell>\n                                      <TableCell className=\"text-right font-medium text-chart-2\">\n                                        ${Number(entry.tutorEarnings).toFixed(2)}\n                                      </TableCell>\n                                      <TableCell className=\"text-muted-foreground text-sm max-w-[200px] truncate\">\n                                        {entry.notes || \"-\"}\n                                      </TableCell>\n                                      {(timesheet.status === \"draft\" || timesheet.status === \"rejected\") && (\n                                        <TableCell className=\"text-right\">\n                                          <div className=\"flex justify-end gap-1\">\n                                            <Button\n                                              variant=\"ghost\"\n                                              size=\"sm\"\n                                              onClick={() => {\n                                                setEditingEntry(entry);\n                                                setEditEntryForm({\n                                                  date: format(new Date(entry.date), \"yyyy-MM-dd\"),\n                                                  duration: Number(entry.duration),\n                                                  notes: entry.notes || \"\",\n                                                });\n                                                setIsEditEntryDialogOpen(true);\n                                              }}\n                                              data-testid={`button-edit-entry-${entry.id}`}\n                                            >\n                                              <Edit className=\"w-4 h-4\" />\n                                            </Button>\n                                            <Button\n                                              variant=\"ghost\"\n                                              size=\"sm\"\n                                              className=\"text-destructive hover:text-destructive\"\n                                              onClick={() => {\n                                                if (confirm(\"Are you sure you want to delete this session entry?\")) {\n                                                  deleteEntryMutation.mutate(entry.id);\n                                                }\n                                              }}\n                                              disabled={deleteEntryMutation.isPending}\n                                              data-testid={`button-delete-entry-${entry.id}`}\n                                            >\n                                              <Trash2 className=\"w-4 h-4\" />\n                                            </Button>\n                                          </div>\n                                        </TableCell>\n                                      )}\n                                    </TableRow>\n                                  ))}\n                              </TableBody>\n                              <TableFooter>\n                                <TableRow>\n                                  <TableCell colSpan={3} className=\"font-medium\">Total</TableCell>\n                                  <TableCell className=\"text-right font-medium\">\n                                    {timesheet.entries.reduce((sum, e) => sum + Number(e.duration), 0)}h\n                                  </TableCell>\n                                  <TableCell className=\"text-right font-bold text-chart-2\">\n                                    ${timesheet.entries.reduce((sum, e) => sum + Number(e.tutorEarnings), 0).toFixed(2)}\n                                  </TableCell>\n                                  <TableCell></TableCell>\n                                  {(timesheet.status === \"draft\" || timesheet.status === \"rejected\") && <TableCell></TableCell>}\n                                </TableRow>\n                              </TableFooter>\n                            </Table>\n                          </div>\n                        )}\n                        \n                        {(timesheet.status === \"draft\" || timesheet.status === \"rejected\") && (\n                          <p className=\"text-sm text-muted-foreground\">\n                            You can log additional sessions for this week using the form below. Select a date within this week's range.\n                          </p>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                ))}\n              {myWeeklyTimesheets.filter(ts => {\n                const currentWeekStart = startOfWeek(new Date(), { weekStartsOn: 1 });\n                return new Date(ts.weekStart).getTime() < currentWeekStart.getTime();\n              }).length === 0 && (\n                <p className=\"text-muted-foreground text-center py-4\">No past timesheets yet</p>\n              )}\n            </div>\n          )}\n        </CardContent>}\n      </Card>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8\">\n        {/* Timesheet Entry Form */}\n        <Card data-testid=\"card-log-session\">\n          <CardHeader \n            className=\"pb-4 cursor-pointer hover:bg-muted/50 transition-colors\"\n            onClick={() => toggleSection('logSession')}\n          >\n            <CardTitle className=\"flex items-center justify-between text-lg\">\n              <div className=\"flex items-center\">\n                <PlusCircle className=\"w-5 h-5 text-primary mr-2\" />\n                Log Teaching Session\n              </div>\n              {sectionsCollapsed.logSession ? (\n                <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n              ) : (\n                <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n              )}\n            </CardTitle>\n          </CardHeader>\n          {!sectionsCollapsed.logSession && <CardContent>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"studentId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Student</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-student\">\n                            <SelectValue placeholder=\"Select a student...\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {studentsLoading ? (\n                            <div className=\"p-2\">Loading students...</div>\n                          ) : (\n                            students.map((student) => (\n                              <SelectItem\n                                key={student.id}\n                                value={student.id}\n                                data-testid={`option-student-${student.id}`}\n                              >\n                                {student.name} - {student.subject} ({student.sessionsRemaining} sessions left)\n                                {student.sessionsRemaining <= 5 && student.sessionsRemaining > 0 && (\n                                  <AlertTriangle className=\"w-4 h-4 text-destructive inline ml-2\" />\n                                )}\n                              </SelectItem>\n                            ))\n                          )}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"date\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Date Taught</FormLabel>\n                      <FormControl>\n                        <Input type=\"date\" {...field} data-testid=\"input-date\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"duration\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Duration (hours)</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          step=\"0.25\"\n                          min=\"0.25\"\n                          max=\"8\"\n                          {...field}\n                          data-testid=\"input-duration\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"notes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Session Notes (Optional)</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Topics covered, homework assigned...\"\n                          className=\"h-20\"\n                          {...field}\n                          data-testid=\"textarea-notes\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full h-12 text-base\"\n                  disabled={createTimesheetMutation.isPending}\n                  data-testid=\"button-submit-session\"\n                >\n                  {createTimesheetMutation.isPending ? (\n                    <div className=\"flex items-center\">\n                      <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary-foreground mr-2\"></div>\n                      Logging...\n                    </div>\n                  ) : (\n                    <>\n                      <Save className=\"w-4 h-4 mr-2\" />\n                      Log Session\n                    </>\n                  )}\n                </Button>\n              </form>\n            </Form>\n          </CardContent>}\n        </Card>\n\n        {/* Recent Sessions */}\n        <Card data-testid=\"card-recent-sessions\">\n          <CardHeader\n            className=\"cursor-pointer hover:bg-muted/50 transition-colors\"\n            onClick={() => toggleSection('recentSessions')}\n          >\n            <CardTitle className=\"flex items-center justify-between\">\n              <span className=\"flex items-center\">\n                <History className=\"w-5 h-5 text-primary mr-2\" />\n                My Recent Sessions\n              </span>\n              {sectionsCollapsed.recentSessions ? (\n                <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n              ) : (\n                <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n              )}\n            </CardTitle>\n          </CardHeader>\n          {!sectionsCollapsed.recentSessions && <CardContent>\n            {allTimesheetsLoading ? (\n              <div className=\"space-y-4\">\n                {[...Array(3)].map((_, i) => (\n                  <div key={i} className=\"flex items-center justify-between p-3 bg-muted/30 rounded-md\">\n                    <div className=\"flex-1\">\n                      <Skeleton className=\"h-4 w-3/4 mb-2\" />\n                      <Skeleton className=\"h-3 w-1/2\" />\n                    </div>\n                    <div className=\"text-right\">\n                      <Skeleton className=\"h-4 w-16 mb-2\" />\n                      <Skeleton className=\"h-3 w-12\" />\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : recentSessions.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Clock className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n                <p>No sessions logged yet</p>\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {recentSessions.map((session) => (\n                  <div\n                    key={session.id}\n                    className=\"p-3 bg-muted/30 rounded-md\"\n                    data-testid={`session-${session.id}`}\n                  >\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <div className=\"flex-1\">\n                        <p className=\"font-medium text-foreground\">\n                          {session.student.name} - {session.student.subject}\n                        </p>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {format(new Date(session.date), \"MMM dd, yyyy\")} â€¢ {session.duration} hours\n                        </p>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"font-medium text-chart-2\">\n                          ${parseFloat(session.tutorEarnings.toString()).toFixed(2)}\n                        </p>\n                        <Badge\n                          variant={\n                            session.status === \"approved\"\n                              ? \"default\"\n                              : session.status === \"rejected\"\n                              ? \"destructive\"\n                              : \"secondary\"\n                          }\n                          className=\"text-xs\"\n                        >\n                          {session.status === \"pending\" ? \"Pending Approval\" : session.status}\n                        </Badge>\n                      </div>\n                    </div>\n                    {session.notes && (\n                      <div className=\"mt-2 pt-2 border-t border-border\">\n                        <p className=\"text-sm text-muted-foreground\">\n                          <span className=\"font-medium\">Notes:</span> {session.notes}\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>}\n        </Card>\n      </div>\n\n      {/* Weekly Summary */}\n      <Card data-testid=\"card-weekly-summary\">\n        <CardHeader\n          className=\"cursor-pointer hover:bg-muted/50 transition-colors\"\n          onClick={() => toggleSection('weeklySummary')}\n        >\n          <CardTitle className=\"flex items-center justify-between\">\n            <span className=\"flex items-center\">\n              <BarChart3 className=\"w-5 h-5 text-primary mr-2\" />\n              Weekly Summary\n            </span>\n            <div className=\"flex items-center gap-2\" onClick={(e) => e.stopPropagation()}>\n              <Select\n                value={format(selectedWeek, \"yyyy-MM-dd\")}\n                onValueChange={(value) => setSelectedWeek(new Date(value))}\n              >\n                <SelectTrigger className=\"w-full sm:w-auto\" data-testid=\"select-week\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value={format(new Date(), \"yyyy-MM-dd\")}>\n                    Current Week ({format(startOfWeek(new Date(), { weekStartsOn: 1 }), \"MMM dd\")} - {format(endOfWeek(new Date(), { weekStartsOn: 1 }), \"MMM dd, yyyy\")})\n                  </SelectItem>\n                  {tutorWeeks.map((week) => {\n                    const weekStartDate = new Date(week.weekStart);\n                    const weekEndDate = new Date(week.weekEnd);\n                    const currentWeekStart = startOfWeek(new Date(), { weekStartsOn: 1 });\n                    if (weekStartDate.toDateString() === currentWeekStart.toDateString()) {\n                      return null;\n                    }\n                    return (\n                      <SelectItem \n                        key={week.weekStart} \n                        value={format(weekStartDate, \"yyyy-MM-dd\")}\n                      >\n                        {format(weekStartDate, \"MMM dd\")} - {format(weekEndDate, \"MMM dd, yyyy\")}\n                      </SelectItem>\n                    );\n                  })}\n                </SelectContent>\n              </Select>\n              {sectionsCollapsed.weeklySummary ? (\n                <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n              ) : (\n                <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n              )}\n            </div>\n          </CardTitle>\n        </CardHeader>\n        {!sectionsCollapsed.weeklySummary && <CardContent>\n          <div className=\"overflow-x-auto mobile-scroll\">\n            <Table className=\"min-w-[600px]\">\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Student</TableHead>\n                  <TableHead>Subject</TableHead>\n                  <TableHead className=\"text-right\">Duration</TableHead>\n                  <TableHead className=\"text-right\">Earnings</TableHead>\n                  <TableHead className=\"text-center\">Status</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {timesheetsLoading ? (\n                  [...Array(3)].map((_, i) => (\n                    <TableRow key={i}>\n                      <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-4 w-24\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-4 w-12\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                      <TableCell><Skeleton className=\"h-4 w-16\" /></TableCell>\n                    </TableRow>\n                  ))\n                ) : timesheetEntries.length === 0 ? (\n                  <TableRow>\n                    <TableCell colSpan={6} className=\"text-center py-8 text-muted-foreground\">\n                      No sessions logged for this week\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  timesheetEntries.map((entry) => (\n                    <Fragment key={entry.id}>\n                      <TableRow \n                        data-testid={`row-timesheet-${entry.id}`}\n                        className={`cursor-pointer hover:bg-muted/50 transition-colors ${expandedSessionId === entry.id ? 'bg-muted/50' : ''}`}\n                        onClick={() => setExpandedSessionId(expandedSessionId === entry.id ? null : entry.id)}\n                      >\n                        <TableCell className=\"flex items-center gap-2\">\n                          {expandedSessionId === entry.id ? (\n                            <ChevronDown className=\"w-4 h-4 text-muted-foreground\" />\n                          ) : (\n                            <ChevronRight className=\"w-4 h-4 text-muted-foreground\" />\n                          )}\n                          {format(new Date(entry.date), \"MMM dd\")}\n                        </TableCell>\n                        <TableCell>{entry.student.name}</TableCell>\n                        <TableCell>{entry.student.subject}</TableCell>\n                        <TableCell className=\"text-right\">{entry.duration}h</TableCell>\n                        <TableCell className=\"text-right font-medium\">\n                          ${parseFloat(entry.tutorEarnings.toString()).toFixed(2)}\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <Badge\n                            variant={\n                              entry.status === \"approved\"\n                                ? \"default\"\n                                : entry.status === \"rejected\"\n                                ? \"destructive\"\n                                : \"secondary\"\n                            }\n                          >\n                            {entry.status}\n                          </Badge>\n                        </TableCell>\n                      </TableRow>\n                      {expandedSessionId === entry.id && (\n                        <TableRow key={`${entry.id}-notes`} className=\"bg-muted/30\">\n                          <TableCell colSpan={6} className=\"py-4\">\n                            <div className=\"pl-6 space-y-2\">\n                              <div className=\"flex items-start gap-2\">\n                                <FileText className=\"w-4 h-4 text-muted-foreground mt-0.5\" />\n                                <div>\n                                  <p className=\"text-sm font-medium text-muted-foreground\">Session Notes</p>\n                                  <p className=\"text-sm mt-1\" data-testid={`text-notes-${entry.id}`}>\n                                    {entry.notes || <span className=\"text-muted-foreground italic\">No notes recorded for this session</span>}\n                                  </p>\n                                </div>\n                              </div>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      )}\n                    </Fragment>\n                  ))\n                )}\n              </TableBody>\n              {timesheetEntries.length > 0 && (\n                <TableFooter>\n                  <TableRow>\n                    <TableCell colSpan={4} className=\"font-semibold\">\n                      Total Earnings This Week\n                    </TableCell>\n                    <TableCell className=\"text-right font-bold text-lg text-primary\" data-testid=\"text-total-earnings\">\n                      ${totalWeeklySessionEarnings.toFixed(2)}\n                    </TableCell>\n                    <TableCell></TableCell>\n                  </TableRow>\n                </TableFooter>\n              )}\n            </Table>\n          </div>\n        </CardContent>}\n      </Card>\n\n      {/* Annual Earnings Widget */}\n      <Card data-testid=\"card-annual-earnings\">\n        <CardHeader \n          className=\"pb-4 cursor-pointer hover:bg-muted/50 transition-colors\"\n          onClick={() => toggleSection('annualEarnings')}\n        >\n          <CardTitle className=\"flex items-center justify-between text-lg\">\n            <span className=\"flex items-center\">\n              <DollarSign className=\"w-5 h-5 text-green-600 mr-2\" />\n              Annual Earnings\n            </span>\n            <div className=\"flex items-center gap-2\" onClick={(e) => e.stopPropagation()}>\n              <Select\n                value={selectedEarningsYear.toString()}\n                onValueChange={(val) => setSelectedEarningsYear(parseInt(val))}\n              >\n                <SelectTrigger className=\"w-[120px]\" data-testid=\"select-earnings-year\">\n                  <SelectValue placeholder=\"Select year\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {[...Array(5)].map((_, i) => {\n                    const year = new Date().getFullYear() - i;\n                    return (\n                      <SelectItem key={year} value={year.toString()}>\n                        {year}\n                      </SelectItem>\n                    );\n                  })}\n                </SelectContent>\n              </Select>\n              {sectionsCollapsed.annualEarnings ? (\n                <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n              ) : (\n                <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n              )}\n            </div>\n          </CardTitle>\n        </CardHeader>\n        {!sectionsCollapsed.annualEarnings && <CardContent>\n          {annualEarningsLoading ? (\n            <div className=\"space-y-2\">\n              <Skeleton className=\"h-12 w-full\" />\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between p-4 bg-green-50 dark:bg-green-950/20 rounded-lg border border-green-200 dark:border-green-800\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Earnings ({selectedEarningsYear})</p>\n                  <p className=\"text-3xl font-bold text-green-600\" data-testid=\"text-annual-earnings-amount\">\n                    Â£{annualEarnings?.totalEarnings?.toFixed(2) || \"0.00\"}\n                  </p>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"text-sm text-muted-foreground\">Approved Sessions</p>\n                  <p className=\"text-2xl font-semibold\" data-testid=\"text-annual-sessions-count\">\n                    {annualEarnings?.approvedSessions || 0}\n                  </p>\n                </div>\n              </div>\n              <p className=\"text-xs text-muted-foreground text-center\">\n                Earnings are calculated from approved timesheets only\n              </p>\n            </div>\n          )}\n        </CardContent>}\n      </Card>\n\n      {/* My Students - Topics Access */}\n      <Card data-testid=\"card-my-students\">\n        <CardHeader \n          className=\"pb-4 cursor-pointer hover:bg-muted/50 transition-colors\"\n          onClick={() => toggleSection('myStudents')}\n        >\n          <CardTitle className=\"flex items-center justify-between text-lg\">\n            <div className=\"flex items-center\">\n              <Users className=\"w-5 h-5 text-primary mr-2\" />\n              My Students - Topics\n            </div>\n            {sectionsCollapsed.myStudents ? (\n              <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n            ) : (\n              <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n            )}\n          </CardTitle>\n        </CardHeader>\n        {!sectionsCollapsed.myStudents && <CardContent>\n          {studentsLoading ? (\n            <div className=\"space-y-2\">\n              <Skeleton className=\"h-12 w-full\" />\n              <Skeleton className=\"h-12 w-full\" />\n            </div>\n          ) : students.length === 0 ? (\n            <p className=\"text-muted-foreground text-center py-4\">No students assigned yet.</p>\n          ) : (\n            <div className=\"space-y-2\">\n              {students.map((student) => (\n                <div\n                  key={student.id}\n                  className=\"flex items-center justify-between p-3 bg-muted/30 rounded-lg\"\n                  data-testid={`student-topics-row-${student.id}`}\n                >\n                  <div>\n                    <p className=\"font-medium\">{student.name}</p>\n                    <p className=\"text-sm text-muted-foreground\">{student.subject}</p>\n                  </div>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => openTopicsDialog(student)}\n                    data-testid={`button-view-topics-${student.id}`}\n                  >\n                    <BookOpen className=\"w-4 h-4 mr-2\" />\n                    View Topics\n                  </Button>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>}\n      </Card>\n\n      {/* Parent Messages */}\n      <Card data-testid=\"card-parent-messages\">\n        <CardHeader \n          className=\"pb-4 cursor-pointer hover:bg-muted/50 transition-colors\"\n          onClick={() => toggleSection('messages')}\n        >\n          <CardTitle className=\"flex items-center justify-between text-lg\">\n            <div className=\"flex items-center\">\n              <MessageSquare className=\"w-5 h-5 text-primary mr-2\" />\n              Messages from Parents\n              {parentMessages.filter(m => !m.isRead).length > 0 && (\n                <Badge variant=\"destructive\" className=\"ml-2\">\n                  {parentMessages.filter(m => !m.isRead).length} new\n                </Badge>\n              )}\n            </div>\n            {sectionsCollapsed.messages ? (\n              <ChevronRight className=\"w-5 h-5 text-muted-foreground\" />\n            ) : (\n              <ChevronDown className=\"w-5 h-5 text-muted-foreground\" />\n            )}\n          </CardTitle>\n        </CardHeader>\n        {!sectionsCollapsed.messages && <CardContent>\n          {messagesLoading ? (\n            <div className=\"space-y-3\">\n              <Skeleton className=\"h-16 w-full\" />\n              <Skeleton className=\"h-16 w-full\" />\n            </div>\n          ) : parentMessages.length === 0 ? (\n            <div className=\"text-center py-6 text-muted-foreground\">\n              <Mail className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n              <p>No messages from parents yet.</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {parentMessages.map((message) => (\n                <div\n                  key={message.id}\n                  className={`rounded-lg border ${\n                    message.isRead \n                      ? \"bg-muted/30 border-border\" \n                      : \"bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800\"\n                  }`}\n                  data-testid={`message-${message.id}`}\n                >\n                  <div \n                    className=\"p-4 cursor-pointer\"\n                    onClick={() => setExpandedMessageId(expandedMessageId === message.id ? null : message.id)}\n                    data-testid={`message-header-${message.id}`}\n                  >\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <div className=\"flex items-center gap-2\">\n                        {expandedMessageId === message.id ? (\n                          <ChevronDown className=\"w-4 h-4 text-muted-foreground\" />\n                        ) : (\n                          <ChevronRight className=\"w-4 h-4 text-muted-foreground\" />\n                        )}\n                        <div>\n                          <p className=\"font-medium text-foreground\">\n                            {message.student?.name || \"Unknown Student\"}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {message.createdAt ? format(new Date(message.createdAt), \"MMM dd, yyyy 'at' h:mm a\") : \"Unknown date\"}\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        {message.replies && message.replies.length > 0 && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {message.replies.length} {message.replies.length === 1 ? \"reply\" : \"replies\"}\n                          </Badge>\n                        )}\n                        {!message.isRead && (\n                          <Badge variant=\"secondary\" className=\"text-xs\">Unread</Badge>\n                        )}\n                      </div>\n                    </div>\n                    <p className=\"text-sm text-foreground whitespace-pre-wrap ml-6\">{message.message}</p>\n                  </div>\n                  \n                  {expandedMessageId === message.id && (\n                    <div className=\"border-t px-4 py-3 bg-background/50\">\n                      {/* Mark as Read button */}\n                      {!message.isRead && (\n                        <div className=\"mb-4\">\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              markAsReadMutation.mutate(message.id);\n                            }}\n                            disabled={markAsReadMutation.isPending}\n                            data-testid={`button-mark-read-${message.id}`}\n                          >\n                            <CheckCheck className=\"w-4 h-4 mr-2\" />\n                            {markAsReadMutation.isPending ? \"Marking...\" : \"Mark as Read\"}\n                          </Button>\n                        </div>\n                      )}\n                      \n                      {expandedMessage?.replies && expandedMessage.replies.length > 0 && (\n                        <div className=\"space-y-3 mb-4\">\n                          <p className=\"text-sm font-medium text-muted-foreground\">Conversation</p>\n                          {expandedMessage.replies.map((reply) => (\n                            <div \n                              key={reply.id} \n                              className=\"ml-6 p-3 bg-primary/5 rounded-lg border-l-2 border-primary\"\n                              data-testid={`reply-${reply.id}`}\n                            >\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <Badge variant=\"outline\" className=\"text-xs capitalize\">\n                                  {reply.repliedByRole}\n                                </Badge>\n                                <span className=\"text-xs text-muted-foreground\">\n                                  {reply.createdAt ? format(new Date(reply.createdAt), \"MMM dd, yyyy 'at' h:mm a\") : \"\"}\n                                </span>\n                              </div>\n                              <p className=\"text-sm whitespace-pre-wrap\">{reply.replyContent}</p>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                      \n                      <div className=\"space-y-2\">\n                        <p className=\"text-sm font-medium text-muted-foreground\">Write a reply</p>\n                        <Textarea\n                          placeholder=\"Type your reply here...\"\n                          value={replyContent}\n                          onChange={(e) => setReplyContent(e.target.value)}\n                          className=\"min-h-[80px]\"\n                          data-testid={`reply-textarea-${message.id}`}\n                        />\n                        <div className=\"flex justify-end\">\n                          <Button\n                            size=\"sm\"\n                            onClick={() => {\n                              if (replyContent.trim()) {\n                                createReplyMutation.mutate({\n                                  messageId: message.id,\n                                  replyContent: replyContent.trim(),\n                                });\n                              }\n                            }}\n                            disabled={!replyContent.trim() || createReplyMutation.isPending}\n                            data-testid={`button-send-reply-${message.id}`}\n                          >\n                            <Reply className=\"w-4 h-4 mr-2\" />\n                            {createReplyMutation.isPending ? \"Sending...\" : \"Send Reply\"}\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>}\n      </Card>\n\n      {/* Topics Dialog */}\n      <Dialog open={isTopicsDialogOpen} onOpenChange={setIsTopicsDialogOpen}>\n        <DialogContent className=\"max-w-xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <BookOpen className=\"w-5 h-5\" />\n              Topics for {selectedStudentForTopics?.name}\n            </DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            {topicsLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-10 w-full\" />\n                <Skeleton className=\"h-10 w-full\" />\n                <Skeleton className=\"h-10 w-full\" />\n              </div>\n            ) : studentTopics.length === 0 ? (\n              <p className=\"text-muted-foreground text-center py-4\">\n                No topics have been added for this student yet.\n              </p>\n            ) : (\n              <div className=\"space-y-2\">\n                <p className=\"text-sm text-muted-foreground mb-3\">\n                  Check off topics as you cover them with the student.\n                </p>\n                {studentTopics.map((topic, index) => (\n                  <div\n                    key={topic.id}\n                    className={`p-3 rounded-lg ${\n                      topic.isCovered ? \"bg-green-50 dark:bg-green-900/20\" : \"bg-muted/30\"\n                    }`}\n                    data-testid={`topic-checkbox-item-${topic.id}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <Checkbox\n                        id={`topic-${topic.id}`}\n                        checked={topic.isCovered}\n                        onCheckedChange={(checked) => {\n                          markTopicCoveredMutation.mutate({\n                            topicId: topic.id,\n                            isCovered: !!checked,\n                            coveredAt: checked ? new Date().toISOString() : undefined,\n                          });\n                        }}\n                        data-testid={`checkbox-topic-${topic.id}`}\n                      />\n                      <label\n                        htmlFor={`topic-${topic.id}`}\n                        className={`flex-1 cursor-pointer ${topic.isCovered ? \"line-through text-muted-foreground\" : \"\"}`}\n                      >\n                        <span className=\"text-muted-foreground text-sm mr-2\">{index + 1}.</span>\n                        {topic.title}\n                      </label>\n                    </div>\n                    {topic.isCovered && (\n                      <div className=\"flex items-center gap-2 mt-2 ml-7\">\n                        <Calendar className=\"w-3 h-3 text-muted-foreground\" />\n                        <span className=\"text-xs text-muted-foreground\">Completed:</span>\n                        <Input\n                          type=\"date\"\n                          value={topic.coveredAt ? format(new Date(topic.coveredAt), \"yyyy-MM-dd\") : \"\"}\n                          onChange={(e) => {\n                            if (e.target.value) {\n                              markTopicCoveredMutation.mutate({\n                                topicId: topic.id,\n                                isCovered: true,\n                                coveredAt: new Date(e.target.value).toISOString(),\n                              });\n                            }\n                          }}\n                          className=\"h-7 w-36 text-xs\"\n                          data-testid={`input-topic-date-${topic.id}`}\n                        />\n                      </div>\n                    )}\n                  </div>\n                ))}\n                <div className=\"pt-3 border-t mt-4\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    Progress: {studentTopics.filter(t => t.isCovered).length} / {studentTopics.length} topics covered\n                  </p>\n                </div>\n              </div>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Entry Dialog */}\n      <Dialog open={isEditEntryDialogOpen} onOpenChange={setIsEditEntryDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Session Entry</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 mt-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Date</label>\n              <Input\n                type=\"date\"\n                value={editEntryForm.date}\n                onChange={(e) => setEditEntryForm({ ...editEntryForm, date: e.target.value })}\n                data-testid=\"input-edit-entry-date\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Duration (hours)</label>\n              <Select\n                value={String(editEntryForm.duration)}\n                onValueChange={(value) => setEditEntryForm({ ...editEntryForm, duration: Number(value) })}\n              >\n                <SelectTrigger data-testid=\"select-edit-entry-duration\">\n                  <SelectValue placeholder=\"Select duration\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"0.25\">15 minutes</SelectItem>\n                  <SelectItem value=\"0.5\">30 minutes</SelectItem>\n                  <SelectItem value=\"0.75\">45 minutes</SelectItem>\n                  <SelectItem value=\"1\">1 hour</SelectItem>\n                  <SelectItem value=\"1.25\">1 hour 15 minutes</SelectItem>\n                  <SelectItem value=\"1.5\">1 hour 30 minutes</SelectItem>\n                  <SelectItem value=\"1.75\">1 hour 45 minutes</SelectItem>\n                  <SelectItem value=\"2\">2 hours</SelectItem>\n                  <SelectItem value=\"2.5\">2 hours 30 minutes</SelectItem>\n                  <SelectItem value=\"3\">3 hours</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Notes</label>\n              <Textarea\n                value={editEntryForm.notes}\n                onChange={(e) => setEditEntryForm({ ...editEntryForm, notes: e.target.value })}\n                placeholder=\"Session notes...\"\n                rows={3}\n                data-testid=\"input-edit-entry-notes\"\n              />\n            </div>\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setIsEditEntryDialogOpen(false);\n                  setEditingEntry(null);\n                }}\n                data-testid=\"button-cancel-edit-entry\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => {\n                  if (editingEntry) {\n                    updateEntryMutation.mutate({\n                      id: editingEntry.id,\n                      date: editEntryForm.date,\n                      duration: editEntryForm.duration,\n                      notes: editEntryForm.notes,\n                    });\n                  }\n                }}\n                disabled={updateEntryMutation.isPending}\n                data-testid=\"button-save-edit-entry\"\n              >\n                {updateEntryMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":87550,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5742,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar-background)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":2766,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"â€¦\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":2066,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --background: hsl(210, 40%, 98%);\n  --foreground: hsl(222.2, 84%, 4.9%);\n  --card: hsl(0, 0%, 100%);\n  --card-foreground: hsl(222.2, 84%, 4.9%);\n  --popover: hsl(0, 0%, 100%);\n  --popover-foreground: hsl(222.2, 84%, 4.9%);\n  --primary: hsl(221.2, 83.2%, 53.3%);\n  --primary-foreground: hsl(210, 40%, 98%);\n  --secondary: hsl(210, 40%, 96%);\n  --secondary-foreground: hsl(222.2, 84%, 4.9%);\n  --muted: hsl(210, 40%, 96%);\n  --muted-foreground: hsl(215.4, 16.3%, 46.9%);\n  --accent: hsl(210, 40%, 96%);\n  --accent-foreground: hsl(222.2, 84%, 4.9%);\n  --destructive: hsl(0, 84.2%, 60.2%);\n  --destructive-foreground: hsl(210, 40%, 98%);\n  --border: hsl(214.3, 31.8%, 91.4%);\n  --input: hsl(214.3, 31.8%, 91.4%);\n  --ring: hsl(221.2, 83.2%, 53.3%);\n  --chart-1: hsl(12, 76%, 61%);\n  --chart-2: hsl(173, 58%, 39%);\n  --chart-3: hsl(197, 37%, 24%);\n  --chart-4: hsl(43, 74%, 66%);\n  --chart-5: hsl(27, 87%, 67%);\n  --radius: 0.5rem;\n  --font-sans: \"Inter\", system-ui, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n}\n\n.dark {\n  --background: hsl(0, 0%, 3.9%);\n  --foreground: hsl(0, 0%, 98%);\n  --card: hsl(0, 0%, 3.9%);\n  --card-foreground: hsl(0, 0%, 98%);\n  --popover: hsl(0, 0%, 3.9%);\n  --popover-foreground: hsl(0, 0%, 98%);\n  --primary: hsl(221.2, 83.2%, 53.3%);\n  --primary-foreground: hsl(210, 40%, 98%);\n  --secondary: hsl(217.2, 32.6%, 17.5%);\n  --secondary-foreground: hsl(210, 40%, 98%);\n  --muted: hsl(217.2, 32.6%, 17.5%);\n  --muted-foreground: hsl(215, 20.2%, 65.1%);\n  --accent: hsl(217.2, 32.6%, 17.5%);\n  --accent-foreground: hsl(210, 40%, 98%);\n  --destructive: hsl(0, 84.2%, 60.2%);\n  --destructive-foreground: hsl(210, 40%, 98%);\n  --border: hsl(217.2, 32.6%, 17.5%);\n  --input: hsl(217.2, 32.6%, 17.5%);\n  --ring: hsl(221.2, 83.2%, 53.3%);\n  --chart-1: hsl(12, 76%, 61%);\n  --chart-2: hsl(173, 58%, 39%);\n  --chart-3: hsl(197, 37%, 24%);\n  --chart-4: hsl(43, 74%, 66%);\n  --chart-5: hsl(27, 87%, 67%);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    /* Optimize for mobile scrolling */\n    -webkit-overflow-scrolling: touch;\n    /* Prevent zoom on inputs on iOS */\n    font-size: 16px;\n  }\n\n  /* Mobile touch improvements */\n  button, [role=\"button\"], input[type=\"submit\"], input[type=\"button\"] {\n    -webkit-touch-callout: none;\n    -webkit-tap-highlight-color: transparent;\n    touch-action: manipulation;\n  }\n\n  /* Improve mobile form inputs */\n  input, textarea, select {\n    font-size: 16px;\n  }\n\n  /* Mobile-specific scrollbars */\n  ::-webkit-scrollbar {\n    width: 8px;\n    height: 8px;\n  }\n\n  ::-webkit-scrollbar-track {\n    background: transparent;\n  }\n\n  ::-webkit-scrollbar-thumb {\n    background: hsl(var(--muted-foreground) / 0.3);\n    border-radius: 4px;\n  }\n\n  ::-webkit-scrollbar-thumb:hover {\n    background: hsl(var(--muted-foreground) / 0.5);\n  }\n\n  /* Mobile table scrolling */\n  .mobile-scroll {\n    -webkit-overflow-scrolling: touch;\n    scrollbar-width: thin;\n    scrollbar-color: hsl(var(--muted-foreground) / 0.3) transparent;\n  }\n}\n","path":null,"size_bytes":3158,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1858,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"server/storage.ts":{"content":"import {\n  users,\n  students,\n  studentTutors,\n  timesheetEntries,\n  weeklyTimesheets,\n  timesheetStatusHistory,\n  tutorTimeSlots,\n  slotBookings,\n  notifications,\n  invoices,\n  invoiceLineItems,\n  payments,\n  tutorInvoices,\n  waitlist,\n  parentMessages,\n  parentMessageReplies,\n  studentTopics,\n  rateConfigurations,\n  tutorRates,\n  parentRates,\n  rateLinks,\n  adhocInvoices,\n  systemSettings,\n  type User,\n  type UpsertUser,\n  type InsertUser,\n  type UpdateUser,\n  type Student,\n  type InsertStudent,\n  type UpdateStudent,\n  type TimesheetEntry,\n  type InsertTimesheetEntry,\n  type WeeklyTimesheet,\n  type InsertWeeklyTimesheet,\n  type TimesheetStatusHistory,\n  type InsertTimesheetStatusHistory,\n  type TutorTimeSlot,\n  type InsertTutorTimeSlot,\n  type UpdateTutorTimeSlot,\n  type SlotBooking,\n  type InsertSlotBooking,\n  type Notification,\n  type InsertNotification,\n  type Invoice,\n  type InsertInvoice,\n  type UpdateInvoice,\n  type InvoiceLineItem,\n  type InsertInvoiceLineItem,\n  type Payment,\n  type InsertPayment,\n  type WaitlistEntry,\n  type InsertWaitlistEntry,\n  type UpdateWaitlistEntry,\n  type ParentMessage,\n  type InsertParentMessage,\n  type ParentMessageWithRelations,\n  type ParentMessageReply,\n  type InsertParentMessageReply,\n  type ParentMessageReplyWithRelations,\n  type StudentWithTutor,\n  type StudentWithRelations,\n  type TimesheetEntryWithRelations,\n  type WeeklyTimesheetWithRelations,\n  type TutorTimeSlotWithRelations,\n  type SlotBookingWithRelations,\n  type InvoiceWithRelations,\n  type PaymentWithRelations,\n  type ArchivedStudentSummary,\n  type ArchivedTutorSummary,\n  type StudentTopic,\n  type InsertStudentTopic,\n  type UpdateStudentTopic,\n  type StudentTutor,\n  type InsertStudentTutor,\n  type StudentTutorWithUser,\n  type StudentTopicWithRelations,\n  type RateConfiguration,\n  type InsertRateConfiguration,\n  type UpdateRateConfiguration,\n  type TutorRate,\n  type InsertTutorRate,\n  type UpdateTutorRate,\n  type ParentRate,\n  type InsertParentRate,\n  type UpdateParentRate,\n  type RateLink,\n  type InsertRateLink,\n  type TutorInvoice,\n  type InsertTutorInvoice,\n  type UpdateTutorInvoice,\n  type AdhocInvoice,\n  type InsertAdhocInvoice,\n  type UpdateAdhocInvoice,\n  type SystemSetting,\n  type InsertSystemSetting,\n  type UpdateSystemSetting,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, gte, lte, desc, asc, sql, inArray, not } from \"drizzle-orm\";\n\nexport interface IStorage {\n  // User operations (mandatory for Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  \n  // Tutor management\n  getTutors(includeInactive?: boolean): Promise<User[]>;\n  createTutor(tutor: InsertUser): Promise<User>;\n  updateTutor(id: string, updates: UpdateUser): Promise<User>;\n  archiveTutor(id: string): Promise<User>;\n  restoreTutor(id: string): Promise<User>;\n  \n  // Student operations\n  getStudents(includeInactive?: boolean): Promise<StudentWithTutor[]>;\n  getStudentsByTutor(tutorId: string): Promise<StudentWithTutor[]>;\n  getStudent(id: string): Promise<StudentWithTutor | undefined>;\n  createStudent(student: InsertStudent): Promise<Student>;\n  updateStudent(id: string, updates: UpdateStudent): Promise<Student>;\n  decrementStudentSessions(id: string): Promise<Student>;\n  incrementStudentSessions(id: string): Promise<Student>;\n  addSessionsToStudent(id: string, sessions: number): Promise<Student>;\n  archiveStudent(id: string): Promise<Student>;\n  restoreStudent(id: string): Promise<Student>;\n  deleteStudent(id: string): Promise<void>;\n  \n  // Timesheet operations\n  getTimesheetEntries(tutorId?: string, startDate?: Date, endDate?: Date): Promise<TimesheetEntryWithRelations[]>;\n  getTimesheetEntriesByStatus(status: \"pending\" | \"approved\" | \"rejected\"): Promise<TimesheetEntryWithRelations[]>;\n  createTimesheetEntry(entry: InsertTimesheetEntry & { tutorId: string }): Promise<TimesheetEntry>;\n  updateTimesheetEntryStatus(id: string, status: \"approved\" | \"rejected\"): Promise<TimesheetEntry>;\n  \n  // Weekly timesheet operations\n  getOrCreateWeeklyTimesheet(tutorId: string, weekStart: Date, weekEnd: Date): Promise<WeeklyTimesheet>;\n  getWeeklyTimesheet(id: string): Promise<WeeklyTimesheetWithRelations | undefined>;\n  getWeeklyTimesheetsByTutor(tutorId: string): Promise<WeeklyTimesheetWithRelations[]>;\n  getWeeklyTimesheetsByStatus(status: \"draft\" | \"submitted\" | \"approved\" | \"rejected\"): Promise<WeeklyTimesheetWithRelations[]>;\n  submitWeeklyTimesheet(id: string): Promise<WeeklyTimesheet>;\n  reviewWeeklyTimesheet(id: string, reviewerId: string, status: \"approved\" | \"rejected\", notes?: string): Promise<WeeklyTimesheet>;\n  \n  // Timesheet entry operations for tutors\n  getTimesheetEntry(id: string): Promise<TimesheetEntry | undefined>;\n  updateTimesheetEntryByTutor(id: string, tutorId: string, updates: { date?: Date; duration?: number; notes?: string }): Promise<TimesheetEntry>;\n  deleteTimesheetEntry(id: string, tutorId: string): Promise<void>;\n  \n  // Timesheet status history operations\n  addTimesheetStatusHistory(history: InsertTimesheetStatusHistory): Promise<TimesheetStatusHistory>;\n  getTimesheetStatusHistory(weeklyTimesheetId: string): Promise<(TimesheetStatusHistory & { changedByName?: string })[]>;\n  \n  // Time slot operations\n  getTutorTimeSlots(tutorId?: string, startDate?: Date, endDate?: Date): Promise<TutorTimeSlotWithRelations[]>;\n  createTutorTimeSlot(slot: InsertTutorTimeSlot): Promise<TutorTimeSlot>;\n  updateTutorTimeSlot(id: string, updates: UpdateTutorTimeSlot): Promise<TutorTimeSlot>;\n  deleteTutorTimeSlot(id: string): Promise<void>;\n  getAvailableSlots(startDate?: Date, endDate?: Date, tutorId?: string, subject?: string): Promise<TutorTimeSlotWithRelations[]>;\n  \n  // Booking operations\n  getSlotBookings(studentId?: string, slotId?: string): Promise<SlotBookingWithRelations[]>;\n  createSlotBooking(booking: InsertSlotBooking): Promise<SlotBooking>;\n  cancelSlotBooking(id: string): Promise<SlotBooking>;\n  markAttendance(slotId: string, presentStudentIds: string[]): Promise<TimesheetEntry[]>;\n  \n  // Notification operations\n  getNotifications(userId: string): Promise<Notification[]>;\n  createNotification(notification: InsertNotification): Promise<Notification>;\n  markNotificationRead(id: string): Promise<Notification>;\n  \n  // Analytics\n  getTutorWeeklyEarnings(tutorId: string, startDate: Date, endDate: Date): Promise<number>;\n  getTutorWeeks(tutorId: string): Promise<{ weekStart: Date; weekEnd: Date }[]>;\n  getTutorAnnualEarnings(tutorId: string, year: number): Promise<{ totalEarnings: number; approvedSessions: number; year: number }>;\n  getAdminStats(): Promise<{\n    totalRevenue: number;\n    activeStudents: number;\n    activeTutors: number;\n    lowBalanceAlerts: number;\n    weeklyOutgoings: number;\n    totalExpenditure: number;\n    monthlyIncome: number;\n  }>;\n  \n  // Archive operations\n  getArchivedStudents(): Promise<ArchivedStudentSummary[]>;\n  getArchivedStudentDetails(id: string): Promise<{\n    student: StudentWithTutor;\n    invoices: InvoiceWithRelations[];\n    payments: PaymentWithRelations[];\n    timesheetEntries: TimesheetEntryWithRelations[];\n    totalBilled: number;\n    totalReceived: number;\n    totalOutstanding: number;\n  } | undefined>;\n  getArchivedTutors(): Promise<ArchivedTutorSummary[]>;\n  getArchivedTutorDetails(id: string): Promise<{\n    tutor: User;\n    timesheetEntries: TimesheetEntryWithRelations[];\n    students: StudentWithTutor[];\n    totalEarnings: number;\n    totalPaid: number;\n    totalOutstanding: number;\n  } | undefined>;\n  \n  // Invoice operations\n  getInvoices(studentId?: string): Promise<InvoiceWithRelations[]>;\n  getInvoice(id: string): Promise<InvoiceWithRelations | undefined>;\n  createInvoice(invoice: InsertInvoice): Promise<Invoice>;\n  updateInvoice(id: string, updates: UpdateInvoice): Promise<Invoice>;\n  addInvoiceLineItem(lineItem: InsertInvoiceLineItem): Promise<InvoiceLineItem>;\n  \n  // Adhoc invoice operations\n  getAdhocInvoices(): Promise<AdhocInvoice[]>;\n  getAdhocInvoice(id: string): Promise<AdhocInvoice | undefined>;\n  createAdhocInvoice(invoice: InsertAdhocInvoice): Promise<AdhocInvoice>;\n  updateAdhocInvoice(id: string, updates: UpdateAdhocInvoice): Promise<AdhocInvoice>;\n  deleteAdhocInvoice(id: string): Promise<void>;\n  \n  // Payment operations\n  getPayments(studentId?: string): Promise<PaymentWithRelations[]>;\n  createPayment(payment: InsertPayment): Promise<Payment>;\n  \n  // Waitlist operations\n  getWaitlistEntries(): Promise<WaitlistEntry[]>;\n  getWaitlistEntry(id: string): Promise<WaitlistEntry | undefined>;\n  createWaitlistEntry(entry: InsertWaitlistEntry): Promise<WaitlistEntry>;\n  updateWaitlistEntry(id: string, updates: UpdateWaitlistEntry): Promise<WaitlistEntry>;\n  deleteWaitlistEntry(id: string): Promise<void>;\n  \n  // Parent portal operations\n  getStudentsByParentEmail(email: string): Promise<StudentWithTutor[]>;\n  getTimesheetEntriesByStudentIds(studentIds: string[]): Promise<TimesheetEntryWithRelations[]>;\n  getInvoicesByStudentIds(studentIds: string[]): Promise<Invoice[]>;\n  getStudentInvoiceSummaries(): Promise<{ studentId: string; outstandingInvoices: number; unpaidSessions: number }[]>;\n  getPaymentsByStudentIds(studentIds: string[]): Promise<Payment[]>;\n  \n  // Parent message operations\n  getParentMessages(recipientType?: \"tutor\" | \"admin\", tutorId?: string): Promise<ParentMessageWithRelations[]>;\n  getParentMessagesByParentEmail(email: string): Promise<ParentMessageWithRelations[]>;\n  getParentMessage(id: string): Promise<ParentMessageWithRelations | undefined>;\n  createParentMessage(message: InsertParentMessage): Promise<ParentMessage>;\n  markParentMessageRead(id: string, tutorId?: string): Promise<ParentMessage>;\n  createParentMessageReply(reply: InsertParentMessageReply): Promise<ParentMessageReply>;\n  getParentMessageReplies(messageId: string): Promise<ParentMessageReplyWithRelations[]>;\n  \n  // Student topics operations\n  getStudentTopics(studentId: string): Promise<StudentTopic[]>;\n  replaceStudentTopics(studentId: string, topics: InsertStudentTopic[]): Promise<StudentTopic[]>;\n  updateStudentTopic(id: string, updates: UpdateStudentTopic): Promise<StudentTopic>;\n  markStudentTopicCovered(topicId: string, tutorId: string, isCovered: boolean, coveredAt?: Date): Promise<StudentTopic>;\n  \n  // Rate configuration operations (deprecated)\n  getRateConfigurations(): Promise<RateConfiguration[]>;\n  getRateConfiguration(id: string): Promise<RateConfiguration | undefined>;\n  createRateConfiguration(rate: InsertRateConfiguration): Promise<RateConfiguration>;\n  updateRateConfiguration(id: string, updates: UpdateRateConfiguration): Promise<RateConfiguration>;\n  deleteRateConfiguration(id: string): Promise<void>;\n  \n  // Tutor rate operations (independent)\n  getTutorRates(): Promise<TutorRate[]>;\n  getTutorRate(id: string): Promise<TutorRate | undefined>;\n  createTutorRate(rate: InsertTutorRate): Promise<TutorRate>;\n  updateTutorRate(id: string, updates: UpdateTutorRate): Promise<TutorRate>;\n  deleteTutorRate(id: string): Promise<void>;\n  \n  // Parent rate operations (independent)\n  getParentRates(): Promise<ParentRate[]>;\n  getParentRate(id: string): Promise<ParentRate | undefined>;\n  createParentRate(rate: InsertParentRate): Promise<ParentRate>;\n  updateParentRate(id: string, updates: UpdateParentRate): Promise<ParentRate>;\n  deleteParentRate(id: string): Promise<void>;\n  \n  // Rate link operations (for profit analysis)\n  getRateLinks(): Promise<(RateLink & { tutorRate: TutorRate; parentRate: ParentRate })[]>;\n  createRateLink(link: InsertRateLink): Promise<RateLink>;\n  deleteRateLink(id: string): Promise<void>;\n  deleteLinkByTutorRateId(tutorRateId: string): Promise<void>;\n  deleteLinkByParentRateId(parentRateId: string): Promise<void>;\n  \n  // System settings operations\n  getSystemSetting(key: string): Promise<SystemSetting | undefined>;\n  getSystemSettings(): Promise<SystemSetting[]>;\n  upsertSystemSetting(key: string, value: string, description?: string): Promise<SystemSetting>;\n  \n  // Overdue invoice operations\n  markOverdueInvoices(): Promise<number>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  async getStudents(includeInactive: boolean = false): Promise<StudentWithTutor[]> {\n    const condition = includeInactive ? undefined : eq(students.isActive, true);\n    let query = db\n      .select()\n      .from(students)\n      .leftJoin(users, eq(students.tutorId, users.id));\n    \n    if (condition) {\n      query = query.where(condition);\n    }\n    \n    return await query\n      .orderBy(asc(students.name))\n      .then(rows => \n        rows.map(row => ({\n          ...row.students,\n          tutor: row.users!,\n        }))\n      );\n  }\n\n  async getStudentsByTutor(tutorId: string): Promise<StudentWithTutor[]> {\n    // Get students where this tutor is the primary tutor\n    const primaryStudents = await db\n      .select()\n      .from(students)\n      .leftJoin(users, eq(students.tutorId, users.id))\n      .where(and(eq(students.tutorId, tutorId), eq(students.isActive, true)))\n      .orderBy(asc(students.name))\n      .then(rows => \n        rows.map(row => ({\n          ...row.students,\n          tutor: row.users!,\n        }))\n      );\n\n    // Get students where this tutor is assigned via join table\n    const assignedStudentIds = await db\n      .select({ studentId: studentTutors.studentId })\n      .from(studentTutors)\n      .where(eq(studentTutors.tutorId, tutorId));\n\n    if (assignedStudentIds.length === 0) {\n      return primaryStudents;\n    }\n\n    const assignedStudents = await db\n      .select()\n      .from(students)\n      .leftJoin(users, eq(students.tutorId, users.id))\n      .where(and(\n        inArray(students.id, assignedStudentIds.map(s => s.studentId)),\n        eq(students.isActive, true)\n      ))\n      .orderBy(asc(students.name))\n      .then(rows => \n        rows.map(row => ({\n          ...row.students,\n          tutor: row.users!,\n        }))\n      );\n\n    // Merge and deduplicate by student ID\n    const allStudentsMap = new Map<string, StudentWithTutor>();\n    for (const student of primaryStudents) {\n      allStudentsMap.set(student.id, student);\n    }\n    for (const student of assignedStudents) {\n      if (!allStudentsMap.has(student.id)) {\n        allStudentsMap.set(student.id, student);\n      }\n    }\n\n    return Array.from(allStudentsMap.values()).sort((a, b) => a.name.localeCompare(b.name));\n  }\n\n  // Student-Tutor relationship methods\n  async getStudentTutors(studentId: string): Promise<StudentTutorWithUser[]> {\n    return await db\n      .select()\n      .from(studentTutors)\n      .leftJoin(users, eq(studentTutors.tutorId, users.id))\n      .where(eq(studentTutors.studentId, studentId))\n      .then(rows => \n        rows.map(row => ({\n          ...row.student_tutors,\n          tutor: row.users!,\n        }))\n      );\n  }\n\n  async addStudentTutor(studentId: string, tutorId: string, isPrimary: boolean = false): Promise<StudentTutor> {\n    // Check if assignment already exists\n    const existing = await db\n      .select()\n      .from(studentTutors)\n      .where(and(eq(studentTutors.studentId, studentId), eq(studentTutors.tutorId, tutorId)));\n    \n    if (existing.length > 0) {\n      return existing[0];\n    }\n\n    const [newAssignment] = await db\n      .insert(studentTutors)\n      .values({ studentId, tutorId, isPrimary })\n      .returning();\n    return newAssignment;\n  }\n\n  async removeStudentTutor(studentId: string, tutorId: string): Promise<void> {\n    await db\n      .delete(studentTutors)\n      .where(and(eq(studentTutors.studentId, studentId), eq(studentTutors.tutorId, tutorId)));\n  }\n\n  async setStudentTutors(studentId: string, tutorIds: string[]): Promise<StudentTutorWithUser[]> {\n    // Remove all existing assignments\n    await db\n      .delete(studentTutors)\n      .where(eq(studentTutors.studentId, studentId));\n\n    // Add new assignments if any\n    if (tutorIds.length > 0) {\n      await db\n        .insert(studentTutors)\n        .values(tutorIds.map((tutorId, index) => ({\n          studentId,\n          tutorId,\n          isPrimary: index === 0,\n        })));\n    }\n\n    return this.getStudentTutors(studentId);\n  }\n\n  async archiveStudent(id: string): Promise<Student> {\n    const [updatedStudent] = await db\n      .update(students)\n      .set({ isActive: false, updatedAt: new Date() })\n      .where(eq(students.id, id))\n      .returning();\n    return updatedStudent;\n  }\n\n  async restoreStudent(id: string): Promise<Student> {\n    const [updatedStudent] = await db\n      .update(students)\n      .set({ isActive: true, updatedAt: new Date() })\n      .where(eq(students.id, id))\n      .returning();\n    return updatedStudent;\n  }\n\n  async deleteStudent(id: string): Promise<void> {\n    // First check if student is archived (only archived students can be deleted)\n    const [student] = await db\n      .select()\n      .from(students)\n      .where(eq(students.id, id));\n    \n    if (!student) {\n      throw new Error(\"Student not found\");\n    }\n    \n    if (student.isActive) {\n      throw new Error(\"Only archived students can be permanently deleted\");\n    }\n    \n    // Delete related records first (timesheet entries, slot bookings, student-tutor assignments)\n    await db.delete(timesheetEntries).where(eq(timesheetEntries.studentId, id));\n    await db.delete(slotBookings).where(eq(slotBookings.studentId, id));\n    await db.delete(studentTutors).where(eq(studentTutors.studentId, id));\n    \n    // Delete the student\n    await db.delete(students).where(eq(students.id, id));\n  }\n\n  async getStudent(id: string): Promise<StudentWithTutor | undefined> {\n    const [result] = await db\n      .select()\n      .from(students)\n      .leftJoin(users, eq(students.tutorId, users.id))\n      .where(eq(students.id, id));\n    \n    if (!result) return undefined;\n    \n    return {\n      ...result.students,\n      tutor: result.users!,\n    };\n  }\n\n  async createStudent(student: InsertStudent): Promise<Student> {\n    const [newStudent] = await db\n      .insert(students)\n      .values(student)\n      .returning();\n    \n    // Note: Invoices are now generated per session logged, not upfront\n    // The sessionsBooked field tracks prepaid credits for reference\n    \n    return newStudent;\n  }\n\n  async updateStudent(id: string, updates: UpdateStudent): Promise<Student> {\n    const [updatedStudent] = await db\n      .update(students)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(students.id, id))\n      .returning();\n    return updatedStudent;\n  }\n\n  async decrementStudentSessions(id: string): Promise<Student> {\n    // Simply decrement sessions for tracking prepaid credits\n    // Invoice generation is now handled separately in createTimesheetEntry\n    const [updatedStudent] = await db\n      .update(students)\n      .set({ \n        sessionsRemaining: sql`${students.sessionsRemaining} - 1`,\n        updatedAt: new Date()\n      })\n      .where(eq(students.id, id))\n      .returning();\n    \n    return updatedStudent;\n  }\n\n  async incrementStudentSessions(id: string): Promise<Student> {\n    const [updatedStudent] = await db\n      .update(students)\n      .set({ \n        sessionsRemaining: sql`${students.sessionsRemaining} + 1`,\n        updatedAt: new Date()\n      })\n      .where(eq(students.id, id))\n      .returning();\n    return updatedStudent;\n  }\n\n  async addSessionsToStudent(id: string, sessions: number): Promise<Student> {\n    const [updatedStudent] = await db\n      .update(students)\n      .set({ \n        sessionsRemaining: sql`${students.sessionsRemaining} + ${sessions}`,\n        sessionsBooked: sessions, // Update the booked count for future invoices\n        updatedAt: new Date()\n      })\n      .where(eq(students.id, id))\n      .returning();\n    return updatedStudent;\n  }\n\n  async getTimesheetEntries(tutorId?: string, startDate?: Date, endDate?: Date): Promise<TimesheetEntryWithRelations[]> {\n    let query = db\n      .select()\n      .from(timesheetEntries)\n      .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n      .leftJoin(users, eq(timesheetEntries.tutorId, users.id));\n\n    const conditions = [];\n    if (tutorId) conditions.push(eq(timesheetEntries.tutorId, tutorId));\n    if (startDate) conditions.push(gte(timesheetEntries.date, startDate));\n    if (endDate) conditions.push(lte(timesheetEntries.date, endDate));\n\n    if (conditions.length > 0) {\n      query = query.where(and(...conditions));\n    }\n\n    const rows = await query.orderBy(desc(timesheetEntries.date));\n    \n    return rows.map(row => ({\n      ...row.timesheet_entries,\n      student: row.students!,\n      tutor: row.users!,\n    }));\n  }\n\n  async getTimesheetEntriesByStatus(status: \"pending\" | \"approved\" | \"rejected\"): Promise<TimesheetEntryWithRelations[]> {\n    const rows = await db\n      .select()\n      .from(timesheetEntries)\n      .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n      .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n      .where(eq(timesheetEntries.status, status))\n      .orderBy(desc(timesheetEntries.createdAt));\n\n    return rows.map(row => ({\n      ...row.timesheet_entries,\n      student: row.students!,\n      tutor: row.users!,\n    }));\n  }\n\n  async createTimesheetEntry(entry: InsertTimesheetEntry & { tutorId: string }): Promise<TimesheetEntry> {\n    // Get student to calculate rates\n    const student = await this.getStudent(entry.studentId);\n    if (!student) {\n      throw new Error(\"Student not found\");\n    }\n\n    const duration = parseFloat(entry.duration.toString());\n    const tutorEarnings = parseFloat(student.tutorRate.toString()) * duration;\n    const parentBilling = parseFloat(student.parentRate.toString()) * duration;\n\n    // Get or create the weekly timesheet for this session's week\n    const sessionDate = new Date(entry.date);\n    const dayOfWeek = sessionDate.getDay();\n    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n    const weekStart = new Date(sessionDate);\n    weekStart.setDate(sessionDate.getDate() + mondayOffset);\n    weekStart.setHours(0, 0, 0, 0);\n    const weekEnd = new Date(weekStart);\n    weekEnd.setDate(weekStart.getDate() + 6);\n    weekEnd.setHours(23, 59, 59, 999);\n\n    // getOrCreateWeeklyTimesheet will return a draft/rejected timesheet if one exists,\n    // or create a new draft timesheet (even if submitted/approved ones exist for this week)\n    const weeklyTimesheet = await this.getOrCreateWeeklyTimesheet(entry.tutorId, weekStart, weekEnd);\n\n    const [newEntry] = await db\n      .insert(timesheetEntries)\n      .values({\n        ...entry,\n        weeklyTimesheetId: weeklyTimesheet.id,\n        tutorEarnings: tutorEarnings.toString(),\n        parentBilling: parentBilling.toString(),\n      })\n      .returning();\n\n    // Decrement student sessions (for tracking prepaid credits)\n    const updatedStudent = await this.decrementStudentSessions(entry.studentId);\n    \n    // Only generate a parent invoice when sessions remaining reaches 0 or below\n    // This means the prepaid package has been exhausted\n    if (updatedStudent.sessionsRemaining <= 0) {\n      await this.generateParentInvoiceForSession(entry.studentId, newEntry.id, duration, parentBilling);\n    }\n\n    return newEntry;\n  }\n\n  async updateTimesheetEntryStatus(id: string, status: \"approved\" | \"rejected\"): Promise<TimesheetEntry> {\n    const [updatedEntry] = await db\n      .update(timesheetEntries)\n      .set({ status, updatedAt: new Date() })\n      .where(eq(timesheetEntries.id, id))\n      .returning();\n    return updatedEntry;\n  }\n\n  async updateTimesheetEntry(id: string, updates: { tutorEarnings?: string; parentBilling?: string; duration?: string; notes?: string }): Promise<TimesheetEntry> {\n    const [updatedEntry] = await db\n      .update(timesheetEntries)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(timesheetEntries.id, id))\n      .returning();\n    return updatedEntry;\n  }\n\n  async getTimesheetEntry(id: string): Promise<TimesheetEntry | undefined> {\n    const [entry] = await db\n      .select()\n      .from(timesheetEntries)\n      .where(eq(timesheetEntries.id, id));\n    return entry;\n  }\n\n  async updateTimesheetEntryByTutor(id: string, tutorId: string, updates: { date?: Date; duration?: number; notes?: string }): Promise<TimesheetEntry> {\n    // Verify the entry belongs to this tutor and the timesheet is in rejected status\n    const entry = await this.getTimesheetEntry(id);\n    if (!entry) {\n      throw new Error(\"Timesheet entry not found\");\n    }\n    if (entry.tutorId !== tutorId) {\n      throw new Error(\"You can only edit your own entries\");\n    }\n\n    // Check if the weekly timesheet is in rejected status\n    if (entry.weeklyTimesheetId) {\n      const weeklyTimesheet = await this.getWeeklyTimesheet(entry.weeklyTimesheetId);\n      if (weeklyTimesheet && weeklyTimesheet.status !== \"rejected\" && weeklyTimesheet.status !== \"draft\") {\n        throw new Error(\"Can only edit entries in rejected or draft timesheets\");\n      }\n    }\n\n    // Recalculate earnings if duration changed\n    const updateFields: any = { ...updates, updatedAt: new Date() };\n    if (updates.duration !== undefined) {\n      // Get student to recalculate rates\n      const [studentResult] = await db\n        .select()\n        .from(students)\n        .where(eq(students.id, entry.studentId));\n      \n      if (studentResult) {\n        const tutorEarnings = Number(studentResult.tutorRate) * updates.duration;\n        const parentBilling = Number(studentResult.parentRate) * updates.duration;\n        updateFields.tutorEarnings = tutorEarnings.toString();\n        updateFields.parentBilling = parentBilling.toString();\n        updateFields.duration = updates.duration.toString();\n      }\n    }\n\n    const [updatedEntry] = await db\n      .update(timesheetEntries)\n      .set(updateFields)\n      .where(eq(timesheetEntries.id, id))\n      .returning();\n    return updatedEntry;\n  }\n\n  async deleteTimesheetEntry(id: string, tutorId: string): Promise<void> {\n    // Verify the entry belongs to this tutor and the timesheet is in rejected/draft status\n    const entry = await this.getTimesheetEntry(id);\n    if (!entry) {\n      throw new Error(\"Timesheet entry not found\");\n    }\n    if (entry.tutorId !== tutorId) {\n      throw new Error(\"You can only delete your own entries\");\n    }\n\n    // Check if the weekly timesheet is in rejected or draft status\n    if (entry.weeklyTimesheetId) {\n      const weeklyTimesheet = await this.getWeeklyTimesheet(entry.weeklyTimesheetId);\n      if (weeklyTimesheet && weeklyTimesheet.status !== \"rejected\" && weeklyTimesheet.status !== \"draft\") {\n        throw new Error(\"Can only delete entries in rejected or draft timesheets\");\n      }\n    }\n\n    await db.delete(timesheetEntries).where(eq(timesheetEntries.id, id));\n\n    // Restore the session to the student's balance\n    await this.incrementStudentSessions(entry.studentId);\n  }\n\n  async addTimesheetStatusHistory(history: InsertTimesheetStatusHistory): Promise<TimesheetStatusHistory> {\n    const [newHistory] = await db\n      .insert(timesheetStatusHistory)\n      .values(history)\n      .returning();\n    return newHistory;\n  }\n\n  async getTimesheetStatusHistory(weeklyTimesheetId: string): Promise<(TimesheetStatusHistory & { changedByName?: string })[]> {\n    const history = await db\n      .select()\n      .from(timesheetStatusHistory)\n      .leftJoin(users, eq(timesheetStatusHistory.changedBy, users.id))\n      .where(eq(timesheetStatusHistory.weeklyTimesheetId, weeklyTimesheetId))\n      .orderBy(desc(timesheetStatusHistory.createdAt));\n\n    return history.map(h => ({\n      ...h.timesheet_status_history,\n      changedByName: h.users?.firstName && h.users?.lastName \n        ? `${h.users.firstName} ${h.users.lastName}` \n        : h.users?.email || 'Unknown',\n    }));\n  }\n\n  // Weekly Timesheet Operations\n  async getOrCreateWeeklyTimesheet(tutorId: string, weekStart: Date, weekEnd: Date): Promise<WeeklyTimesheet> {\n    // Check if a draft or rejected weekly timesheet exists for this tutor and week\n    // We only want to add to a timesheet that's still editable\n    const existing = await db\n      .select()\n      .from(weeklyTimesheets)\n      .where(\n        and(\n          eq(weeklyTimesheets.tutorId, tutorId),\n          eq(weeklyTimesheets.weekStart, weekStart)\n        )\n      );\n\n    // Look for a draft or rejected timesheet we can add to\n    const editableTimesheet = existing.find(ts => ts.status === \"draft\" || ts.status === \"rejected\");\n    if (editableTimesheet) {\n      return editableTimesheet;\n    }\n\n    // No editable timesheet exists - create a new one\n    // This allows late submissions to go to a separate timesheet even if one was already submitted/approved\n    const [newTimesheet] = await db\n      .insert(weeklyTimesheets)\n      .values({\n        tutorId,\n        weekStart,\n        weekEnd,\n      })\n      .returning();\n\n    return newTimesheet;\n  }\n\n  async getWeeklyTimesheet(id: string): Promise<WeeklyTimesheetWithRelations | undefined> {\n    const [result] = await db\n      .select()\n      .from(weeklyTimesheets)\n      .leftJoin(users, eq(weeklyTimesheets.tutorId, users.id))\n      .where(eq(weeklyTimesheets.id, id));\n\n    if (!result) return undefined;\n\n    // Get entries for this timesheet\n    const entries = await db\n      .select()\n      .from(timesheetEntries)\n      .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n      .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n      .where(eq(timesheetEntries.weeklyTimesheetId, id))\n      .orderBy(desc(timesheetEntries.date));\n\n    // Get reviewer if exists\n    let reviewer = null;\n    if (result.weekly_timesheets.reviewerId) {\n      const [reviewerResult] = await db\n        .select()\n        .from(users)\n        .where(eq(users.id, result.weekly_timesheets.reviewerId));\n      reviewer = reviewerResult || null;\n    }\n\n    return {\n      ...result.weekly_timesheets,\n      tutor: result.users!,\n      reviewer,\n      entries: entries.map(row => ({\n        ...row.timesheet_entries,\n        student: row.students!,\n        tutor: row.users!,\n      })),\n    };\n  }\n\n  async getWeeklyTimesheetsByTutor(tutorId: string): Promise<WeeklyTimesheetWithRelations[]> {\n    const results = await db\n      .select()\n      .from(weeklyTimesheets)\n      .leftJoin(users, eq(weeklyTimesheets.tutorId, users.id))\n      .where(eq(weeklyTimesheets.tutorId, tutorId))\n      .orderBy(desc(weeklyTimesheets.weekStart));\n\n    const timesheetsWithRelations: WeeklyTimesheetWithRelations[] = [];\n\n    for (const result of results) {\n      const entries = await db\n        .select()\n        .from(timesheetEntries)\n        .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n        .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n        .where(eq(timesheetEntries.weeklyTimesheetId, result.weekly_timesheets.id))\n        .orderBy(desc(timesheetEntries.date));\n\n      let reviewer = null;\n      if (result.weekly_timesheets.reviewerId) {\n        const [reviewerResult] = await db\n          .select()\n          .from(users)\n          .where(eq(users.id, result.weekly_timesheets.reviewerId));\n        reviewer = reviewerResult || null;\n      }\n\n      timesheetsWithRelations.push({\n        ...result.weekly_timesheets,\n        tutor: result.users!,\n        reviewer,\n        entries: entries.map(row => ({\n          ...row.timesheet_entries,\n          student: row.students!,\n          tutor: row.users!,\n        })),\n      });\n    }\n\n    return timesheetsWithRelations;\n  }\n\n  async getWeeklyTimesheetsByStatus(status: \"draft\" | \"submitted\" | \"approved\" | \"rejected\"): Promise<WeeklyTimesheetWithRelations[]> {\n    const results = await db\n      .select()\n      .from(weeklyTimesheets)\n      .leftJoin(users, eq(weeklyTimesheets.tutorId, users.id))\n      .where(eq(weeklyTimesheets.status, status))\n      .orderBy(desc(weeklyTimesheets.weekStart));\n\n    const timesheetsWithRelations: WeeklyTimesheetWithRelations[] = [];\n\n    for (const result of results) {\n      const entries = await db\n        .select()\n        .from(timesheetEntries)\n        .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n        .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n        .where(eq(timesheetEntries.weeklyTimesheetId, result.weekly_timesheets.id))\n        .orderBy(desc(timesheetEntries.date));\n\n      let reviewer = null;\n      if (result.weekly_timesheets.reviewerId) {\n        const [reviewerResult] = await db\n          .select()\n          .from(users)\n          .where(eq(users.id, result.weekly_timesheets.reviewerId));\n        reviewer = reviewerResult || null;\n      }\n\n      timesheetsWithRelations.push({\n        ...result.weekly_timesheets,\n        tutor: result.users!,\n        reviewer,\n        entries: entries.map(row => ({\n          ...row.timesheet_entries,\n          student: row.students!,\n          tutor: row.users!,\n        })),\n      });\n    }\n\n    return timesheetsWithRelations;\n  }\n\n  async submitWeeklyTimesheet(id: string): Promise<WeeklyTimesheet> {\n    // Get the current status before updating\n    const [current] = await db\n      .select()\n      .from(weeklyTimesheets)\n      .where(eq(weeklyTimesheets.id, id));\n\n    const fromStatus = current?.status as \"draft\" | \"submitted\" | \"approved\" | \"rejected\" | undefined;\n\n    const [submitted] = await db\n      .update(weeklyTimesheets)\n      .set({\n        status: \"submitted\",\n        submittedAt: new Date(),\n        reviewNotes: null, // Clear any previous rejection notes on resubmit\n        updatedAt: new Date(),\n      })\n      .where(eq(weeklyTimesheets.id, id))\n      .returning();\n\n    // Log status history\n    await this.addTimesheetStatusHistory({\n      weeklyTimesheetId: id,\n      fromStatus: fromStatus || null,\n      toStatus: \"submitted\",\n      changedBy: submitted.tutorId,\n      notes: fromStatus === \"rejected\" ? \"Resubmitted after rejection\" : \"Submitted for approval\",\n    });\n\n    // Update all entries in this timesheet to pending\n    await db\n      .update(timesheetEntries)\n      .set({ status: \"pending\", updatedAt: new Date() })\n      .where(eq(timesheetEntries.weeklyTimesheetId, id));\n\n    return submitted;\n  }\n\n  async reviewWeeklyTimesheet(id: string, reviewerId: string, status: \"approved\" | \"rejected\", notes?: string): Promise<WeeklyTimesheet> {\n    // Get the current status before updating\n    const [current] = await db\n      .select()\n      .from(weeklyTimesheets)\n      .where(eq(weeklyTimesheets.id, id));\n\n    const fromStatus = current?.status as \"draft\" | \"submitted\" | \"approved\" | \"rejected\" | undefined;\n\n    const [reviewed] = await db\n      .update(weeklyTimesheets)\n      .set({\n        status,\n        reviewedAt: new Date(),\n        reviewerId,\n        reviewNotes: notes || null,\n        updatedAt: new Date(),\n      })\n      .where(eq(weeklyTimesheets.id, id))\n      .returning();\n\n    // Log status history\n    await this.addTimesheetStatusHistory({\n      weeklyTimesheetId: id,\n      fromStatus: fromStatus || null,\n      toStatus: status,\n      changedBy: reviewerId,\n      notes: notes || (status === \"approved\" ? \"Approved\" : \"Rejected\"),\n    });\n\n    // Update all entries in this timesheet to match the status\n    await db\n      .update(timesheetEntries)\n      .set({ status, updatedAt: new Date() })\n      .where(eq(timesheetEntries.weeklyTimesheetId, id));\n\n    // Auto-generate tutor invoice when timesheet is approved\n    if (status === \"approved\" && current) {\n      // Calculate total earnings and hours from all entries in this timesheet\n      const entries = await db\n        .select()\n        .from(timesheetEntries)\n        .where(eq(timesheetEntries.weeklyTimesheetId, id));\n\n      const totalAmount = entries.reduce((sum, entry) => {\n        return sum + parseFloat(entry.tutorEarnings?.toString() || \"0\");\n      }, 0);\n\n      const totalHours = entries.reduce((sum, entry) => {\n        return sum + parseFloat(entry.duration?.toString() || \"0\");\n      }, 0);\n\n      if (totalAmount > 0) {\n        // Get tutor info for invoice title\n        const [tutor] = await db.select().from(users).where(eq(users.id, current.tutorId));\n        const tutorName = tutor ? (tutor.firstName && tutor.lastName \n          ? `${tutor.firstName}-${tutor.lastName}` \n          : tutor.email.split('@')[0]).toUpperCase().replace(/\\s+/g, '-').substring(0, 15) \n          : 'TUTOR';\n        \n        // Get next sequential invoice number\n        const [countResult] = await db.select({ count: sql<number>`count(*)` }).from(tutorInvoices);\n        const nextNumber = (countResult?.count || 0) + 1;\n        \n        // Generate invoice number: TutorName-Date-SequentialNumber\n        const now = new Date();\n        const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;\n        const invoiceNumber = `${tutorName}-${dateStr}-${String(nextNumber).padStart(4, '0')}`;\n\n        // Create tutor invoice automatically with approved status\n        await db.insert(tutorInvoices).values({\n          tutorId: current.tutorId,\n          weeklyTimesheetId: id,\n          invoiceNumber,\n          amount: totalAmount.toFixed(2),\n          hoursWorked: totalHours.toFixed(2),\n          status: \"approved\",\n          approvedAt: new Date(),\n          submittedAt: new Date(),\n          notes: `Auto-generated from approved timesheet for week of ${current.weekStart.toISOString().split('T')[0]}`,\n        });\n      }\n\n      // Update parent invoices linked to timesheet entries to \"approved\" status\n      const entryIds = entries.map(e => e.id);\n      if (entryIds.length > 0) {\n        // Find all invoice line items linked to these entries\n        const lineItems = await db\n          .select({ invoiceId: invoiceLineItems.invoiceId })\n          .from(invoiceLineItems)\n          .where(inArray(invoiceLineItems.timesheetEntryId, entryIds));\n        \n        const invoiceIds = Array.from(new Set(lineItems.map(li => li.invoiceId)));\n        \n        if (invoiceIds.length > 0) {\n          // Update parent invoices to approved status (only if not already paid)\n          await db\n            .update(invoices)\n            .set({ \n              status: \"approved\",\n              updatedAt: new Date() \n            })\n            .where(\n              and(\n                inArray(invoices.id, invoiceIds),\n                not(inArray(invoices.status, [\"paid\", \"cancelled\"]))\n              )\n            );\n        }\n      }\n    }\n\n    return reviewed;\n  }\n\n  async getTutorWeeklyEarnings(tutorId: string, startDate: Date, endDate: Date): Promise<number> {\n    const entries = await db\n      .select()\n      .from(timesheetEntries)\n      .where(\n        and(\n          eq(timesheetEntries.tutorId, tutorId),\n          eq(timesheetEntries.status, \"approved\"),\n          gte(timesheetEntries.date, startDate),\n          lte(timesheetEntries.date, endDate)\n        )\n      );\n\n    return entries.reduce((total, entry) => {\n      return total + parseFloat(entry.tutorEarnings.toString());\n    }, 0);\n  }\n\n  async getTutorWeeks(tutorId: string): Promise<{ weekStart: Date; weekEnd: Date }[]> {\n    const entries = await db\n      .select({ date: timesheetEntries.date })\n      .from(timesheetEntries)\n      .where(eq(timesheetEntries.tutorId, tutorId))\n      .orderBy(desc(timesheetEntries.date));\n\n    const weekMap = new Map<string, { weekStart: Date; weekEnd: Date }>();\n    \n    for (const entry of entries) {\n      const date = new Date(entry.date);\n      const day = date.getDay();\n      const diff = date.getDate() - day + (day === 0 ? -6 : 1);\n      const weekStart = new Date(date);\n      weekStart.setDate(diff);\n      weekStart.setHours(0, 0, 0, 0);\n      \n      const weekEnd = new Date(weekStart);\n      weekEnd.setDate(weekStart.getDate() + 6);\n      weekEnd.setHours(23, 59, 59, 999);\n      \n      const key = weekStart.toISOString().split('T')[0];\n      if (!weekMap.has(key)) {\n        weekMap.set(key, { weekStart, weekEnd });\n      }\n    }\n    \n    return Array.from(weekMap.values()).sort((a, b) => b.weekStart.getTime() - a.weekStart.getTime());\n  }\n\n  async getTutorAnnualEarnings(tutorId: string, year: number): Promise<{ totalEarnings: number; approvedSessions: number; year: number }> {\n    const yearStart = new Date(year, 0, 1);\n    const yearEnd = new Date(year, 11, 31, 23, 59, 59, 999);\n    \n    const entries = await db\n      .select({\n        tutorEarnings: timesheetEntries.tutorEarnings,\n      })\n      .from(timesheetEntries)\n      .innerJoin(weeklyTimesheets, eq(timesheetEntries.weeklyTimesheetId, weeklyTimesheets.id))\n      .where(\n        and(\n          eq(timesheetEntries.tutorId, tutorId),\n          eq(weeklyTimesheets.status, \"approved\"),\n          gte(timesheetEntries.date, yearStart),\n          lte(timesheetEntries.date, yearEnd)\n        )\n      );\n\n    const totalEarnings = entries.reduce((total, entry) => {\n      return total + parseFloat(entry.tutorEarnings.toString());\n    }, 0);\n\n    return {\n      totalEarnings,\n      approvedSessions: entries.length,\n      year,\n    };\n  }\n\n  async getTutors(includeInactive: boolean = false): Promise<User[]> {\n    // Return all staff (both admins and tutors) for management purposes\n    const condition = includeInactive ? undefined : eq(users.isActive, true);\n    let query = db.select().from(users);\n    \n    if (condition) {\n      query = query.where(condition);\n    }\n    \n    return await query.orderBy(asc(users.firstName), asc(users.lastName));\n  }\n\n  async archiveTutor(id: string): Promise<User> {\n    const [updatedUser] = await db\n      .update(users)\n      .set({ isActive: false, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    return updatedUser;\n  }\n\n  async restoreTutor(id: string): Promise<User> {\n    const [updatedUser] = await db\n      .update(users)\n      .set({ isActive: true, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    return updatedUser;\n  }\n\n  async createTutor(tutorData: InsertUser): Promise<User> {\n    const [tutor] = await db\n      .insert(users)\n      .values({ ...tutorData, role: \"tutor\" })\n      .returning();\n    return tutor;\n  }\n\n  async updateTutor(id: string, updates: UpdateUser): Promise<User> {\n    const [updatedTutor] = await db\n      .update(users)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    return updatedTutor;\n  }\n\n  async getAdminStats(): Promise<{\n    totalRevenue: number;\n    activeStudents: number;\n    activeTutors: number;\n    lowBalanceAlerts: number;\n    weeklyOutgoings: number;\n    totalExpenditure: number;\n    monthlyIncome: number;\n  }> {\n    // Get all approved timesheet entries for revenue calculation\n    const approvedEntries = await db\n      .select()\n      .from(timesheetEntries)\n      .where(eq(timesheetEntries.status, \"approved\"));\n\n    const totalRevenue = approvedEntries.reduce((total, entry) => {\n      return total + parseFloat(entry.parentBilling.toString());\n    }, 0);\n\n    // Calculate total expenditure (all tutor payments)\n    const totalExpenditure = approvedEntries.reduce((total, entry) => {\n      return total + parseFloat(entry.tutorEarnings.toString());\n    }, 0);\n\n    // Calculate monthly income (revenue for current month)\n    const now = new Date();\n    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n    monthStart.setHours(0, 0, 0, 0);\n    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n    monthEnd.setHours(23, 59, 59, 999);\n\n    const monthlyEntries = approvedEntries.filter(entry => {\n      const entryDate = new Date(entry.date);\n      return entryDate >= monthStart && entryDate <= monthEnd;\n    });\n\n    const monthlyIncome = monthlyEntries.reduce((total, entry) => {\n      return total + parseFloat(entry.parentBilling.toString());\n    }, 0);\n\n    // Get active students count (based on isActive field, not sessions remaining)\n    const allStudents = await db.select().from(students);\n    const activeStudents = allStudents.filter(student => student.isActive).length;\n\n    // Get active tutors count\n    const allTutors = await db.select().from(users).where(eq(users.role, \"tutor\"));\n    const activeTutors = allTutors.length;\n\n    // Get low balance alerts (students with 5 or fewer sessions, including 0)\n    const lowBalanceAlerts = allStudents.filter(student => student.isActive && student.sessionsRemaining <= 5).length;\n\n    // Calculate weekly outgoings (tutor payments for this week)\n    const dayOfWeek = now.getDay();\n    const weekStart = new Date(now);\n    weekStart.setDate(now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));\n    weekStart.setHours(0, 0, 0, 0);\n    const weekEnd = new Date(weekStart);\n    weekEnd.setDate(weekStart.getDate() + 6);\n    weekEnd.setHours(23, 59, 59, 999);\n\n    const weeklyEntries = await db\n      .select()\n      .from(timesheetEntries)\n      .where(\n        and(\n          eq(timesheetEntries.status, \"approved\"),\n          gte(timesheetEntries.date, weekStart),\n          lte(timesheetEntries.date, weekEnd)\n        )\n      );\n\n    const weeklyOutgoings = weeklyEntries.reduce((total, entry) => {\n      return total + parseFloat(entry.tutorEarnings.toString());\n    }, 0);\n\n    return {\n      totalRevenue,\n      activeStudents,\n      activeTutors,\n      lowBalanceAlerts,\n      weeklyOutgoings,\n      totalExpenditure,\n      monthlyIncome,\n    };\n  }\n\n  // Time slot operations\n  async getTutorTimeSlots(tutorId?: string, startDate?: Date, endDate?: Date): Promise<TutorTimeSlotWithRelations[]> {\n    const conditions = [eq(tutorTimeSlots.isCanceled, false)];\n    \n    if (tutorId) {\n      conditions.push(eq(tutorTimeSlots.tutorId, tutorId));\n    }\n    if (startDate) {\n      conditions.push(gte(tutorTimeSlots.startTime, startDate));\n    }\n    if (endDate) {\n      conditions.push(lte(tutorTimeSlots.endTime, endDate));\n    }\n\n    const results = await db\n      .select()\n      .from(tutorTimeSlots)\n      .leftJoin(users, eq(tutorTimeSlots.tutorId, users.id))\n      .where(and(...conditions))\n      .orderBy(asc(tutorTimeSlots.startTime));\n    \n    // Get bookings for each slot\n    const slotsWithBookings: TutorTimeSlotWithRelations[] = [];\n    \n    for (const result of results) {\n      const bookings = await this.getSlotBookings(undefined, result.tutor_time_slots.id);\n      slotsWithBookings.push({\n        ...result.tutor_time_slots,\n        tutor: result.users!,\n        slotBookings: bookings,\n      });\n    }\n\n    return slotsWithBookings;\n  }\n\n  async createTutorTimeSlot(slotData: InsertTutorTimeSlot): Promise<TutorTimeSlot> {\n    const [slot] = await db\n      .insert(tutorTimeSlots)\n      .values(slotData)\n      .returning();\n    return slot;\n  }\n\n  async updateTutorTimeSlot(id: string, updates: UpdateTutorTimeSlot): Promise<TutorTimeSlot> {\n    const [updatedSlot] = await db\n      .update(tutorTimeSlots)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(tutorTimeSlots.id, id))\n      .returning();\n    return updatedSlot;\n  }\n\n  async deleteTutorTimeSlot(id: string): Promise<void> {\n    await db\n      .update(tutorTimeSlots)\n      .set({ isCanceled: true, updatedAt: new Date() })\n      .where(eq(tutorTimeSlots.id, id));\n  }\n\n  async getAvailableSlots(startDate?: Date, endDate?: Date, tutorId?: string, subject?: string): Promise<TutorTimeSlotWithRelations[]> {\n    const conditions = [\n      eq(tutorTimeSlots.isCanceled, false),\n      gte(tutorTimeSlots.startTime, new Date()) // Only future slots\n    ];\n    \n    if (startDate) {\n      conditions.push(gte(tutorTimeSlots.startTime, startDate));\n    }\n    if (endDate) {\n      conditions.push(lte(tutorTimeSlots.endTime, endDate));\n    }\n    if (tutorId) {\n      conditions.push(eq(tutorTimeSlots.tutorId, tutorId));\n    }\n    if (subject) {\n      conditions.push(eq(tutorTimeSlots.subject, subject));\n    }\n\n    const results = await db\n      .select()\n      .from(tutorTimeSlots)\n      .leftJoin(users, eq(tutorTimeSlots.tutorId, users.id))\n      .where(and(...conditions))\n      .orderBy(asc(tutorTimeSlots.startTime));\n    \n    // Get bookings and filter slots that have availability\n    const availableSlots: TutorTimeSlotWithRelations[] = [];\n    \n    for (const result of results) {\n      const bookings = await this.getSlotBookings(undefined, result.tutor_time_slots.id);\n      const bookedCount = bookings.filter(b => b.status === \"booked\").length;\n      \n      if (bookedCount < result.tutor_time_slots.capacity) {\n        availableSlots.push({\n          ...result.tutor_time_slots,\n          tutor: result.users!,\n          slotBookings: bookings,\n        });\n      }\n    }\n\n    return availableSlots;\n  }\n\n  // Booking operations\n  async getSlotBookings(studentId?: string, slotId?: string): Promise<SlotBookingWithRelations[]> {\n    const conditions = [];\n    \n    if (studentId) {\n      conditions.push(eq(slotBookings.studentId, studentId));\n    }\n    if (slotId) {\n      conditions.push(eq(slotBookings.slotId, slotId));\n    }\n\n    let query = db\n      .select()\n      .from(slotBookings)\n      .leftJoin(tutorTimeSlots, eq(slotBookings.slotId, tutorTimeSlots.id))\n      .leftJoin(students, eq(slotBookings.studentId, students.id))\n      .leftJoin(users, eq(students.tutorId, users.id));\n\n    if (conditions.length > 0) {\n      query = query.where(and(...conditions));\n    }\n\n    const results = await query.orderBy(desc(slotBookings.createdAt));\n    \n    return results.map(result => ({\n      ...result.slot_bookings,\n      slot: result.tutor_time_slots!,\n      student: {\n        ...result.students!,\n        tutor: result.users!,\n      },\n    }));\n  }\n\n  async createSlotBooking(bookingData: InsertSlotBooking): Promise<SlotBooking> {\n    // Check if slot has capacity and student has sessions remaining\n    const slot = await db.select().from(tutorTimeSlots).where(eq(tutorTimeSlots.id, bookingData.slotId));\n    if (!slot[0]) {\n      throw new Error(\"Slot not found\");\n    }\n\n    const existingBookings = await this.getSlotBookings(undefined, bookingData.slotId);\n    const bookedCount = existingBookings.filter(b => b.status === \"booked\").length;\n    \n    if (bookedCount >= slot[0].capacity) {\n      throw new Error(\"Slot is full\");\n    }\n\n    const student = await this.getStudent(bookingData.studentId);\n    if (!student || student.sessionsRemaining <= 0) {\n      throw new Error(\"Student has no remaining sessions\");\n    }\n\n    const [booking] = await db\n      .insert(slotBookings)\n      .values(bookingData)\n      .returning();\n    \n    // Internal admin notification only (no parent notifications)\n    await this.createNotification({\n      userId: slot[0].tutorId, // Notify the tutor\n      type: \"schedule_changed\",\n      payload: {\n        message: `Student ${student.name} assigned to your session`,\n        slotTime: slot[0].startTime,\n        studentName: student.name\n      }\n    });\n\n    return booking;\n  }\n\n  async cancelSlotBooking(id: string): Promise<SlotBooking> {\n    const [canceledBooking] = await db\n      .update(slotBookings)\n      .set({ status: \"canceled\" })\n      .where(eq(slotBookings.id, id))\n      .returning();\n    return canceledBooking;\n  }\n\n  async markAttendance(slotId: string, presentStudentIds: string[]): Promise<TimesheetEntry[]> {\n    const slot = await db.select().from(tutorTimeSlots).where(eq(tutorTimeSlots.id, slotId));\n    if (!slot[0]) {\n      throw new Error(\"Slot not found\");\n    }\n\n    const bookings = await this.getSlotBookings(undefined, slotId);\n    const timesheetEntries: TimesheetEntry[] = [];\n\n    for (const booking of bookings) {\n      if (presentStudentIds.includes(booking.student.id)) {\n        // Mark as attended\n        await db\n          .update(slotBookings)\n          .set({ status: \"attended\" })\n          .where(eq(slotBookings.id, booking.id));\n\n        // Create timesheet entry\n        const duration = (slot[0].endTime.getTime() - slot[0].startTime.getTime()) / (1000 * 60 * 60);\n        const timesheetEntry = await this.createTimesheetEntry({\n          tutorId: slot[0].tutorId,\n          studentId: booking.student.id,\n          date: slot[0].startTime,\n          duration: duration.toString(),\n          notes: `Group class attendance - ${slot[0].subject || booking.student.subject}`,\n        });\n        \n        timesheetEntries.push(timesheetEntry);\n\n        // Decrement student sessions\n        await this.decrementStudentSessions(booking.student.id);\n\n        // Check for low balance notification (notify admins, not parents)\n        const updatedStudent = await this.getStudent(booking.student.id);\n        if (updatedStudent && updatedStudent.sessionsRemaining <= 2) {\n          // Notify admin users about low balance\n          const admins = await db.select().from(users).where(eq(users.role, \"admin\"));\n          for (const admin of admins) {\n            await this.createNotification({\n              userId: admin.id,\n              type: \"low_balance\",\n              payload: {\n                studentName: updatedStudent.name,\n                sessionsRemaining: updatedStudent.sessionsRemaining,\n                message: `Student ${updatedStudent.name} has ${updatedStudent.sessionsRemaining} sessions remaining`\n              }\n            });\n          }\n        }\n      } else {\n        // Mark as no-show\n        await db\n          .update(slotBookings)\n          .set({ status: \"no_show\" })\n          .where(eq(slotBookings.id, booking.id));\n      }\n    }\n\n    return timesheetEntries;\n  }\n\n  // Notification operations\n  async getNotifications(userId: string): Promise<Notification[]> {\n    return await db\n      .select()\n      .from(notifications)\n      .where(eq(notifications.userId, userId))\n      .orderBy(desc(notifications.createdAt));\n  }\n\n  async createNotification(notificationData: InsertNotification): Promise<Notification> {\n    const [notification] = await db\n      .insert(notifications)\n      .values(notificationData)\n      .returning();\n    return notification;\n  }\n\n  async markNotificationRead(id: string): Promise<Notification> {\n    const [notification] = await db\n      .update(notifications)\n      .set({ readAt: new Date() })\n      .where(eq(notifications.id, id))\n      .returning();\n    return notification;\n  }\n\n  // QuickBooks Export Methods - Replace Excel-to-QuickBooks workflow\n  async generateParentInvoicesCSV(startDate: Date, endDate: Date): Promise<string> {\n    // Get approved timesheet entries within date range\n    const approvedEntries = await db\n      .select()\n      .from(timesheetEntries)\n      .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n      .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n      .where(\n        and(\n          eq(timesheetEntries.status, \"approved\"),\n          gte(timesheetEntries.date, startDate),\n          lte(timesheetEntries.date, endDate)\n        )\n      )\n      .orderBy(students.name);\n\n    // Group by student for invoicing\n    const invoiceData: Record<string, {\n      studentName: string;\n      parentContact: string;\n      totalHours: number;\n      totalAmount: number;\n      sessions: Array<{\n        date: Date;\n        duration: number;\n        rate: number;\n        amount: number;\n        tutorName: string;\n        subject: string;\n      }>;\n    }> = {};\n\n    for (const entry of approvedEntries) {\n      const student = entry.students!;\n      const tutor = entry.users!;\n      const timesheet = entry.timesheet_entries;\n      \n      if (!invoiceData[student.id]) {\n        invoiceData[student.id] = {\n          studentName: student.name,\n          parentContact: student.parentContactInfo || 'No contact info',\n          totalHours: 0,\n          totalAmount: 0,\n          sessions: []\n        };\n      }\n\n      const duration = parseFloat(timesheet.duration);\n      const amount = parseFloat(timesheet.parentBilling);\n      \n      invoiceData[student.id].totalHours += duration;\n      invoiceData[student.id].totalAmount += amount;\n      invoiceData[student.id].sessions.push({\n        date: timesheet.date,\n        duration: duration,\n        rate: parseFloat(student.parentRate),\n        amount: amount,\n        tutorName: `${tutor.firstName} ${tutor.lastName}`,\n        subject: student.subject\n      });\n    }\n\n    // Generate CSV for QuickBooks import\n    const csvRows = [\n      'Student Name,Parent Contact,Date,Hours,Rate,Amount,Tutor,Subject,Invoice Total',\n    ];\n\n    for (const studentData of Object.values(invoiceData)) {\n      for (const session of studentData.sessions) {\n        csvRows.push([\n          `\"${studentData.studentName}\"`,\n          `\"${studentData.parentContact}\"`,\n          session.date.toISOString().split('T')[0],\n          session.duration.toString(),\n          session.rate.toString(),\n          session.amount.toString(),\n          `\"${session.tutorName}\"`,\n          `\"${session.subject}\"`,\n          studentData.totalAmount.toString()\n        ].join(','));\n      }\n    }\n\n    return csvRows.join('\\n');\n  }\n\n  async generateTutorPayrollCSV(startDate: Date, endDate: Date): Promise<string> {\n    // Get approved timesheet entries within date range\n    const approvedEntries = await db\n      .select()\n      .from(timesheetEntries)\n      .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n      .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n      .where(\n        and(\n          eq(timesheetEntries.status, \"approved\"),\n          gte(timesheetEntries.date, startDate),\n          lte(timesheetEntries.date, endDate)\n        )\n      )\n      .orderBy(users.firstName);\n\n    // Group by tutor for payroll\n    const payrollData: Record<string, {\n      tutorName: string;\n      tutorEmail: string;\n      totalHours: number;\n      totalEarnings: number;\n      sessions: Array<{\n        date: Date;\n        studentName: string;\n        duration: number;\n        rate: number;\n        earnings: number;\n        subject: string;\n      }>;\n    }> = {};\n\n    for (const entry of approvedEntries) {\n      const student = entry.students!;\n      const tutor = entry.users!;\n      const timesheet = entry.timesheet_entries;\n      \n      if (!payrollData[tutor.id]) {\n        payrollData[tutor.id] = {\n          tutorName: `${tutor.firstName} ${tutor.lastName}`,\n          tutorEmail: tutor.email || 'No email',\n          totalHours: 0,\n          totalEarnings: 0,\n          sessions: []\n        };\n      }\n\n      const duration = parseFloat(timesheet.duration);\n      const earnings = parseFloat(timesheet.tutorEarnings);\n      \n      payrollData[tutor.id].totalHours += duration;\n      payrollData[tutor.id].totalEarnings += earnings;\n      payrollData[tutor.id].sessions.push({\n        date: timesheet.date,\n        studentName: student.name,\n        duration: duration,\n        rate: parseFloat(student.tutorRate),\n        earnings: earnings,\n        subject: student.subject\n      });\n    }\n\n    // Generate CSV for payroll processing\n    const csvRows = [\n      'Tutor Name,Tutor Email,Date,Student,Hours,Rate,Earnings,Subject,Total Earnings',\n    ];\n\n    for (const tutorData of Object.values(payrollData)) {\n      for (const session of tutorData.sessions) {\n        csvRows.push([\n          `\"${tutorData.tutorName}\"`,\n          `\"${tutorData.tutorEmail}\"`,\n          session.date.toISOString().split('T')[0],\n          `\"${session.studentName}\"`,\n          session.duration.toString(),\n          session.rate.toString(),\n          session.earnings.toString(),\n          `\"${session.subject}\"`,\n          tutorData.totalEarnings.toString()\n        ].join(','));\n      }\n    }\n\n    return csvRows.join('\\n');\n  }\n\n  // Archive operations\n  async getArchivedStudents(): Promise<ArchivedStudentSummary[]> {\n    const archivedStudents = await db\n      .select()\n      .from(students)\n      .leftJoin(users, eq(students.tutorId, users.id))\n      .where(eq(students.isActive, false))\n      .orderBy(desc(students.updatedAt));\n\n    const results: ArchivedStudentSummary[] = [];\n\n    for (const row of archivedStudents) {\n      const student = row.students;\n      const tutor = row.users!;\n\n      // Get total billed from approved timesheet entries\n      const billedResult = await db\n        .select({ total: sql<string>`COALESCE(SUM(${timesheetEntries.parentBilling}), 0)` })\n        .from(timesheetEntries)\n        .where(and(\n          eq(timesheetEntries.studentId, student.id),\n          eq(timesheetEntries.status, \"approved\")\n        ));\n      const totalBilled = parseFloat(billedResult[0]?.total || \"0\");\n\n      // Get total received from payments\n      const receivedResult = await db\n        .select({ total: sql<string>`COALESCE(SUM(${payments.amount}), 0)` })\n        .from(payments)\n        .where(eq(payments.studentId, student.id));\n      const totalReceived = parseFloat(receivedResult[0]?.total || \"0\");\n\n      // Get counts\n      const invoiceCountResult = await db\n        .select({ count: sql<string>`COUNT(*)` })\n        .from(invoices)\n        .where(eq(invoices.studentId, student.id));\n      const invoiceCount = parseInt(invoiceCountResult[0]?.count || \"0\");\n\n      const sessionCountResult = await db\n        .select({ count: sql<string>`COUNT(*)` })\n        .from(timesheetEntries)\n        .where(eq(timesheetEntries.studentId, student.id));\n      const sessionCount = parseInt(sessionCountResult[0]?.count || \"0\");\n\n      results.push({\n        ...student,\n        tutor,\n        totalBilled,\n        totalReceived,\n        totalOutstanding: totalBilled - totalReceived,\n        invoiceCount,\n        sessionCount,\n      });\n    }\n\n    return results;\n  }\n\n  async getArchivedStudentDetails(id: string): Promise<{\n    student: StudentWithTutor;\n    invoices: InvoiceWithRelations[];\n    payments: PaymentWithRelations[];\n    timesheetEntries: TimesheetEntryWithRelations[];\n    totalBilled: number;\n    totalReceived: number;\n    totalOutstanding: number;\n  } | undefined> {\n    const studentResult = await db\n      .select()\n      .from(students)\n      .leftJoin(users, eq(students.tutorId, users.id))\n      .where(eq(students.id, id));\n\n    if (studentResult.length === 0) return undefined;\n\n    const student = studentResult[0].students;\n    const tutor = studentResult[0].users!;\n\n    // Get invoices with line items and payments\n    const invoiceResults = await db\n      .select()\n      .from(invoices)\n      .where(eq(invoices.studentId, id))\n      .orderBy(desc(invoices.createdAt));\n\n    const invoicesWithRelations: InvoiceWithRelations[] = [];\n    for (const invoice of invoiceResults) {\n      const lineItems = await db\n        .select()\n        .from(invoiceLineItems)\n        .where(eq(invoiceLineItems.invoiceId, invoice.id));\n      \n      const invoicePayments = await db\n        .select()\n        .from(payments)\n        .where(eq(payments.invoiceId, invoice.id));\n\n      invoicesWithRelations.push({\n        ...invoice,\n        student,\n        lineItems,\n        payments: invoicePayments,\n      });\n    }\n\n    // Get all payments\n    const paymentResults = await db\n      .select()\n      .from(payments)\n      .leftJoin(invoices, eq(payments.invoiceId, invoices.id))\n      .where(eq(payments.studentId, id))\n      .orderBy(desc(payments.receivedAt));\n\n    const paymentsWithRelations: PaymentWithRelations[] = paymentResults.map(row => ({\n      ...row.payments,\n      invoice: row.invoices || null,\n      student,\n    }));\n\n    // Get timesheet entries\n    const entryResults = await db\n      .select()\n      .from(timesheetEntries)\n      .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n      .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n      .where(eq(timesheetEntries.studentId, id))\n      .orderBy(desc(timesheetEntries.date));\n\n    const entries: TimesheetEntryWithRelations[] = entryResults.map(row => ({\n      ...row.timesheet_entries,\n      student: row.students!,\n      tutor: row.users!,\n    }));\n\n    // Calculate totals\n    const billedResult = await db\n      .select({ total: sql<string>`COALESCE(SUM(${timesheetEntries.parentBilling}), 0)` })\n      .from(timesheetEntries)\n      .where(and(\n        eq(timesheetEntries.studentId, id),\n        eq(timesheetEntries.status, \"approved\")\n      ));\n    const totalBilled = parseFloat(billedResult[0]?.total || \"0\");\n\n    const receivedResult = await db\n      .select({ total: sql<string>`COALESCE(SUM(${payments.amount}), 0)` })\n      .from(payments)\n      .where(eq(payments.studentId, id));\n    const totalReceived = parseFloat(receivedResult[0]?.total || \"0\");\n\n    return {\n      student: { ...student, tutor },\n      invoices: invoicesWithRelations,\n      payments: paymentsWithRelations,\n      timesheetEntries: entries,\n      totalBilled,\n      totalReceived,\n      totalOutstanding: totalBilled - totalReceived,\n    };\n  }\n\n  async getArchivedTutors(): Promise<ArchivedTutorSummary[]> {\n    // Get all archived staff (both tutors and admins)\n    const archivedTutors = await db\n      .select()\n      .from(users)\n      .where(eq(users.isActive, false))\n      .orderBy(desc(users.updatedAt));\n\n    const results: ArchivedTutorSummary[] = [];\n\n    for (const tutor of archivedTutors) {\n      // Get total earnings from approved timesheet entries\n      const earningsResult = await db\n        .select({ total: sql<string>`COALESCE(SUM(${timesheetEntries.tutorEarnings}), 0)` })\n        .from(timesheetEntries)\n        .where(and(\n          eq(timesheetEntries.tutorId, tutor.id),\n          eq(timesheetEntries.status, \"approved\")\n        ));\n      const totalEarnings = parseFloat(earningsResult[0]?.total || \"0\");\n\n      // Get session count\n      const sessionCountResult = await db\n        .select({ count: sql<string>`COUNT(*)` })\n        .from(timesheetEntries)\n        .where(eq(timesheetEntries.tutorId, tutor.id));\n      const sessionCount = parseInt(sessionCountResult[0]?.count || \"0\");\n\n      // Get student count\n      const studentCountResult = await db\n        .select({ count: sql<string>`COUNT(DISTINCT ${students.id})` })\n        .from(students)\n        .where(eq(students.tutorId, tutor.id));\n      const studentCount = parseInt(studentCountResult[0]?.count || \"0\");\n\n      results.push({\n        ...tutor,\n        totalEarnings,\n        totalPaid: totalEarnings, // Assuming all approved earnings are paid\n        totalOutstanding: 0,\n        sessionCount,\n        studentCount,\n      });\n    }\n\n    return results;\n  }\n\n  async getArchivedTutorDetails(id: string): Promise<{\n    tutor: User;\n    timesheetEntries: TimesheetEntryWithRelations[];\n    students: StudentWithTutor[];\n    totalEarnings: number;\n    totalPaid: number;\n    totalOutstanding: number;\n  } | undefined> {\n    const tutorResult = await db\n      .select()\n      .from(users)\n      .where(eq(users.id, id));\n\n    if (tutorResult.length === 0) return undefined;\n    const tutor = tutorResult[0];\n\n    // Get timesheet entries\n    const entryResults = await db\n      .select()\n      .from(timesheetEntries)\n      .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n      .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n      .where(eq(timesheetEntries.tutorId, id))\n      .orderBy(desc(timesheetEntries.date));\n\n    const entries: TimesheetEntryWithRelations[] = entryResults.map(row => ({\n      ...row.timesheet_entries,\n      student: row.students!,\n      tutor: row.users!,\n    }));\n\n    // Get students assigned to this tutor\n    const studentResults = await db\n      .select()\n      .from(students)\n      .leftJoin(users, eq(students.tutorId, users.id))\n      .where(eq(students.tutorId, id));\n\n    const tutorStudents: StudentWithTutor[] = studentResults.map(row => ({\n      ...row.students,\n      tutor: row.users!,\n    }));\n\n    // Calculate totals\n    const earningsResult = await db\n      .select({ total: sql<string>`COALESCE(SUM(${timesheetEntries.tutorEarnings}), 0)` })\n      .from(timesheetEntries)\n      .where(and(\n        eq(timesheetEntries.tutorId, id),\n        eq(timesheetEntries.status, \"approved\")\n      ));\n    const totalEarnings = parseFloat(earningsResult[0]?.total || \"0\");\n\n    return {\n      tutor,\n      timesheetEntries: entries,\n      students: tutorStudents,\n      totalEarnings,\n      totalPaid: totalEarnings,\n      totalOutstanding: 0,\n    };\n  }\n\n  // Invoice operations\n  async getInvoices(studentId?: string): Promise<InvoiceWithRelations[]> {\n    let query = db.select().from(invoices).leftJoin(students, eq(invoices.studentId, students.id));\n    \n    if (studentId) {\n      query = query.where(eq(invoices.studentId, studentId)) as typeof query;\n    }\n\n    const results = await query.orderBy(desc(invoices.createdAt));\n\n    const invoicesWithRelations: InvoiceWithRelations[] = [];\n    for (const row of results) {\n      const lineItems = await db\n        .select()\n        .from(invoiceLineItems)\n        .where(eq(invoiceLineItems.invoiceId, row.invoices.id));\n      \n      const invoicePayments = await db\n        .select()\n        .from(payments)\n        .where(eq(payments.invoiceId, row.invoices.id));\n\n      invoicesWithRelations.push({\n        ...row.invoices,\n        student: row.students!,\n        lineItems,\n        payments: invoicePayments,\n      });\n    }\n\n    return invoicesWithRelations;\n  }\n\n  async getInvoice(id: string): Promise<InvoiceWithRelations | undefined> {\n    const result = await db\n      .select()\n      .from(invoices)\n      .leftJoin(students, eq(invoices.studentId, students.id))\n      .where(eq(invoices.id, id));\n\n    if (result.length === 0) return undefined;\n\n    const invoice = result[0].invoices;\n    const student = result[0].students!;\n\n    const lineItems = await db\n      .select()\n      .from(invoiceLineItems)\n      .where(eq(invoiceLineItems.invoiceId, id));\n\n    const invoicePayments = await db\n      .select()\n      .from(payments)\n      .where(eq(payments.invoiceId, id));\n\n    return {\n      ...invoice,\n      student,\n      lineItems,\n      payments: invoicePayments,\n    };\n  }\n\n  async createInvoice(invoice: InsertInvoice): Promise<Invoice> {\n    const [created] = await db.insert(invoices).values(invoice).returning();\n    return created;\n  }\n\n  async updateInvoice(id: string, updates: UpdateInvoice): Promise<Invoice> {\n    const [updated] = await db\n      .update(invoices)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(invoices.id, id))\n      .returning();\n    return updated;\n  }\n\n  async addInvoiceLineItem(lineItem: InsertInvoiceLineItem): Promise<InvoiceLineItem> {\n    const [created] = await db.insert(invoiceLineItems).values(lineItem).returning();\n    return created;\n  }\n\n  // Adhoc invoice operations\n  async getAdhocInvoices(): Promise<AdhocInvoice[]> {\n    return await db\n      .select()\n      .from(adhocInvoices)\n      .orderBy(desc(adhocInvoices.createdAt));\n  }\n\n  async getAdhocInvoice(id: string): Promise<AdhocInvoice | undefined> {\n    const [invoice] = await db\n      .select()\n      .from(adhocInvoices)\n      .where(eq(adhocInvoices.id, id));\n    return invoice;\n  }\n\n  async createAdhocInvoice(invoice: InsertAdhocInvoice): Promise<AdhocInvoice> {\n    // Generate invoice number: ADHOC-YYYYMMDD-XXXX\n    const today = new Date();\n    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');\n    \n    // Get count of adhoc invoices for sequential numbering\n    const existingInvoices = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(adhocInvoices);\n    const count = Number(existingInvoices[0]?.count || 0) + 1;\n    const invoiceNumber = `ADHOC-${dateStr}-${String(count).padStart(4, '0')}`;\n    \n    const [created] = await db\n      .insert(adhocInvoices)\n      .values({ ...invoice, invoiceNumber })\n      .returning();\n    return created;\n  }\n\n  async updateAdhocInvoice(id: string, updates: UpdateAdhocInvoice): Promise<AdhocInvoice> {\n    const [updated] = await db\n      .update(adhocInvoices)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(adhocInvoices.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteAdhocInvoice(id: string): Promise<void> {\n    await db.delete(adhocInvoices).where(eq(adhocInvoices.id, id));\n  }\n\n  // Payment operations\n  async getPayments(studentId?: string): Promise<PaymentWithRelations[]> {\n    let query = db\n      .select()\n      .from(payments)\n      .leftJoin(invoices, eq(payments.invoiceId, invoices.id))\n      .leftJoin(students, eq(payments.studentId, students.id));\n\n    if (studentId) {\n      query = query.where(eq(payments.studentId, studentId)) as typeof query;\n    }\n\n    const results = await query.orderBy(desc(payments.receivedAt));\n\n    return results.map(row => ({\n      ...row.payments,\n      invoice: row.invoices || null,\n      student: row.students!,\n    }));\n  }\n\n  async createPayment(payment: InsertPayment): Promise<Payment> {\n    const [created] = await db.insert(payments).values(payment).returning();\n    \n    // If payment is linked to an invoice, update invoice status\n    if (payment.invoiceId) {\n      const invoice = await this.getInvoice(payment.invoiceId);\n      if (invoice) {\n        const totalPaid = invoice.payments.reduce((sum, p) => sum + parseFloat(p.amount), 0) + parseFloat(payment.amount);\n        const invoiceAmount = parseFloat(invoice.amount);\n        \n        let newStatus: \"paid\" | \"partial\" = \"partial\";\n        if (totalPaid >= invoiceAmount) {\n          newStatus = \"paid\";\n          await this.updateInvoice(payment.invoiceId, { status: newStatus, paidAt: new Date() } as any);\n        } else {\n          await this.updateInvoice(payment.invoiceId, { status: newStatus } as any);\n        }\n      }\n    }\n\n    return created;\n  }\n\n  // Tutor Invoice operations\n  async getTutorInvoices(tutorId?: string, weekStart?: Date): Promise<(TutorInvoice & { tutor: User })[]> {\n    let baseQuery = db\n      .select()\n      .from(tutorInvoices)\n      .leftJoin(users, eq(tutorInvoices.tutorId, users.id));\n\n    const conditions = [];\n    if (tutorId) {\n      conditions.push(eq(tutorInvoices.tutorId, tutorId));\n    }\n    if (weekStart) {\n      const weekEnd = new Date(weekStart);\n      weekEnd.setDate(weekEnd.getDate() + 7);\n      conditions.push(gte(tutorInvoices.submittedAt, weekStart));\n      conditions.push(lte(tutorInvoices.submittedAt, weekEnd));\n    }\n\n    const results = conditions.length > 0\n      ? await baseQuery.where(and(...conditions)).orderBy(desc(tutorInvoices.submittedAt))\n      : await baseQuery.orderBy(desc(tutorInvoices.submittedAt));\n\n    return results.map(row => ({\n      ...row.tutor_invoices,\n      tutor: row.users!,\n    }));\n  }\n\n  async getTutorInvoicesThisWeek(): Promise<(TutorInvoice & { tutor: User })[]> {\n    const now = new Date();\n    const dayOfWeek = now.getDay();\n    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n    const weekStart = new Date(now);\n    weekStart.setDate(now.getDate() + mondayOffset);\n    weekStart.setHours(0, 0, 0, 0);\n\n    return this.getTutorInvoices(undefined, weekStart);\n  }\n\n  async createTutorInvoice(invoice: InsertTutorInvoice): Promise<TutorInvoice> {\n    const [created] = await db.insert(tutorInvoices).values(invoice).returning();\n    return created;\n  }\n\n  async updateTutorInvoice(id: string, updates: UpdateTutorInvoice): Promise<TutorInvoice> {\n    const [updated] = await db\n      .update(tutorInvoices)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(tutorInvoices.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Auto-generate parent invoice for each individual session logged\n  async generateParentInvoiceForSession(studentId: string, timesheetEntryId: string, duration: number, amount: number): Promise<Invoice | null> {\n    const [student] = await db.select().from(students).where(eq(students.id, studentId));\n    if (!student) return null;\n\n    // Mark any existing outstanding invoices for this student as overdue\n    await db\n      .update(invoices)\n      .set({ status: \"overdue\", updatedAt: new Date() })\n      .where(\n        and(\n          eq(invoices.studentId, studentId),\n          inArray(invoices.status, [\"sent\", \"draft\", \"partial\"])\n        )\n      );\n\n    // Generate invoice number with student name, date, and unique suffix\n    const now = new Date();\n    const studentNameSlug = student.name.replace(/\\s+/g, '-').toUpperCase().substring(0, 10);\n    const uniqueSuffix = Math.random().toString(36).substr(2, 4).toUpperCase();\n    const invoiceNumber = `INV-${studentNameSlug}-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${uniqueSuffix}`;\n    \n    // Get configurable due date days from system settings (default 6 days)\n    const dueDateSetting = await this.getSystemSetting('invoice_due_days');\n    const dueDays = dueDateSetting ? parseInt(dueDateSetting.value, 10) : 6;\n    \n    const dueDate = new Date();\n    dueDate.setDate(dueDate.getDate() + dueDays);\n\n    const rate = parseFloat(student.parentRate);\n\n    const [created] = await db.insert(invoices).values({\n      invoiceNumber,\n      studentId,\n      timesheetEntryId, // Link invoice to specific session\n      invoiceType: \"auto_sessions\",\n      sessionsIncluded: 1, // Each invoice is for 1 session\n      amount: amount.toFixed(2),\n      status: \"sent\",\n      sentAt: now,\n      dueDate,\n      notes: `Invoice for ${student.name} - 1 session (${duration}hr) at Â£${rate}/hr. Auto-generated on session log.`,\n    }).returning();\n\n    return created;\n  }\n\n  // Legacy function kept for manual invoice generation (e.g., package invoices)\n  async generateParentInvoiceForStudent(studentId: string, sessions: number): Promise<Invoice | null> {\n    const [student] = await db.select().from(students).where(eq(students.id, studentId));\n    if (!student) return null;\n\n    const rate = parseFloat(student.parentRate);\n    const amount = rate * sessions * 1; // Assuming 1 hour per session\n    \n    // Generate invoice number with student name and unique suffix\n    const now = new Date();\n    const studentNameSlug = student.name.replace(/\\s+/g, '-').toUpperCase().substring(0, 10);\n    const uniqueSuffix = Math.random().toString(36).substr(2, 4).toUpperCase();\n    const invoiceNumber = `INV-${studentNameSlug}-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${uniqueSuffix}`;\n    \n    // Get configurable due date days from system settings (default 6 days)\n    const dueDateSetting = await this.getSystemSetting('invoice_due_days');\n    const dueDays = dueDateSetting ? parseInt(dueDateSetting.value, 10) : 6;\n    \n    const dueDate = new Date();\n    dueDate.setDate(dueDate.getDate() + dueDays);\n\n    const [created] = await db.insert(invoices).values({\n      invoiceNumber,\n      studentId,\n      invoiceType: \"auto_sessions\",\n      sessionsIncluded: sessions,\n      amount: amount.toFixed(2),\n      status: \"sent\",\n      sentAt: now,\n      dueDate,\n      notes: `Invoice for ${student.name} - ${sessions} session package at Â£${rate}/hr.`,\n    }).returning();\n\n    return created;\n  }\n\n  // Waitlist operations\n  async getWaitlistEntries(): Promise<WaitlistEntry[]> {\n    return await db\n      .select()\n      .from(waitlist)\n      .orderBy(desc(waitlist.createdAt));\n  }\n\n  async getWaitlistEntry(id: string): Promise<WaitlistEntry | undefined> {\n    const [entry] = await db.select().from(waitlist).where(eq(waitlist.id, id));\n    return entry;\n  }\n\n  async createWaitlistEntry(entry: InsertWaitlistEntry): Promise<WaitlistEntry> {\n    const [created] = await db.insert(waitlist).values(entry).returning();\n    return created;\n  }\n\n  async updateWaitlistEntry(id: string, updates: UpdateWaitlistEntry): Promise<WaitlistEntry> {\n    const [updated] = await db\n      .update(waitlist)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(waitlist.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteWaitlistEntry(id: string): Promise<void> {\n    await db.delete(waitlist).where(eq(waitlist.id, id));\n  }\n\n  // Parent portal operations\n  async getStudentsByParentEmail(email: string): Promise<StudentWithTutor[]> {\n    return await db\n      .select()\n      .from(students)\n      .leftJoin(users, eq(students.tutorId, users.id))\n      .where(and(eq(students.parentEmail, email), eq(students.isActive, true)))\n      .orderBy(asc(students.name))\n      .then(rows =>\n        rows.map(row => ({\n          ...row.students,\n          tutor: row.users!,\n        }))\n      );\n  }\n\n  async getTimesheetEntriesByStudentIds(studentIds: string[]): Promise<TimesheetEntryWithRelations[]> {\n    if (studentIds.length === 0) return [];\n    \n    const rows = await db\n      .select()\n      .from(timesheetEntries)\n      .leftJoin(students, eq(timesheetEntries.studentId, students.id))\n      .leftJoin(users, eq(timesheetEntries.tutorId, users.id))\n      .where(inArray(timesheetEntries.studentId, studentIds))\n      .orderBy(desc(timesheetEntries.date));\n\n    return rows.map(row => ({\n      ...row.timesheet_entries,\n      student: row.students!,\n      tutor: row.users!,\n    }));\n  }\n\n  async getInvoicesByStudentIds(studentIds: string[]): Promise<Invoice[]> {\n    if (studentIds.length === 0) return [];\n    \n    return await db\n      .select()\n      .from(invoices)\n      .where(inArray(invoices.studentId, studentIds))\n      .orderBy(desc(invoices.dueDate), desc(invoices.createdAt));\n  }\n\n  async getStudentInvoiceSummaries(): Promise<{ studentId: string; outstandingInvoices: number; unpaidSessions: number }[]> {\n    // Get all active students\n    const activeStudents = await db\n      .select({ id: students.id })\n      .from(students)\n      .where(eq(students.isActive, true));\n    \n    if (activeStudents.length === 0) return [];\n    \n    const studentIds = activeStudents.map(s => s.id);\n    \n    // Get all invoices for these students\n    const allInvoices = await db\n      .select()\n      .from(invoices)\n      .where(inArray(invoices.studentId, studentIds))\n      .orderBy(desc(invoices.createdAt));\n    \n    // Get all timesheet entries for these students\n    const allEntries = await db\n      .select()\n      .from(timesheetEntries)\n      .where(inArray(timesheetEntries.studentId, studentIds))\n      .orderBy(desc(timesheetEntries.date));\n    \n    // Calculate summaries for each student\n    const summaries = studentIds.map(studentId => {\n      const studentInvoices = allInvoices.filter(inv => inv.studentId === studentId);\n      const studentEntries = allEntries.filter(entry => entry.studentId === studentId);\n      \n      // Count outstanding (unpaid) invoices - exclude 'paid' and 'cancelled'\n      const outstandingInvoices = studentInvoices.filter(inv => \n        inv.status !== 'paid' && inv.status !== 'cancelled'\n      ).length;\n      \n      // Find the last paid invoice date\n      const lastPaidInvoice = studentInvoices.find(inv => inv.status === 'paid');\n      const lastPaidDate = lastPaidInvoice?.paidAt || lastPaidInvoice?.createdAt;\n      \n      // Count sessions since last paid invoice\n      let unpaidSessions = 0;\n      if (lastPaidDate) {\n        unpaidSessions = studentEntries.filter(entry => \n          new Date(entry.date) > new Date(lastPaidDate)\n        ).length;\n      } else {\n        // No paid invoices - all sessions are unpaid\n        unpaidSessions = studentEntries.length;\n      }\n      \n      return { studentId, outstandingInvoices, unpaidSessions };\n    });\n    \n    return summaries;\n  }\n\n  async getPaymentsByStudentIds(studentIds: string[]): Promise<Payment[]> {\n    if (studentIds.length === 0) return [];\n    \n    return await db\n      .select()\n      .from(payments)\n      .where(inArray(payments.studentId, studentIds))\n      .orderBy(desc(payments.receivedAt));\n  }\n\n  // Parent message operations\n  async getParentMessages(recipientType?: \"tutor\" | \"admin\", tutorId?: string): Promise<ParentMessageWithRelations[]> {\n    const rows = await db\n      .select()\n      .from(parentMessages)\n      .leftJoin(students, eq(parentMessages.studentId, students.id))\n      .leftJoin(users, eq(parentMessages.readByTutorId, users.id))\n      .orderBy(desc(parentMessages.createdAt));\n\n    let result = rows.map(row => ({\n      ...row.parent_messages,\n      student: row.students!,\n      readByTutor: row.users || null,\n    }));\n\n    if (recipientType === \"admin\") {\n      return result;\n    } else if (recipientType === \"tutor\" && tutorId) {\n      return result.filter(msg => \n        msg.recipientType === \"tutor\" && msg.student.tutorId === tutorId\n      );\n    }\n\n    return result;\n  }\n\n  async getParentMessagesByParentEmail(email: string): Promise<ParentMessageWithRelations[]> {\n    const rows = await db\n      .select()\n      .from(parentMessages)\n      .leftJoin(students, eq(parentMessages.studentId, students.id))\n      .leftJoin(users, eq(parentMessages.readByTutorId, users.id))\n      .where(eq(parentMessages.senderEmail, email))\n      .orderBy(desc(parentMessages.createdAt));\n\n    return rows.map(row => ({\n      ...row.parent_messages,\n      student: row.students!,\n      readByTutor: row.users || null,\n    }));\n  }\n\n  async createParentMessage(message: InsertParentMessage): Promise<ParentMessage> {\n    const [created] = await db.insert(parentMessages).values(message).returning();\n    return created;\n  }\n\n  async markParentMessageRead(id: string, tutorId?: string): Promise<ParentMessage> {\n    const updateData: { isRead: boolean; readAt: Date; readByTutorId?: string } = { \n      isRead: true, \n      readAt: new Date(),\n    };\n    if (tutorId) {\n      updateData.readByTutorId = tutorId;\n    }\n    const [updated] = await db\n      .update(parentMessages)\n      .set(updateData)\n      .where(eq(parentMessages.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getParentMessage(id: string): Promise<ParentMessageWithRelations | undefined> {\n    const [row] = await db\n      .select()\n      .from(parentMessages)\n      .leftJoin(students, eq(parentMessages.studentId, students.id))\n      .leftJoin(users, eq(parentMessages.readByTutorId, users.id))\n      .where(eq(parentMessages.id, id));\n\n    if (!row) return undefined;\n\n    const replies = await this.getParentMessageReplies(id);\n\n    return {\n      ...row.parent_messages,\n      student: row.students!,\n      replies,\n      readByTutor: row.users || null,\n    };\n  }\n\n  async createParentMessageReply(reply: InsertParentMessageReply): Promise<ParentMessageReply> {\n    const [created] = await db.insert(parentMessageReplies).values(reply).returning();\n    return created;\n  }\n\n  async getParentMessageReplies(messageId: string): Promise<ParentMessageReplyWithRelations[]> {\n    const rows = await db\n      .select()\n      .from(parentMessageReplies)\n      .leftJoin(users, eq(parentMessageReplies.repliedById, users.id))\n      .where(eq(parentMessageReplies.messageId, messageId))\n      .orderBy(asc(parentMessageReplies.createdAt));\n\n    return rows.map(row => ({\n      ...row.parent_message_replies,\n      repliedBy: row.users!,\n    }));\n  }\n\n  // Student topics operations\n  async getStudentTopics(studentId: string): Promise<StudentTopic[]> {\n    return await db\n      .select()\n      .from(studentTopics)\n      .where(eq(studentTopics.studentId, studentId))\n      .orderBy(asc(studentTopics.orderIndex), asc(studentTopics.title));\n  }\n\n  async replaceStudentTopics(studentId: string, topics: InsertStudentTopic[]): Promise<StudentTopic[]> {\n    await db.delete(studentTopics).where(eq(studentTopics.studentId, studentId));\n    \n    if (topics.length === 0) {\n      return [];\n    }\n    \n    const topicsWithOrder = topics.map((topic, index) => ({\n      ...topic,\n      studentId,\n      orderIndex: topic.orderIndex ?? index,\n    }));\n    \n    return await db.insert(studentTopics).values(topicsWithOrder).returning();\n  }\n\n  async updateStudentTopic(id: string, updates: UpdateStudentTopic): Promise<StudentTopic> {\n    const [updated] = await db\n      .update(studentTopics)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(studentTopics.id, id))\n      .returning();\n    return updated;\n  }\n\n  async markStudentTopicCovered(topicId: string, tutorId: string, isCovered: boolean, coveredAt?: Date): Promise<StudentTopic> {\n    const [updated] = await db\n      .update(studentTopics)\n      .set({\n        isCovered,\n        coveredAt: isCovered ? (coveredAt || new Date()) : null,\n        coveredById: isCovered ? tutorId : null,\n        updatedAt: new Date(),\n      })\n      .where(eq(studentTopics.id, topicId))\n      .returning();\n    return updated;\n  }\n\n  // Rate configuration operations\n  async getRateConfigurations(): Promise<RateConfiguration[]> {\n    return await db\n      .select()\n      .from(rateConfigurations)\n      .orderBy(asc(rateConfigurations.name));\n  }\n\n  async getRateConfiguration(id: string): Promise<RateConfiguration | undefined> {\n    const [rate] = await db\n      .select()\n      .from(rateConfigurations)\n      .where(eq(rateConfigurations.id, id));\n    return rate;\n  }\n\n  async createRateConfiguration(rate: InsertRateConfiguration): Promise<RateConfiguration> {\n    const [created] = await db\n      .insert(rateConfigurations)\n      .values(rate)\n      .returning();\n    return created;\n  }\n\n  async updateRateConfiguration(id: string, updates: UpdateRateConfiguration): Promise<RateConfiguration> {\n    const [updated] = await db\n      .update(rateConfigurations)\n      .set({\n        ...updates,\n        updatedAt: new Date(),\n      })\n      .where(eq(rateConfigurations.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteRateConfiguration(id: string): Promise<void> {\n    await db\n      .delete(rateConfigurations)\n      .where(eq(rateConfigurations.id, id));\n  }\n\n  // Tutor rate operations (independent)\n  async getTutorRates(): Promise<TutorRate[]> {\n    return await db\n      .select()\n      .from(tutorRates)\n      .orderBy(asc(tutorRates.name));\n  }\n\n  async getTutorRate(id: string): Promise<TutorRate | undefined> {\n    const [rate] = await db\n      .select()\n      .from(tutorRates)\n      .where(eq(tutorRates.id, id));\n    return rate;\n  }\n\n  async createTutorRate(rate: InsertTutorRate): Promise<TutorRate> {\n    const [created] = await db\n      .insert(tutorRates)\n      .values(rate)\n      .returning();\n    return created;\n  }\n\n  async updateTutorRate(id: string, updates: UpdateTutorRate): Promise<TutorRate> {\n    const [updated] = await db\n      .update(tutorRates)\n      .set({\n        ...updates,\n        updatedAt: new Date(),\n      })\n      .where(eq(tutorRates.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTutorRate(id: string): Promise<void> {\n    await db\n      .delete(tutorRates)\n      .where(eq(tutorRates.id, id));\n  }\n\n  // Parent rate operations (independent)\n  async getParentRates(): Promise<ParentRate[]> {\n    return await db\n      .select()\n      .from(parentRates)\n      .orderBy(asc(parentRates.name));\n  }\n\n  async getParentRate(id: string): Promise<ParentRate | undefined> {\n    const [rate] = await db\n      .select()\n      .from(parentRates)\n      .where(eq(parentRates.id, id));\n    return rate;\n  }\n\n  async createParentRate(rate: InsertParentRate): Promise<ParentRate> {\n    const [created] = await db\n      .insert(parentRates)\n      .values(rate)\n      .returning();\n    return created;\n  }\n\n  async updateParentRate(id: string, updates: UpdateParentRate): Promise<ParentRate> {\n    const [updated] = await db\n      .update(parentRates)\n      .set({\n        ...updates,\n        updatedAt: new Date(),\n      })\n      .where(eq(parentRates.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteParentRate(id: string): Promise<void> {\n    await db\n      .delete(parentRates)\n      .where(eq(parentRates.id, id));\n  }\n\n  // Rate link operations (for profit analysis)\n  async getRateLinks(): Promise<(RateLink & { tutorRate: TutorRate; parentRate: ParentRate })[]> {\n    const results = await db\n      .select()\n      .from(rateLinks)\n      .innerJoin(tutorRates, eq(rateLinks.tutorRateId, tutorRates.id))\n      .innerJoin(parentRates, eq(rateLinks.parentRateId, parentRates.id));\n    \n    return results.map(r => ({\n      ...r.rate_links,\n      tutorRate: r.tutor_rates,\n      parentRate: r.parent_rates,\n    }));\n  }\n\n  async createRateLink(link: InsertRateLink): Promise<RateLink> {\n    const [created] = await db\n      .insert(rateLinks)\n      .values(link)\n      .returning();\n    return created;\n  }\n\n  async deleteRateLink(id: string): Promise<void> {\n    await db\n      .delete(rateLinks)\n      .where(eq(rateLinks.id, id));\n  }\n\n  async deleteLinkByTutorRateId(tutorRateId: string): Promise<void> {\n    await db\n      .delete(rateLinks)\n      .where(eq(rateLinks.tutorRateId, tutorRateId));\n  }\n\n  async deleteLinkByParentRateId(parentRateId: string): Promise<void> {\n    await db\n      .delete(rateLinks)\n      .where(eq(rateLinks.parentRateId, parentRateId));\n  }\n\n  // System settings operations\n  async getSystemSetting(key: string): Promise<SystemSetting | undefined> {\n    const [setting] = await db.select().from(systemSettings).where(eq(systemSettings.key, key));\n    return setting;\n  }\n\n  async getSystemSettings(): Promise<SystemSetting[]> {\n    return await db.select().from(systemSettings).orderBy(asc(systemSettings.key));\n  }\n\n  async upsertSystemSetting(key: string, value: string, description?: string): Promise<SystemSetting> {\n    const [setting] = await db\n      .insert(systemSettings)\n      .values({ key, value, description })\n      .onConflictDoUpdate({\n        target: systemSettings.key,\n        set: { value, description, updatedAt: new Date() },\n      })\n      .returning();\n    return setting;\n  }\n\n  // Check all invoices and mark as overdue if past due date\n  async markOverdueInvoices(): Promise<number> {\n    const now = new Date();\n    const result = await db\n      .update(invoices)\n      .set({ status: \"overdue\", updatedAt: now })\n      .where(\n        and(\n          inArray(invoices.status, [\"sent\", \"draft\", \"partial\"]),\n          lte(invoices.dueDate, now)\n        )\n      )\n      .returning();\n    return result.length;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":94413,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":971,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: 30000, // Refetch every 30 seconds\n      refetchOnWindowFocus: true, // Refetch when user returns to the tab\n      staleTime: 10000, // Data is fresh for 10 seconds\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1479,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 touch-manipulation\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90 active:bg-primary/80\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90 active:bg-destructive/80\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground active:bg-accent/80\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80 active:bg-secondary/70\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground active:bg-accent/80\",\n        link: \"text-primary underline-offset-4 hover:underline active:text-primary/80\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2 min-h-[44px]\",\n        sm: \"h-9 rounded-md px-3 min-h-[36px]\",\n        lg: \"h-11 rounded-md px-8 min-h-[48px]\",\n        icon: \"h-10 w-10 min-h-[44px] min-w-[44px]\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2117,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from 'drizzle-orm';\nimport {\n  index,\n  jsonb,\n  pgTable,\n  timestamp,\n  varchar,\n  text,\n  decimal,\n  integer,\n  boolean,\n} from \"drizzle-orm/pg-core\";\nimport { relations } from \"drizzle-orm\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table for Replit Auth\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User storage table for Replit Auth\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  role: varchar(\"role\", { enum: [\"admin\", \"tutor\", \"parent\"] }).notNull().default(\"tutor\"),\n  startYear: integer(\"start_year\"),\n  endYear: integer(\"end_year\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Students table\nexport const students = pgTable(\"students\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  subject: varchar(\"subject\").notNull(),\n  examType: varchar(\"exam_type\"), // Type of exam: 11+, 13+, GCSE, A-Level, etc.\n  tutorId: varchar(\"tutor_id\").notNull().references(() => users.id),\n  parentName: varchar(\"parent_name\"),\n  parentSurname: varchar(\"parent_surname\"),\n  parentEmail: varchar(\"parent_email\"),\n  parentPhone: varchar(\"parent_phone\"),\n  parentContactInfo: text(\"parent_contact_info\"), // Legacy field - can be used for additional notes\n  classType: varchar(\"class_type\", { enum: [\"individual\", \"group\"] }).notNull().default(\"individual\"),\n  sessionsBooked: integer(\"sessions_booked\").notNull().default(0),\n  sessionsRemaining: integer(\"sessions_remaining\").notNull().default(0),\n  parentRate: decimal(\"parent_rate\", { precision: 10, scale: 2 }).notNull(),\n  tutorRate: decimal(\"tutor_rate\", { precision: 10, scale: 2 }).notNull(),\n  startYear: integer(\"start_year\"),\n  endYear: integer(\"end_year\"),\n  examMonth: integer(\"exam_month\"), // 1-12\n  examYear: integer(\"exam_year\"),\n  examBoard: varchar(\"exam_board\"), // Exam board they are applying to\n  targetSchools: varchar(\"target_schools\"), // Target schools\n  primarySchool: varchar(\"primary_school\"), // Primary school they attend\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Student-Tutor relationship table (many-to-many for multiple tutors per student)\nexport const studentTutors = pgTable(\"student_tutors\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  studentId: varchar(\"student_id\").notNull().references(() => students.id, { onDelete: \"cascade\" }),\n  tutorId: varchar(\"tutor_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  isPrimary: boolean(\"is_primary\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Weekly timesheets table - groups sessions by week for submission/approval\nexport const weeklyTimesheets = pgTable(\"weekly_timesheets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tutorId: varchar(\"tutor_id\").notNull().references(() => users.id),\n  weekStart: timestamp(\"week_start\").notNull(),\n  weekEnd: timestamp(\"week_end\").notNull(),\n  status: varchar(\"status\", { enum: [\"draft\", \"submitted\", \"approved\", \"rejected\"] }).notNull().default(\"draft\"),\n  submittedAt: timestamp(\"submitted_at\"),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  reviewerId: varchar(\"reviewer_id\").references(() => users.id),\n  reviewNotes: text(\"review_notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Timesheet status history table - tracks the journey of a timesheet\nexport const timesheetStatusHistory = pgTable(\"timesheet_status_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  weeklyTimesheetId: varchar(\"weekly_timesheet_id\").notNull().references(() => weeklyTimesheets.id),\n  fromStatus: varchar(\"from_status\", { enum: [\"draft\", \"submitted\", \"approved\", \"rejected\"] }),\n  toStatus: varchar(\"to_status\", { enum: [\"draft\", \"submitted\", \"approved\", \"rejected\"] }).notNull(),\n  changedBy: varchar(\"changed_by\").notNull().references(() => users.id),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Timesheet entries table\nexport const timesheetEntries = pgTable(\"timesheet_entries\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tutorId: varchar(\"tutor_id\").notNull().references(() => users.id),\n  studentId: varchar(\"student_id\").notNull().references(() => students.id),\n  weeklyTimesheetId: varchar(\"weekly_timesheet_id\").references(() => weeklyTimesheets.id),\n  date: timestamp(\"date\").notNull(),\n  duration: decimal(\"duration\", { precision: 4, scale: 2 }).notNull(),\n  notes: text(\"notes\"),\n  status: varchar(\"status\", { enum: [\"pending\", \"approved\", \"rejected\"] }).notNull().default(\"pending\"),\n  tutorEarnings: decimal(\"tutor_earnings\", { precision: 10, scale: 2 }).notNull(),\n  parentBilling: decimal(\"parent_billing\", { precision: 10, scale: 2 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Tutor time slots table\nexport const tutorTimeSlots = pgTable(\"tutor_time_slots\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tutorId: varchar(\"tutor_id\").notNull().references(() => users.id),\n  startTime: timestamp(\"start_time\").notNull(),\n  endTime: timestamp(\"end_time\").notNull(),\n  capacity: integer(\"capacity\").notNull().default(1),\n  isCanceled: boolean(\"is_canceled\").notNull().default(false),\n  subject: varchar(\"subject\"),\n  classType: varchar(\"class_type\", { enum: [\"individual\", \"group\"] }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Slot bookings table\nexport const slotBookings = pgTable(\"slot_bookings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  slotId: varchar(\"slot_id\").notNull().references(() => tutorTimeSlots.id),\n  studentId: varchar(\"student_id\").notNull().references(() => students.id),\n  status: varchar(\"status\", { enum: [\"booked\", \"canceled\", \"attended\", \"no_show\"] }).notNull().default(\"booked\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Notifications table\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  type: varchar(\"type\", { \n    enum: [\"low_balance\", \"booking_confirmed\", \"booking_canceled\", \"schedule_changed\", \"payment_needed\"] \n  }).notNull(),\n  payload: jsonb(\"payload\"),\n  readAt: timestamp(\"read_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Invoices table - tracks billing for students/parents\nexport const invoices = pgTable(\"invoices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  invoiceNumber: varchar(\"invoice_number\").notNull().unique(),\n  studentId: varchar(\"student_id\").notNull().references(() => students.id),\n  invoiceType: varchar(\"invoice_type\", { enum: [\"manual\", \"auto_sessions\"] }).notNull().default(\"manual\"),\n  sessionsIncluded: integer(\"sessions_included\"),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  status: varchar(\"status\", { enum: [\"draft\", \"sent\", \"approved\", \"paid\", \"partial\", \"overdue\", \"cancelled\"] }).notNull().default(\"draft\"),\n  sentAt: timestamp(\"sent_at\"), // Date the invoice was sent (date of final lesson)\n  dueDate: timestamp(\"due_date\"),\n  paidAt: timestamp(\"paid_at\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Tutor invoices table - invoices submitted by tutors to admin for payment\nexport const tutorInvoices = pgTable(\"tutor_invoices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  invoiceNumber: varchar(\"invoice_number\").notNull().unique(),\n  tutorId: varchar(\"tutor_id\").notNull().references(() => users.id),\n  weeklyTimesheetId: varchar(\"weekly_timesheet_id\").references(() => weeklyTimesheets.id),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  hoursWorked: decimal(\"hours_worked\", { precision: 6, scale: 2 }).notNull(),\n  status: varchar(\"status\", { enum: [\"pending\", \"approved\", \"paid\", \"rejected\"] }).notNull().default(\"pending\"),\n  submittedAt: timestamp(\"submitted_at\").defaultNow(),\n  approvedAt: timestamp(\"approved_at\"),\n  paidAt: timestamp(\"paid_at\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Adhoc invoices table - manually created invoices not tied to students\nexport const adhocInvoices = pgTable(\"adhoc_invoices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  invoiceNumber: varchar(\"invoice_number\").notNull().unique(),\n  parentFirstName: varchar(\"parent_first_name\").notNull(),\n  parentSurname: varchar(\"parent_surname\").notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  reason: text(\"reason\").notNull(),\n  status: varchar(\"status\", { enum: [\"draft\", \"sent\", \"paid\", \"partial\", \"overdue\", \"cancelled\"] }).notNull().default(\"draft\"),\n  dueDate: timestamp(\"due_date\"),\n  paidAt: timestamp(\"paid_at\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Invoice line items - links invoices to timesheet entries\nexport const invoiceLineItems = pgTable(\"invoice_line_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  invoiceId: varchar(\"invoice_id\").notNull().references(() => invoices.id),\n  timesheetEntryId: varchar(\"timesheet_entry_id\").references(() => timesheetEntries.id),\n  description: text(\"description\").notNull(),\n  quantity: decimal(\"quantity\", { precision: 4, scale: 2 }).notNull(),\n  unitPrice: decimal(\"unit_price\", { precision: 10, scale: 2 }).notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Payments table - tracks payments received\nexport const payments = pgTable(\"payments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  invoiceId: varchar(\"invoice_id\").references(() => invoices.id),\n  studentId: varchar(\"student_id\").notNull().references(() => students.id),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paymentMethod: varchar(\"payment_method\", { enum: [\"cash\", \"bank_transfer\", \"card\", \"other\"] }).notNull().default(\"bank_transfer\"),\n  reference: varchar(\"reference\"),\n  notes: text(\"notes\"),\n  receivedAt: timestamp(\"received_at\").notNull().defaultNow(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Waitlist table - tracks prospective students who have contacted about tuition\nexport const waitlist = pgTable(\"waitlist\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  studentName: varchar(\"student_name\").notNull(),\n  parentName: varchar(\"parent_name\"),\n  parentEmail: varchar(\"parent_email\"),\n  parentPhone: varchar(\"parent_phone\"),\n  subject: varchar(\"subject\"),\n  notes: text(\"notes\"),\n  depositPaid: boolean(\"deposit_paid\").notNull().default(false),\n  depositAmount: decimal(\"deposit_amount\", { precision: 10, scale: 2 }),\n  status: varchar(\"status\", { enum: [\"new\", \"contacted\", \"scheduled\", \"converted\", \"declined\"] }).notNull().default(\"new\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Parent messages table - feedback/messages from parents to tutors/admin\nexport const parentMessages = pgTable(\"parent_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  studentId: varchar(\"student_id\").notNull().references(() => students.id),\n  senderEmail: varchar(\"sender_email\").notNull(),\n  senderName: varchar(\"sender_name\"),\n  recipientType: varchar(\"recipient_type\", { enum: [\"tutor\", \"admin\"] }).notNull(),\n  subject: varchar(\"subject\"),\n  message: text(\"message\").notNull(),\n  isRead: boolean(\"is_read\").notNull().default(false),\n  readAt: timestamp(\"read_at\"),\n  readByTutorId: varchar(\"read_by_tutor_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Student topics table - tracks curriculum topics for each student\nexport const studentTopics = pgTable(\"student_topics\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  studentId: varchar(\"student_id\").notNull().references(() => students.id),\n  title: varchar(\"title\").notNull(),\n  description: text(\"description\"),\n  orderIndex: integer(\"order_index\").notNull().default(0),\n  isCovered: boolean(\"is_covered\").notNull().default(false),\n  coveredAt: timestamp(\"covered_at\"),\n  coveredById: varchar(\"covered_by_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Rate configurations table - DEPRECATED, use tutorRates and parentRates instead\nexport const rateConfigurations = pgTable(\"rate_configurations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  classType: varchar(\"class_type\", { enum: [\"individual\", \"group\"] }).notNull().default(\"individual\"),\n  subject: varchar(\"subject\"),\n  rateType: varchar(\"rate_type\", { enum: [\"tutor\", \"parent\", \"combined\"] }).notNull().default(\"combined\"),\n  tutorRate: decimal(\"tutor_rate\", { precision: 10, scale: 2 }).notNull(),\n  parentRate: decimal(\"parent_rate\", { precision: 10, scale: 2 }).notNull(),\n  linkedRateId: varchar(\"linked_rate_id\"),\n  isDefault: boolean(\"is_default\").notNull().default(false),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Tutor rates table - rates paid TO tutors (completely independent)\nexport const tutorRates = pgTable(\"tutor_rates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  classType: varchar(\"class_type\", { enum: [\"individual\", \"group\"] }).notNull().default(\"individual\"),\n  subject: varchar(\"subject\"),\n  rate: decimal(\"rate\", { precision: 10, scale: 2 }).notNull(),\n  isDefault: boolean(\"is_default\").notNull().default(false),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Parent rates table - rates charged TO parents (completely independent)\nexport const parentRates = pgTable(\"parent_rates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  classType: varchar(\"class_type\", { enum: [\"individual\", \"group\"] }).notNull().default(\"individual\"),\n  subject: varchar(\"subject\"),\n  rate: decimal(\"rate\", { precision: 10, scale: 2 }).notNull(),\n  isDefault: boolean(\"is_default\").notNull().default(false),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Rate links table - optional linking for profit margin analysis\nexport const rateLinks = pgTable(\"rate_links\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tutorRateId: varchar(\"tutor_rate_id\").notNull().references(() => tutorRates.id, { onDelete: \"cascade\" }),\n  parentRateId: varchar(\"parent_rate_id\").notNull().references(() => parentRates.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Parent message replies table - replies from tutors/admins to parent messages\nexport const parentMessageReplies = pgTable(\"parent_message_replies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  messageId: varchar(\"message_id\").notNull().references(() => parentMessages.id),\n  replyContent: text(\"reply_content\").notNull(),\n  repliedById: varchar(\"replied_by_id\").notNull().references(() => users.id),\n  repliedByRole: varchar(\"replied_by_role\", { enum: [\"admin\", \"tutor\"] }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// System settings table for configurable options\nexport const systemSettings = pgTable(\"system_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  key: varchar(\"key\").notNull().unique(),\n  value: varchar(\"value\").notNull(),\n  description: text(\"description\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Relations\nexport const usersRelations = relations(users, ({ many }) => ({\n  students: many(students),\n  timesheetEntries: many(timesheetEntries),\n  weeklyTimesheets: many(weeklyTimesheets),\n  tutorTimeSlots: many(tutorTimeSlots),\n  notifications: many(notifications),\n}));\n\nexport const weeklyTimesheetsRelations = relations(weeklyTimesheets, ({ one, many }) => ({\n  tutor: one(users, {\n    fields: [weeklyTimesheets.tutorId],\n    references: [users.id],\n  }),\n  reviewer: one(users, {\n    fields: [weeklyTimesheets.reviewerId],\n    references: [users.id],\n  }),\n  entries: many(timesheetEntries),\n  statusHistory: many(timesheetStatusHistory),\n}));\n\nexport const timesheetStatusHistoryRelations = relations(timesheetStatusHistory, ({ one }) => ({\n  weeklyTimesheet: one(weeklyTimesheets, {\n    fields: [timesheetStatusHistory.weeklyTimesheetId],\n    references: [weeklyTimesheets.id],\n  }),\n  changedByUser: one(users, {\n    fields: [timesheetStatusHistory.changedBy],\n    references: [users.id],\n  }),\n}));\n\nexport const studentsRelations = relations(students, ({ one, many }) => ({\n  tutor: one(users, {\n    fields: [students.tutorId],\n    references: [users.id],\n  }),\n  tutors: many(studentTutors),\n  timesheetEntries: many(timesheetEntries),\n  slotBookings: many(slotBookings),\n  invoices: many(invoices),\n  payments: many(payments),\n}));\n\nexport const studentTutorsRelations = relations(studentTutors, ({ one }) => ({\n  student: one(students, {\n    fields: [studentTutors.studentId],\n    references: [students.id],\n  }),\n  tutor: one(users, {\n    fields: [studentTutors.tutorId],\n    references: [users.id],\n  }),\n}));\n\nexport const timesheetEntriesRelations = relations(timesheetEntries, ({ one }) => ({\n  tutor: one(users, {\n    fields: [timesheetEntries.tutorId],\n    references: [users.id],\n  }),\n  student: one(students, {\n    fields: [timesheetEntries.studentId],\n    references: [students.id],\n  }),\n  weeklyTimesheet: one(weeklyTimesheets, {\n    fields: [timesheetEntries.weeklyTimesheetId],\n    references: [weeklyTimesheets.id],\n  }),\n}));\n\nexport const tutorTimeSlotsRelations = relations(tutorTimeSlots, ({ one, many }) => ({\n  tutor: one(users, {\n    fields: [tutorTimeSlots.tutorId],\n    references: [users.id],\n  }),\n  slotBookings: many(slotBookings),\n}));\n\nexport const slotBookingsRelations = relations(slotBookings, ({ one }) => ({\n  slot: one(tutorTimeSlots, {\n    fields: [slotBookings.slotId],\n    references: [tutorTimeSlots.id],\n  }),\n  student: one(students, {\n    fields: [slotBookings.studentId],\n    references: [students.id],\n  }),\n}));\n\nexport const notificationsRelations = relations(notifications, ({ one }) => ({\n  user: one(users, {\n    fields: [notifications.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const invoicesRelations = relations(invoices, ({ one, many }) => ({\n  student: one(students, {\n    fields: [invoices.studentId],\n    references: [students.id],\n  }),\n  lineItems: many(invoiceLineItems),\n  payments: many(payments),\n}));\n\nexport const invoiceLineItemsRelations = relations(invoiceLineItems, ({ one }) => ({\n  invoice: one(invoices, {\n    fields: [invoiceLineItems.invoiceId],\n    references: [invoices.id],\n  }),\n  timesheetEntry: one(timesheetEntries, {\n    fields: [invoiceLineItems.timesheetEntryId],\n    references: [timesheetEntries.id],\n  }),\n}));\n\nexport const paymentsRelations = relations(payments, ({ one }) => ({\n  invoice: one(invoices, {\n    fields: [payments.invoiceId],\n    references: [invoices.id],\n  }),\n  student: one(students, {\n    fields: [payments.studentId],\n    references: [students.id],\n  }),\n}));\n\nexport const parentMessagesRelations = relations(parentMessages, ({ one, many }) => ({\n  student: one(students, {\n    fields: [parentMessages.studentId],\n    references: [students.id],\n  }),\n  readByTutor: one(users, {\n    fields: [parentMessages.readByTutorId],\n    references: [users.id],\n  }),\n  replies: many(parentMessageReplies),\n}));\n\nexport const parentMessageRepliesRelations = relations(parentMessageReplies, ({ one }) => ({\n  message: one(parentMessages, {\n    fields: [parentMessageReplies.messageId],\n    references: [parentMessages.id],\n  }),\n  repliedBy: one(users, {\n    fields: [parentMessageReplies.repliedById],\n    references: [users.id],\n  }),\n}));\n\nexport const studentTopicsRelations = relations(studentTopics, ({ one }) => ({\n  student: one(students, {\n    fields: [studentTopics.studentId],\n    references: [students.id],\n  }),\n  coveredBy: one(users, {\n    fields: [studentTopics.coveredById],\n    references: [users.id],\n  }),\n}));\n\n// Insert schemas\nexport const insertStudentSchema = createInsertSchema(students).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertTimesheetEntrySchema = createInsertSchema(timesheetEntries).omit({\n  id: true,\n  tutorEarnings: true,\n  parentBilling: true,\n  status: true,\n  weeklyTimesheetId: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertWeeklyTimesheetSchema = createInsertSchema(weeklyTimesheets).omit({\n  id: true,\n  status: true,\n  submittedAt: true,\n  reviewedAt: true,\n  reviewerId: true,\n  reviewNotes: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertTimesheetStatusHistorySchema = createInsertSchema(timesheetStatusHistory).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertTutorTimeSlotSchema = createInsertSchema(tutorTimeSlots).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertSlotBookingSchema = createInsertSchema(slotBookings).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertStudentTutorSchema = createInsertSchema(studentTutors).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertInvoiceSchema = createInsertSchema(invoices).omit({\n  id: true,\n  status: true,\n  paidAt: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertInvoiceLineItemSchema = createInsertSchema(invoiceLineItems).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertTutorInvoiceSchema = createInsertSchema(tutorInvoices).omit({\n  id: true,\n  status: true,\n  approvedAt: true,\n  paidAt: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateTutorInvoiceSchema = createInsertSchema(tutorInvoices).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).partial();\n\nexport const insertAdhocInvoiceSchema = createInsertSchema(adhocInvoices).omit({\n  id: true,\n  status: true,\n  paidAt: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateAdhocInvoiceSchema = createInsertSchema(adhocInvoices).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).partial();\n\nexport const insertPaymentSchema = createInsertSchema(payments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertWaitlistSchema = createInsertSchema(waitlist).omit({\n  id: true,\n  status: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateWaitlistSchema = createInsertSchema(waitlist).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).partial();\n\nexport const insertParentMessageSchema = createInsertSchema(parentMessages).omit({\n  id: true,\n  isRead: true,\n  readAt: true,\n  createdAt: true,\n});\n\nexport const insertParentMessageReplySchema = createInsertSchema(parentMessageReplies).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertStudentTopicSchema = createInsertSchema(studentTopics).omit({\n  id: true,\n  isCovered: true,\n  coveredAt: true,\n  coveredById: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateStudentTopicSchema = createInsertSchema(studentTopics).omit({\n  id: true,\n  studentId: true,\n  createdAt: true,\n  updatedAt: true,\n}).partial();\n\nexport const insertRateConfigurationSchema = createInsertSchema(rateConfigurations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateRateConfigurationSchema = createInsertSchema(rateConfigurations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).partial();\n\n// Tutor rate schemas\nexport const insertTutorRateSchema = createInsertSchema(tutorRates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateTutorRateSchema = createInsertSchema(tutorRates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).partial();\n\n// Parent rate schemas\nexport const insertParentRateSchema = createInsertSchema(parentRates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const updateParentRateSchema = createInsertSchema(parentRates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).partial();\n\n// Rate link schemas\nexport const insertRateLinkSchema = createInsertSchema(rateLinks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const updateStudentSchema = insertStudentSchema.partial();\nexport const updateUserSchema = insertUserSchema.partial();\nexport const updateTutorTimeSlotSchema = insertTutorTimeSlotSchema.partial();\nexport const updateInvoiceSchema = insertInvoiceSchema.partial();\n\n// Types\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type UpdateUser = z.infer<typeof updateUserSchema>;\nexport type Student = typeof students.$inferSelect;\nexport type InsertStudent = z.infer<typeof insertStudentSchema>;\nexport type UpdateStudent = z.infer<typeof updateStudentSchema>;\nexport type TimesheetEntry = typeof timesheetEntries.$inferSelect;\nexport type InsertTimesheetEntry = z.infer<typeof insertTimesheetEntrySchema>;\nexport type WeeklyTimesheet = typeof weeklyTimesheets.$inferSelect;\nexport type InsertWeeklyTimesheet = z.infer<typeof insertWeeklyTimesheetSchema>;\nexport type TimesheetStatusHistory = typeof timesheetStatusHistory.$inferSelect;\nexport type InsertTimesheetStatusHistory = z.infer<typeof insertTimesheetStatusHistorySchema>;\nexport type TutorTimeSlot = typeof tutorTimeSlots.$inferSelect;\nexport type InsertTutorTimeSlot = z.infer<typeof insertTutorTimeSlotSchema>;\nexport type UpdateTutorTimeSlot = z.infer<typeof updateTutorTimeSlotSchema>;\nexport type SlotBooking = typeof slotBookings.$inferSelect;\nexport type InsertSlotBooking = z.infer<typeof insertSlotBookingSchema>;\nexport type Notification = typeof notifications.$inferSelect;\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type Invoice = typeof invoices.$inferSelect;\nexport type InsertInvoice = z.infer<typeof insertInvoiceSchema>;\nexport type UpdateInvoice = z.infer<typeof updateInvoiceSchema>;\nexport type TutorInvoice = typeof tutorInvoices.$inferSelect;\nexport type InsertTutorInvoice = z.infer<typeof insertTutorInvoiceSchema>;\nexport type UpdateTutorInvoice = z.infer<typeof updateTutorInvoiceSchema>;\nexport type AdhocInvoice = typeof adhocInvoices.$inferSelect;\nexport type InsertAdhocInvoice = z.infer<typeof insertAdhocInvoiceSchema>;\nexport type UpdateAdhocInvoice = z.infer<typeof updateAdhocInvoiceSchema>;\nexport type InvoiceLineItem = typeof invoiceLineItems.$inferSelect;\nexport type InsertInvoiceLineItem = z.infer<typeof insertInvoiceLineItemSchema>;\nexport type Payment = typeof payments.$inferSelect;\nexport type InsertPayment = z.infer<typeof insertPaymentSchema>;\nexport type WaitlistEntry = typeof waitlist.$inferSelect;\nexport type InsertWaitlistEntry = z.infer<typeof insertWaitlistSchema>;\nexport type UpdateWaitlistEntry = z.infer<typeof updateWaitlistSchema>;\nexport type ParentMessage = typeof parentMessages.$inferSelect;\nexport type InsertParentMessage = z.infer<typeof insertParentMessageSchema>;\nexport type ParentMessageReply = typeof parentMessageReplies.$inferSelect;\nexport type InsertParentMessageReply = z.infer<typeof insertParentMessageReplySchema>;\nexport type StudentTopic = typeof studentTopics.$inferSelect;\nexport type InsertStudentTopic = z.infer<typeof insertStudentTopicSchema>;\nexport type UpdateStudentTopic = z.infer<typeof updateStudentTopicSchema>;\nexport type RateConfiguration = typeof rateConfigurations.$inferSelect;\nexport type InsertRateConfiguration = z.infer<typeof insertRateConfigurationSchema>;\nexport type UpdateRateConfiguration = z.infer<typeof updateRateConfigurationSchema>;\nexport type TutorRate = typeof tutorRates.$inferSelect;\nexport type InsertTutorRate = z.infer<typeof insertTutorRateSchema>;\nexport type UpdateTutorRate = z.infer<typeof updateTutorRateSchema>;\nexport type ParentRate = typeof parentRates.$inferSelect;\nexport type InsertParentRate = z.infer<typeof insertParentRateSchema>;\nexport type UpdateParentRate = z.infer<typeof updateParentRateSchema>;\nexport type RateLink = typeof rateLinks.$inferSelect;\nexport type InsertRateLink = z.infer<typeof insertRateLinkSchema>;\nexport type StudentTutor = typeof studentTutors.$inferSelect;\nexport type InsertStudentTutor = z.infer<typeof insertStudentTutorSchema>;\n\n// Extended types with relations\nexport type StudentTutorWithUser = StudentTutor & {\n  tutor: User;\n};\n\nexport type StudentWithTutor = Student & {\n  tutor: User;\n  assignedTutors?: StudentTutorWithUser[];\n};\n\nexport type StudentWithRelations = Student & {\n  tutor: User;\n  parent?: User;\n};\n\nexport type TimesheetEntryWithRelations = TimesheetEntry & {\n  student: Student;\n  tutor: User;\n};\n\nexport type WeeklyTimesheetWithRelations = WeeklyTimesheet & {\n  tutor: User;\n  reviewer?: User | null;\n  entries: TimesheetEntryWithRelations[];\n};\n\nexport type TutorTimeSlotWithRelations = TutorTimeSlot & {\n  tutor: User;\n  slotBookings: SlotBookingWithRelations[];\n};\n\nexport type SlotBookingWithRelations = SlotBooking & {\n  slot: TutorTimeSlot;\n  student: StudentWithRelations;\n};\n\nexport type InvoiceWithRelations = Invoice & {\n  student: Student;\n  lineItems: InvoiceLineItem[];\n  payments: Payment[];\n};\n\nexport type PaymentWithRelations = Payment & {\n  invoice?: Invoice | null;\n  student: Student;\n};\n\n// Archive summary types\nexport type ArchivedStudentSummary = Student & {\n  tutor: User;\n  totalBilled: number;\n  totalReceived: number;\n  totalOutstanding: number;\n  invoiceCount: number;\n  sessionCount: number;\n};\n\nexport type ArchivedTutorSummary = User & {\n  totalEarnings: number;\n  totalPaid: number;\n  totalOutstanding: number;\n  sessionCount: number;\n  studentCount: number;\n};\n\nexport type ParentMessageReplyWithRelations = ParentMessageReply & {\n  repliedBy: User;\n};\n\nexport type ParentMessageWithRelations = ParentMessage & {\n  student: Student;\n  replies?: ParentMessageReplyWithRelations[];\n  readByTutor?: User | null;\n};\n\nexport type StudentTopicWithRelations = StudentTopic & {\n  student: Student;\n  coveredBy?: User | null;\n};\n\n// System settings schemas and types\nexport const insertSystemSettingSchema = createInsertSchema(systemSettings).omit({ id: true, updatedAt: true });\nexport const updateSystemSettingSchema = insertSystemSettingSchema.partial();\nexport type SystemSetting = typeof systemSettings.$inferSelect;\nexport type InsertSystemSetting = z.infer<typeof insertSystemSettingSchema>;\nexport type UpdateSystemSetting = z.infer<typeof updateSystemSettingSchema>;\n","path":null,"size_bytes":32300,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport Landing from \"@/pages/landing\";\nimport Home from \"@/pages/home\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction Router() {\n  const { isAuthenticated, isLoading } = useAuth();\n\n  return (\n    <Switch>\n      {isLoading || !isAuthenticated ? (\n        <Route path=\"/\" component={Landing} />\n      ) : (\n        <>\n          <Route path=\"/\" component={Home} />\n        </>\n      )}\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <Toaster />\n        <Router />\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":970,"size_tokens":null},"replit.md":{"content":"# Overview\n\nZHK Tuition Ltd Management System is a comprehensive tuition business management system built specifically for ZHK Tuition Ltd. The application manages student information, tracks tutoring sessions, handles timesheet entries, and implements a dual-rate payment system where students pay one rate while tutors receive another. It features role-based access control with admin and tutor dashboards, session-based authentication through Replit Auth, and real-time data management capabilities.\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# System Architecture\n\n## Frontend Architecture\n- **Framework**: React 18 with TypeScript using Vite as the build tool\n- **UI Components**: Shadcn/ui component library built on Radix UI primitives\n- **Styling**: Tailwind CSS with custom CSS variables for theming\n- **State Management**: TanStack Query (React Query) for server state management\n- **Routing**: Wouter for lightweight client-side routing\n- **Forms**: React Hook Form with Zod validation for type-safe form handling\n\n## Backend Architecture\n- **Framework**: Express.js with TypeScript\n- **Database**: PostgreSQL with Drizzle ORM for type-safe database operations\n- **Authentication**: Replit Auth with OpenID Connect (OIDC) integration\n- **Session Management**: Express sessions with PostgreSQL session store\n- **API Design**: RESTful API with role-based route protection\n\n## Database Design\n- **Users Table**: Stores user authentication data and role information (admin/tutor/parent)\n- **Students Table**: Contains student profiles with tutor assignments and session tracking\n- **Weekly Timesheets Table**: Groups timesheet entries by ISO week with status workflow (draft/submitted/approved/rejected)\n- **Timesheet Entries Table**: Records individual tutoring sessions linked to weekly timesheets\n- **Sessions Table**: Handles user session storage for authentication\n- **Tutor Rates Table**: Independent table for tutor payment rates (Â£/hr for what tutors earn)\n- **Parent Rates Table**: Independent table for parent billing rates (Â£/hr for what parents pay)\n- **Rate Linkings Table**: Optional linking table connecting tutor and parent rates for profit margin analysis\n\n## Independent Rate System\n- **Design Principle**: Tutor rates and parent rates are completely independent - creating, updating, or deleting one rate type does NOT affect the other\n- **Tutor Rates**: Define how much tutors are paid per hour for different session types\n- **Parent Rates**: Define how much parents are billed per hour for different session types\n- **Optional Linking**: Rates can be manually linked for profit margin analysis without creating dependencies\n- **API Endpoints**: Separate endpoints for each rate type (/api/tutor-rates, /api/parent-rates, /api/rate-links)\n\n## Weekly Timesheet Workflow\n- Sessions are automatically grouped into weekly timesheets by ISO week (Monday start)\n- Tutors log individual sessions which link to draft weekly timesheets\n- Tutors submit their weekly timesheet for approval when the week is complete\n- Admins review submitted timesheets and can approve or reject with notes\n- Status flow: draft â†’ submitted â†’ approved/rejected\n\n## Authentication & Authorization\n- **Provider**: Replit Auth with OIDC for secure authentication\n- **Session Storage**: PostgreSQL-backed session store with 7-day TTL\n- **Role-Based Access**: Admin users can view all data, tutors can only access their assigned students\n- **Route Protection**: Middleware-based authentication checks on all API endpoints\n\n## Data Storage & Management\n- **ORM**: Drizzle ORM with PostgreSQL dialect for type-safe database queries\n- **Connection**: Neon Database serverless PostgreSQL with connection pooling\n- **Migrations**: Drizzle Kit for schema migrations and database management\n- **Validation**: Zod schemas for runtime type validation and API input sanitization\n\n# External Dependencies\n\n## Database Services\n- **Neon Database**: Serverless PostgreSQL database hosting\n- **Connection Pooling**: @neondatabase/serverless for optimized database connections\n\n## Authentication Services\n- **Replit Auth**: OpenID Connect authentication provider\n- **Session Management**: connect-pg-simple for PostgreSQL session storage\n\n## UI & Styling Libraries\n- **Radix UI**: Headless component primitives for accessibility\n- **Shadcn/ui**: Pre-built component library with consistent design system\n- **Tailwind CSS**: Utility-first CSS framework with custom theming\n- **Lucide React**: Icon library for consistent iconography\n\n## Development & Build Tools\n- **Vite**: Fast build tool and development server\n- **TypeScript**: Static type checking and enhanced developer experience\n- **ESBuild**: Fast JavaScript bundler for production builds\n- **Drizzle Kit**: Database migration and schema management tools","path":null,"size_bytes":4833,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":23567,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/pages/home.tsx":{"content":"import { useAuth } from \"@/hooks/useAuth\";\nimport { useEffect, useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport TutorDashboard from \"@/components/tutor-dashboard\";\nimport AdminDashboard from \"@/components/admin-dashboard\";\nimport ParentDashboard from \"@/components/parent-dashboard\";\nimport { GraduationCap, Bus, ShieldQuestion, Users } from \"lucide-react\";\n\nexport default function Home() {\n  const { user, isLoading } = useAuth();\n  const { toast } = useToast();\n  const [currentRole, setCurrentRole] = useState<\"tutor\" | \"admin\" | \"parent\">(\"tutor\");\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n\n    if (user?.role) {\n      setCurrentRole(user.role as \"tutor\" | \"admin\" | \"parent\");\n    }\n  }, [user, isLoading, toast]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return null;\n  }\n\n  const canSwitchRole = user.role === \"admin\";\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <header className=\"bg-card border-b border-border shadow-sm\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex justify-between items-center h-16\">\n            <div className=\"flex items-center space-x-2 sm:space-x-4\">\n              <div className=\"flex items-center space-x-2\">\n                <GraduationCap className=\"text-primary h-6 w-6 sm:h-8 sm:w-8\" />\n                <h1 className=\"text-lg sm:text-xl font-bold text-foreground\">ZHK Tuition Ltd</h1>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center space-x-2 sm:space-x-4\">\n              {/* Role Switcher - only show for admin */}\n              {canSwitchRole && (\n                <div className=\"bg-secondary rounded-lg p-1 flex\">\n                  <button\n                    onClick={() => setCurrentRole(\"tutor\")}\n                    className={`px-2 sm:px-3 py-1 rounded-md text-xs sm:text-sm font-medium transition-all ${\n                      currentRole === \"tutor\"\n                        ? \"bg-primary text-primary-foreground\"\n                        : \"text-muted-foreground hover:text-foreground\"\n                    }`}\n                    data-testid=\"button-role-tutor\"\n                  >\n                    <Bus className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 inline\" />\n                    <span className=\"hidden sm:inline\">Tutor</span>\n                  </button>\n                  <button\n                    onClick={() => setCurrentRole(\"admin\")}\n                    className={`px-2 sm:px-3 py-1 rounded-md text-xs sm:text-sm font-medium transition-all ${\n                      currentRole === \"admin\"\n                        ? \"bg-primary text-primary-foreground\"\n                        : \"text-muted-foreground hover:text-foreground\"\n                    }`}\n                    data-testid=\"button-role-admin\"\n                  >\n                    <ShieldQuestion className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 inline\" />\n                    <span className=\"hidden sm:inline\">Admin</span>\n                  </button>\n                  <button\n                    onClick={() => setCurrentRole(\"parent\")}\n                    className={`px-2 sm:px-3 py-1 rounded-md text-xs sm:text-sm font-medium transition-all ${\n                      currentRole === \"parent\"\n                        ? \"bg-primary text-primary-foreground\"\n                        : \"text-muted-foreground hover:text-foreground\"\n                    }`}\n                    data-testid=\"button-role-parent\"\n                  >\n                    <Users className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 inline\" />\n                    <span className=\"hidden sm:inline\">Parent</span>\n                  </button>\n                </div>\n              )}\n              \n              <div className=\"flex items-center space-x-2\">\n                <div className=\"w-8 h-8 bg-primary rounded-full flex items-center justify-center\">\n                  {user.profileImageUrl ? (\n                    <img\n                      src={user.profileImageUrl}\n                      alt=\"Profile\"\n                      className=\"w-8 h-8 rounded-full object-cover\"\n                    />\n                  ) : (\n                    <div className=\"w-8 h-8 bg-primary rounded-full flex items-center justify-center\">\n                      <span className=\"text-primary-foreground text-sm font-medium\">\n                        {user.firstName?.[0] || user.email?.[0] || \"?\"}\n                      </span>\n                    </div>\n                  )}\n                </div>\n                <span className=\"text-sm font-medium hidden sm:block\" data-testid=\"text-user-name\">\n                  {user.firstName && user.lastName\n                    ? `${user.firstName} ${user.lastName}`\n                    : user.email}\n                </span>\n                <button\n                  onClick={() => window.location.href = \"/api/logout\"}\n                  className=\"text-xs sm:text-sm text-muted-foreground hover:text-foreground px-2 py-1\"\n                  data-testid=\"button-logout\"\n                >\n                  Logout\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <div className=\"max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 lg:py-8\">\n        {currentRole === \"parent\" ? (\n          <ParentDashboard user={user} />\n        ) : currentRole === \"tutor\" ? (\n          <TutorDashboard user={user} />\n        ) : (\n          <AdminDashboard user={user} />\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6215,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1128,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-12 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm touch-manipulation\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":810,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n  };\n}\n","path":null,"size_bytes":307,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/lib/authUtils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}","path":null,"size_bytes":115,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { setupAuth, isAuthenticated } from \"./replitAuth\";\nimport { \n  insertStudentSchema, \n  insertTimesheetEntrySchema, \n  updateStudentSchema, \n  insertUserSchema, \n  updateUserSchema,\n  insertTutorTimeSlotSchema,\n  updateTutorTimeSlotSchema,\n  insertSlotBookingSchema,\n  insertNotificationSchema,\n  insertWaitlistSchema,\n  updateWaitlistSchema,\n  insertParentMessageSchema,\n  insertParentMessageReplySchema,\n  insertStudentTopicSchema,\n  updateStudentTopicSchema\n} from \"@shared/schema\";\nimport { z } from \"zod\";\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Auth middleware\n  await setupAuth(app);\n\n  // Auth routes\n  app.get('/api/auth/user', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  // Tutor routes\n  app.get(\"/api/tutors\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const tutors = await storage.getTutors();\n      res.json(tutors);\n    } catch (error) {\n      console.error(\"Error fetching tutors:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutors\" });\n    }\n  });\n\n  app.post(\"/api/tutors\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const validatedData = insertUserSchema.parse(req.body);\n      const tutor = await storage.createTutor(validatedData);\n      res.status(201).json(tutor);\n    } catch (error) {\n      console.error(\"Error creating tutor:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create tutor\" });\n    }\n  });\n\n  app.patch(\"/api/tutors/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const validatedData = updateUserSchema.parse(req.body);\n      const tutor = await storage.updateTutor(req.params.id, validatedData);\n      res.json(tutor);\n    } catch (error) {\n      console.error(\"Error updating tutor:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update tutor\" });\n    }\n  });\n\n  // Archive tutor (soft delete)\n  app.patch(\"/api/tutors/:id/archive\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      if (req.params.id === userId) {\n        return res.status(400).json({ message: \"Cannot archive yourself\" });\n      }\n\n      const tutor = await storage.archiveTutor(req.params.id);\n      res.json(tutor);\n    } catch (error) {\n      console.error(\"Error archiving tutor:\", error);\n      res.status(500).json({ message: \"Failed to archive tutor\" });\n    }\n  });\n\n  // Restore tutor\n  app.patch(\"/api/tutors/:id/restore\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const tutor = await storage.restoreTutor(req.params.id);\n      res.json(tutor);\n    } catch (error) {\n      console.error(\"Error restoring tutor:\", error);\n      res.status(500).json({ message: \"Failed to restore tutor\" });\n    }\n  });\n\n  // Get all tutors including inactive (ex-tutors)\n  app.get(\"/api/tutors/all\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const tutors = await storage.getTutors(true);\n      res.json(tutors);\n    } catch (error) {\n      console.error(\"Error fetching all tutors:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutors\" });\n    }\n  });\n\n  // Student routes\n  app.get(\"/api/students\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      let students;\n      if (user.role === \"admin\") {\n        students = await storage.getStudents();\n      } else {\n        students = await storage.getStudentsByTutor(userId);\n      }\n      \n      res.json(students);\n    } catch (error) {\n      console.error(\"Error fetching students:\", error);\n      res.status(500).json({ message: \"Failed to fetch students\" });\n    }\n  });\n\n  // Get only students assigned to the current user (for tutor view)\n  app.get(\"/api/students/my\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Always return only students assigned to this user, regardless of admin status\n      const students = await storage.getStudentsByTutor(userId);\n      res.json(students);\n    } catch (error) {\n      console.error(\"Error fetching my students:\", error);\n      res.status(500).json({ message: \"Failed to fetch students\" });\n    }\n  });\n\n  app.post(\"/api/students\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Convert numeric rates to strings for database decimal columns\n      const dataToValidate = {\n        ...req.body,\n        parentRate: String(req.body.parentRate),\n        tutorRate: String(req.body.tutorRate),\n      };\n\n      const validatedData = insertStudentSchema.parse(dataToValidate);\n      const student = await storage.createStudent(validatedData);\n      res.status(201).json(student);\n    } catch (error) {\n      console.error(\"Error creating student:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create student\" });\n    }\n  });\n\n  app.patch(\"/api/students/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const validatedData = updateStudentSchema.parse(req.body);\n      const student = await storage.updateStudent(req.params.id, validatedData);\n      res.json(student);\n    } catch (error) {\n      console.error(\"Error updating student:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update student\" });\n    }\n  });\n\n  // Archive student (soft delete)\n  app.patch(\"/api/students/:id/archive\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const student = await storage.archiveStudent(req.params.id);\n      res.json(student);\n    } catch (error) {\n      console.error(\"Error archiving student:\", error);\n      res.status(500).json({ message: \"Failed to archive student\" });\n    }\n  });\n\n  // Restore student\n  app.patch(\"/api/students/:id/restore\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const student = await storage.restoreStudent(req.params.id);\n      res.json(student);\n    } catch (error) {\n      console.error(\"Error restoring student:\", error);\n      res.status(500).json({ message: \"Failed to restore student\" });\n    }\n  });\n\n  // Permanently delete archived student\n  app.delete(\"/api/students/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      await storage.deleteStudent(req.params.id);\n      res.json({ message: \"Student permanently deleted\" });\n    } catch (error: any) {\n      console.error(\"Error deleting student:\", error);\n      res.status(400).json({ message: error.message || \"Failed to delete student\" });\n    }\n  });\n\n  // Get all students including inactive (ex-students)\n  app.get(\"/api/students/all\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const students = await storage.getStudents(true);\n      res.json(students);\n    } catch (error) {\n      console.error(\"Error fetching all students:\", error);\n      res.status(500).json({ message: \"Failed to fetch students\" });\n    }\n  });\n\n  // Get student invoice summaries (outstanding invoices and unpaid sessions)\n  app.get(\"/api/students/invoice-summaries\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const summaries = await storage.getStudentInvoiceSummaries();\n      res.json(summaries);\n    } catch (error) {\n      console.error(\"Error fetching student invoice summaries:\", error);\n      res.status(500).json({ message: \"Failed to fetch invoice summaries\" });\n    }\n  });\n\n  // Timesheet routes\n  // Get all sessions for the current tutor\n  app.get(\"/api/timesheets/my-sessions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Get all sessions for this tutor (no date filter)\n      const timesheets = await storage.getTimesheetEntries(userId, undefined, undefined);\n      res.json(timesheets);\n    } catch (error) {\n      console.error(\"Error fetching my sessions:\", error);\n      res.status(500).json({ message: \"Failed to fetch sessions\" });\n    }\n  });\n\n  // Get all sessions for admin view\n  app.get(\"/api/timesheets/all\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const timesheets = await storage.getTimesheetEntries(undefined, undefined, undefined);\n      res.json(timesheets);\n    } catch (error) {\n      console.error(\"Error fetching all timesheets:\", error);\n      res.status(500).json({ message: \"Failed to fetch timesheets\" });\n    }\n  });\n\n  // Route for path-based date parameters (used by frontend queryKey)\n  app.get(\"/api/timesheets/:startDate/:endDate\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const { startDate, endDate } = req.params;\n      const tutorId = user.role === \"admin\" ? undefined : userId;\n      const start = new Date(startDate);\n      const end = new Date(endDate);\n      \n      const timesheets = await storage.getTimesheetEntries(tutorId, start, end);\n      res.json(timesheets);\n    } catch (error) {\n      console.error(\"Error fetching timesheets:\", error);\n      res.status(500).json({ message: \"Failed to fetch timesheets\" });\n    }\n  });\n\n  app.get(\"/api/timesheets\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const { startDate, endDate, status } = req.query;\n      \n      let timesheets;\n      if (status && user.role === \"admin\") {\n        timesheets = await storage.getTimesheetEntriesByStatus(status as \"pending\" | \"approved\" | \"rejected\");\n      } else {\n        const tutorId = user.role === \"admin\" ? undefined : userId;\n        const start = startDate ? new Date(startDate as string) : undefined;\n        const end = endDate ? new Date(endDate as string) : undefined;\n        timesheets = await storage.getTimesheetEntries(tutorId, start, end);\n      }\n      \n      res.json(timesheets);\n    } catch (error) {\n      console.error(\"Error fetching timesheets:\", error);\n      res.status(500).json({ message: \"Failed to fetch timesheets\" });\n    }\n  });\n\n  app.post(\"/api/timesheets\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const { studentId, date, duration, notes } = req.body;\n      \n      if (!studentId || !date || duration === undefined) {\n        return res.status(400).json({ message: \"Missing required fields: studentId, date, duration\" });\n      }\n\n      // Validate that the date is not in the future\n      const sessionDate = new Date(date);\n      const today = new Date();\n      today.setHours(23, 59, 59, 999);\n      if (sessionDate > today) {\n        return res.status(400).json({ message: \"Cannot log sessions for future dates\" });\n      }\n\n      const timesheet = await storage.createTimesheetEntry({\n        tutorId: userId,\n        studentId: String(studentId),\n        date: new Date(date),\n        duration: String(duration),\n        notes: notes || null,\n      });\n      \n      res.status(201).json(timesheet);\n    } catch (error) {\n      console.error(\"Error creating timesheet:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create timesheet entry\" });\n    }\n  });\n\n  app.patch(\"/api/timesheets/:id/status\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { status } = req.body;\n      if (!status || ![\"approved\", \"rejected\"].includes(status)) {\n        return res.status(400).json({ message: \"Invalid status\" });\n      }\n\n      const timesheet = await storage.updateTimesheetEntryStatus(req.params.id, status);\n      res.json(timesheet);\n    } catch (error) {\n      console.error(\"Error updating timesheet status:\", error);\n      res.status(500).json({ message: \"Failed to update timesheet status\" });\n    }\n  });\n\n  // Weekly Timesheet Routes\n  // Get current week's timesheet for the logged-in tutor\n  app.get(\"/api/weekly-timesheets/current\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Calculate current week boundaries (Monday to Sunday)\n      const now = new Date();\n      const dayOfWeek = now.getDay();\n      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n      const weekStart = new Date(now);\n      weekStart.setDate(now.getDate() + mondayOffset);\n      weekStart.setHours(0, 0, 0, 0);\n      const weekEnd = new Date(weekStart);\n      weekEnd.setDate(weekStart.getDate() + 6);\n      weekEnd.setHours(23, 59, 59, 999);\n\n      const timesheet = await storage.getOrCreateWeeklyTimesheet(userId, weekStart, weekEnd);\n      const fullTimesheet = await storage.getWeeklyTimesheet(timesheet.id);\n      \n      res.json(fullTimesheet);\n    } catch (error) {\n      console.error(\"Error fetching current weekly timesheet:\", error);\n      res.status(500).json({ message: \"Failed to fetch current weekly timesheet\" });\n    }\n  });\n\n  // Get all weekly timesheets for the logged-in tutor\n  app.get(\"/api/weekly-timesheets/my\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const timesheets = await storage.getWeeklyTimesheetsByTutor(userId);\n      res.json(timesheets);\n    } catch (error) {\n      console.error(\"Error fetching weekly timesheets:\", error);\n      res.status(500).json({ message: \"Failed to fetch weekly timesheets\" });\n    }\n  });\n\n  // Get submitted timesheets for admin review\n  app.get(\"/api/weekly-timesheets/submitted\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const timesheets = await storage.getWeeklyTimesheetsByStatus(\"submitted\");\n      res.json(timesheets);\n    } catch (error) {\n      console.error(\"Error fetching submitted timesheets:\", error);\n      res.status(500).json({ message: \"Failed to fetch submitted timesheets\" });\n    }\n  });\n\n  // Get a specific weekly timesheet\n  app.get(\"/api/weekly-timesheets/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const timesheet = await storage.getWeeklyTimesheet(req.params.id);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n\n      // Tutors can only see their own timesheets\n      if (user.role !== \"admin\" && timesheet.tutorId !== userId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      res.json(timesheet);\n    } catch (error) {\n      console.error(\"Error fetching weekly timesheet:\", error);\n      res.status(500).json({ message: \"Failed to fetch weekly timesheet\" });\n    }\n  });\n\n  // Submit a weekly timesheet for approval\n  app.post(\"/api/weekly-timesheets/:id/submit\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const timesheet = await storage.getWeeklyTimesheet(req.params.id);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n\n      // Only the owner can submit their timesheet\n      if (timesheet.tutorId !== userId) {\n        return res.status(403).json({ message: \"You can only submit your own timesheets\" });\n      }\n\n      if (timesheet.status !== \"draft\" && timesheet.status !== \"rejected\") {\n        return res.status(400).json({ message: \"Timesheet has already been submitted or approved\" });\n      }\n\n      if (timesheet.entries.length === 0) {\n        return res.status(400).json({ message: \"Cannot submit an empty timesheet\" });\n      }\n\n      const submitted = await storage.submitWeeklyTimesheet(req.params.id);\n      res.json(submitted);\n    } catch (error) {\n      console.error(\"Error submitting weekly timesheet:\", error);\n      res.status(500).json({ message: \"Failed to submit weekly timesheet\" });\n    }\n  });\n\n  // Approve or reject a weekly timesheet (admin only)\n  app.patch(\"/api/weekly-timesheets/:id/review\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { status, notes } = req.body;\n      if (!status || ![\"approved\", \"rejected\"].includes(status)) {\n        return res.status(400).json({ message: \"Invalid status. Must be 'approved' or 'rejected'\" });\n      }\n\n      const timesheet = await storage.getWeeklyTimesheet(req.params.id);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n\n      if (timesheet.status !== \"submitted\") {\n        return res.status(400).json({ message: \"Only submitted timesheets can be reviewed\" });\n      }\n\n      const reviewed = await storage.reviewWeeklyTimesheet(req.params.id, userId, status, notes);\n      res.json(reviewed);\n    } catch (error) {\n      console.error(\"Error reviewing weekly timesheet:\", error);\n      res.status(500).json({ message: \"Failed to review weekly timesheet\" });\n    }\n  });\n\n  // Update a timesheet entry (admin only)\n  app.patch(\"/api/timesheet-entries/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { tutorEarnings, parentBilling, duration, notes } = req.body;\n      \n      const updates: { tutorEarnings?: string; parentBilling?: string; duration?: string; notes?: string } = {};\n      if (tutorEarnings !== undefined) updates.tutorEarnings = String(tutorEarnings);\n      if (parentBilling !== undefined) updates.parentBilling = String(parentBilling);\n      if (duration !== undefined) updates.duration = String(duration);\n      if (notes !== undefined) updates.notes = notes;\n\n      const updated = await storage.updateTimesheetEntry(req.params.id, updates);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating timesheet entry:\", error);\n      res.status(500).json({ message: \"Failed to update timesheet entry\" });\n    }\n  });\n\n  // Tutor route to update their own entries in rejected/draft timesheets\n  app.patch(\"/api/timesheet-entries/:id/tutor\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const { date, duration, notes } = req.body;\n      \n      const updates: { date?: Date; duration?: number; notes?: string } = {};\n      if (date !== undefined) updates.date = new Date(date);\n      if (duration !== undefined) updates.duration = Number(duration);\n      if (notes !== undefined) updates.notes = notes;\n\n      const updated = await storage.updateTimesheetEntryByTutor(req.params.id, userId, updates);\n      res.json(updated);\n    } catch (error: any) {\n      console.error(\"Error updating timesheet entry by tutor:\", error);\n      res.status(error.message?.includes(\"only edit\") || error.message?.includes(\"only delete\") ? 403 : 500)\n        .json({ message: error.message || \"Failed to update timesheet entry\" });\n    }\n  });\n\n  // Tutor route to delete their own entries in rejected/draft timesheets\n  app.delete(\"/api/timesheet-entries/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      await storage.deleteTimesheetEntry(req.params.id, userId);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Error deleting timesheet entry:\", error);\n      res.status(error.message?.includes(\"only\") ? 403 : 500)\n        .json({ message: error.message || \"Failed to delete timesheet entry\" });\n    }\n  });\n\n  // Get timesheet status history\n  app.get(\"/api/weekly-timesheets/:id/history\", isAuthenticated, async (req: any, res) => {\n    try {\n      const history = await storage.getTimesheetStatusHistory(req.params.id);\n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching timesheet status history:\", error);\n      res.status(500).json({ message: \"Failed to fetch status history\" });\n    }\n  });\n\n  // Analytics routes\n  app.get(\"/api/analytics/tutor-earnings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const { startDate, endDate } = req.query;\n      \n      if (!startDate || !endDate) {\n        return res.status(400).json({ message: \"Start date and end date are required\" });\n      }\n\n      const earnings = await storage.getTutorWeeklyEarnings(\n        userId,\n        new Date(startDate as string),\n        new Date(endDate as string)\n      );\n      \n      res.json({ earnings });\n    } catch (error) {\n      console.error(\"Error fetching tutor earnings:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutor earnings\" });\n    }\n  });\n\n  app.get(\"/api/analytics/tutor-weeks\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const weeks = await storage.getTutorWeeks(userId);\n      res.json(weeks);\n    } catch (error) {\n      console.error(\"Error fetching tutor weeks:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutor weeks\" });\n    }\n  });\n\n  app.get(\"/api/analytics/admin-stats\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const stats = await storage.getAdminStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching admin stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch admin stats\" });\n    }\n  });\n\n  // Admin: View a specific tutor's earnings (what the tutor sees)\n  app.get(\"/api/analytics/tutor-earnings/:tutorId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { tutorId } = req.params;\n      const { startDate, endDate } = req.query;\n      \n      if (!startDate || !endDate) {\n        return res.status(400).json({ message: \"Start date and end date are required\" });\n      }\n\n      const earnings = await storage.getTutorWeeklyEarnings(\n        tutorId,\n        new Date(startDate as string),\n        new Date(endDate as string)\n      );\n\n      // Also get the detailed entries so admin can see breakdown\n      const entries = await storage.getTimesheetEntries(\n        tutorId,\n        new Date(startDate as string),\n        new Date(endDate as string)\n      );\n      \n      res.json({ earnings, entries });\n    } catch (error) {\n      console.error(\"Error fetching tutor earnings for admin:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutor earnings\" });\n    }\n  });\n\n  // Time slot routes\n  app.get(\"/api/slots\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { tutorId, startDate, endDate, subject } = req.query;\n      \n      const slots = await storage.getAvailableSlots(\n        startDate ? new Date(startDate as string) : undefined,\n        endDate ? new Date(endDate as string) : undefined,\n        tutorId as string,\n        subject as string\n      );\n      res.json(slots);\n    } catch (error) {\n      console.error(\"Error fetching available slots:\", error);\n      res.status(500).json({ message: \"Failed to fetch available slots\" });\n    }\n  });\n\n  app.get(\"/api/tutor/slots\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || (user.role !== \"tutor\" && user.role !== \"admin\")) {\n        return res.status(403).json({ message: \"Tutor or admin access required\" });\n      }\n\n      const { startDate, endDate } = req.query;\n      const tutorId = user.role === \"admin\" ? req.query.tutorId : userId;\n      \n      const slots = await storage.getTutorTimeSlots(\n        tutorId as string,\n        startDate ? new Date(startDate as string) : undefined,\n        endDate ? new Date(endDate as string) : undefined\n      );\n      res.json(slots);\n    } catch (error) {\n      console.error(\"Error fetching tutor slots:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutor slots\" });\n    }\n  });\n\n  app.post(\"/api/tutor/slots\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || (user.role !== \"tutor\" && user.role !== \"admin\")) {\n        return res.status(403).json({ message: \"Tutor or admin access required\" });\n      }\n\n      const validatedData = insertTutorTimeSlotSchema.parse({\n        ...req.body,\n        tutorId: user.role === \"admin\" ? req.body.tutorId : userId\n      });\n      \n      const slot = await storage.createTutorTimeSlot(validatedData);\n      res.status(201).json(slot);\n    } catch (error) {\n      console.error(\"Error creating time slot:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create time slot\" });\n    }\n  });\n\n  app.patch(\"/api/tutor/slots/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || (user.role !== \"tutor\" && user.role !== \"admin\")) {\n        return res.status(403).json({ message: \"Tutor or admin access required\" });\n      }\n\n      const validatedData = updateTutorTimeSlotSchema.parse(req.body);\n      const slot = await storage.updateTutorTimeSlot(req.params.id, validatedData);\n      res.json(slot);\n    } catch (error) {\n      console.error(\"Error updating time slot:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update time slot\" });\n    }\n  });\n\n  app.delete(\"/api/tutor/slots/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || (user.role !== \"tutor\" && user.role !== \"admin\")) {\n        return res.status(403).json({ message: \"Tutor or admin access required\" });\n      }\n\n      await storage.deleteTutorTimeSlot(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting time slot:\", error);\n      res.status(500).json({ message: \"Failed to delete time slot\" });\n    }\n  });\n\n  // Get tutor annual earnings\n  app.get(\"/api/tutor/earnings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || (user.role !== \"tutor\" && user.role !== \"admin\")) {\n        return res.status(403).json({ message: \"Tutor access required\" });\n      }\n\n      const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear();\n      const earnings = await storage.getTutorAnnualEarnings(userId, year);\n      res.json(earnings);\n    } catch (error) {\n      console.error(\"Error fetching tutor earnings:\", error);\n      res.status(500).json({ message: \"Failed to fetch earnings\" });\n    }\n  });\n\n  // Internal admin booking assignment (replaces public booking)\n  app.get(\"/api/admin/slot-assignments\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { studentId, slotId } = req.query;\n      const bookings = await storage.getSlotBookings(studentId as string, slotId as string);\n      res.json(bookings);\n    } catch (error) {\n      console.error(\"Error fetching slot assignments:\", error);\n      res.status(500).json({ message: \"Failed to fetch slot assignments\" });\n    }\n  });\n\n  app.post(\"/api/admin/assign-student\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const validatedData = insertSlotBookingSchema.parse(req.body);\n      const booking = await storage.createSlotBooking(validatedData);\n      res.status(201).json(booking);\n    } catch (error) {\n      console.error(\"Error assigning student to slot:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      if (error instanceof Error) {\n        return res.status(400).json({ message: error.message });\n      }\n      res.status(500).json({ message: \"Failed to assign student\" });\n    }\n  });\n\n  app.delete(\"/api/admin/unassign-student/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const booking = await storage.cancelSlotBooking(req.params.id);\n      res.json(booking);\n    } catch (error) {\n      console.error(\"Error unassigning student:\", error);\n      res.status(500).json({ message: \"Failed to unassign student\" });\n    }\n  });\n\n  // Attendance marking\n  app.post(\"/api/slots/:id/attendance\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || (user.role !== \"tutor\" && user.role !== \"admin\")) {\n        return res.status(403).json({ message: \"Tutor or admin access required\" });\n      }\n\n      const { presentStudentIds } = req.body;\n      if (!Array.isArray(presentStudentIds)) {\n        return res.status(400).json({ message: \"presentStudentIds must be an array\" });\n      }\n\n      const timesheetEntries = await storage.markAttendance(req.params.id, presentStudentIds);\n      res.json(timesheetEntries);\n    } catch (error) {\n      console.error(\"Error marking attendance:\", error);\n      if (error instanceof Error) {\n        return res.status(400).json({ message: error.message });\n      }\n      res.status(500).json({ message: \"Failed to mark attendance\" });\n    }\n  });\n\n  // Notification routes\n  app.get(\"/api/notifications\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const notifications = await storage.getNotifications(userId);\n      res.json(notifications);\n    } catch (error) {\n      console.error(\"Error fetching notifications:\", error);\n      res.status(500).json({ message: \"Failed to fetch notifications\" });\n    }\n  });\n\n  app.patch(\"/api/notifications/:id/read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const notification = await storage.markNotificationRead(req.params.id);\n      res.json(notification);\n    } catch (error) {\n      console.error(\"Error marking notification as read:\", error);\n      res.status(500).json({ message: \"Failed to mark notification as read\" });\n    }\n  });\n\n  // Tutor Invoice Routes\n  app.get(\"/api/tutor-invoices\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const invoices = await storage.getTutorInvoices();\n      res.json(invoices);\n    } catch (error) {\n      console.error(\"Error fetching tutor invoices:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutor invoices\" });\n    }\n  });\n\n  app.get(\"/api/tutor-invoices/this-week\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const invoices = await storage.getTutorInvoicesThisWeek();\n      res.json(invoices);\n    } catch (error) {\n      console.error(\"Error fetching tutor invoices this week:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutor invoices\" });\n    }\n  });\n\n  app.post(\"/api/tutor-invoices\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      \n      // Generate invoice number\n      const now = new Date();\n      const invoiceNumber = `TI-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;\n\n      const invoice = await storage.createTutorInvoice({\n        ...req.body,\n        tutorId: userId,\n        invoiceNumber,\n      });\n      res.status(201).json(invoice);\n    } catch (error) {\n      console.error(\"Error creating tutor invoice:\", error);\n      res.status(500).json({ message: \"Failed to create tutor invoice\" });\n    }\n  });\n\n  app.patch(\"/api/tutor-invoices/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const updated = await storage.updateTutorInvoice(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating tutor invoice:\", error);\n      res.status(500).json({ message: \"Failed to update tutor invoice\" });\n    }\n  });\n\n  // Parent Invoices (for admin view)\n  app.get(\"/api/invoices\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { studentId } = req.query;\n      const invoices = await storage.getInvoices(studentId as string | undefined);\n      res.json(invoices);\n    } catch (error) {\n      console.error(\"Error fetching invoices:\", error);\n      res.status(500).json({ message: \"Failed to fetch invoices\" });\n    }\n  });\n\n  app.post(\"/api/invoices\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Generate invoice number\n      const now = new Date();\n      const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;\n\n      const invoice = await storage.createInvoice({\n        ...req.body,\n        invoiceNumber,\n      });\n      res.status(201).json(invoice);\n    } catch (error) {\n      console.error(\"Error creating invoice:\", error);\n      res.status(500).json({ message: \"Failed to create invoice\" });\n    }\n  });\n\n  app.patch(\"/api/invoices/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Get the current invoice to check if status is changing to paid\n      const currentInvoice = await storage.getInvoice(req.params.id);\n      if (!currentInvoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n\n      const updated = await storage.updateInvoice(req.params.id, req.body);\n\n      // If status changed to \"paid\", add sessions to the student\n      if (req.body.status === \"paid\" && currentInvoice.status !== \"paid\") {\n        const sessionsToAdd = updated.sessionsIncluded || currentInvoice.sessionsIncluded || 0;\n        if (sessionsToAdd > 0) {\n          await storage.addSessionsToStudent(currentInvoice.studentId, sessionsToAdd);\n        }\n      }\n\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating invoice:\", error);\n      res.status(500).json({ message: \"Failed to update invoice\" });\n    }\n  });\n\n  // Auto-generate parent invoice when sessions run out (called from session logging)\n  app.post(\"/api/invoices/auto-generate/:studentId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { sessions } = req.body;\n      const invoice = await storage.generateParentInvoiceForStudent(req.params.studentId, sessions || 6);\n      if (invoice) {\n        res.status(201).json(invoice);\n      } else {\n        res.status(404).json({ message: \"Student not found\" });\n      }\n    } catch (error) {\n      console.error(\"Error auto-generating invoice:\", error);\n      res.status(500).json({ message: \"Failed to generate invoice\" });\n    }\n  });\n\n  // Adhoc Invoices (manual invoices not tied to students)\n  app.get(\"/api/adhoc-invoices\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const invoices = await storage.getAdhocInvoices();\n      res.json(invoices);\n    } catch (error) {\n      console.error(\"Error fetching adhoc invoices:\", error);\n      res.status(500).json({ message: \"Failed to fetch adhoc invoices\" });\n    }\n  });\n\n  app.post(\"/api/adhoc-invoices\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Convert date strings to Date objects for timestamp columns\n      const invoiceData = {\n        ...req.body,\n        dueDate: req.body.dueDate ? new Date(req.body.dueDate) : null,\n        paidAt: req.body.paidAt ? new Date(req.body.paidAt) : null,\n      };\n\n      const invoice = await storage.createAdhocInvoice(invoiceData);\n      res.status(201).json(invoice);\n    } catch (error) {\n      console.error(\"Error creating adhoc invoice:\", error);\n      res.status(500).json({ message: \"Failed to create adhoc invoice\" });\n    }\n  });\n\n  app.patch(\"/api/adhoc-invoices/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Convert date strings to Date objects for timestamp columns\n      const updateData = { ...req.body };\n      if (updateData.dueDate !== undefined) {\n        updateData.dueDate = updateData.dueDate ? new Date(updateData.dueDate) : null;\n      }\n      if (updateData.paidAt !== undefined) {\n        updateData.paidAt = updateData.paidAt ? new Date(updateData.paidAt) : null;\n      }\n\n      const updated = await storage.updateAdhocInvoice(req.params.id, updateData);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating adhoc invoice:\", error);\n      res.status(500).json({ message: \"Failed to update adhoc invoice\" });\n    }\n  });\n\n  app.delete(\"/api/adhoc-invoices/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      await storage.deleteAdhocInvoice(req.params.id);\n      res.json({ message: \"Adhoc invoice deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting adhoc invoice:\", error);\n      res.status(500).json({ message: \"Failed to delete adhoc invoice\" });\n    }\n  });\n\n  // QuickBooks Export Routes - Replace Excel-to-QuickBooks workflow\n  app.get(\"/api/exports/parent-invoices\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { startDate, endDate } = req.query;\n      \n      if (!startDate || !endDate) {\n        return res.status(400).json({ message: \"Start date and end date are required\" });\n      }\n\n      const csvData = await storage.generateParentInvoicesCSV(\n        new Date(startDate as string),\n        new Date(endDate as string)\n      );\n      \n      res.setHeader('Content-Type', 'text/csv');\n      res.setHeader('Content-Disposition', `attachment; filename=\"parent-invoices-${startDate}-${endDate}.csv\"`);\n      res.send(csvData);\n    } catch (error) {\n      console.error(\"Error generating parent invoices CSV:\", error);\n      res.status(500).json({ message: \"Failed to generate parent invoices CSV\" });\n    }\n  });\n\n  app.get(\"/api/exports/tutor-payroll\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { startDate, endDate } = req.query;\n      \n      if (!startDate || !endDate) {\n        return res.status(400).json({ message: \"Start date and end date are required\" });\n      }\n\n      const csvData = await storage.generateTutorPayrollCSV(\n        new Date(startDate as string),\n        new Date(endDate as string)\n      );\n      \n      res.setHeader('Content-Type', 'text/csv');\n      res.setHeader('Content-Disposition', `attachment; filename=\"tutor-payroll-${startDate}-${endDate}.csv\"`);\n      res.send(csvData);\n    } catch (error) {\n      console.error(\"Error generating tutor payroll CSV:\", error);\n      res.status(500).json({ message: \"Failed to generate tutor payroll CSV\" });\n    }\n  });\n\n  // Archive routes - admin only\n  app.get(\"/api/archive/students\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const archivedStudents = await storage.getArchivedStudents();\n      res.json(archivedStudents);\n    } catch (error) {\n      console.error(\"Error fetching archived students:\", error);\n      res.status(500).json({ message: \"Failed to fetch archived students\" });\n    }\n  });\n\n  app.get(\"/api/archive/students/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const details = await storage.getArchivedStudentDetails(req.params.id);\n      if (!details) {\n        return res.status(404).json({ message: \"Student not found\" });\n      }\n      res.json(details);\n    } catch (error) {\n      console.error(\"Error fetching archived student details:\", error);\n      res.status(500).json({ message: \"Failed to fetch archived student details\" });\n    }\n  });\n\n  app.get(\"/api/archive/tutors\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const archivedTutors = await storage.getArchivedTutors();\n      res.json(archivedTutors);\n    } catch (error) {\n      console.error(\"Error fetching archived tutors:\", error);\n      res.status(500).json({ message: \"Failed to fetch archived tutors\" });\n    }\n  });\n\n  app.get(\"/api/archive/tutors/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const details = await storage.getArchivedTutorDetails(req.params.id);\n      if (!details) {\n        return res.status(404).json({ message: \"Tutor not found\" });\n      }\n      res.json(details);\n    } catch (error) {\n      console.error(\"Error fetching archived tutor details:\", error);\n      res.status(500).json({ message: \"Failed to fetch archived tutor details\" });\n    }\n  });\n\n  // Waitlist routes - admin only\n  app.get(\"/api/waitlist\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const entries = await storage.getWaitlistEntries();\n      res.json(entries);\n    } catch (error) {\n      console.error(\"Error fetching waitlist entries:\", error);\n      res.status(500).json({ message: \"Failed to fetch waitlist entries\" });\n    }\n  });\n\n  app.post(\"/api/waitlist\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const validatedData = insertWaitlistSchema.parse(req.body);\n      const entry = await storage.createWaitlistEntry(validatedData);\n      res.status(201).json(entry);\n    } catch (error) {\n      console.error(\"Error creating waitlist entry:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create waitlist entry\" });\n    }\n  });\n\n  app.patch(\"/api/waitlist/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const validatedData = updateWaitlistSchema.parse(req.body);\n      const entry = await storage.updateWaitlistEntry(req.params.id, validatedData);\n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error updating waitlist entry:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update waitlist entry\" });\n    }\n  });\n\n  app.delete(\"/api/waitlist/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      await storage.deleteWaitlistEntry(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting waitlist entry:\", error);\n      res.status(500).json({ message: \"Failed to delete waitlist entry\" });\n    }\n  });\n\n  // Parent routes - for parents to view their child's data\n  app.get(\"/api/parent/students\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Admin can view all, parents can only view their linked students\n      if (user.role === \"admin\") {\n        // For admin demo view, return first student or empty\n        const students = await storage.getStudents();\n        res.json(students.slice(0, 1));\n      } else if (user.role === \"parent\") {\n        // Find students where parentEmail matches user email\n        const students = await storage.getStudentsByParentEmail(user.email || \"\");\n        res.json(students);\n      } else {\n        return res.status(403).json({ message: \"Parent access required\" });\n      }\n    } catch (error) {\n      console.error(\"Error fetching parent students:\", error);\n      res.status(500).json({ message: \"Failed to fetch students\" });\n    }\n  });\n\n  app.get(\"/api/parent/sessions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      let studentIds: string[] = [];\n      \n      if (user.role === \"admin\") {\n        const students = await storage.getStudents();\n        studentIds = students.slice(0, 1).map(s => s.id);\n      } else if (user.role === \"parent\") {\n        const students = await storage.getStudentsByParentEmail(user.email || \"\");\n        studentIds = students.map(s => s.id);\n      } else {\n        return res.status(403).json({ message: \"Parent access required\" });\n      }\n\n      if (studentIds.length === 0) {\n        return res.json([]);\n      }\n\n      const sessions = await storage.getTimesheetEntriesByStudentIds(studentIds);\n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching parent sessions:\", error);\n      res.status(500).json({ message: \"Failed to fetch sessions\" });\n    }\n  });\n\n  app.get(\"/api/parent/invoices\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      let studentIds: string[] = [];\n      \n      if (user.role === \"admin\") {\n        const students = await storage.getStudents();\n        studentIds = students.slice(0, 1).map(s => s.id);\n      } else if (user.role === \"parent\") {\n        const students = await storage.getStudentsByParentEmail(user.email || \"\");\n        studentIds = students.map(s => s.id);\n      } else {\n        return res.status(403).json({ message: \"Parent access required\" });\n      }\n\n      if (studentIds.length === 0) {\n        return res.json([]);\n      }\n\n      const invoices = await storage.getInvoicesByStudentIds(studentIds);\n      res.json(invoices);\n    } catch (error) {\n      console.error(\"Error fetching parent invoices:\", error);\n      res.status(500).json({ message: \"Failed to fetch invoices\" });\n    }\n  });\n\n  app.get(\"/api/parent/payments\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      let studentIds: string[] = [];\n      \n      if (user.role === \"admin\") {\n        const students = await storage.getStudents();\n        studentIds = students.slice(0, 1).map(s => s.id);\n      } else if (user.role === \"parent\") {\n        const students = await storage.getStudentsByParentEmail(user.email || \"\");\n        studentIds = students.map(s => s.id);\n      } else {\n        return res.status(403).json({ message: \"Parent access required\" });\n      }\n\n      if (studentIds.length === 0) {\n        return res.json([]);\n      }\n\n      const payments = await storage.getPaymentsByStudentIds(studentIds);\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching parent payments:\", error);\n      res.status(500).json({ message: \"Failed to fetch payments\" });\n    }\n  });\n\n  // Parent message routes\n  // Parents can send messages\n  app.post(\"/api/parent/messages\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Allow admins (for testing) and parents\n      if (user.role !== \"admin\" && user.role !== \"parent\") {\n        return res.status(403).json({ message: \"Parent access required\" });\n      }\n\n      const validatedData = insertParentMessageSchema.parse(req.body);\n      const message = await storage.createParentMessage(validatedData);\n      res.status(201).json(message);\n    } catch (error) {\n      console.error(\"Error creating parent message:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to send message\" });\n    }\n  });\n\n  // Parents can view their sent messages\n  app.get(\"/api/parent/messages\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      if (user.role !== \"admin\" && user.role !== \"parent\") {\n        return res.status(403).json({ message: \"Parent access required\" });\n      }\n\n      const messages = await storage.getParentMessagesByParentEmail(user.email || \"\");\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching parent messages:\", error);\n      res.status(500).json({ message: \"Failed to fetch messages\" });\n    }\n  });\n\n  // Admin can view all messages\n  app.get(\"/api/messages/admin\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Admin sees ALL messages\n      const messages = await storage.getParentMessages(\"admin\");\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching admin messages:\", error);\n      res.status(500).json({ message: \"Failed to fetch messages\" });\n    }\n  });\n\n  // Tutor can view messages sent to tutors (only for their students)\n  // Admins can see all tutor-addressed messages\n  app.get(\"/api/messages/tutor\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      if (user.role !== \"tutor\" && user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Tutor access required\" });\n      }\n\n      // Admins see all tutor-addressed messages, tutors only see their own\n      if (user.role === \"admin\") {\n        const allMessages = await storage.getParentMessages();\n        const tutorMessages = allMessages.filter(msg => msg.recipientType === \"tutor\");\n        res.json(tutorMessages);\n      } else {\n        // Tutors only see messages with recipientType=\"tutor\" for their students\n        const messages = await storage.getParentMessages(\"tutor\", userId);\n        res.json(messages);\n      }\n    } catch (error) {\n      console.error(\"Error fetching tutor messages:\", error);\n      res.status(500).json({ message: \"Failed to fetch messages\" });\n    }\n  });\n\n  // Mark message as read\n  app.patch(\"/api/messages/:id/read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Only tutors and admins can mark messages as read\n      if (user.role !== \"tutor\" && user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Only tutors and admins can mark messages as read\" });\n      }\n\n      // Pass tutor ID if the user is a tutor\n      const tutorId = user.role === \"tutor\" ? user.id : undefined;\n      const message = await storage.markParentMessageRead(req.params.id, tutorId);\n      res.json(message);\n    } catch (error) {\n      console.error(\"Error marking message as read:\", error);\n      res.status(500).json({ message: \"Failed to mark message as read\" });\n    }\n  });\n\n  // Get single message with replies\n  app.get(\"/api/messages/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const message = await storage.getParentMessage(req.params.id);\n      \n      if (!message) {\n        return res.status(404).json({ message: \"Message not found\" });\n      }\n\n      // Tutors can only see messages for their students\n      if (user.role === \"tutor\" && message.student.tutorId !== userId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Get replies for this message\n      const replies = await storage.getParentMessageReplies(req.params.id);\n      \n      res.json({ ...message, replies });\n    } catch (error) {\n      console.error(\"Error fetching message:\", error);\n      res.status(500).json({ message: \"Failed to fetch message\" });\n    }\n  });\n\n  // Create reply to a parent message (tutor/admin only)\n  app.post(\"/api/messages/:id/replies\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      if (user.role !== \"tutor\" && user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Only tutors and admins can reply to messages\" });\n      }\n\n      const message = await storage.getParentMessage(req.params.id);\n      \n      if (!message) {\n        return res.status(404).json({ message: \"Message not found\" });\n      }\n\n      // Tutors can only reply to messages for their students\n      if (user.role === \"tutor\" && message.student.tutorId !== userId) {\n        return res.status(403).json({ message: \"You can only reply to messages for your students\" });\n      }\n\n      const { replyContent } = req.body;\n      \n      if (!replyContent || typeof replyContent !== \"string\" || replyContent.trim() === \"\") {\n        return res.status(400).json({ message: \"Reply content is required\" });\n      }\n\n      const replyData = insertParentMessageReplySchema.parse({\n        messageId: req.params.id,\n        replyContent: replyContent.trim(),\n        repliedById: userId,\n        repliedByRole: user.role as \"admin\" | \"tutor\",\n      });\n\n      const reply = await storage.createParentMessageReply(replyData);\n      res.status(201).json(reply);\n    } catch (error) {\n      console.error(\"Error creating message reply:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create reply\" });\n    }\n  });\n\n  // Student Topics Routes\n  // Get topics for a student (admin or assigned tutor)\n  app.get(\"/api/students/:studentId/topics\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { studentId } = req.params;\n      const student = await storage.getStudent(studentId);\n      \n      if (!student) {\n        return res.status(404).json({ message: \"Student not found\" });\n      }\n\n      // Allow admin or assigned tutor to view topics\n      if (user.role !== \"admin\" && student.tutorId !== userId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const topics = await storage.getStudentTopics(studentId);\n      res.json(topics);\n    } catch (error) {\n      console.error(\"Error fetching student topics:\", error);\n      res.status(500).json({ message: \"Failed to fetch topics\" });\n    }\n  });\n\n  // Bulk import topics for a student (admin only)\n  app.post(\"/api/students/:studentId/topics/import\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { studentId } = req.params;\n      const student = await storage.getStudent(studentId);\n      \n      if (!student) {\n        return res.status(404).json({ message: \"Student not found\" });\n      }\n\n      const { topics } = req.body;\n      if (!Array.isArray(topics)) {\n        return res.status(400).json({ message: \"Topics must be an array\" });\n      }\n\n      const validatedTopics = topics.map((topic, index) => \n        insertStudentTopicSchema.parse({\n          studentId,\n          title: topic.title,\n          description: topic.description || null,\n          orderIndex: topic.orderIndex ?? index,\n        })\n      );\n\n      const created = await storage.replaceStudentTopics(studentId, validatedTopics);\n      res.status(201).json(created);\n    } catch (error) {\n      console.error(\"Error importing student topics:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid topic data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to import topics\" });\n    }\n  });\n\n  // Update a single topic (admin only)\n  app.patch(\"/api/topics/:topicId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const validatedData = updateStudentTopicSchema.parse(req.body);\n      const updated = await storage.updateStudentTopic(req.params.topicId, validatedData);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating topic:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update topic\" });\n    }\n  });\n\n  // Mark topic as covered/uncovered (tutor or admin)\n  app.patch(\"/api/topics/:topicId/covered\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      const { isCovered, coveredAt } = req.body;\n      if (typeof isCovered !== \"boolean\") {\n        return res.status(400).json({ message: \"isCovered must be a boolean\" });\n      }\n\n      // Parse coveredAt date if provided\n      const parsedCoveredAt = coveredAt ? new Date(coveredAt) : undefined;\n      \n      const updated = await storage.markStudentTopicCovered(req.params.topicId, userId, isCovered, parsedCoveredAt);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error marking topic as covered:\", error);\n      res.status(500).json({ message: \"Failed to update topic\" });\n    }\n  });\n\n  // Rate Configuration Routes (admin only)\n  app.get(\"/api/rate-configurations\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const rates = await storage.getRateConfigurations();\n      res.json(rates);\n    } catch (error) {\n      console.error(\"Error fetching rate configurations:\", error);\n      res.status(500).json({ message: \"Failed to fetch rate configurations\" });\n    }\n  });\n\n  app.post(\"/api/rate-configurations\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { insertRateConfigurationSchema } = await import(\"@shared/schema\");\n      const validatedData = insertRateConfigurationSchema.parse(req.body);\n      const rate = await storage.createRateConfiguration(validatedData);\n      res.status(201).json(rate);\n    } catch (error) {\n      console.error(\"Error creating rate configuration:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create rate configuration\" });\n    }\n  });\n\n  app.patch(\"/api/rate-configurations/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { updateRateConfigurationSchema } = await import(\"@shared/schema\");\n      const validatedData = updateRateConfigurationSchema.parse(req.body);\n      const rate = await storage.updateRateConfiguration(req.params.id, validatedData);\n      res.json(rate);\n    } catch (error) {\n      console.error(\"Error updating rate configuration:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update rate configuration\" });\n    }\n  });\n\n  app.delete(\"/api/rate-configurations/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      await storage.deleteRateConfiguration(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting rate configuration:\", error);\n      res.status(500).json({ message: \"Failed to delete rate configuration\" });\n    }\n  });\n\n  // ============ NEW INDEPENDENT RATE SYSTEM ============\n  \n  // Tutor Rates (independent - rates paid TO tutors)\n  app.get(\"/api/tutor-rates\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const rates = await storage.getTutorRates();\n      res.json(rates);\n    } catch (error) {\n      console.error(\"Error fetching tutor rates:\", error);\n      res.status(500).json({ message: \"Failed to fetch tutor rates\" });\n    }\n  });\n\n  app.post(\"/api/tutor-rates\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { insertTutorRateSchema } = await import(\"@shared/schema\");\n      const validatedData = insertTutorRateSchema.parse(req.body);\n      const rate = await storage.createTutorRate(validatedData);\n      res.status(201).json(rate);\n    } catch (error) {\n      console.error(\"Error creating tutor rate:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create tutor rate\" });\n    }\n  });\n\n  app.patch(\"/api/tutor-rates/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { updateTutorRateSchema } = await import(\"@shared/schema\");\n      const validatedData = updateTutorRateSchema.parse(req.body);\n      const rate = await storage.updateTutorRate(req.params.id, validatedData);\n      res.json(rate);\n    } catch (error) {\n      console.error(\"Error updating tutor rate:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update tutor rate\" });\n    }\n  });\n\n  app.delete(\"/api/tutor-rates/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      await storage.deleteTutorRate(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting tutor rate:\", error);\n      res.status(500).json({ message: \"Failed to delete tutor rate\" });\n    }\n  });\n\n  // Parent Rates (independent - rates charged TO parents)\n  app.get(\"/api/parent-rates\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const rates = await storage.getParentRates();\n      res.json(rates);\n    } catch (error) {\n      console.error(\"Error fetching parent rates:\", error);\n      res.status(500).json({ message: \"Failed to fetch parent rates\" });\n    }\n  });\n\n  app.post(\"/api/parent-rates\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { insertParentRateSchema } = await import(\"@shared/schema\");\n      const validatedData = insertParentRateSchema.parse(req.body);\n      const rate = await storage.createParentRate(validatedData);\n      res.status(201).json(rate);\n    } catch (error) {\n      console.error(\"Error creating parent rate:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create parent rate\" });\n    }\n  });\n\n  app.patch(\"/api/parent-rates/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { updateParentRateSchema } = await import(\"@shared/schema\");\n      const validatedData = updateParentRateSchema.parse(req.body);\n      const rate = await storage.updateParentRate(req.params.id, validatedData);\n      res.json(rate);\n    } catch (error) {\n      console.error(\"Error updating parent rate:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update parent rate\" });\n    }\n  });\n\n  app.delete(\"/api/parent-rates/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      await storage.deleteParentRate(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting parent rate:\", error);\n      res.status(500).json({ message: \"Failed to delete parent rate\" });\n    }\n  });\n\n  // Rate Links (optional linking for profit margin analysis)\n  app.get(\"/api/rate-links\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const links = await storage.getRateLinks();\n      res.json(links);\n    } catch (error) {\n      console.error(\"Error fetching rate links:\", error);\n      res.status(500).json({ message: \"Failed to fetch rate links\" });\n    }\n  });\n\n  app.post(\"/api/rate-links\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { insertRateLinkSchema } = await import(\"@shared/schema\");\n      const validatedData = insertRateLinkSchema.parse(req.body);\n      const link = await storage.createRateLink(validatedData);\n      res.status(201).json(link);\n    } catch (error) {\n      console.error(\"Error creating rate link:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create rate link\" });\n    }\n  });\n\n  app.delete(\"/api/rate-links/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      await storage.deleteRateLink(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting rate link:\", error);\n      res.status(500).json({ message: \"Failed to delete rate link\" });\n    }\n  });\n\n  // System Settings Routes\n  app.get(\"/api/settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const settings = await storage.getSystemSettings();\n      res.json(settings);\n    } catch (error) {\n      console.error(\"Error fetching settings:\", error);\n      res.status(500).json({ message: \"Failed to fetch settings\" });\n    }\n  });\n\n  app.get(\"/api/settings/:key\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const setting = await storage.getSystemSetting(req.params.key);\n      if (!setting) {\n        return res.status(404).json({ message: \"Setting not found\" });\n      }\n      res.json(setting);\n    } catch (error) {\n      console.error(\"Error fetching setting:\", error);\n      res.status(500).json({ message: \"Failed to fetch setting\" });\n    }\n  });\n\n  app.put(\"/api/settings/:key\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { value, description } = req.body;\n      if (!value) {\n        return res.status(400).json({ message: \"Value is required\" });\n      }\n\n      const setting = await storage.upsertSystemSetting(req.params.key, value, description);\n      res.json(setting);\n    } catch (error) {\n      console.error(\"Error updating setting:\", error);\n      res.status(500).json({ message: \"Failed to update setting\" });\n    }\n  });\n\n  // Mark overdue invoices (can be called periodically or manually)\n  app.post(\"/api/invoices/mark-overdue\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (!user || user.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const count = await storage.markOverdueInvoices();\n      res.json({ message: `Marked ${count} invoices as overdue`, count });\n    } catch (error) {\n      console.error(\"Error marking overdue invoices:\", error);\n      res.status(500).json({ message: \"Failed to mark overdue invoices\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":83900,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { GraduationCap, Clock, Users, DollarSign } from \"lucide-react\";\n\nexport default function Landing() {\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <header className=\"bg-card border-b border-border shadow-sm\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex justify-between items-center h-16\">\n            <div className=\"flex items-center space-x-2\">\n              <GraduationCap className=\"text-primary h-6 w-6 sm:h-8 sm:w-8\" />\n              <h1 className=\"text-lg sm:text-xl font-bold text-foreground\">ZHK Tuition Ltd</h1>\n            </div>\n            \n            <Button onClick={() => window.location.href = \"/api/login\"} data-testid=\"button-login\">\n              Staff Login\n            </Button>\n          </div>\n        </div>\n      </header>\n\n      {/* Hero Section */}\n      <div className=\"bg-gradient-to-br from-primary/5 to-accent/5 py-12 sm:py-20\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center\">\n          <h1 className=\"text-3xl sm:text-4xl md:text-6xl font-bold text-foreground mb-6\">\n            ZHK Tuition Ltd Internal Console\n          </h1>\n          <p className=\"text-lg sm:text-xl text-muted-foreground mb-8 max-w-3xl mx-auto\">\n            Internal management system for ZHK staff. Track timesheets, manage students, \n            and generate reports to replace Excel-to-QuickBooks workflows.\n          </p>\n          <Button \n            size=\"lg\" \n            onClick={() => window.location.href = \"/api/login\"}\n            data-testid=\"button-get-started\"\n          >\n            Access Console\n          </Button>\n        </div>\n      </div>\n\n      {/* Features */}\n      <div className=\"py-20 bg-card\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"text-center mb-16\">\n            <h2 className=\"text-3xl font-bold text-foreground mb-4\">\n              Internal Tools for ZHK Tuition Ltd Staff\n            </h2>\n            <p className=\"text-muted-foreground text-lg\">\n              Streamlined workflow management to replace manual Excel processes\n            </p>\n          </div>\n\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 sm:gap-8\">\n            <Card data-testid=\"card-feature-timesheet\">\n              <CardHeader>\n                <Clock className=\"h-8 w-8 text-primary mb-2\" />\n                <CardTitle>Easy Timesheet Management</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-muted-foreground\">\n                  ZHK tutors can log sessions with automated tracking for accurate billing and payroll.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-feature-sessions\">\n              <CardHeader>\n                <Users className=\"h-8 w-8 text-primary mb-2\" />\n                <CardTitle>Session Tracking</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-muted-foreground\">\n                  Monitor student session balances and automate billing calculations for ZHK's dual-rate system.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-feature-rates\">\n              <CardHeader>\n                <DollarSign className=\"h-8 w-8 text-primary mb-2\" />\n                <CardTitle>Dual-Rate System</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-muted-foreground\">\n                  ZHK's dual-rate system calculates both parent invoices and tutor payroll from session data.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card data-testid=\"card-feature-admin\">\n              <CardHeader>\n                <GraduationCap className=\"h-8 w-8 text-primary mb-2\" />\n                <CardTitle>Admin Dashboard</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-muted-foreground\">\n                  Internal admin dashboard for ZHK staff to manage students, approve sessions, and export to QuickBooks.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n\n      {/* Footer */}\n      <footer className=\"bg-secondary py-8\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center\">\n          <p className=\"text-muted-foreground\">\n            Â© 2024 ZHK Tuition Ltd. Internal Management System.\n          </p>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":4769,"size_tokens":null},"design_guidelines.md":{"content":"# ZHK Tuition Ltd Management System - Design Guidelines\n\n## Design Approach\n\n**Selected Approach:** Design System-Based (Modern SaaS Dashboard)\n**Primary References:** Linear's data organization + Notion's table aesthetics + Stripe Dashboard's professional restraint\n**Rationale:** Information-dense business tool requiring clarity, efficiency, and professional credibility.\n\n---\n\n## Typography System\n\n**Font Stack:**\n- **Primary:** Inter (via Google Fonts) - for UI elements, tables, cards\n- **Display/Headers:** Cal Sans or Clash Display - for marketing/landing sections\n\n**Hierarchy:**\n- Page Titles: 2xl-3xl, semibold (600)\n- Section Headers: xl-2xl, semibold (600)\n- Card Titles: lg, medium (500)\n- Body/Table Text: base, regular (400)\n- Labels/Meta: sm, medium (500)\n- Captions: xs, regular (400)\n\n---\n\n## Layout & Spacing System\n\n**Spacing Primitives:** Tailwind units of 2, 4, 6, 8, 12, 16\n- Component internal padding: p-4 to p-6\n- Card spacing: p-6\n- Section padding: py-12 to py-16\n- Dashboard sidebar width: w-64\n- Content max-width: max-w-7xl\n\n**Grid System:**\n- Dashboard: 12-column grid\n- Cards: 2-3 columns on desktop (grid-cols-1 md:grid-cols-2 lg:grid-cols-3)\n- Tables: Full-width within container\n\n---\n\n## Component Library\n\n### Navigation\n**Dashboard Sidebar:**\n- Fixed left sidebar (w-64)\n- Vertical navigation with icons + labels\n- Active state: subtle background treatment\n- Logo at top, user profile at bottom\n- Collapsible on mobile (hamburger)\n\n**Top Bar:**\n- Breadcrumb navigation\n- Search functionality (prominent)\n- User menu dropdown (right-aligned)\n- Notification bell icon\n\n### Data Display\n\n**Tables:**\n- Striped rows for scannability\n- Sticky header on scroll\n- Row hover states\n- Action buttons (icon-only) right-aligned\n- Sortable column headers with chevron indicators\n- Pagination controls (bottom-right)\n- Empty states with clear messaging\n- Responsive: stack on mobile with card-like display\n\n**Cards:**\n- Rounded corners (rounded-lg)\n- Subtle shadow (shadow-sm)\n- Padding: p-6\n- Header with title + action button/icon\n- Divider between header and content\n- Stat cards: Large number + label + trend indicator\n\n**Status Badges:**\n- Pill-shaped (rounded-full)\n- Small size: px-3 py-1, text-xs\n- Semantic states: Active, Pending, Completed, Cancelled\n\n### Forms\n- Labels: text-sm, medium (500), mb-2\n- Input fields: px-4 py-2.5, rounded-md, border\n- Focus states: ring treatment\n- Error messages: text-sm, below input\n- Required indicators: asterisk (*)\n- Field grouping with mb-6 spacing\n- Submit buttons: Primary style, full or auto width\n\n### Buttons\n**Primary:** Solid background, semibold text, px-6 py-2.5, rounded-md\n**Secondary:** Border treatment, semibold text, same padding\n**Ghost:** No background/border on default, hover reveals\n**Icon Buttons:** Square/circular, p-2\n**Blurred Hero Buttons:** backdrop-blur-sm with semi-transparent background\n\n### Modals & Overlays\n- Centered overlay with backdrop\n- Max-width: max-w-2xl\n- Padding: p-8\n- Header with title + close button\n- Footer with action buttons (right-aligned)\n- Smooth entry/exit transitions\n\n---\n\n## Page Layouts\n\n### Landing/Marketing Page\n**Hero Section (80vh):**\n- Large background image (tutoring environment: students with tutor, bright classroom)\n- Centered content with max-w-4xl\n- Headline: 4xl-5xl, bold\n- Subheadline: xl\n- CTA buttons: Primary + Secondary, backdrop-blur treatment\n- Trust indicator: \"Managing 500+ students across 50 tutors\"\n\n**Features Grid:** 3 columns, icon + title + description cards\n**Benefits Section:** 2-column split (image left, content right)\n**Testimonials:** 2-column card layout with photos\n**Pricing/Demo CTA:** Centered, bold section\n**Footer:** 3-column (Company, Product, Support) + Newsletter signup\n\n### Dashboard Layout (Admin & Tutor)\n**Structure:**\n- Fixed sidebar (left)\n- Main content area with top bar\n- Content padding: p-8\n\n**Admin Dashboard:**\n- Stats overview: 4-column stat cards\n- Recent activity table\n- Quick actions card\n- Student/Tutor summary widgets\n\n**Tutor Dashboard:**\n- Personal stats: 3-column cards\n- Timesheet management (prominent table)\n- Upcoming sessions calendar view\n- Student list with quick actions\n\n### Student Management Page\n- Page header with title + \"Add Student\" button\n- Filter/search bar\n- Student table: Name, Contact, Status, Sessions, Tutor, Actions\n- Pagination controls\n\n### Timesheet Tracking\n- Calendar view toggle (week/month)\n- Time entry form (inline or modal)\n- Approval workflow indicators\n- Export functionality (top-right)\n\n### Billing Section\n- Dual-rate display (clear differentiation)\n- Invoice generation interface\n- Payment status tracking table\n- Financial summary cards\n\n---\n\n## Images\n\n**Hero Image:** Full-width background image showing professional tutoring environment - bright, modern classroom with tutor helping students, natural lighting, professional photography style. Position: Behind hero content with subtle gradient overlay for text contrast.\n\n**Benefits Section:** Supporting image showing dashboard interface mockup or happy students/tutors interaction (right side of 2-column layout).\n\n**Testimonial Photos:** Square headshots (64x64px) for testimonial cards.\n\n---\n\n## Accessibility\n\n- All interactive elements keyboard navigable\n- Focus indicators: 2px ring offset\n- ARIA labels for icon-only buttons\n- Table headers properly scoped\n- Form labels explicitly associated with inputs\n- Minimum touch target: 44x44px\n- Consistent tab order throughout\n\n---\n\n## Animations\n\n**Minimal & Purposeful:**\n- Page transitions: Subtle fade (150ms)\n- Modal entry: Scale + fade (200ms)\n- Button states: Instant feedback\n- Table row hover: Smooth background transition (150ms)\n- No scroll-triggered animations\n- Dropdown menus: Slide down (150ms)","path":null,"size_bytes":5767,"size_tokens":null},"client/src/components/parent-dashboard.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { format } from \"date-fns\";\nimport {\n  Card,\n  CardContent,\n  CardHeader,\n  CardTitle,\n  CardDescription,\n} from \"@/components/ui/card\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  GraduationCap,\n  Calendar,\n  Clock,\n  DollarSign,\n  User,\n  BookOpen,\n  FileText,\n  MessageSquare,\n  Send,\n  ChevronDown,\n  ChevronUp,\n  MessageCircle,\n} from \"lucide-react\";\nimport { useState } from \"react\";\nimport type { User as UserType, StudentWithTutor, TimesheetEntryWithRelations, Invoice, Payment, ParentMessageWithRelations } from \"@shared/schema\";\n\ninterface ParentDashboardProps {\n  user: UserType;\n  viewingStudentId?: string;\n}\n\nexport default function ParentDashboard({ user, viewingStudentId }: ParentDashboardProps) {\n  const { toast } = useToast();\n  const [messageSubject, setMessageSubject] = useState(\"\");\n  const [messageContent, setMessageContent] = useState(\"\");\n  const [recipientType, setRecipientType] = useState<\"tutor\" | \"admin\">(\"tutor\");\n  const [selectedStudentId, setSelectedStudentId] = useState<string>(\"\");\n  const [expandedMessageId, setExpandedMessageId] = useState<string | null>(null);\n\n  const { data: students = [], isLoading: studentsLoading } = useQuery<StudentWithTutor[]>({\n    queryKey: [\"/api/parent/students\", viewingStudentId],\n    retry: false,\n  });\n\n  const { data: sessions = [], isLoading: sessionsLoading } = useQuery<TimesheetEntryWithRelations[]>({\n    queryKey: [\"/api/parent/sessions\", viewingStudentId],\n    retry: false,\n  });\n\n  const { data: invoices = [], isLoading: invoicesLoading } = useQuery<Invoice[]>({\n    queryKey: [\"/api/parent/invoices\", viewingStudentId],\n    retry: false,\n  });\n\n  const { data: payments = [], isLoading: paymentsLoading } = useQuery<Payment[]>({\n    queryKey: [\"/api/parent/payments\", viewingStudentId],\n    retry: false,\n  });\n\n  const { data: sentMessages = [], isLoading: messagesLoading } = useQuery<ParentMessageWithRelations[]>({\n    queryKey: [\"/api/parent/messages\"],\n    retry: false,\n  });\n\n  const { data: expandedMessage } = useQuery<ParentMessageWithRelations>({\n    queryKey: [\"/api/messages\", expandedMessageId],\n    enabled: !!expandedMessageId,\n    retry: false,\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (data: { studentId: string; recipientType: \"tutor\" | \"admin\"; subject: string; message: string; senderEmail: string; senderName: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/parent/messages\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Message sent successfully\" });\n      setMessageSubject(\"\");\n      setMessageContent(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/parent/messages\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to send message\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSendMessage = () => {\n    const studentId = selectedStudentId || students[0]?.id;\n    if (!studentId || !messageContent.trim()) {\n      toast({ title: \"Please enter a message\", variant: \"destructive\" });\n      return;\n    }\n    sendMessageMutation.mutate({\n      studentId,\n      recipientType,\n      subject: messageSubject.trim() || \"No Subject\",\n      message: messageContent.trim(),\n      senderEmail: user.email || \"\",\n      senderName: `${user.firstName || \"\"} ${user.lastName || \"\"}`.trim() || \"Parent\",\n    });\n  };\n\n  const totalBilled = invoices.reduce((sum, inv) => sum + parseFloat(inv.amount?.toString() || \"0\"), 0);\n  const totalPaid = payments.reduce((sum, p) => sum + parseFloat(p.amount?.toString() || \"0\"), 0);\n  const balance = totalBilled - totalPaid;\n\n  if (studentsLoading) {\n    return (\n      <div className=\"space-y-4\">\n        <Skeleton className=\"h-32 w-full\" />\n        <Skeleton className=\"h-64 w-full\" />\n      </div>\n    );\n  }\n\n  const student = students[0];\n\n  if (!student) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-16\">\n        <GraduationCap className=\"h-16 w-16 text-muted-foreground mb-4\" />\n        <h2 className=\"text-xl font-semibold mb-2\">No Student Linked</h2>\n        <p className=\"text-muted-foreground text-center max-w-md\">\n          Your account is not linked to any student records. Please contact the tuition center to link your child's account.\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card data-testid=\"card-student-info\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Student</CardTitle>\n            <GraduationCap className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-student-name\">\n              {student.name}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              {student.subject} {student.examType ? `- ${student.examType}` : \"\"}\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-sessions-remaining\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Sessions Remaining</CardTitle>\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-sessions-remaining\">\n              {student.sessionsRemaining || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              of {student.sessionsBooked || 0} booked\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-account-balance\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Account Balance</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${balance > 0 ? \"text-red-500\" : \"text-green-500\"}`} data-testid=\"text-account-balance\">\n              Â£{balance.toFixed(2)}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              {balance > 0 ? \"Amount due\" : \"Credit balance\"}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {student.tutor && (\n        <Card data-testid=\"card-tutor-info\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <User className=\"h-5 w-5\" />\n              Your Tutor\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center\">\n                <User className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"font-semibold\" data-testid=\"text-tutor-name\">\n                  {student.tutor?.firstName} {student.tutor?.lastName}\n                </p>\n                <p className=\"text-sm text-muted-foreground\" data-testid=\"text-tutor-email\">\n                  {student.tutor?.email}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <Card>\n        <Tabs defaultValue=\"sessions\">\n          <CardHeader>\n            <TabsList className=\"grid w-full grid-cols-4\">\n              <TabsTrigger value=\"sessions\" data-testid=\"tab-sessions\">\n                <Clock className=\"h-4 w-4 mr-2\" />\n                Sessions\n              </TabsTrigger>\n              <TabsTrigger value=\"invoices\" data-testid=\"tab-invoices\">\n                <FileText className=\"h-4 w-4 mr-2\" />\n                Invoices\n              </TabsTrigger>\n              <TabsTrigger value=\"payments\" data-testid=\"tab-payments\">\n                <DollarSign className=\"h-4 w-4 mr-2\" />\n                Payments\n              </TabsTrigger>\n              <TabsTrigger value=\"messages\" data-testid=\"tab-messages\">\n                <MessageSquare className=\"h-4 w-4 mr-2\" />\n                Messages\n              </TabsTrigger>\n            </TabsList>\n          </CardHeader>\n\n          <TabsContent value=\"sessions\" className=\"p-4\">\n            <CardContent className=\"p-0\">\n              {sessionsLoading ? (\n                <Skeleton className=\"h-48 w-full\" />\n              ) : sessions.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <BookOpen className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No sessions recorded yet</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Duration</TableHead>\n                        <TableHead>Notes</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {sessions.map((session) => (\n                        <TableRow key={session.id} data-testid={`row-session-${session.id}`}>\n                          <TableCell>\n                            {format(new Date(session.date), \"EEE, MMM d, yyyy\")}\n                          </TableCell>\n                          <TableCell>{session.duration} hr{parseFloat(session.duration.toString()) !== 1 ? \"s\" : \"\"}</TableCell>\n                          <TableCell className=\"max-w-xs truncate\">{session.notes || \"-\"}</TableCell>\n                          <TableCell className=\"text-right font-medium\">\n                            Â£{parseFloat(session.parentBilling?.toString() || \"0\").toFixed(2)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </TabsContent>\n\n          <TabsContent value=\"invoices\" className=\"p-4\">\n            <CardContent className=\"p-0\">\n              {invoicesLoading ? (\n                <Skeleton className=\"h-48 w-full\" />\n              ) : invoices.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <FileText className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No invoices yet</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Invoice #</TableHead>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Due Date</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {invoices.map((invoice) => (\n                        <TableRow key={invoice.id} data-testid={`row-invoice-${invoice.id}`}>\n                          <TableCell className=\"font-medium\">{invoice.invoiceNumber}</TableCell>\n                          <TableCell>\n                            {invoice.createdAt ? format(new Date(invoice.createdAt), \"MMM d, yyyy\") : \"-\"}\n                          </TableCell>\n                          <TableCell>\n                            {invoice.dueDate ? format(new Date(invoice.dueDate), \"MMM d, yyyy\") : \"-\"}\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant={\n                              invoice.status === \"paid\" ? \"default\" :\n                              invoice.status === \"overdue\" ? \"destructive\" :\n                              \"secondary\"\n                            }>\n                              {invoice.status}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right font-medium\">\n                            Â£{parseFloat(invoice.amount?.toString() || \"0\").toFixed(2)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </TabsContent>\n\n          <TabsContent value=\"payments\" className=\"p-4\">\n            <CardContent className=\"p-0\">\n              {paymentsLoading ? (\n                <Skeleton className=\"h-48 w-full\" />\n              ) : payments.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <DollarSign className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No payments recorded yet</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Method</TableHead>\n                        <TableHead>Reference</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {payments.map((payment) => (\n                        <TableRow key={payment.id} data-testid={`row-payment-${payment.id}`}>\n                          <TableCell>\n                            {payment.receivedAt ? format(new Date(payment.receivedAt), \"MMM d, yyyy\") : \"-\"}\n                          </TableCell>\n                          <TableCell className=\"capitalize\">{payment.paymentMethod?.replace(\"_\", \" \")}</TableCell>\n                          <TableCell>{payment.reference || \"-\"}</TableCell>\n                          <TableCell className=\"text-right font-medium text-green-600\">\n                            Â£{parseFloat(payment.amount?.toString() || \"0\").toFixed(2)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </TabsContent>\n\n          <TabsContent value=\"messages\" className=\"p-4\">\n            <CardContent className=\"p-0 space-y-6\">\n              <Card className=\"border-dashed\">\n                <CardHeader>\n                  <CardTitle className=\"text-lg flex items-center gap-2\">\n                    <Send className=\"h-5 w-5\" />\n                    Send a Message\n                  </CardTitle>\n                  <CardDescription>\n                    Contact your tutor or the admin team with questions or feedback\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  {students.length > 1 && (\n                    <div className=\"space-y-2\">\n                      <Label>Regarding Student</Label>\n                      <Select value={selectedStudentId || students[0]?.id} onValueChange={setSelectedStudentId}>\n                        <SelectTrigger data-testid=\"select-student\">\n                          <SelectValue placeholder=\"Select student\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {students.map((s) => (\n                            <SelectItem key={s.id} value={s.id}>{s.name}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  )}\n\n                  <div className=\"space-y-2\">\n                    <Label>Send To</Label>\n                    <RadioGroup\n                      value={recipientType}\n                      onValueChange={(v) => setRecipientType(v as \"tutor\" | \"admin\")}\n                      className=\"flex gap-4\"\n                    >\n                      <div className=\"flex items-center space-x-2\">\n                        <RadioGroupItem value=\"tutor\" id=\"recipient-tutor\" data-testid=\"radio-tutor\" />\n                        <Label htmlFor=\"recipient-tutor\" className=\"cursor-pointer\">\n                          Tutor ({student?.tutor?.firstName} {student?.tutor?.lastName})\n                        </Label>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <RadioGroupItem value=\"admin\" id=\"recipient-admin\" data-testid=\"radio-admin\" />\n                        <Label htmlFor=\"recipient-admin\" className=\"cursor-pointer\">Admin Only</Label>\n                      </div>\n                    </RadioGroup>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {recipientType === \"tutor\" \n                        ? \"Your message will be sent to both the tutor and admin.\" \n                        : \"Your message will be sent to admin only (tutor will not see it).\"}\n                    </p>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"message-subject\">Subject (Optional)</Label>\n                    <Input\n                      id=\"message-subject\"\n                      placeholder=\"Enter subject...\"\n                      value={messageSubject}\n                      onChange={(e) => setMessageSubject(e.target.value)}\n                      data-testid=\"input-message-subject\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"message-content\">Message</Label>\n                    <Textarea\n                      id=\"message-content\"\n                      placeholder=\"Type your message here...\"\n                      value={messageContent}\n                      onChange={(e) => setMessageContent(e.target.value)}\n                      rows={4}\n                      data-testid=\"input-message-content\"\n                    />\n                  </div>\n\n                  <Button\n                    onClick={handleSendMessage}\n                    disabled={sendMessageMutation.isPending || !messageContent.trim()}\n                    data-testid=\"button-send-message\"\n                  >\n                    {sendMessageMutation.isPending ? \"Sending...\" : \"Send Message\"}\n                    <Send className=\"h-4 w-4 ml-2\" />\n                  </Button>\n                </CardContent>\n              </Card>\n\n              <div>\n                <h3 className=\"font-semibold mb-3\">Sent Messages</h3>\n                {messagesLoading ? (\n                  <Skeleton className=\"h-32 w-full\" />\n                ) : sentMessages.length === 0 ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <MessageSquare className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                    <p>No messages sent yet</p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {sentMessages.map((msg) => {\n                      const isExpanded = expandedMessageId === msg.id;\n                      const replies = isExpanded && expandedMessage?.replies ? expandedMessage.replies : [];\n                      const hasReplies = (msg.replies && msg.replies.length > 0) || replies.length > 0;\n                      \n                      return (\n                        <Card key={msg.id} className=\"bg-muted/30\" data-testid={`card-message-${msg.id}`}>\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex justify-between items-start mb-2\">\n                              <div>\n                                <p className=\"font-medium\">{msg.subject || \"No Subject\"}</p>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  To: {msg.recipientType === \"tutor\" ? \"Tutor & Admin\" : \"Admin Only\"} â€¢ \n                                  {msg.createdAt ? format(new Date(msg.createdAt), \" MMM d, yyyy h:mm a\") : \"\"}\n                                </p>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <Badge variant={msg.isRead ? \"secondary\" : \"default\"}>\n                                  {msg.isRead \n                                    ? (msg.readByTutor \n                                        ? `Read by ${msg.readByTutor.firstName}` \n                                        : \"Read\") \n                                    : \"Sent\"}\n                                </Badge>\n                                {hasReplies && (\n                                  <Badge variant=\"outline\" className=\"text-xs\">\n                                    <MessageCircle className=\"h-3 w-3 mr-1\" />\n                                    {replies.length || msg.replies?.length || 0}\n                                  </Badge>\n                                )}\n                              </div>\n                            </div>\n                            <p className=\"text-sm text-muted-foreground\">{msg.message}</p>\n                            \n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              className=\"mt-2 w-full justify-center text-xs\"\n                              onClick={() => setExpandedMessageId(isExpanded ? null : msg.id)}\n                              data-testid={`button-toggle-message-${msg.id}`}\n                            >\n                              {isExpanded ? (\n                                <>Hide Replies <ChevronUp className=\"h-4 w-4 ml-1\" /></>\n                              ) : (\n                                <>View Replies <ChevronDown className=\"h-4 w-4 ml-1\" /></>\n                              )}\n                            </Button>\n                            \n                            {isExpanded && (\n                              <div className=\"mt-4 border-t pt-4 space-y-3\">\n                                {replies.length === 0 ? (\n                                  <p className=\"text-sm text-muted-foreground text-center py-2\">\n                                    No replies yet\n                                  </p>\n                                ) : (\n                                  replies.map((reply) => (\n                                    <div\n                                      key={reply.id}\n                                      className=\"bg-primary/5 rounded-lg p-3 border-l-2 border-primary\"\n                                      data-testid={`reply-${reply.id}`}\n                                    >\n                                      <div className=\"flex justify-between items-start mb-1\">\n                                        <p className=\"text-sm font-medium\">\n                                          {reply.repliedBy?.firstName} {reply.repliedBy?.lastName}\n                                          <span className=\"text-xs text-muted-foreground ml-2\">\n                                            ({reply.repliedBy?.role === \"admin\" ? \"Admin\" : \"Tutor\"})\n                                          </span>\n                                        </p>\n                                        <p className=\"text-xs text-muted-foreground\">\n                                          {reply.createdAt ? format(new Date(reply.createdAt), \"MMM d, h:mm a\") : \"\"}\n                                        </p>\n                                      </div>\n                                      <p className=\"text-sm\">{reply.replyContent}</p>\n                                    </div>\n                                  ))\n                                )}\n                              </div>\n                            )}\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </TabsContent>\n        </Tabs>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":25329,"size_tokens":null}},"version":2}